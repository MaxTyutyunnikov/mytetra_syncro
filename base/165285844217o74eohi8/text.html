<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">За последние несколько лет мне пришлось столкнуться с множеством вопросов, которые были сформулированы примерно так: «мой проект не открывается в среде CLion». В свою очередь, это приводило к необходимости из раза в раз объяснять разным людям примерно одно и то же. Статья имеет целью сохранить тот опыт, который был накоплен в процессе анализа десятков разных проектов.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="cut"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">C</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Lion — проприетарная кроссплатформенная среда разработки для языков C и C++ от компании JetBrains. Предполагается, что </span><a href="https://www.jetbrains.com/help/clion/makefiles-support.html"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">официальная документация</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> вам уже известна и не вызывает вопросов.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Если вам лень вникать в скучные технические детали, можете перейти прямо к разделу «Рекомендации».</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Постановка задачи</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Основная проблема с проектами, использующими в качестве системы сборки </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, состоит в том, что эта система не предоставляет ровным счётом никакой информации о проектной модели, т. е. о том, какие файлы исходного кода попадут на вход компилятора, какие ключи компилятора, директивы препроцессора и заголовочные файлы будут использованы, и какие бинарные файлы мы получим на выходе. Эта информация остаётся неизвестной до тех пор, пока проект не будет собран. В этом состоит сложность задачи интеграции сред разработки (IDE) и системы сборки </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Рассмотрим, например, проект с вот такой плоской структурой:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Makefile</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">foo.c</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">bar.c</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">и вот таким элементарным Makefile:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.PHONY: all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">all: foo</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.PHONY: clean</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">clean:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(RM) foo</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Здесь видно, что файл foo.c является частью проектной модели, т. к. будет участвовать в процессе компиляции (посредством встроенного правила $(CC) foo.c -o foo), а файл bar.c — не является.</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Подходы к анализу проектной модели</span></h2>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">База данных компиляции</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Можно решить задачу «в лоб» и сначала собрать проект, а уж затем выяснить, какие файлы и с какими флагами были скомпилированы. Для создания файла </span><a href="https://clang.llvm.org/docs/JSONCompilationDatabase.html"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">compile_commands.json</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (собственно базы данных компиляции) будем использовать любой из доступных генераторов — </span><a href="https://github.com/rizsotto/Bear"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">bear</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> или </span><a href="https://github.com/nickdiego/compiledb"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">compiledb</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. bear работает посредством перехвата динамических вызовов (LD_PRELOAD) и потому выдаёт достаточно точный результат, не зависит от системы сборки (т. е. может использоваться совместно с любой системой сборки, хоть с чёртом в ступе, а не только с </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), но имеет ограничения на </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Mac OS X</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и вообще не работает на </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Windows</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. С другой стороны, compiledb анализирует исключительно </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">вывод</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> команды make и потому нередко совершает ошибки, но, с другой стороны, работает везде. Если вы используете </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Linux</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, я предлагаю вам остановить свой выбор именно на bear. По крайней мере, у вас не будет ошибок, связанных с неверной интерпретацией двойных кавычек, апострофов и путей, содержащих пробелы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Итак, мы собрали наш проект, «обернув» команду сборки и выполнив что-то вроде bear make или bear make all, и теперь имеем на выходе заветный compile_commands.json. </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> вполне в состоянии открыть этот файл как проект, но у такого подхода есть по меньшей мере 2 недостатка:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сборка всего проекта может занимать десятки минут (ядро <span style=" font-style:italic;">Linux</span>) или даже часы, а открыть проект в IDE хочется «почти мгновенно».</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вы не просто открыли проект с целью «посмотреть код», а собираетесь добавлять/удалять/переименовывать файлы, переписывать сам Makefile или его прототип (как в системах сборки типа <a href="https://ru.wikipedia.org/wiki/Autotools"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">GNU Autotools</span></a>, работающих поверх <span style=" font-style:italic;">Make</span>), то после каждой такой операции вам придётся заново генерировать базу данных компиляции. И это муторно, скажу я вам.</li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Поэтому стоит задаться вопросом, нет ли способа проанализировать структуру проекта, не выполняя сборку.</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Переопределение переменных окружения</span></h3>
<h4 style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Переопределение переменной $(MAKE)</span></h4>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Этот подход не может использоваться как самостоятельное решение, однако, если проект использует рекурсивные вызовы </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (см. </span><a href="https://www.gnu.org/software/make/manual/html_node/Recursion.html"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">5.7 Recursive Use of make</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), можно переопределить переменную MAKE и, подставив в значение путь до собственной «обёртки» над </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (MAKE=my-custom-make-wrapper), отслеживать все такие вызовы и, при необходимости, менять или дополнять флаги </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, редактируя аргументы перехватываемой командной строки.</span></p>
<h4 style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Переопределение компиляторов</span></h4>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Переопределяя переменные CC и CXX (и имея «обёртку», которая может имитировать поведение компилятора), можно перехватывать вызовы компилятора и, таким образом, точно знать, в каком каталоге и с какими аргументами компилятор был вызван.</span></p>
<h4 style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Переопределение оболочки</span></h4>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Переопределяя переменную SHELL (при наличии «обёртки», опять же), можно получить информацию обо всех вызываемых командах (а не только о командах компиляции).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Разумеется, вышеупомянутые техники можно произвольным образом комбинировать.</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Перехват системных вызовов</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">На </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Linux</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Solaris</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и, с оговорками, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Mac OS X</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> информацию о системных вызовах </span><a href="https://www.tutorialspoint.com/unix_system_calls/execve.htm"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">execve()</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (и интересующих нас аналогах) можно получить через механизм LD_PRELOAD или (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Linux</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">) запуская утилиту </span><a href="https://man7.org/linux/man-pages/man1/strace.1.html"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">strace</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Впрочем, полученное решение уже не будет кроссплатформенным.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Мне не известен ни один инструмент, где бы хотя бы частично были реализованы эти техники, кроме, быть может, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">NetBeans CND</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Oracle Solaris Studio</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Однако, насколько мне известно, поддержка Makefile-проектов в упомянутых продуктах не развивалась с 2016 года.</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Запуск </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;"> в режиме «dry run»</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">На русский язык переводится как «репетиция», но подобного русскоязычного термина попросту нет, поэтому впредь будем называть этот режим именно «dry run», как в англоязычной документации. Вот описание ключа командной строки </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">GNU Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">-n, –just-print, –dry-run, –recon</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Print the commands that would be executed, but do not execute them (except in certain circumstances).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Помимо этого флага, нам ещё понадобится флаг w:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">-w, –print-directory</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Print a message containing the working directory before and after other processing. This may be useful for tracking down errors from complicated nests of recursive make commands.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">и флаг k:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">-k, –keep-going</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Continue as much as possible after an error. While the target that failed, and those that depend on it, cannot be remade, the other dependencies of these targets can be processed all the same.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Полная командная строка, таким образом, будет make -wnk, и вывод команды </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в большинстве случаев позволяет нам проанализировать структуру проекта. Этот способ не столь точен, как переопределение переменных или перехват системных вызовов, но он относительно прост в реализации, и в </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> используется именно этот подход.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Вручную указывать в настройках проекта флаги w, n и k не нужно: в процессе анализа проектной модели </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> подставит их автоматически. При необходимости глобальные значения флагов, используемых для анализа, можно изменить в расширенных настройках, но доля проектов, где в этом была бы практическая необходимость, исчезающе мала: </span><a href="https://unix-junkie.github.io/docs/makefile-projects-in-clion/clion-makefile-advanced-settings.png"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">снимок</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Выделение списка целей</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Помимо анализа проектной модели, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> умеет собирать информацию о том, какие </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">цели</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> объявлены в Makefile. Каждая выявленная цель автоматически становится конфигурацией типа </span><a href="https://www.jetbrains.com/help/clion/run-debug-configuration-makefile-application.html"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic; text-decoration: underline; color:#0000ff;">Makefile Application</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">: </span><a href="https://unix-junkie.github.io/docs/makefile-projects-in-clion/clion-makefile-application.png"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">снимок</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; font-style:italic;">GNU Make</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Для </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">GNU Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> информация о целях собирается так же, как это сделано в соответствующем сценарии из проекта </span><a href="https://github.com/scop/bash-completion/blob/master/completions/make"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">bash-completion</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, достаточно воспользоваться флагом p:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">-p, –print-data-base</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Print the data base (rules and variable values) that results from reading the makefiles; then execute as usual or as otherwise specified. This also prints the version information given by the -v switch. To print the data base without trying to remake any files, use make -p -f/dev/null.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">и выполнить make -npq.</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; font-style:italic;">BSD Make</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Здесь нужен другой подход: </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">BSD Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ничего не знает о флаге p, это расширение GNU.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В настоящее время </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> не поддерживает </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">BSD Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, но, чисто теоретически, «научить» работать с целями </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">BSD Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> достаточно просто, используя (опять же, нестандартный) флаг V:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">-V variable</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Print bmake’s idea of the value of </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">variable</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, in the global context. Do not build any targets. Multiple instances of this option may be specified; the variables will be printed one per line, with a blank line for each null or undefined variable. If </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">variable</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> contains a ‘$’ then the value will be expanded before printing.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Таким образом, список целей можно легко получить, выполнив команду</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">bmake V '$(.ALLTARGETS)'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Если хочется исключить из этого списка синтетические «псевдоцели» (.WAIT), команду надо привести к следующему виду:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">bmake -V '$(.ALLTARGETS:N.WAIT_*:O)'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Рекомендации</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Теперь, собственно, то, ради чего вся статья и была написана. Следование этим рекомендациям не даст стопроцентной гарантии, что ваш проект без ошибок откроется в </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, но, во всяком случае, существенно снизит количество этих ошибок.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Часть советов касается рекурсивных вызовов </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Внимательный читатель, вероятно, скажет, что это абсолютное зло, сославшись на статью Питера Миллера «Recursive Make Considered Harmful» (</span><a href="https://accu.org/journals/overload/14/71/miller_2004/"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">HTML</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><a href="https://web.archive.org/web/20070205211740/http://aegis.sourceforge.net/auug97.pdf"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">PDF</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">). На что можно возразить, что подавляющее большинство проектов, основанных на </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">GNU Autotools</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, таки использует рекурсию </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, так что зло это хоть и абсолютное, но, увы, неизбежное. К тому же, как выяснилось в процессе подготовки статьи, есть и </span><a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/03/hadrian.pdf"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">альтернативный взгляд на вещи</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Начнём.</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Убедитесь, что проект таки собирается (в том же окружении и тем же компилятором, какие выбраны в настройках проекта <span style=" font-style:italic;">CLion</span>). Условно говоря, если в настройках выбраны WSL и GCC, то код должен собираться в выбранной гостевой виртуальной машине компилятором GCC. Отсутствующие заголовочные файлы, недостающие зависимости, завершающийся с ошибкой сценарий configure (для <span style=" font-style:italic;">GNU Autotools</span>) — все эти проблемы стоит разрешить заранее, <span style=" font-style:italic;">до</span> того, как вы попытаетесь открыть проект в <span style=" font-style:italic;">CLion</span>.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Используйте <a href="https://www.gnu.org/software/make/"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">GNU Make</span></a>. Убедитесь, что путь именно к этому инструменту выбран у вас в настройках. <a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/make.html"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">POSIX Make</span></a>, <a href="https://www.crufty.net/help/sjg/bmake.html"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">BSD Make</span></a>, <a href="http://docs.embarcadero.com/products/rad_studio/radstudio2007/RS2007_helpupdates/HUpdate4/EN/html/devwin32/make_xml.html"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">Borland Make</span></a> и <a href="https://docs.microsoft.com/en-us/cpp/build/reference/nmake-reference"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">Microsoft NMake</span></a> пока не поддерживаются.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если ваш Makefile использует рекурсивные вызовы <span style=" font-style:italic;">Make</span>, в коде <a href="https://www.gnu.org/software/make/manual/html_node/Recipes.html"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">рецепта</span></a> (т. е. интерпретируемого оболочкой набора команд для сборки цели) всегда вызывайте <a href="https://www.gnu.org/software/make/manual/html_node/MAKE-Variable.html"><span style=" text-decoration: underline; color:#0000ff;">$(MAKE)</span></a> вместо make. Тому есть две причины.</li>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Первая причина никак не связана собственно с </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">: у кого-то из пользователей инструмент </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> может отсутствовать в переменной PATH или быть установлен как gmake или bmake. Рекурсивно вызывая $(MAKE), вы можете быть уверены, что для родительского и дочернего процессов </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> будет использован один и тот же исполняемый файл (напр., /usr/bin/make), т. е., скажем, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">GNU Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> никогда не породит </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">BSD Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, и наоборот.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Во-вторых, в пресловутом режиме «dry run», используемом для анализа проектной модели, первая форма записи будет распознана как рекурсивный вызов с печатью соответствующих команд, а вторая — нет. Рассмотрим проект с такой структурой:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Makefile</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">foo/ </li>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 3;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Makefile</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">foo.c</li></ul>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">bar/ </li></ul>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 3;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Makefile</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">bar.c</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">А теперь сравним два варианта вывода </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Первый, через $(MAKE):</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make: Entering directory '/home/alice'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make -C foo all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: Entering directory '/home/alice/foo'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">echo &quot;Making all in foo...&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">gcc -c -o foo.o foo.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: Leaving directory '/home/alice/foo'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make -C bar all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: Entering directory '/home/alice/bar'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">echo &quot;Making all in bar...&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">gcc -c -o bar.o bar.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: Leaving directory '/home/alice/bar'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make: Leaving directory '/home/alice'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">А теперь make:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make: Entering directory '/home/alice'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make -C foo all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make -C bar all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make: Leaving directory '/home/alice'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Во втором случае, если в каком-то из дочерних (рекурсивно вызываемых) Makefile’ов был столь нужный нам вызов компилятора, мы этого просто не увидим.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Кстати, ровно в вышеописанном нюансе состоит сложность реализации поддержки средой </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> инструмента </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">BSD Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">: с точки зрения конечного пользователя, bmake -wnk никогда не распознаёт рекурсивные вызовы, независимо от формы записи. Связано это с тем, что </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">GNU Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в режиме «dry-run» (-n) для каждого рекурсивного исполнения $(MAKE) производит системный вызов execve() (тоже с флагом -n, разумеется), а вот </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">BSD Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> — как раз нет (разница легко обнаруживается при запуске утилиты strace с ключом -f):</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$ strace -f -e execve make -wnk 2&gt;&amp;1 &gt;/dev/null | grep -vF ENOENT | grep -F execve</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">execve(&quot;/usr/bin/make&quot;, [&quot;make&quot;, &quot;-wnk&quot;], 0x7ffe8a5a35a0 /* 80 vars */) = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">[pid 15729] execve(&quot;/usr/bin/make&quot;, [&quot;make&quot;, &quot;-C&quot;, &quot;foo&quot;, &quot;all&quot;], 0x5608f4544a30 /* 84 vars */) = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">[pid 15730] execve(&quot;/usr/bin/make&quot;, [&quot;make&quot;, &quot;-C&quot;, &quot;bar&quot;, &quot;all&quot;], 0x5608f4544a30 /* 84 vars */) = 0</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$ strace -f -e execve bmake -wnk 2&gt;&amp;1 &gt;/dev/null | grep -vF ENOENT | grep -F execve</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">execve(&quot;/usr/bin/bmake&quot;, [&quot;bmake&quot;, &quot;-wnk&quot;], 0x7ffc10221bb0 /* 80 vars */) = 0</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Не «зашивайте» в ваш Makefile короткое имя компилятора или полный путь к нему, как, напр., gcc или /usr/bin/clang++. Вместо этого используйте стандартные переменные $(CC) и $(CXX). При запуске внешних процессов <span style=" font-style:italic;">CLion</span> устанавливает одноимённые переменные окружения так, чтобы они соответствовали набору инструментов («<a href="https://www.jetbrains.com/help/clion/how-to-create-toolchain-in-clion.html"><span style=" text-decoration: underline; color:#0000ff;">toolchain</span></a>»), выбранному в настройках проекта. В результате и в процессе анализа проектной модели, и в процессе сборки будут использованы ровно те компиляторы C и C++, какие выбраны у вас в настройках проекта (поле «<span style=" font-style:italic;">Toolchain</span>»). Соответственно, и переключиться с GCC на Clang или наоборот легко и просто — с той лишь оговоркой, что потребуется повторить и фазу анализа проектной модели, и сборку.</li>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Вот так плохо:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">foo.o: foo.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	cc -c -o $@ $&lt;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Вот так хорошо:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">foo.o: foo.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(CC) -c -o $@ $&lt;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поскольку флаги w, n и k являются принципиально важными для корректного анализа проектной модели, не меняйте значений этих флагов посредством MFLAGS, MAKEFLAGS или GNUMAKEFLAGS. Плохой пример, выключение флага w:</li>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">GNUMAKEFLAGS += --no-print-directory</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В качестве альтернативы, если вы работаете с «чужим» проектом, куда у вас нет прав на запись (пусть, напр., </span><a href="https://github.com/nodejs/node/commit/ad7b98baa84172d1c6de1ed0a06be6aad9f6f3db"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">Node.js</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), и не хотите менять файлы, находящиеся под контролем системы VCS, можно для фазы анализа включить флаг e:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">-e, –environment-overrides</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Give variables taken from the environment precedence over variables from makefiles.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Вот так могут выглядеть настройки проекта для Node.js: </span><a href="https://unix-junkie.github.io/docs/makefile-projects-in-clion/clion-makefile-node.js.png"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">снимок</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Включение флага e через поле «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Arguments</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">» может быть альтернативным решением и в иных случаях, когда на уровне Makefile переопределены флаги </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> или другие стандартные переменные окружения (см. ниже).</span></p>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Избегайте параллелизма на уровне процессов (make -jN при <span style=" font-style:italic;">N &gt; 1</span>), «зашитого» в Makefile через переопределение переменных MFLAGS, MAKEFLAGS или GNUMAKEFLAGS (подробнее в <a href="https://www.gnu.org/software/make/manual/html_node/Options_002fRecursion.html"><span style=" text-decoration: underline; color:#0000ff;">5.7.3 Communicating Options to a Sub-make</span></a>):</li>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">MAKEFLAGS += j8</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.PHONY: all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">all: foo-all bar-all</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.PHONY: foo-all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">foo-all:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(MAKE) -C foo all</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.PHONY: bar-all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">bar-all:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(MAKE) -C bar all</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В таких условиях </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> будет использовать более одного (в примере выше — 8) параллельного процесса при рекурсивных вызовах, в результате чего в выводе команды сообщения вида «Entering directory ‘…’» и «Leaving directory ‘…’» будут перемешаны между собой, команды компиляции — произвольным образом разбросаны между этими сообщениями, и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> не сможет отследить ни смену каталога, ни принадлежность команды тому или иному каталогу:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make: Entering directory '/home/alice'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make -C foo all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make -C bar all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: Entering directory '/home/alice/foo'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: Entering directory '/home/alice/bar'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">echo &quot;Making all in foo...&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: Leaving directory '/home/alice/foo'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">echo &quot;Making all in bar...&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: Leaving directory '/home/alice/bar'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make: Leaving directory '/home/alice'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">С учётом вышесказанного, если вы хотите иметь возможность собирать проект, используя несколько параллельных процессов </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, передайте флаг -j через поле «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Build options</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">» в настройках проекта (но ни в коем случае не через поле «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Arguments</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">» — флаги в этом поле используются для анализа проектной модели, но не для сборки): </span><a href="https://unix-junkie.github.io/docs/makefile-projects-in-clion/clion-makefile-multiple-jobs.png"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">снимок</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Аналогичным образом, при рекурсивных вызовах <span style=" font-style:italic;">Make</span>, не переопределяйте региональные настройки (LC_*, LANG, LANGUAGE) внутри ваших Makefile’ов и/или сценариев сборки. Дело в том, что <span style=" font-style:italic;">CLion</span>, отслеживая сообщения о смене каталога, ожидает эти сообщения именно на английском языке (и заботливо устанавливает нужное окружение для родительского процесса <span style=" font-style:italic;">Make</span>). Вот что будет, если вмешается пользователь:</li>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">export LC_ALL = ru_RU.UTF-8</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">export LANG = ru_RU.UTF-8</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.PHONY: all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">all: foo-all bar-all</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.PHONY: foo-all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">foo-all:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(MAKE) -C foo all</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.PHONY: bar-all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">bar-all:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(MAKE) -C bar all</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Вывод команды make -wnk:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make: Entering directory '/home/alice'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make -C foo all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: вход в каталог «/home/alice/foo»</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">echo &quot;Making all in foo...&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: выход из каталога «/home/alice/foo»</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make -C bar all</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: вход в каталог «/home/alice/bar»</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">echo &quot;Making all in bar...&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make[1]: выход из каталога «/home/alice/bar»</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">make: Leaving directory '/home/alice'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее, при рекурсивных вызовах <span style=" font-style:italic;">Make</span>, старайтесь вместо формы</li>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">target:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	cd subdir &amp;&amp; $(MAKE) target</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">использовать форму</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">target:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(MAKE) -C subdir target</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Помимо служебных сообщений </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> («Entering directory», «Leaving directory»), </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, безусловно, обработает и команду cd и отследит смену текущего каталога, но второй вариант записи кажется надёжнее.</span></p>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Используйте встроенную функцию <a href="https://www.gnu.org/software/make/manual/html_node/Foreach-Function.html"><span style=" text-decoration: underline; color:#0000ff;">$(foreach)</span></a> вместо циклов оболочки POSIX (for ... do ... done или while ... do ... done). Рассмотрим проект со следующей структурой:</li>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Makefile</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">foo/ </li>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 3;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Makefile</li></ul>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">bar/ </li>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 3;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Makefile</li></ul>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">baz/ </li></ul>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 3;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Makefile</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">и вот таким Makefile’ом в корневом каталоге проекта:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">all-recursive:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	for subdir in foo bar baz; \</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	do (cd $$subdir; $(MAKE) all) || exit 1; done</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Здесь рецепт цели all-recursive — это цикл оболочки POSIX, который, скорее всего, не будет выполнен в режиме «dry run». Если воспользоваться функцией $(foreach), то можно переписать так:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">all-recursive:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(foreach subdir,$(SUBDIRS),$(MAKE) -C $(subdir) all;)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если есть необходимость скомпилировать сразу несколько файлов исходного кода одной командной строкой, не используйте <span style=" font-style:italic;">маски</span> (wildcards) оболочки. Вместо этого используйте встроенную функцию <a href="https://www.gnu.org/software/make/manual/html_node/Wildcard-Function.html"><span style=" text-decoration: underline; color:#0000ff;">$(wildcard)</span></a>. Вот так плохо:</li>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">all:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(CC) -c *.c</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Если в одном с Makefile’ом каталоге находятся, например, файлы foo.c и bar.c, то на стадии анализа команда make -wnk по-прежнему выведет</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">cc -c *.c</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">а </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> не умеет вычислять маски оболочки (к тому же, на UNIX и Windows оболочки разные и, соответственно, синтаксис масок слегка различен). Вот так хорошо:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">all:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(CC) -c $(wildcard *.c)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В этом случае значение маски будет вычислено средствами </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Make</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">cc -c foo.c bar.c</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Файлы исходного кода должны существовать в дереве проекта на момент анализа проектной модели.</span></p>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вам необходимо выполнить фрагмент кода <span style=" font-style:italic;">рецепта</span> цели во <span style=" font-style:italic;">вложенной оболочке</span> (по-английски это называется «<a href="https://en.wikiversity.org/wiki/Bash_programming/Subshells"><span style=" text-decoration: underline; color:#0000ff;">subshell</span></a>»), и этот фрагмент одновременно является частью <span style=" font-style:italic;">команды компиляции</span> (которая, как вы ожидаете, должна быть распознана средой <span style=" font-style:italic;">CLion</span>), то дочерние процессы оболочки POSIX лучше создавать средствами <span style=" font-style:italic;">Make</span>, используя встроенную функцию <a href="https://www.gnu.org/software/make/manual/html_node/Shell-Function.html"><span style=" text-decoration: underline; color:#0000ff;">$(shell)</span></a>, а не средствами оболочки ($(команда) или `команда`). Иными словами, вот такой подход будет работать:</li></ol>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">main.o: main.cpp</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(CXX) -I../ -g -Wall $(shell pkg-config some-library) -c -o $@ $&lt;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">в то время как такой — нет:</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">main.o: main.cpp</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(CXX) -I../ -g -Wall `pkg-config some-library` -c -o $@ $&lt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">	$(CXX) -I../ -g -Wall $$(pkg-config some-library) -c -o $@ $&lt;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Это связано с тем, что </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">CLion</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, за вычетом некоторых исключений (напр., </span><a href="https://www.gnu.org/software/automake/manual/html_node/VPATH-Builds.html"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">VPATH</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">-сборки в </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">GNU Autotools</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), не умеет анализировать командные строки, использующие </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">вложенную оболочку</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">На этом всё. Надеюсь, описанный опыт был кому-то полезен. Есть ещё некоторые нюансы, которые проще всего проиллюстрировать на конкретном Makefile-проекте (а именно, ядре Linux).</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p></body></html>