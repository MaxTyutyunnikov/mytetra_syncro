<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16pt; font-weight:600;">Путеводитель по Эльбрусу</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Автор: <span style=" font-family:'sans-serif'; font-size:12pt;">evm</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">(перевод)</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans','DejaVu Sans'; font-size:12pt; font-style:italic;">Следуя замечательной традиции публиковать в нашем издании уникальные туристические путеводители, давайте совершим волшебное путешествие по современной компьютерной архитектуре &quot;Эльбрус 2000&quot;, которая разработана в матушке России.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Что мы имеем</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Основные модели</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Elbrus-1S+, Elbrus-4S, Elbrus-85, Elbrus-8SV, Elbrus-16S</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Архитектура</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Фон Нейман</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Очень широкое командное слово (VLIW)</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Управление регистровым окном (32-разрядные базовые регистры)</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans','DejaVu Sans'; font-size:12pt; font-weight:600;">Регистры</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans','DejaVu Sans Mono'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">g0-g31: Глобальные регистры</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">r0-r17: Универсальные (оконные) регистры</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">bO-b7: Регистр наложения окна</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Pred0-Pred31: Регистры логических предикатов</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans','DejaVu Sans'; font-size:12pt; font-weight:600;">Адресное пространство</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">64-разрядная виртуальная адресация</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Неизвестная нам физическая карта памяти</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image17218207042jzica5jbg.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Предыстория и история</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">&quot;Эльбрус&quot; - это российская архитектура процессоров, которая в той или иной форме существует уже более 40 лет. Все началось в Институте точной механики и вычислительной техники им. Лебедева. Это был первый суперскалярный процессор с out-of-order исполнением, разработанный в Советском Союзе (&quot;Эльбрус-1&quot; дебютировал в 1979 году). В 1990 году архитектура Elbrus 3 была расширена до архитектуры с очень длинными инструкциями (VLIW). После полной интеграции в качестве микропроцессорной архитектуры в 2001 году (ранее в предыдущих версиях использовалось много дискретных микросхем), архитектура стала известна как Elbrus 2000 (сокращенно E2K). &quot;Эльбрус&quot; разработан в России, но в настоящее время производится компанией TSMC на Тайване из-за нехватки российских производственных мощностей, способных производить чипы на передовых технологических нормах. <span style=" vertical-align:super;">48</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В начале 90-х годов из Института Лебедева было выделено акционерное общество &quot;Московский центр SPARC технологий&quot; (сокращенно - МЦСТ). В настоящее время МЦСТ производит новые чипы &quot;Эльбрус&quot; для ПК, ноутбуков и серверов на базе &quot;Эльбруса&quot;. В настоящее время Elbrus-8S и 8SV являются самыми современными моделями процессоров (восьмиядерные версии для серверов и настольных компьютеров), а также доступны более дешевые 1S+ (одноядерные). Обратите внимание на транслитерацию с кириллицы, где названия моделей выглядят как Эльбрус-8S, Эльбрус-8CB и Эльбрус-1C+ соответственно. Как ни странно, процессоры 8S примерно в три раза медленнее аналогичных процессоров Intel, <span style=" vertical-align:super;">49</span> но преимущество Эльбруса в том, что это полностью отечественный процессор российского производства. Сообщается, что российские военные заказали тысячи ноутбуков в защищенном исполнении на базе Эльбрус-1S+ <span style=" vertical-align:super;">50</span>, хотя нет никаких указаний на то, что этот заказ когда-либо был доставлен.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В настоящее время существует очень мало общедоступной документации по Elbrus, поскольку MCST контролирует большую часть документации в соответствии с соглашениями о неразглашении. Это означает, что у нас нет полной документации по процессору, как это обычно бывает с коммерческими процессорами.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для этой статьи мы использовали три источника информации:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">русскоязычное руководство по программированию и оптимизации на Эльбрусе, опубликованное MCST, </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">исходный код, опубликованный OpenE2K group (группой любителей, по-видимому, не связанной с MCST), </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">утечка исходного кода ядра Linux.</li></ol>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В настоящее время MCST находится в санкционном списке США, но благодаря проведению и нашим друзьям мы получили доступ к компьютеру Elbrus-1S+ и использовали его для проверки работы некоторых примеров кода. На нашем Эльбрусе была установлена версия Linux производства MCST, но для Эльбруса также доступны другие российские дистрибутивы Linux (например, Astra Linux). В машине Elbrus есть компилятор под названием <span style=" font-family:'FreeMono'; color:#6a1009;">lcc</span>, который является компилятором MCST, основанным на <span style=" font-family:'FreeMono'; color:#6a1009;">gcc</span> (на самом деле, нет. - прим. переводчика) . Он создает стандартные двоичные файлы Linux ELF. На данный момент возможности для дизассемблирования ограничены <span style=" font-family:'FreeMono'; color:#6a1009;">ldis</span>, который является частью <span style=" font-family:'FreeMono'; color:#6a1009;">lcc</span>, и <span style=" font-family:'FreeMono'; color:#6a1009;">objdump</span>, который является частью пакета <span style=" font-family:'FreeMono'; color:#6a1009;">binutils</span>, выпущенного OpenE2K group. <span style=" font-family:'FreeMono'; color:#6a1009;">ldis</span> обеспечивает более чистый вывод, включая разрешение имен символов, в то время как <span style=" font-family:'FreeMono'; color:#6a1009;">objdump</span> имеет флаг отладки в сборке, который будет предварять вывод декодированными инструкциями в шестнадцатеричном формате. Как ни странно, <span style=" font-family:'FreeMono'; color:#6a1009;">ldis</span>, похоже, упускает некоторые моменты (например, не разбирает все функции), хотя это может быть связано с ошибкой оператора.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы изучить набор инструкций Elbrus, мы обновили <span style=" font-weight:600;">rix's Smashing C++ VPTRs</span> из <span style=" font-weight:600;">Phrack 56:8</span>. Это целая история, которая будет рассказана в другой раз, но вы найдете мои примеры кода и соответствующую разборку кода Elbrus, приложенную к этому PDF-файлу. <span style=" vertical-align:super;">52</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Основы декодирования набора команд</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Первое, что нам нужно было выяснить, - это как устроен формат инструкции, поскольку в официальной документации эта тема полностью отсутствовала. К счастью, мы обнаружили, что в выпуске OpenE2K <span style=" font-weight:600;">binutils</span> есть флаг препроцессора ENABLE_E2K_ENCODINGS, который заставляет <span style=" font-weight:600;">objdump</span> распечатывать байты команд и их группы.<span style=" vertical-align:super;">53</span> Версия <span style=" font-weight:600;">objdump</span> с этим флагом была именно той, что мы использовали для выполнения разборки большей части данной статьи.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В документации Elbrus VLIW называется &quot;широкой командой&quot;. Широкая команда содержит несколько инструкций, каждая из которых предназначена для отдельных исполнительных блоков в конвейере процессора. В документации по-разному используются термины &quot;команды&quot; (commands), “инструкции” (intruction) и “операции” (operations) для обозначения компонентов инструкции в полном командном слове.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Код OpenE2K <span style=" font-family:'FreeMono'; color:#6a1009;">objdump</span> описывает способ кодирования команд компонентов в виде “слогов”. Приятной особенностью Elbrus является то, что кодировка команд довольно проста по сравнению с современными DSP-архитектурами, с которыми мы ранее сталкивались. Подсчет длинны команды - это эксплуатационная задача, которая может быть довольно сложной на некоторых архитектурах, но не на Elbrus. Определить длину команды по начальному слогу “HS” довольно просто (показано далее).</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Слог HS определяет наличие других слогов инструкции, которые располагаются в определенном порядке. Порядок такой: SS; ALU; CS0; ALES полуслоги 2 и 5; CS1; ALES полуслоги 0, 1, 3 и 4; полуслоги AAS; проверка пробелов; CDS; PLS; и, наконец, LTS (литералы).</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Буквальные данные слогов (т.е. непосредственные значения) располагаются в конце слогов. Код OpenE2K <span style=" font-family:'FreeMono'; color:#6a1009;">objdump</span> ищет все указанные выше флаги наличия слогов, считывает их по порядку (учитывая возможные пробелы), а затем сравнивает количество прочитанных слогов с полем размера в HS. Любые дополнительные слоги считываются как литералы. Для слогов, содержащих &quot;полуслоги&quot; (т.е. 16-разрядные значения), порядок следования слогов меняется по мере их последовательного появления в памяти.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Byte order          | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">                    ---------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Half syllable order |   1   |   0   |   3   |   2   |</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Тайный смысл вы поймете, если вы задумаетесь о том, что байты считываются как 4-байтовые значения в порядке убывания:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Word order          |       0       |       1       |</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">                    ---------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Byte order          | 3 | 2 | 1 | 0 | 7 | 6 | 5 | 4 |</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">                    ---------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Half syllable order |   0   |   1   |   2   |   3   |</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Набор регистров</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Базовые регистры Elbrus состоят из 18 регистров общего назначения (r0–r17), 32 глобальных регистров (g0–g31) и скользящего набора оконных регистров (b0–b7). Подробнее об управлении регистровым окном будет рассказано в следующем разделе. Имена регистров имеют префикс ширины доступа, аналогичный x86.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Например, регистр sr0 - это одинарный (single) 32-разрядный r0, а dr0 - это двойной (double) 64-разрядный r0, который используется по умолчанию. Когда регистры используются со значениями с плавающей запятой, используется xr0, который является 80-разрядной версией, предположительно использующей формат long double из x86. Согласно документации, к двум двойным регистрам можно получить доступ как к четверному (quad) регистру – например, qr[i], где [i] является четным, – но gdb в нашем случае, похоже, не знает об этом обозначении.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">ВНИМАНИЕ: в Elbrus размер слова равен 32 битам как для регистров, так и для доступа к памяти, поэтому значение single/double/quad в Elbrus в два раза больше, чем в 64-разрядных версиях x86, где длина слова восходит к его ранним предкам.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image172182177695haebqv3t.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Кодировка начального слога HS, который определяет наличие других слогов</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">в слове-инструкции для всего командного языка Эльбрус.</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Неясно, для чего используются слоги ALES, CDS и PLS, </span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">поскольку мы не генерировали ни одну из этих инструкций в примере кода.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Основные арифметические операции и операции с памятью в Elbrus</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В следующей таблице собраны различные операции с регистром ALU:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image17218219786c7nm1ycxi.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Базовая инструкция ALU выглядит следующим образом:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ALS0 1181d48d addd,0 %dr1, _f16s,_lts0hi 0xfff0, %dr13</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это переводится как &quot;добавить в режиме двойной точности, используя канал 0, значение 64-разрядного регистра %dr1 к 16-разрядному значению со знаком 0xfff0, и поместить результат в регистр dr13&quot;. Существует шесть каналов ALU, поэтому вы можете выполнять до шести команд ALU в одной общей команде. Команды простого &quot;перемещения&quot; регистра (MOVE) не существует, поэтому компилятор обычно использует сложение с нулем в качестве команды перемещения. Полный список операций с регистром ALU приведен в таблице выше. Обратите внимание, что это довольно небольшое количество операций. За пределами конструкций, используемых для обслуживания VLIW, набор команд Elbrus выглядит довольно похожим на RISC.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Операции с памятью также довольно просты. Операции загрузки и сохранения данных могут иметь различные спецификаторы ширины. Адреса могут выражаться как регистр плюс непосредственное смещение или как сумма двух регистров. Вот пример базовой операции загрузки:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ALS0 678dc08c ldd,0 %dr13, 0x0, %dr12</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ldis</span> переводит это (немного более четко) как:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ldd,0 [ %dr13 + 0x0 ], %dr12</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Данная команда расшифровывается как &quot;загрузить двойное слово (64-разряда) из памяти, используя канал 0, с адреса <span style=" font-family:'FreeMono'; color:#6a1009;">dr13 +0</span> и сохранить в регистре <span style=" font-family:'FreeMono'; color:#6a1009;">dr12</span>&quot;. Существуют также операции загрузки/сохранения массива в памяти (<span style=" font-family:'FreeMono'; color:#6a1009;">ldaa</span>/<span style=" font-family:'FreeMono'; color:#6a1009;">staa</span>), которые работают аналогично. Насколько мы можем судить из документации, режим массива не добавляет какой-либо специальной адресации. Это все равно сумма двух регистров или регистр плюс константа; главное преимущество заключается в том, что есть встроенная операция постинкремента.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Управление регистровым окном</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вероятно, самый простой способ понять, как происходит управление регистровым окном, заключается в том, что оно функционирует аналогично локальным переменным в стековом фрейме, выделенном в стековой памяти. В процессорах без регистрового окна (которыми являются почти все семейства процессоров, за некоторыми заметными исключениями, такими как SPARC и Itanium) мы привыкли кодировать перенос регистров между вызовами функций, что означает, что некоторые регистры необходимо сохранять в стековой памяти или переносить в незащищенные регистры перед вызовом функции. То есть, мы обычно используем гарантии, предоставляемые двоичным интерфейсом приложения ABI, чтобы вызываемая функция произвольно не изменяла заданные регистры.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функция (написанная с разумной сложностью) сохранит регистры, которые она не должна изменять, в стековую память, чтобы эти регистры были доступны для изменений и вычислений. А затем, в конце выполнения функции, будет сделано восстановление предыдущих значений регистров из стека. </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Управление окнами регистров направлено на то, чтобы уменьшить некоторые накладные расходы на объединение сохраняемых регистров в группы, сделав функцию сохранения регистров более похожей на сохранение в стековую память. По сути, в Эльбрусе, вместо того, чтобы функция выделяла для себя фрейм стека, функция выделяет для себя окно регистров.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В Elbrus это выполняется в прологе функции с помощью команды <span style=" font-family:'FreeMono'; color:#6a1009;">setwd</span>. После выполнения команды <span style=" font-family:'FreeMono'; color:#6a1009;">setwd</span>, &quot;регистр&quot; r0 на самом деле является ссылкой на первый элемент в регистровом окне. Теперь функция может использовать значения от r0 до r&lt;N&gt; без необходимости сохранять какие-либо регистры из вызывающей функции. Как насчет передачи параметров в регистрах? Как и в архитектурах с параметрами, передаваемыми через стек, нам нужна вызывающая функция и вызываемая функция, которые будут совместно использовать перекрывающуюся область в регистровом файле.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это делается с помощью параметра <span style=" font-family:'FreeMono'; color:#6a1009;">wbs</span> в инструкции вызова подпрограммы (функции). <span style=" font-family:'FreeMono'; color:#6a1009;">wbs</span> указывает начало расположения параметров совместно используемых основным кодом и функцией в текущем окне. После вызова значение <span style=" font-family:'FreeMono'; color:#6a1009;">r0</span> в вызываемой функции теперь относится к началу области совместно используемых параметров. Это проиллюстрировано на рисунке, где вызывающая функция имеет окно размером N и вызывает функцию, которая выделяет окно размером K:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1721825302c4t5r4i9eb.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Elbrus также предлагает скользящий или подвижный базисный регистр (<span style=" font-family:'FreeMono'; color:#6a1009;">b</span>), который может использовать функция в своем собственном функциональном окне. Базисный регистр - это просто некоторое смещение для наложения на существующее окно регистра; он указывает на данные регистров в окне. Для доступа к регистрам через базисный регистр, используется запись в виде массива — например, <span style=" font-family:'FreeMono'; color:#6a1009;">db[0]</span> означает “доступ к первому двойному регистру (64-разрядному) по базисному указателю”. Для установки этого указателя используется команда <span style=" font-family:'FreeMono'; color:#6a1009;">set-bn</span>.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Операнд <span style=" font-family:'FreeMono'; color:#6a1009;">rbs</span> (смещение для установки регистра <span style=" font-family:'FreeMono'; color:#6a1009;">b</span> от основания окна) также задается как quad words. На практике это выглядит так, что <span style=" font-family:'FreeMono'; color:#6a1009;">lcc</span> использует базовый указатель для указания на область параметров, поэтому <span style=" font-family:'FreeMono'; color:#6a1009;">db[0]</span>, <span style=" font-family:'FreeMono'; color:#6a1009;">db[1]</span>, <span style=" font-family:'FreeMono'; color:#6a1009;">db[2]</span> и т.д. являются параметрами 0, 1, 2 и т.д. для функций, которые должны быть вызваны.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поскольку функции возвращают значения в <span style=" font-family:'FreeMono'; color:#6a1009;">dr0</span>, это также означает, что <span style=" font-family:'FreeMono'; color:#6a1009;">db[0]</span> содержит возвращаемое значение с точки зрения вызывающего кода.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Вызовы и ветвления в Эльбрусе</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вызовы и переходы в Elbrus несколько уникальны, они выполняются в два этапа, а не в виде одной команды, как это работает в большинстве архитектур. Elbrus использует команду <span style=" font-family:'FreeMono'; color:#6a1009;">disp</span> для настройки любой команды передачи управления. При этом регистру <span style=" font-family:'FreeMono'; color:#6a1009;">ctptr1</span> присваивается целевой адрес. Команда <span style=" font-family:'FreeMono'; color:#6a1009;">call</span> выполняет передачу управления. Это позволяет конвейеру получать небольшое предварительное предупреждение о вызове, позволяя ему настроить состояние для целевой функции, которое может быть отменено или проигнорировано, если вызов не выполняется. В документации упоминается часть <span style=" font-family:'FreeMono'; color:#6a1009;">ipd</span>, в которой указывается некая “глубина подкачки”, но неясно, что это означает.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Инструкции возврата из подпрограммы выполняются аналогично: сначала выполняется команда </span><span style=" font-family:'FreeMono'; color:#6a1009;">return</span><span style=" color:#000000;">, которая настраивает возврат и команду </span><span style=" font-family:'FreeMono'; color:#6a1009;">ct</span><span style=" color:#000000;"> для выполнения передачи управления. (Этот механизм также используется для ветвлений, его мы обсудим в следующем разделе.) Обратите внимание, что функция, похоже, никогда ничего не делает с адресом </span><span style=" font-family:'FreeMono'; color:#6a1009;">return</span><span style=" color:#000000;">. Это связано с тем, что у Elbrus есть совершенно отдельный стек цепочек вызовов, называемый стеком цепочек процедур (PCS). Архитектурно ссылка на него осуществляется через регистр указателя стека цепочек процедур (PCSP). PCSP недоступен из пользовательского режима; скорее, его значение настраивается ядром аналогично тому, как пользовательская стековая память настраивается для каждого процесса. (Видимо, автор не понял, что это аппаратная защита от возврата по произвольному адресу, когда уязвимому коду невозможно переписать вершину стека - прим. переводчика).</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600; color:#000000;">Стек цепочки процедур (PCS)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">PCSP довольно прост — это 128-разрядный регистр с 64-разрядными частями “lo” и “hi”. Часть “lo” содержит базовый адрес, а часть “hi” содержит индекс текущего кадра. </span><span style=" color:#000000; vertical-align:super;">54</span><span style=" color:#000000;"> На данный момент неясно, для чего на самом деле используется поле “rw”.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) info registers pcsp_lo</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">pcsp_lo 0x1800c2e00002b000 1729596524238909440</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">base 0xc2e00002b000 214267328638976</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">rw 0x3 3</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) info registers pcsp_hi</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">pcsp_hi 0x200000000060 35184372088928</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ind 0x60 96</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">size 0x2000 8192</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Исходный код ядра Linux показывает формат стековых фреймов в виде структуры <span style=" font-family:'FreeMono'; color:#6a1009;">e2k_mem_cr</span>. Каждый кадр имеет размер 32 байта и состоит из четырех сохраненных 64-разрядных значений регистра, частей “lo” и “hi” для <span style=" font-family:'FreeMono'; color:#6a1009;">cr0</span> и <span style=" font-family:'FreeMono'; color:#6a1009;">cr1</span> соответственно. И снова мы остаемся без документации о том, что именно делают регистры <span style=" font-family:'FreeMono'; color:#6a1009;">cr0</span> и <span style=" font-family:'FreeMono'; color:#6a1009;">cr1</span>, но они должны быть задействованы в передаче управления. Код Linux показывает, что <span style=" font-family:'FreeMono'; color:#6a1009;">cr0</span> “hi” содержит обратный адрес, а <span style=" font-family:'FreeMono'; color:#6a1009;">cr1</span> содержит набор полей, относящихся к текущему процедурному регистровому окну.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вот определение <span style=" font-family:'FreeMono'; color:#6a1009;">e2k_mem_crstack</span> (структуры фреймов PCSP) в ядре E2K Linux (файл <span style=" font-family:'FreeMono'; color:#6a1009;">arch/e2k/kernel/e2k_syswork.c</span>):</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">typedef struct e2k_mem_crstack </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  e2k_cr0_lo_t cr0_lo; //pf?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  e2k_cr0_hi_t cr0_hi; //return address</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  e2k_cr1_lo_t cr1_lo; //mess of fields - includes</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">                       // interrupt enable flags</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  e2k_cr1_hi_t cr1_hi; //more fields - includes register</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">                       // window and stuff</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">} e2k_mem_crs_t;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Таким образом, инструкция <span style=" font-family:'FreeMono'; color:#6a1009;">return %ctpr3</span>, по сути, гласит: “переместить текущий кадр с PCS в <span style=" font-family:'FreeMono'; color:#6a1009;">cr0</span> и <span style=" font-family:'FreeMono'; color:#6a1009;">cr1</span> и засунуть обратный адрес в <span style=" font-family:'FreeMono'; color:#6a1009;">ctpr3</span>”.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Ветвление</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Аналогичная конструкция используется для базовых ветвей. Вместо регистров флагов или условий, как в x86 или ARM, процессоры VLIW часто имеют полный набор условных регистров, называемых “предикатными” регистрами. Это позволяет компилятору настроить последовательность, в которой перед переходом может выполняться несколько сравнений, и тогда переход может основываться на нескольких предикатах, или может быть создана последовательность переходов с использованием разных регистров предикатов.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вот общий шаблон проектирования, который можно увидеть при организации ветвлений в Эльбрусе. Следующий код, по сути, реализует <span style=" font-family:'FreeMono'; color:#6a1009;">if (условие) { function(); }</span> в языке C:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">disp %ctpr1, 0x10d48</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">cmpedb,0 %dr0, 0x0, %pred0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">ct %ctpr1 ? %pred0</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сначала команда <span style=" font-family:'FreeMono'; color:#6a1009;">disp</span> указывает конвейеру цель передачи управления - то есть задает адрес функции. Затем в инструкции <span style=" font-family:'FreeMono'; color:#6a1009;">cmpedb</span> регистр <span style=" font-family:'FreeMono'; color:#6a1009;">dr0</span> сравнивается с 0, и результат помещается в предикатный регистр <span style=" font-family:'FreeMono'; color:#6a1009;">%pred0</span> (истина или ложь). Наконец, если <span style=" font-family:'FreeMono'; color:#6a1009;">%pred0</span> имеет значение true, то команда <span style=" font-family:'FreeMono'; color:#6a1009;">ct</span> вызывает передачу управления, в противном случае мы переходим к следующей инструкции.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Выводы</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Процессоры Elbrus довольно производительны и позволяют создавать достойные Linux-машины. Несмотря на то, что процессор Elbrus может быть менее производительным по сравнению с аналогичными серверными процессорами Intel или ARM, учитывая геополитическую ситуацию в России, эти ребята еще долго будут работать на рынке. Архитектура Elbrus VLIW и система управления ргеистровым окном создают дополнительные проблемы для разработчиков эксплойтов. К счастью, инструкции для компонентов Elbrus очень похожи на RISC, несмотря на использование широкого командного слова.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В этой статье мы рассмотрели основы работы с набором инструкций и PCS, основываясь на общедоступной документации. Однако нам предстоит узнать еще многое. Нам понадобится полная документация, чтобы начать разбираться в таких вещах, как виртуальная память, обработка прерываний и исключений, а также как происходит процесс загрузки программы начального старта (ПНС-bios) и самой ОС Linux.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Сноски в тексте</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">45</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Travis Goodspeed and Ryan Speers, “A Tourist’s Phrasebook for Reversing Embedded ARM in the Dialect of the CortexM Series,” PoC</span><span style=" font-family:'monospace'; font-size:12pt;">∥</span><span style=" font-family:'sans-serif'; font-size:12pt;">GTFO 11:6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">46</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Ryan Speers and Travis Goodspeed, “A Tourist’s Phrasebook for Reversing MSP430,” PoC</span><span style=" font-family:'monospace'; font-size:12pt;">∥</span><span style=" font-family:'sans-serif'; font-size:12pt;">GTFO 11:08</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">47</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Chris Hewitt, “A Tourist’s Guide to Altera NIOS,” PoC</span><span style=" font-family:'monospace'; font-size:12pt;">∥</span><span style=" font-family:'sans-serif'; font-size:12pt;">GTFO 21:7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">48</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Ian Cutress, “Russia’s Elbrus 8CB Microarchitecture: 8-core VLIW on TSMC 28nm,” AnandTech, June 1, 2020.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">49</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Anton Shilov, “Russian-Made Elbrus CPUs Fail Trials, ‘A Completely Unacceptable Platform’,” Tom’s Hardware, December 24, 2021.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">50</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Inna Sidorkova, “Цены на военные ноутбуки достигли Эльбруса.” July 9, 2018, RBC.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">51</span><span style=" font-family:'monospace'; font-size:12pt;"> unzip pocorgtfo22.pdf elbrusprog.pdf</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Murad Neumann-zadeh and Sergei Korolev, “Руководство по эффективному программированию на платформе «Эльбрус»”</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">52</span><span style=" font-family:'monospace'; font-size:12pt;"> unzip pocorgtfo22.pdf vptrs.zip</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">53</span><span style=" font-family:'monospace'; font-size:12pt;"> git clone https://git.mentality.rip/OpenE2K/binutils-gdb.git</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p></body></html>