<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16pt; font-weight:600;">A Tourist’s Guide to Эльбрус</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">by evm</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">In the tradition of the many high quality tourist guides that have appeared in this fine publication, let’s take a magical tour around Russia’s modern computer architecture, the Elbrus 2000. </span><span style=" font-family:'sans-serif'; font-size:12pt; vertical-align:super;">45 46 47</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt;">At A Glance</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Common Models</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Elbrus-1S+, Elbrus-4S, Elbrus-85, Elbrus-8SV, Elbrus-16S</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Architecture</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Von Neumann</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Very Long Instruction Word</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Register Windowing (32-bit Base Registers)</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Registers</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">g0-g31: Global Registers</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">r0-r17: General Purpose (Windowed)</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">bO-b7: Overlay Register within Window</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Pred0-Pred31: Boolean Predicate Registers</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Address Space</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">64bit Virtual Addressing</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Unknown Physical Memory Map</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Background &amp; History</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Elbrus is a Russian CPU architecture that has been around in some form for over 40 years. It started at Lebedev Institute of Precision Mechanics and Computer Engineering. It was the first superscalar, out-of-order execution processor developed in the Soviet Union (when the Elbrus 1 debuted in 1979). The architecture was extended to be a very long instruction word (VLIW) architecture with Elbrus 3 in 1990. Once fully integrated as a microprocessor architecture in 2001 (previous versions had used many discrete chips), the architecture became known as Elbrus 2000, or E2K for short. Elbrus is designed in Russia but currently manufactured by TSMC in Taiwan because of a lack of Russian production facilities capable of producing chips at advanced technology nodes. </span><span style=" font-family:'sans-serif'; font-size:12pt; vertical-align:super;">48</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">In the early ’90s, the Lebedev Institute spun off a joint stock company called the Moscow Center of SPARC Technologies (now shortened to just MCST). MCST currently produces new Elbrus chips and Elbrus-based PCs, laptops, and servers. Elbrus-8S and 8SV are the current top-of-the-line processor models (eight core versions for servers and desktops), and a lower-cost 1S+ (single core) is available as well. Note the transliteration from Cyrillic where the model names appear as Эльбрус-8С, Эльбрус-8СB, and Эльбрус-1C+, respectively. Anecdotally, the 8S CPUs are about three times slower than a comparable Intel CPU, </span><span style=" font-family:'sans-serif'; font-size:12pt; vertical-align:super;">49</span><span style=" font-family:'sans-serif'; font-size:12pt;"> but the draw of Elbrus is that it’s a fully domestically designed Russian processor. The Russian military has reportedly ordered thousands of ruggedized laptops based on the Elbrus-1S+, </span><span style=" font-family:'sans-serif'; font-size:12pt; vertical-align:super;">50</span><span style=" font-family:'sans-serif'; font-size:12pt;"> although there is no indication that the order was ever delivered.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">There is currently very little public documentation on Elbrus because MCST controls most documentation under nondisclosure agreements. This means we don’t have full processor documentation like we normally would for a commercial CPU.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">45</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Travis Goodspeed and Ryan Speers, “A Tourist’s Phrasebook for Reversing Embedded ARM in the Dialect of the CortexM Series,” PoC</span><span style=" font-family:'monospace'; font-size:12pt;">∥</span><span style=" font-family:'sans-serif'; font-size:12pt;">GTFO 11:6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">46</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Ryan Speers and Travis Goodspeed, “A Tourist’s Phrasebook for Reversing MSP430,” PoC</span><span style=" font-family:'monospace'; font-size:12pt;">∥</span><span style=" font-family:'sans-serif'; font-size:12pt;">GTFO 11:08</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">47</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Chris Hewitt, “A Tourist’s Guide to Altera NIOS,” PoC</span><span style=" font-family:'monospace'; font-size:12pt;">∥</span><span style=" font-family:'sans-serif'; font-size:12pt;">GTFO 21:7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">48</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Ian Cutress, “Russia’s Elbrus 8CB Microarchitecture: 8-core VLIW on TSMC 28nm,” AnandTech, June 1, 2020.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">49</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Anton Shilov, “Russian-Made Elbrus CPUs Fail Trials, ‘A Completely Unacceptable Platform’,” Tom’s Hardware, December 24, 2021.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">50</span><span style=" font-family:'monospace'; font-size:12pt;"> </span><span style=" font-family:'sans-serif'; font-size:12pt;">Inna Sidorkova, “Цены на военные ноутбуки достигли Эльбруса.” July 9, 2018, RBC.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<hr />
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">We used three sources of information for this article: (1) a Russian guide to Elbrus programming and optimization published by MCST,51 (2) source code published by the OpenE2K group (a hobbyist group seemingly unrelated to MCST), and (3) leaked Linux kernel source code.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">MCST is currently on the US sanctions list but thanks to the Reverend and friends we had access to an Elbrus-1S+ machine and used it to play around with some code examples. Our Elbrus was running a version of Linux made by MCST, but other Russian Linux distros are also available for Elbrus (e.g., Astra Linux). The Elbrus machine has a compiler called lcc, which is the MCST compiler based on gcc. It produces standard Linux ELF binary files. The options for disassembly at the moment are limited to ldis, which is part of lcc, and objdump, which is part of the binutils package put out by the OpenE2K group. ldis produces cleaner output, including resolution of symbol names, while objdump has a debug flag in the build that will prefix the output with the decoded instructions in hex. Anecdotally, ldis seems to miss some things (e.g., not disassemble all functions), although that could be due to operator error. </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">In order to explore the Elbrus instruction set we updated rix’s Smashing C++ VPTRs from Phrack 56:8. That is a whole story for a another day, but you will find my code examples and the corresponding Elbrus disassembly attached to this PDF. </span><span style=" font-family:'sans-serif'; font-size:12pt; vertical-align:super;">52</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:14pt; font-weight:600;">Basics of Instruction Set Decoding</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">The first thing we needed to figure out was how the instruction format works since the official documentation left this topic out entirely. Fortunately we found that the OpenE2K binutils release has a preprocessor flag </span><span style=" font-family:'monospace'; font-size:12pt;">ENABLE_E2K_ENCODINGS</span><span style=" font-family:'sans-serif'; font-size:12pt;">, which causes objdump to print out the instruction bytes and their groupings.53 A version of objdump with this flag was what we used to produce the disassembly for most of this article.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">In Elbrus documentation, the VLIW is called a “wide command” (широкой командой). A wide command contains multiple instructions, each of which is targeted at individual execution units in the CPU pipeline. The documentation variously uses the terms “commands” (команд), “instructions” (инструкций), and “operations” (операций) for the component instructions within the instruction word.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">The OpenE2K objdump code refers to the way these component instructions are encoded as “syllables.” A nice feature of Elbrus is that the instruction encoding is fairly simple when compared against modern DSP architectures we’ve experienced. Instruction counting is an exploitation task that can be pretty complicated on some architectures, but not Elbrus. It’s fairly simple to determine the length of an instruction from the initial “HS” syllable (shown on page 49).</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">The HS syllable determines the presence of the other instruction syllables, which appear in a particular order. The order is: SS; ALU; CS0; ALES half syllables 2 and 5; CS1; ALES half syllables 0, 1, 3, and 4; AAS half syllables; a gap check; CDS; PLS; and finally LTS (literals). Literal syllables (i.e., immediate values) occur at the end of the syllables. The OpenE2K objdump code looks for all of the syllable presence flags above, reads them in order (minding the possible gap), and then compares the number of syllables read against the size field in HS. Any extra syllables are read as literals. For syllables that contain “half syllables” (i.e., 16-bit values), the order of the syllables is flipped as they appear sequentially in memory.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Byte order | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">---------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Half syllable order | 1 | 0 | 3 | 2 |</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">This makes more sense if you think about the bytes being read in as 4-byte little-endian values.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Word order | 0 | 1 |</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">---------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Byte order | 3 | 2 | 1 | 0 | 7 | 6 | 5 | 4 |</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">---------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Half syllable order | 0 | 1 | 2 | 3 |</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Register Set</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Elbrus’s basic registers consist of 18 general-purpose registers (</span><span style=" font-family:'monospace'; font-size:12pt;">r0</span><span style=" font-family:'sans-serif'; font-size:12pt;">–</span><span style=" font-family:'monospace'; font-size:12pt;">r17</span><span style=" font-family:'sans-serif'; font-size:12pt;">), 32 global registers (</span><span style=" font-family:'monospace'; font-size:12pt;">g0</span><span style=" font-family:'sans-serif'; font-size:12pt;">–</span><span style=" font-family:'monospace'; font-size:12pt;">g31</span><span style=" font-family:'sans-serif'; font-size:12pt;">), and a sliding set of windowed registers (</span><span style=" font-family:'monospace'; font-size:12pt;">b0</span><span style=" font-family:'sans-serif'; font-size:12pt;">–</span><span style=" font-family:'monospace'; font-size:12pt;">b7</span><span style=" font-family:'sans-serif'; font-size:12pt;">). More will be explained about the register windowing in the next section. Registers are prefixed with an access width, similar to x86.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">For example, </span><span style=" font-family:'monospace'; font-size:12pt;">sr0 </span><span style=" font-family:'sans-serif'; font-size:12pt;">is single (32-bit) </span><span style=" font-family:'monospace'; font-size:12pt;">r0</span><span style=" font-family:'sans-serif'; font-size:12pt;">, and </span><span style=" font-family:'monospace'; font-size:12pt;">dr0 </span><span style=" font-family:'sans-serif'; font-size:12pt;">is double (64-bit) </span><span style=" font-family:'monospace'; font-size:12pt;">r0</span><span style=" font-family:'sans-serif'; font-size:12pt;">, which is also the default. When the registers are used with floating point values,</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">51</span><span style=" font-family:'monospace'; font-size:12pt;"> unzip pocorgtfo22.pdf elbrusprog.pdf</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Murad Neumann-zadeh and Sergei Korolev, “Руководство по эффективному программированию на платформе «Эльбрус»”</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">52</span><span style=" font-family:'monospace'; font-size:12pt;"> unzip pocorgtfo22.pdf vptrs.zip</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt; vertical-align:super;">53</span><span style=" font-family:'monospace'; font-size:12pt;"> git clone https://git.mentality.rip/OpenE2K/binutils-gdb.git</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<hr />
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">there is an </span><span style=" font-family:'monospace'; font-size:12pt;">xr0</span><span style=" font-family:'sans-serif'; font-size:12pt;">, which is an 80-bit version, presumably using the long double format from x86. According to the documentation, two double registers can be accessed as a quad register – for example </span><span style=" font-family:'monospace'; font-size:12pt;">qr[i] </span><span style=" font-family:'sans-serif'; font-size:12pt;">where </span><span style=" font-family:'monospace'; font-size:12pt;">[i] </span><span style=" font-family:'sans-serif'; font-size:12pt;">is even – but </span><span style=" font-family:'monospace'; font-size:12pt;">gdb </span><span style=" font-family:'sans-serif'; font-size:12pt;">on our box doesn’t seem to be aware of this notation.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">CAUTION: Elbrus has a word size of 32-bits for both registers and memory accesses, so the notion of single/double/quad on Elbrus is double what you might be used to on 64-bit x86, where the length of a word dates back to its early ancestors.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1721821241ic3fajs9gd.png" /></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Encoding of the initial HS syllable, which determines the presence of other syllables,</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">in an Elbrus-wide instruction word. It is unclear what the ALES, CDS, and PLS syllables</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">are used for as we did not generate any of those instructions in the example code.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:14pt; font-weight:600;">Basic Arithmetic, and Memory Operations in Elbrus</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Here we show the various ALU register operations:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1721821310jny2i9lbyi.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">A basic ALU instruction looks like this:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">ALS0 1181d48d addd,0 %dr1, _f16s,_lts0hi 0xfff0, %dr13</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">This translates to “add double precision, using channel 0, the 64-bit register %dr1 to the signed 16-bit value 0xfff0, and place the result in dr13.” There are six ALU channels, so you can do up to six ALU instructions in one wide instruction. There is no simple register “move,” so the compiler tends to use a zero-add as a “move” instruction. The full list of</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<hr />
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">ALU register operations is shown in the table above. Notice that this is a fairly small number of operations. Outside of the VLIW construct, the Elbrus instruction set feels pretty RISC-like.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Memory operations are also pretty simple. Operations are load and store with a variety of width specifiers. Addresses can be a register plus an immediate offset, or the sum of two registers. Here is an example of a basic load operation:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">ALS0 678dc08c ldd,0 %dr13, 0x0, %dr12</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">ldis renders this (a bit more clearly) as:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">ldd,0 [ %dr13 + 0x0 ], %dr12</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">This translates as “load double word (64-bits) from memory, using channel 0, from the address </span><span style=" font-family:'monospace'; font-size:12pt;">dr13 </span><span style=" font-family:'sans-serif'; font-size:12pt;">+</span><span style=" font-family:'monospace'; font-size:12pt;">0</span><span style=" font-family:'sans-serif'; font-size:12pt;">, and store in register </span><span style=" font-family:'monospace'; font-size:12pt;">dr12</span><span style=" font-family:'sans-serif'; font-size:12pt;">.” There are also array memory load/store operations (</span><span style=" font-family:'monospace'; font-size:12pt;">ldaa</span><span style=" font-family:'sans-serif'; font-size:12pt;">/</span><span style=" font-family:'monospace'; font-size:12pt;">staa</span><span style=" font-family:'sans-serif'; font-size:12pt;">) that work similarly. As far as we can tell from the documentation, the array mode doesn’t add any special addressing. It’s still the sum of two registers or a register plus a constant; the main advantage is that there’s a built-in post-increment operation.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Register Windowing</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Probably the simplest way to understand register windowing is that it functions similarly to local variables within a stack frame in a memory stack. In processors without windowing (which is nearly all processor families with some notable exceptions, like SPARC and Itanium), we are used to code transferring registers around between function calls, meaning that some registers need to be saved on the memory stack or transferred to nonclobbered registers (those guaranteed by the application-binary inter-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">face to not get modified by the called function) prior</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">to a function call.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">A function of reasonable complexity will save</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">registers it’s not supposed to clobber to the memory</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">stack so that they are available for calculations and</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">then restore the previous values from the stack at</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">the end of the function. Register windowing aims to</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">reduce some of this register bucket-brigading over-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">head by making the register set function more like</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">a memory stack. In the same way that a function</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">allocates a stack frame for itself, a function allocates</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">a window of registers.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">On Elbrus, this is accomplished in a function</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">prologue with the </span><span style=" font-family:'monospace'; font-size:12pt;">setwd </span><span style=" font-family:'sans-serif'; font-size:12pt;">instruction. After </span><span style=" font-family:'monospace'; font-size:12pt;">setwd</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">executes, the “register” </span><span style=" font-family:'monospace'; font-size:12pt;">r0 </span><span style=" font-family:'sans-serif'; font-size:12pt;">is really a reference to the</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">first item in the register window. Now the function</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">can use </span><span style=" font-family:'monospace'; font-size:12pt;">r0 </span><span style=" font-family:'sans-serif'; font-size:12pt;">to </span><span style=" font-family:'monospace'; font-size:12pt;">r&lt;N&gt; </span><span style=" font-family:'sans-serif'; font-size:12pt;">without having to save any reg-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">isters from the calling function. How about parame-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">ter passing in registers? Just like architectures with</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">stack-passed parameters, we need a calling function</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">and the called function to share an overlapping area.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">This is done with a </span><span style=" font-family:'monospace'; font-size:12pt;">wbs </span><span style=" font-family:'sans-serif'; font-size:12pt;">parameter in the </span><span style=" font-family:'monospace'; font-size:12pt;">call </span><span style=" font-family:'sans-serif'; font-size:12pt;">in-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">struction. </span><span style=" font-family:'monospace'; font-size:12pt;">wbs </span><span style=" font-family:'sans-serif'; font-size:12pt;">indicates the start of shared function</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">parameters within the current window. After a call,</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'monospace'; font-size:12pt;">r0 </span><span style=" font-family:'sans-serif'; font-size:12pt;">in the called function now refers to the base of</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">the shared parameter area. This is illustrated here,</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">where a caller function has a window of size N and</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">calls a function that allocates a window of size K:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1721822367hsilnrzb2x.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Elbrus also offers a sliding or mobile base reg-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">ister (</span><span style=" font-family:'monospace'; font-size:12pt;">b</span><span style=" font-family:'sans-serif'; font-size:12pt;">), which a function can use within its own</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">function window. The base register is just an over-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">lay on the existing register window; it points to a</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">given register within the window. Accesses to regis-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">ters with the base register use an array notation—for</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">example, </span><span style=" font-family:'monospace'; font-size:12pt;">db[0] </span><span style=" font-family:'sans-serif'; font-size:12pt;">means “access first double register</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">(64-bits) at the base pointer.” The instruction </span><span style=" font-family:'monospace'; font-size:12pt;">set-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'monospace'; font-size:12pt;">bn </span><span style=" font-family:'sans-serif'; font-size:12pt;">is used to set this pointer.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">The operand </span><span style=" font-family:'monospace'; font-size:12pt;">rbs </span><span style=" font-family:'sans-serif'; font-size:12pt;">(the offset to set b from the</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">base of the window) is also specified in quadwords.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">In practice, it looks like lcc uses the base pointer</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">to point to the parameter area, so </span><span style=" font-family:'monospace'; font-size:12pt;">db[0]</span><span style=" font-family:'sans-serif'; font-size:12pt;">, </span><span style=" font-family:'monospace'; font-size:12pt;">db[1]</span><span style=" font-family:'sans-serif'; font-size:12pt;">,</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'monospace'; font-size:12pt;">db[2]</span><span style=" font-family:'sans-serif'; font-size:12pt;">, etc. are parameter 0, parameter 1, parame-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">ter 2, etc. for functions that are about to be called.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Since functions return values in </span><span style=" font-family:'monospace'; font-size:12pt;">dr0</span><span style=" font-family:'sans-serif'; font-size:12pt;">, this also</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">means that </span><span style=" font-family:'monospace'; font-size:12pt;">db[0] </span><span style=" font-family:'sans-serif'; font-size:12pt;">holds the return value from the</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">calling function’s point of view.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Calls and Branches in Elbrus</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:12pt;">Calls and branches are somewhat unique in Elbrus,</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">they occur in two phases instead of in a single in-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">struction the way it works on most architectures.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">Elbrus uses the </span><span style=" font-family:'monospace'; font-size:12pt;">disp </span><span style=" font-family:'sans-serif'; font-size:12pt;">instruction to set up any kind</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">of control transfer instruction. This sets the </span><span style=" font-family:'monospace'; font-size:12pt;">ctptr1</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">register to the target address. The </span><span style=" font-family:'monospace'; font-size:12pt;">call </span><span style=" font-family:'sans-serif'; font-size:12pt;">instruc-</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">tion executes the control transfer. This allows the</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">pipeline to get a little bit of advance warning for</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">the call, allowing it to set up state for the target</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">function, which can be undone or ignored if the call</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">doesn’t execute. The documentation refers to the</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'monospace'; font-size:12pt;">ipd </span><span style=" font-family:'sans-serif'; font-size:12pt;">portion as specifying the “swap depth,” but it is</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'sans-serif'; font-size:12pt;">unclear what this means.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p>
<hr />
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'sans-serif'; font-size:12pt;"><br /></p></body></html>