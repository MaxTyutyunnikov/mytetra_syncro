<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Библиотека CMSIS включает в себя следующие компоненты:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">CMSIS-CORE:</span> API для ядра Cortex-M и периферии. Стандартизированный интерфейс доступен для Cortex-M0, Cortex-M3, Cortex-M4, SC000, и SC300. Включает дополнительные SIMD-инструкции для Cortex-M4.</li>
<li style=" font-family:'Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">CMSIS-Driver:</span> определяет основные драйверы интерфейсов периферии. Содержит API для операционных систем реального времени (ОСРВ, или англ. Real-Time operating systems — RTOS) и соединяет микроконтроллер с промежуточным ПО (стек коммуникации, файловая система или графический интерфейс).</li>
<li style=" font-family:'Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">CMSIS-DSP:</span> коллекция из более чем 60 функций для различных типов данных (относятся к обработке сигналов): с фиксированной точкой и с плавающей точкой (одинарной точности, 32 бита). Библиотека доступна для Cortex-M0, Cortex-M3, и Cortex-M4. Реализация библиотеки для Cortex-M4 оптимизирована c использованием SIMD-инструкций.</li>
<li style=" font-family:'Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">CMSIS-RTOS API:</span> общий API для систем реального времени. Используя функции данного интерфейса вы можете отойти от конкретной реализации операционной системы.</li>
<li style=" font-family:'Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">CMSIS-DAP</span> (Debug Access Port): стандартизованное программное обеспечение для отладчика (Debug Unit).</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Рассмотрим только </span><span style=" font-family:'Sans'; font-size:12pt; font-weight:600;">CMSIS-CORE</span><span style=" font-family:'Sans'; font-size:12pt;">.</span></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1650753939pkwrslt7o4.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Библиотека состоит из стандартной (предоставляется ARM) и вендор-зависимой (предоставляется в нашем случае ST) частей.</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="header-n17"></a><span style=" font-family:'Sans'; font-size:12pt; font-weight:600;">С</span><span style=" font-family:'Sans'; font-size:12pt; font-weight:600;">тандартная часть</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Заголовочный файл </span><span style=" font-family:'monospace'; font-size:12pt;">core_&lt;processor_unit&gt;.h</span><span style=" font-family:'Sans'; font-size:12pt;"> предоставляет интерфейс к ядру. Для </span><span style=" font-family:'Sans'; font-size:12pt; font-weight:600;">stm32f103c8</span><span style=" font-family:'Sans'; font-size:12pt;"> это </span><span style=" font-family:'monospace'; font-size:12pt;">core_cm3.h</span><span style=" font-family:'Sans'; font-size:12pt;">, так как он работает на Cortex-M3. Для Cortex-M0+ это будет файл </span><span style=" font-family:'monospace'; font-size:12pt;">core_cm0plus.h</span><span style=" font-family:'Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Под интерфейсом понимается удобный доступ к его регистрам. Например, в состав ядра входят еще две сущности: системный таймер и контроллер прерываний NVIC. Поэтому в этом файле содержатся вспомогательные функции для их быстрой настройки. Включить прерывание можно вызовом функции:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">static __INLINE void NVIC_EnableIRQ(IRQn_Type IRQn) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    NVIC-&gt;ISER[((uint32_t)(IRQn) &gt;&gt; 5)] = (1 &lt;&lt; ((uint32_t)(IRQn) &amp; 0x1F));</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    /* enable interrupt */</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Вам не нужно работать с регистрами ядра напрямую.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Другие файлы нам не столь интересны, но справедливости ради упомянем их. Например файл </span><span style=" font-family:'monospace'; font-size:12pt;">core_cmInstr.h</span><span style=" font-family:'Sans'; font-size:12pt;"> содержит обертки инструкций, а </span><span style=" font-family:'monospace'; font-size:12pt;">core_cmFunc.h</span><span style=" font-family:'Sans'; font-size:12pt;"> — обертки некоторых важных системных функций.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">// Возвращает значение стека (PSP)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">__attribute__( ( always_inline ) ) static __INLINE uint32_t __get_PSP(void) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  register uint32_t result;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">​</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  __ASM volatile (&quot;MRS %0, psp\n&quot;  : &quot;=r&quot; (result) );</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  return(result);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Если вы не разрабатываете приложение на самом низком уровне, то заглядывать в эти файлы незачем. Тем не менее, подробное описание работы ядра можно найти в документе ARM — </span><a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0552a/DUI0552A_cortex_m3_dgug.pdf"><span style=" font-family:'Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">Cortex-M3 Devices Generic User Guide</span></a><span style=" font-family:'Sans'; font-size:12pt;">, и мы им даже воспользуемся при настройке системного таймера.</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="header-n25"></a><span style=" font-family:'Sans'; font-size:12pt; font-weight:600;">В</span><span style=" font-family:'Sans'; font-size:12pt; font-weight:600;">ендор-зависимая часть</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Вторая часть библиотеки пишется непосредственным производителем микроконтроллера. Это происходит потому, что микроконтроллер — это не только его ядро, а еще и периферия. Реализация периферии не стандартизована, и каждый производитель делает ее так, как считает нужным. Адреса и даже поведение внутренних модулей (ADC, SPI, USART и т.д.) могут отличаться.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">В ассемблеровском файле </span><span style=" font-family:'monospace'; font-size:12pt;">startup_&lt;device&gt;.s</span><span style=" font-family:'Sans'; font-size:12pt;"> (в нашем случае это </span><span style=" font-family:'monospace'; font-size:12pt;">startup_stm32f10x_md.s</span><span style=" font-family:'Sans'; font-size:12pt;">) реализуется функция обработчика сброса </span><span style=" font-family:'monospace'; font-size:12pt;">Reset_Handler</span><span style=" font-family:'Sans'; font-size:12pt;">. Он задает поведение МК при запуске, т.е. выполняет некоторые задачи до входа в функцию </span><span style=" font-family:'monospace'; font-size:12pt;">main()</span><span style=" font-family:'Sans'; font-size:12pt;">, в частности, вызывает функцию </span><span style=" font-family:'monospace'; font-size:12pt;">SystemInit()</span><span style=" font-family:'Sans'; font-size:12pt;"> из файла </span><span style=" font-family:'monospace'; font-size:12pt;">system_&lt;device&gt;.c</span><span style=" font-family:'Sans'; font-size:12pt;"> (</span><span style=" font-family:'monospace'; font-size:12pt;">system_stm32f10x.c</span><span style=" font-family:'Sans'; font-size:12pt;">). Также в нем задается таблица векторов прерываний (англ. interrupt vector table) с их названиями:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">g_pfnVectors:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   _estack</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   Reset_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   NMI_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   HardFault_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   MemManage_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   BusFault_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   UsageFault_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;"># ............................</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   SVC_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   DebugMon_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   0</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   PendSV_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   SysTick_Handler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    .word   WWDG_IRQHandler</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;"># ............................</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Заголовочный файл </span><span style=" font-family:'monospace'; font-size:12pt;">system_&lt;device&gt;.h</span><span style=" font-family:'Sans'; font-size:12pt;"> (</span><span style=" font-family:'monospace'; font-size:12pt;">system_stm32f10x.h</span><span style=" font-family:'Sans'; font-size:12pt;">) предоставляет интерфейс двум функциям и глобальной переменной и отвечает за систему тактирования.</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Переменная <span style=" font-family:'monospace';">SystemCoreClock</span> хранит в себе текущее значение тактовой частоты.</li></ul>
<h4 align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt; font-weight:600;">Обратите внимание</span></h4>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Меняя это число, вы не меняете тактовую частоту! Переменную </span><span style=" font-family:'monospace'; font-size:12pt;">SystemCoreClock</span><span style=" font-family:'Sans'; font-size:12pt;"> стоит использовать только как индикатор. Более того, никто не гарантирует, что число, записанное в этой переменной, будет отображать реальную частоту: во-первых, оно может не обновиться после изменения регистров; во-вторых, оно никак не учитывает погрешность хода генератора; и в-третьих, стандартная частота (определенная как макрос </span><span style=" font-family:'monospace'; font-size:12pt;">HSE_VALUE</span><span style=" font-family:'Sans'; font-size:12pt;"> в библиотеке) внешнего кварцевого генератора — 8 МГц, но никто не мешает разработчику поставить, скажем, кварц на 12 МГц.</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">SystemCoreClockUpdate()</span> проходится по всем регистрам, связанным с системой тактирования, вычисляет текущую тактовую скорость и записывает ее в <span style=" font-family:'monospace';">SystemCoreClock</span>. Данную функцию нужно вызывать каждый раз, когда регистры, отвечающие за тактирование ядра, меняются.</li>
<li style=" font-family:'Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функция <span style=" font-family:'monospace';">SystemInit()</span> сбрасывает тактирование всей периферии и отключает все прерывания (в целях отладки), затем настраивает систему тактирования и подгружает таблицу векторов прерываний.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">И последний файл, самый важный для программиста, это драйвер микроконтроллера </span><span style=" font-family:'monospace'; font-size:12pt;">&lt;device&gt;.h</span><span style=" font-family:'Sans'; font-size:12pt;"> (</span><span style=" font-family:'monospace'; font-size:12pt;">stm32f10x.h</span><span style=" font-family:'Sans'; font-size:12pt;">). Вся карта памяти микроконтроллера (о ней еще поговорим) записана там в виде макросов. Например, адрес начала регистров периферии, флеш и оперативной памяти:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define FLASH_BASE            ((uint32_t)0x08000000)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define SRAM_BASE             ((uint32_t)0x20000000)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define PERIPH_BASE           ((uint32_t)0x40000000)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Регистры модулей, таких как порты ввода-вывода, обернуты в структуры.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef struct</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  __IO uint32_t CRL;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  __IO uint32_t CRH;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  __IO uint32_t IDR;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  __IO uint32_t ODR;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  __IO uint32_t BSRR;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  __IO uint32_t BRR;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">  __IO uint32_t LCKR;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">} GPIO_TypeDef;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Вместо того, чтобы обращаться к ячейке по нужному адресу, это можно сделать через структуру.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define APB2PERIPH_BASE       (PERIPH_BASE + 0x10000)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">// ...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define GPIOA_BASE            (APB2PERIPH_BASE + 0x0800)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">// ...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define GPIOA                 ((GPIO_TypeDef *) GPIOA_BASE)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Так как элементы в структуре расположены линейно, друг за другом, а длина регистра фиксирована (</span><span style=" font-family:'monospace'; font-size:12pt;">uint32_t</span><span style=" font-family:'Sans'; font-size:12pt;">, 4 байта), то регистр </span><span style=" font-family:'monospace'; font-size:12pt;">CRL</span><span style=" font-family:'Sans'; font-size:12pt;"> хранится по адресу </span><span style=" font-family:'monospace'; font-size:12pt;">GPIOA_BASE</span><span style=" font-family:'Sans'; font-size:12pt;">, а следующий за ним </span><span style=" font-family:'monospace'; font-size:12pt;">CRH</span><span style=" font-family:'Sans'; font-size:12pt;"> через четыре байта, по адресу </span><span style=" font-family:'monospace'; font-size:12pt;">GPIOA_BASE + 4</span><span style=" font-family:'Sans'; font-size:12pt;">. Ниже приведен пример настройки одной из ножек порта на выход. Вам этот код пока что ничего не скажет, но суть сейчас в другом — вам нужно увидеть пример использования библиотеки.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">RCC-&gt;APB2ENR |= RCC_APB2ENR_IOPAEN; // Включение тактирования порта A</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">​</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">GPIOA-&gt;CRL &amp;= ~GPIO_CRL_MODE3_0; // set as</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">GPIOA-&gt;CRL |= GPIO_CRL_MODE3_1;  // output with 2 MHz speed</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">GPIOA-&gt;CRL &amp;= ~GPIO_CRL_CNF3;    // push-pull output</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">В самом конце файла есть полезные макросы для записи, сброса, чтения битов и целых регистров.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define SET_BIT(REG, BIT)     ((REG) |= (BIT))</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define CLEAR_BIT(REG, BIT)   ((REG) &amp;= ~(BIT))</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define READ_BIT(REG, BIT)    ((REG) &amp; (BIT))</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define CLEAR_REG(REG)        ((REG) = (0x0))</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define WRITE_REG(REG, VAL)   ((REG) = (VAL))</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define READ_REG(REG)         ((REG))</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define MODIFY_REG(REG, CLEARMASK, SETMASK)  WRITE_REG((REG), (((READ_REG(REG)) &amp; (~(CLEARMASK))) | (SETMASK)))</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Мы рассмотрели, как эти операции работают, в разделе «</span><a href="http://themagicsmoke.ru/courses/stm32/under_the_scope.html"><span style=" font-family:'Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">Микроконтроллер под микроскопом</span></a><span style=" font-family:'Sans'; font-size:12pt;">». Т.е. код выше можно переписать так (и он будет более читаем):</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">SET_BIT(RCC-&gt;APB2ENR, RCC_APB2ENR_IOPAEN);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">​</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">CLEAR_BIT(GPIOA-&gt;CRL, GPIO_CRL_MODE3_1);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">// ...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Для всех стандартных типов (определенных в </span><span style=" font-family:'monospace'; font-size:12pt;">&lt;stdint.h&gt;</span><span style=" font-family:'Sans'; font-size:12pt;">) вводятся сокращенные синонимы, например:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef uint32_t u32;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef uint16_t u16;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef uint8_t  u8;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">​</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef const uint32_t uc32;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef const uint16_t uc16;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef const uint8_t  uc8;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">​</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef __IO uint32_t vu32;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef __IO uint16_t vu16;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef __IO uint8_t  vu8;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Слово </span><span style=" font-family:'monospace'; font-size:12pt;">__IO</span><span style=" font-family:'Sans'; font-size:12pt;"> не входит в стандарт языка, а переопределено в </span><span style=" font-family:'monospace'; font-size:12pt;">core_cm3.h</span><span style=" font-family:'Sans'; font-size:12pt;">:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#define     __IO    volatile</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Последнее, о чём нужно упомянуть, это перечисление </span><span style=" font-family:'monospace'; font-size:12pt;">IRQn_Type</span><span style=" font-family:'Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">typedef enum IRQn</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">{ // Cortex-M3 Processor Exceptions Numbers</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    NonMaskableInt_IRQn         = -14,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    MemoryManagement_IRQn       = -12,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    BusFault_IRQn               = -11,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    UsageFault_IRQn             = -10,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    SVCall_IRQn                 = -5,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    DebugMonitor_IRQn           = -4,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    PendSV_IRQn                 = -2,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    SysTick_IRQn                = -1,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    // ....</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#ifdef STM32F10X_MD</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    ADC1_2_IRQn                 = 18,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    USB_HP_CAN1_TX_IRQn         = 19,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    USB_LP_CAN1_RX0_IRQn        = 20,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    CAN1_RX1_IRQn               = 21,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    CAN1_SCE_IRQn               = 22,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    EXTI9_5_IRQn                = 23,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    TIM1_BRK_IRQn               = 24,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    TIM1_UP_IRQn                = 25,</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">    // ...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">#endif /* STM32F10X_MD */</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:12pt;">} IRQn_Type;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:12pt;">Оно устанавливает номер исключительной ситуации в соответствие с его названием. Когда вы вызываете функции </span><span style=" font-family:'monospace'; font-size:12pt;">NVIC_Enable()</span><span style=" font-family:'Sans'; font-size:12pt;"> или </span><span style=" font-family:'monospace'; font-size:12pt;">NVIC_Disable()</span><span style=" font-family:'Sans'; font-size:12pt;">, в качестве параметра нужно использовать одно из имен в этом перечислении.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans'; font-size:12pt;"><br /></p></body></html>