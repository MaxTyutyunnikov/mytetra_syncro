<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Добрый день.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">В прошлой статье мы достаточно бегло ознакомились с минимальным набором возможностей BLE стека и создали свой первый проект для соединения двух удаленных устройств. Теперь пришло время обратить внимание на аппаратную часть nRF51822, а именно на 32-битный микроконтроллер на базе архитектуры ARM с ядром Cortex M0 (256kB/128kB flash + 32kB/16kB RAM). </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">В данной статье хотелось бы уделить время наверное одной из основных особенностей устройств Bluetooth Low Energy — энергосбережению, а также рассмотреть наиболее часто используемую периферию, такую как АЦП, таймеры и интересный, как мне кажется блок PPI. Остальные часто используемые периферийные блоки такие, как SPI, I2C, UART рассмотрим в следующих статьях.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans'; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Итак, начнем.</span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Режимы энергосбережения</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как уже говорилось выше, одной из ключевых особенностей BLE чипов является их низкое энергопотребление, что собственно и определяет их использование в различных SMART-устройствах. Рассмотрим, что же предлагает один из лидеров сегмента BLE — Nordic Semiconductor со своими nRF51822.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Согласно даташиту, nRF51822 имеет два основных режима работы, один из которых стационарный с возможностью перехода подрежимы энергосбережения, и один для достижения максимльной экономии энергии.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">System ON mode</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">System ON — основной режим, в котором контроллер полностью функционален и выполняет все заявленные функции. Контроллер входит в спящий режим посредством инструкций WFI и WFE, разница между которыми в том, что в первом случае пробуждение происходит по прерыванию разрешенному в NVIC, а во втором — от любого события, как разрешенного в NVIC, так и не разрешенного. System ON примечателен тем, что в спящем режиме может находится в двух состояниях: Low power и Constant Latency. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; font-style:italic; color:#0d3f66;">Low power</span><span style=" font-family:'Sans'; font-size:10pt;"> — режим пониженного энергопотребления, который достигается путем оптимизации системы управления питанием. В данном случае отключается часть регуляторов (подробнее можно посмотреть в product specification) и кварцевый резонатор, что приводит к увеличению временного промежутка, необходимого для пробуждения ядра, а также задержки ответа на запрос PPI модуля (подробнее о PPI модуле смотрите ниже).К тому же этот промежуток не всегда постоянен и может меняться в зависимости от периферии, вызвавшей прерывание. Для входа в Low Power необходимо активировать задачу в регистре </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">LOWPWR</span><span style=" font-family:'Sans'; font-size:10pt;">. В данный режим является стандартным и именно в нем находится контроллер после Reset.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; font-style:italic; color:#0d3f66;">Constant Latency</span><span style=" font-family:'Sans'; font-size:10pt;"> — режим, в целом схожий с предыдущим, отличие лишь в том, что задержки ядра и ответа на запрос PPI модуля являются постоянными и минимальными. Однако это влечет за собой более высокое энергопотребление, так как кварцевый резонатор остается включенным, хоть и находится в режиме минимального потребления.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для входа в Constant Latency необходимо активировать задачу в регистре <span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CONSTLAT</span><span style=" font-family:'Sans'; font-size:10pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Потребление в режиме System ON Low power напрямую зависит от количества активных блоков памяти и составляет:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; color:#0d3f66;">2.6 мкА</span><span style=" font-family:'Sans'; font-size:10pt;"> — 16 Кб RAM активно</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; color:#0d3f66;">3.8 мкА</span><span style=" font-family:'Sans'; font-size:10pt;"> — 32 Кб RAM активно</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Специалисты и Nordic советуют придерживаться ряда правил для существенно большего снижения энергопотребления в режиме System On:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">— использовать встроенный DC/DC (выигрыш до 30%);</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">— увеличить интервал между advertising пакетами;</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">— по возможности снизить объем advertising пакета;</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">— по возможности снизить мощность радиопередатчика;</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">— отключать неиспользуемые периферийные модули перед переходом в режим «сна»;</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">— отключать SPI,TWI,UART модули после завершения цикла приема/передачи.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">System OFF mode</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">System OFF — режим, в котором достигается наиболее экономичный режим энергопотребления. В данном режиме ядро контроллера отключено и все процессы прекращены. Активными в данном случае остаются один или несколько блоков RAM. Выход из данного режима возможен по внешнему сигналу DETECT, по сигналу ANADETECT от встроенного компаратора LPCOMP, а также по сигналу RESET. После выхода выполняется принудительный reset системы.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для входа в режим System OFF необходимо выполнить следующие действия в следующих регистрах:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">1.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">RESETREAS</span><span style=" font-family:'Sans'; font-size:10pt;"> — определить событие пробуждения в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">2.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">RAMON</span><span style=" font-family:'Sans'; font-size:10pt;"> и </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">RAMONB</span><span style=" font-family:'Sans'; font-size:10pt;"> — определить активные блоки RAM в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">3.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">SYSTEMOFF</span><span style=" font-family:'Sans'; font-size:10pt;"> — активировать System OFF режим в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">4.</span><span style=" font-family:'Sans'; font-size:10pt;"> настроить блок ответственный за пробуждение контроллера.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Функция запуска режима SystemOFF</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">#define WAKEUP_PIN                 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">void SystemOFF_active(void){</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Настройка события пробуждения: от внешнего прерывания */	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_POWER-&gt;RESETREAS 		=  POWER_RESETREAS_OFF_Detected;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Настройка активных блоков RAM */	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_POWER-&gt;RAMON 		=  POWER_RAMON_OFFRAM0_RAM0Off;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Настройка ножки P0.01 в качестве приемника внешних событий*/		</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_GPIO-&gt;PIN_CNF[WAKEUP_PIN] =  </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(GPIO_PIN_CNF_DIR_Input &lt;&lt; GPIO_PIN_CNF_DIR_Pos)|</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(GPIO_PIN_CNF_PULL_Pulldown &lt;&lt; GPIO_PIN_CNF_PULL_Pos)|</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(GPIO_PIN_CNF_SENSE_High &lt;&lt; GPIO_PIN_CNF_SENSE_Pos)|</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(GPIO_PIN_CNF_INPUT_Connect &lt;&lt; GPIO_PIN_CNF_INPUT_Pos);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Настройка мониторинга событий на ножке P0.01*/	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_GPIOTE-&gt;CONFIG[0] = </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(GPIOTE_CONFIG_MODE_Event &lt;&lt; GPIOTE_CONFIG_MODE_Pos)|</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(WAKEUP_PIN &lt;&lt; GPIOTE_CONFIG_PSEL_Pos)|</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(GPIOTE_CONFIG_POLARITY_LoToHi &lt;&lt; GPIOTE_CONFIG_POLARITY_Pos);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Вход в режим SystemOFF*/	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_POWER-&gt;SYSTEMOFF = 1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Потребление в данном режиме напрямую зависит от количества активных блоков памяти и составляет:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; color:#0d3f66;">0.6 мкА</span><span style=" font-family:'Sans'; font-size:10pt;"> — нет активных блоков RAM</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; color:#0d3f66;">1.8 мкА</span><span style=" font-family:'Sans'; font-size:10pt;"> — 16 Кб RAM активно</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; color:#0d3f66;">3.0 мкА</span><span style=" font-family:'Sans'; font-size:10pt;"> — 32 Кб RAM активно</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В целом интересный режим энергосбережения, но далеко не всем окажется по душе из-за скудного перечня возможностей пробуждения контроллера. </p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Аналого-цифровой преобразователь (ADC)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Аналого-цифровой преобразователь (ADC) один из наиболее часто используемых элементов периферии микроконтроллера. Описывать принцип его работы я смысла не вижу, так как об этом написано огромное количество сторонних статей различной степени углубленности. Однако обратить внимание на особенности исполнения АЦП стоит. У nRF51822 есть один АЦП и характеристики его достаточно скромные:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">— 8 каналов + 2 внешних канала для подачи внешнего опорного напряжения;</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">— разрешение 8,9,10 бит;</p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1549033459e9z336rs71.png" width="625" height="278" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Собственно и все, что можно сказать об основных характеристиках. Стоит отметить, что каналы мультиплексированы, т.е. выборка единовременно может происходить тольк с одного канала, а режим преобразования, к сожалению, только один — однократное преобразование. Реализвать непрерываное можно при помощи таймера и модуля PPI, но об этом мы поговорим чуть позже.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Также, важным параметром, является время одного преобразования, которое необходимо учитывать в случае реализации непрерывного преобразования нескольких каналов с промежуточной обработкой данных.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; color:#0d3f66;">68 мкс</span><span style=" font-family:'Sans'; font-size:10pt;"> — 10 бит АЦП;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; color:#0d3f66;">36 мкс</span><span style=" font-family:'Sans'; font-size:10pt;"> — 9 бит АЦП;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; color:#0d3f66;">20 мкс</span><span style=" font-family:'Sans'; font-size:10pt;"> — 9 бит АЦП.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для активации АЦП в режиме одиночного преобразования необходимо выполнить следующие действия в следующих регистрах:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">1.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CONFIG </span><span style=" font-family:'Sans'; font-size:10pt;">— определить разрядность АЦП в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">2.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CONFIG </span><span style=" font-family:'Sans'; font-size:10pt;">— определить делитель напряжения в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">3.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CONFIG</span><span style=" font-family:'Sans'; font-size:10pt;"> — определить номер канала для преобразования в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">4.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">POWER</span><span style=" font-family:'Sans'; font-size:10pt;"> — активировать прерывания (опционально) в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">5.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">ENABLE</span><span style=" font-family:'Sans'; font-size:10pt;"> — подать питание на АЦП в регистре.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">6.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">TASKS_START </span><span style=" font-family:'Sans'; font-size:10pt;">— запустить преобразование в регистре.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ниже представлен пример инициализации АЦП для проведения одиночного преобразования с последующей обработкой полученного результата в прерывании.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Функция инициализации АЦП</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Функция инициализации АЦП */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* АЦП - 10 бит, Делитель напряжения - 1/3, Канал преобразования - 2 */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_ADC-&gt;CONFIG  |=  </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(ADC_CONFIG_RES_10bit &lt;&lt; ADC_CONFIG_RES_Pos)|</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(ADC_CONFIG_INPSEL_AnalogInputOneThirdPrescaling &lt;&lt; ADC_CONFIG_INPSEL_Pos)|</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">(ADC_CONFIG_PSEL_AnalogInput2 &lt;&lt; ADC_CONFIG_PSEL_Pos);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Активация прерывания по окончанию преобразования */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_ADC-&gt;INTENSET  |= 	ADC_INTENSET_END_Enabled &lt;&lt; ADC_INTENSET_END_Pos;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Включение АЦП */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_ADC-&gt;ENABLE    |= 	ADC_ENABLE_ENABLE_Enabled &lt;&lt; ADC_ENABLE_ENABLE_Pos;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Разрешение прерываний в NVIC и установка приоритета */	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NVIC_SetPriority(ADC_IRQn, 1);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NVIC_EnableIRQ(ADC_IRQn);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Запустить одиночное преобразование */	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_ADC-&gt;TASKS_START = 1;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Обработчик прерывания АЦП</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Функция обработчик прерывания */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">#define ADC_REF   		       1200</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">#define ADC_PRESCALING                 3     </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">uint16_t adc_value, adc_value_in_mV;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">void ADC_IRQHandler(void){</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        /* Сброс флага, сигнализирующего об окончании преобразования */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NRF_ADC-&gt;EVENTS_END = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        /* Проверка текущего канала преобразования */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	switch(NRF_ADC-&gt;CONFIG &gt;&gt; ADC_CONFIG_PSEL_Pos){</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        case (ADC_CONFIG_PSEL_AnalogInput2):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	    adc_value = NRF_ADC-&gt;RESULT;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">            adc_value_in_mV = ((adc_value*ADC_REF)/1024)*ADC_PRESCALING</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        break;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        /* здесь можно реализовать обработку данных с нужного канала */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        default:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	break;	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Более подробно описывать смысла не вижу, так как для людей, которые читают даташиты, настройка не составит особого труда (регистров мало, все интуитивно понятны), а для тех, кто их читать не любит, данной информации (и той, что описана ниже) будет достаточно, чтобы запустить и использовать АЦП.</p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1549033459veyvkapqtk.png" width="696" height="191" /></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Таймеры (TIMER)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">У nRF51822 есть 3 таймера, которые могут работать в двух режимах: в режиме таймера (сравнения) и счетчика (захвата). Все таймеры — 8, 16, 24 и 32 битные.</p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1549033459g7mbgmhm8x.png" width="651" height="400" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; font-style:italic; color:#0d3f66;">Режим таймера (сравнения):</span><span style=" font-family:'Sans'; font-size:10pt;"> Самый обыкновенный режим работы таймера. Текущее значение счетчика сравнивается со значением, находящимся в регистре </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CC[n]</span><span style=" font-family:'Sans'; font-size:10pt;"> и генерирует событие/прерывание при совпадении этих двух значений. Наиболее часто используемый режим, так как при помощи него можно отсчитывают временные интервалы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600; font-style:italic; color:#0d3f66;">Режим счетчика (захвата сигнала):</span><span style=" font-family:'Sans'; font-size:10pt;"> При приходе внешнего импульса таймер фиксирует (захватывает) текущее значение счетчика в регистр </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CC[n]</span><span style=" font-family:'Sans'; font-size:10pt;">. При следующем импульсе таймер снова фиксирует значение счетчика в том же регистре. Таким образом, мы можем получить период или же длительность входного импульса. Отлавливать можно как фронт импульса, так и спад. Очень полезный режим работы таймера.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Частота таймера рассчитывается по следующей формуле:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для активации таймера в режиме сравнения необходимо выполнить следующие действия в следующих регистрах:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">1.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">MODE</span><span style=" font-family:'Sans'; font-size:10pt;"> — определить режим работы таймера в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">2.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">PRESCALER</span><span style=" font-family:'Sans'; font-size:10pt;"> — определить делитель тактового сигнала в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">3.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CC[n]</span><span style=" font-family:'Sans'; font-size:10pt;"> — определить число «тиков», до которого необходимо считать в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">4.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">POWER</span><span style=" font-family:'Sans'; font-size:10pt;"> — активировать питание таймера в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">5.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">TASKS_START</span><span style=" font-family:'Sans'; font-size:10pt;"> — запустить таймер в регистре.</span></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1549033459xnnd6qjxyq.png" width="702" height="333" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рассмотрим инициализацию таймера для отсчета времени с интервалом 1 секунда. Ниже представлена функция инициализации таймера, а также функция обработчика прерывания таймера, по достижению значения установленного в регистр <span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CC[n]</span><span style=" font-family:'Sans'; font-size:10pt;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Функция инициализации таймера</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NRF_TIMER1-&gt;POWER = 1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        /* Режим таймера */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NRF_TIMER1-&gt;MODE  = TIMER_MODE_MODE_Timer &lt;&lt; TIMER_MODE_MODE_Pos;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        /* Получить секунду можно различными вариантами. Например: поделить </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        тактовый сигнал (16 MHz) на 2 в степени 9 и отсчитать 31250 &quot;тиков&quot; */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NRF_TIMER1-&gt;PRESCALER = 9; </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NRF_TIMER1-&gt;CC[0] = 31250;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        /* Активация прерывания */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NRF_TIMER1-&gt;INTENSET = </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">       (TIMER_INTENSET_COMPARE0_Enabled &lt;&lt; TIMER_INTENSET_COMPARE0_Pos);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        /* Разрешение прерываний в NVIC и установка приоритета */		</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NVIC_SetPriority(TIMER1_IRQn, NRF_APP_PRIORITY_HIGH);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NVIC_EnableIRQ(TIMER1_IRQn);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        /* Запуск таймера на счет*/	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NRF_TIMER1-&gt;TASKS_START = 1;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Функция обработчика прерывания таймера</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">void TIMER1_IRQHandler(void){</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">         /* Сброс флага, сигнализирующего об окончании счета*/</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NRF_TIMER1-&gt;EVENTS_COMPARE[0] = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">        /* Очищение счетного регистра*/</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">	NRF_ADC-&gt;TASKS_CLEAR = 1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Да, регистров для хранения значения Захвата/Сравнения 4 <span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CC[0] — CC[3]</span><span style=" font-family:'Sans'; font-size:10pt;">, однако счетный регистр один, так что можно отсчитывать только 4 последовательных результата, после чего очищать счетный регистр и начинать считать заново.</span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Модуль PPI</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь мы медленно подошли к тому, зачем я так бегло и неполно описал возможности таймера и АЦП, ведь можно было, как и в большинстве подобных статей для других контроллеров (например, STM32), выделить на каждый модуль по отдельному посту, обсудить каждый регистр, каждый бит… И все это скучно и вторично, любая из статей про АЦП или таймеры даст вам необходимую минимальную базу знаний и нет смысла плодить это вновь и вновь. Я предлагаю рассмотреть интересный модуль nRF51 и при его помощи реализовать стандартную связку TIMER + ADC, тем самым обеспечив непрерывный режим преобразования с заданной частотой сэмплирования.</p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1549033459ftkdplnebx.png" width="747" height="667" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для чего же нужен PPI модуль? </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">PPI модуль необходим для передачи данных о событии/прерывании одной периферии в другую без участия ядра контроллера. Например, прерывание по RTC (Real Time Counter) может без участия CPU запустить любую единицу периферии. Кроме того, общение через модуль PPI между периферийными устройствами может происходить при спящем или отключенном CPU.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В нашем случае, данный модуль можно использовать для запуска преобразования АЦП, как следствие события достижения таймером установленного значения. Таким образом, мы без участия CPU добьемся реализации непрерывного преобразования АЦП.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итак, модуль PPI имеет 16 доступных для программирования каналов объединенных в 4 группы. Помимо этого, существуют 12 уже запрограммированных системой каналов. Ниже представленная настройка этих 12 каналов (<span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">EEP</span><span style=" font-family:'Sans'; font-size:10pt;"> — адрес периферии вызвавшей событие, </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">TEP</span><span style=" font-family:'Sans'; font-size:10pt;"> — адрес задачи выполняемой в случае возникновения события).</span></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1549033459e8kgj03g3b.png" width="695" height="159" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как уже говорилось ранее у модуля на каждый канал есть два регистра — регистр события и регистр задачи, выполняемой в случае возниконовения события.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для активации модуля PPI необходимо выполнить следующие действия в следующих регистрах:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">1.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CHENSET</span><span style=" font-family:'Sans'; font-size:10pt;"> — активировать модуль необходимый канал в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">2.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CH[n].EPP</span><span style=" font-family:'Sans'; font-size:10pt;"> — определить адрес события в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">3.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CH[n].TEP</span><span style=" font-family:'Sans'; font-size:10pt;"> — определить адрес задачи в регистре;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">4.</span><span style=" font-family:'Sans'; font-size:10pt;"> </span><span style=" font-family:'Sans'; font-size:10pt; color:#c00000;">CHG[n].EN</span><span style=" font-family:'Sans'; font-size:10pt;"> — активировать группу в которой находится данный канал в регистре.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ниже представлена функция инициализации модуля PPI для связки TIMER + ADC.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Функция инициализации таймера</span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Адрес события. В данном случае адрес регистра NRF_TIMER1-&gt;EVENTS_COMPARE[0] */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_PPI-&gt;CH[0].EEP = 0x40009140;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Адрес задачи. В данном случае адрес регистра NRF_ADC-&gt;TASKS_START */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_PPI-&gt;CH[0].TEP = 0x40007000;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Активация нулевого канала */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_PPI-&gt;CHEN 	 |= PPI_CHEN_CH0_Enabled;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_PPI-&gt;CHENSET |= PPI_CHENSET_CH0_Enabled;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">/* Запуск необходимой группы PPI */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">NRF_PPI-&gt;TASKS_CHG[0].EN = 1;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ссылка на код проекта связки TIMER + PPI + ADC есть в приложении к статье.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Хотелось бы обратить ваше внимание на то, что как правильно подсказывали люди в комментариях к прошлой статье, nRF51822 не самая стабильная микросхема. В ней существует ряд неочевидных проблем. Помимо этого, сам по себе чип с одной стороны богат на периферию, с другой стороны достаточно беден. Слишком медленный АЦП, отсутствие DMA для той части периферии, для которой он наиболее необходим (SPIM, TWI, UART, ADC), отсутствие FPU, все это ограничивает данный чип в использовании. Многие скажут, что это бред, так как и с более скудными характеристиками можно сделать много крутых устройств, лишь бы руки были из того места. И, в принципе, будут правы. НО, на данный момент существует отладочная плата nRF52 с чипом nRF52832, лишенным всех перечисленных недостатков и куда более стабильный чем 51-я серия, с тем же ценником. Так что будьте внимательны при подборе контроллера для различных задач.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В следующей статье, если она будет, расскажу про особенности реализации различных интерфейсов (SPIS,SPIM,TWI,UART), может захвачу RTC и прочую периферию.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Дополнительная информация</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://drive.google.com/open?id=1NtAiWvyfAVDj8_8zondVO0dGsJL3MmTw"><span style=" font-family:'Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Проект реализации связки Timer+PPI+ADC</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://ultran.ru/interfeys-ppi-programmable-peripheral-interconnect"><span style=" font-family:'Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Интерфейс PPI </span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/post/343166/"><span style=" font-family:'Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Коротко о nRF51822: Быстрый старт</span></a><span style=" font-family:'Sans'; font-size:10pt;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans'; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans'; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>