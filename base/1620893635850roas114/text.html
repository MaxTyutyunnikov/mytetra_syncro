<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Есть всего три популярных, высококачественных, широко принятых в индустрии компиляторов C/C++:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">GCC (Gnu Compiler Collections и GNU C Compiler), кроссплатформенный и Open-Source, используется в Linux как основной, на Windows известен как MinGW</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">MSVC (Microsoft Visual C/C++), низкая кроссплатформенность и закрытый код, используется в Windows как основной</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">LLVM/Clang, кроссплатформенный и Open-Source, используется в Mac OSX как основной, на Windows умеет быть совместимым и с MinGW, и с MSVC, доступен в Visual Studio 2015 и выше в модификации Clang/C2</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Принципы работы GCC и Clang можно детально исследовать благодаря открытому исходному коду и отладочным средствам.</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow0"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">G</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">CC (компиляция и вывод ассемблера)</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Разберёмся, как использовать GCC из командной строки. На UNIX-платформах GCC доступен по команде</span><span style=" color:#000000;"> </span><span style=" color:#000000; background-color:#fefefe;">gcc</span><span style=" color:#000000;">, а для Windows есть </span><a href="https://sourceforge.net/projects/mingw/files/"><span style=" text-decoration: underline; color:#2a7ae2;">порт GCC — MinGW</span></a><span style=" color:#000000;">. Воспользуемся примером кода, складывающего два числа:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">#include &lt;stdio.h&gt;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">float sum(float a, float b)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    return a + b;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">int main()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    float a = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    float b = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    scanf(&quot;%f %f&quot;, &amp;a, &amp;b);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    float ab = sum(a, b);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    printf(&quot;a + b = %f\n&quot;, ab);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Компиляция файла из командной строки с опциями по умолчанию (отладочная сборка без оптимизаций):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-style:italic; color:#999988; background-color:#ffffff;"># после флага -o задан выходной путь</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-style:italic; color:#999988; background-color:#ffffff;"># все параметры вне флагов считаются входными путями</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">gcc a+b.c </span><span style=" color:#000080; background-color:#ffffff;">-o</span><span style=" color:#000000; background-color:#ffffff;"> a+b</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Вывод программы после запуска:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">10 29</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">a + b = 39.000000</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Получение ассемблерного кода для отладочного режима без оптимизаций возможно с опцией</span><span style=" color:#000000;"> </span><span style=" color:#000000; background-color:#fefefe;">-S</span><span style=" color:#000000;">. По умолчанию создаваемый ассемблер использует </span><a href="https://ru.wikipedia.org/wiki/AT%26T-%D1%81%D0%B8%D0%BD%D1%82%D0%B0%D0%BA%D1%81%D0%B8%D1%81"><span style=" text-decoration: underline; color:#2a7ae2;">синтаксис AT&amp;T</span></a><span style=" color:#000000;">, который заметно отличается от </span><a href="https://ru.wikipedia.org/wiki/Intel-%D1%81%D0%B8%D0%BD%D1%82%D0%B0%D0%BA%D1%81%D0%B8%D1%81"><span style=" text-decoration: underline; color:#2a7ae2;">синтаксиса Intel</span></a><span style=" color:#000000;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;"># -oa+b_debug.s необязательная опция, указывает явно имя выходного файла</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;"># -S указывает генерировать ассемблер вместо исполяемого кода</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">gcc -S a+b.c -oa+b_debug.s</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;"># -masm=intel указывает на смену синтаксиса выходного ассемблера</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">gcc -S a+b.c -oa+b_debug.s -masm=intel</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Можно получить ассемблерный код в режиме с оптимизациями, используя флаг</span><span style=" color:#000000;"> </span><span style=" color:#000000; background-color:#fefefe;">-O2</span><span style=" color:#000000;">, где “O” в верхнем регистре. Если сравнить отладочный и оптимизированный код с помощью утилиты diff, будут видны сильные отличия в цепочках инструкций.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;"># -oa+b_debug.s необязательная опция, указывает явно имя выходного файла</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;"># -S указывает генерировать ассемблер вместо исполяемого кода</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;"># -O2 указывает второй уровень оптимизаций, аналогичный Release-сборкам</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">gcc -O2 -S a+b.c -oa+b_debug.s</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Вы можете скомпилировать ассемблер с помощью того же gcc, который сам передаст нужные параметры утилите “gas” (GNU Assembler).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">gcc a+b_debug.s</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow1"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">C</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">lang (компиляция, вывод ассемблера и LLVM-IR)</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Clang разрабатывался как прозрачная замена компилятору GCC для Linux и Mac OSX. Поэтому большая часть опций, касающихся компиляции C/C++, у этих двух компиляторов совпадает. Компиляция примера на языке C выглядит точно так же:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-style:italic; color:#999988; background-color:#ffffff;"># после флага -o задан выходной путь</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-style:italic; color:#999988; background-color:#ffffff;"># все параметры вне флагов считаются входными путями</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">clang a+b.c </span><span style=" color:#000080; background-color:#ffffff;">-o</span><span style=" color:#000000; background-color:#ffffff;"> a+b</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Генерация ассемблера с синтаксисом Intel:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">clang </span><span style=" color:#000080; background-color:#ffffff;">-S</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" color:#000080; background-color:#ffffff;">-mllvm</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" color:#000080; background-color:#ffffff;">--x86-asm-syntax</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">=</span><span style=" color:#000000; background-color:#ffffff;">intel a+b.c</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow2"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">Б</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">екенды GCC и Clang</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">GCC и Clang оба используют гибкие фреймворки для построения бекендов компилятора. В GNU Compiler Collections используется собственный промежуточный язык и бекенд GIMPLE, который сильно упрощает написание компиляторов для новых языков в составе GNU Compiler Collections, но плохо подходит для изучения новичком. Проект LLVM гораздо дружественнее к новичкам и студентам, и именно его использует компилятор Clang.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Вы можете изучать промежуточный код проекта LLVM, называемый LLVM-IR, с помощью clang, исследуя преобразование кода из C в LLVM-IR:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-style:italic; color:#999988; background-color:#ffffff;"># Выходной файл: a+b.ll</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">clang </span><span style=" color:#000080; background-color:#ffffff;">-S</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" color:#000080; background-color:#ffffff;">-emit-llvm</span><span style=" color:#000000; background-color:#ffffff;"> a+b.c</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-style:italic; color:#999988; background-color:#ffffff;"># Компиляция с оптимизациями (O2)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-style:italic; color:#999988; background-color:#ffffff;"># Выходной файл: a+b.ll</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">clang </span><span style=" color:#000080; background-color:#ffffff;">-O2</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" color:#000080; background-color:#ffffff;">-S</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" color:#000080; background-color:#ffffff;">-emit-llvm</span><span style=" color:#000000; background-color:#ffffff;"> a+b.c</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow3"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">У</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">пражнения</span></h2>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Напишите 3-4 простейших программы в 10-20 строк на C (сложение двух чисел, вывод текущего времени с начала эпохи UNIX, вывод версии операционной системы, переворачивание строки т.п.). Сгенерируйте из этих программ листинги в машинном ассемблере либо в LLVM-IR, и сравните листинги от разных программ с помощью diff. Попробуйте собрать минимальный шаблон ассемблерного кода, который можно было бы разворачивать в полноценную программу путём подстановки цепочки инструкций вместо переменной </span><span style=" font-size:16px; background-color:#fefefe;">{CODE}</span><span style=" font-size:18px;">.</span></li></ul></body></html>