<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Жажда тюнинга может завести в неведомые дебри. И, пожалуй, едва ли не самая частая неправильная оптимизация — отключение swap-файла. Если прикинуть частоту, с которой эта ошибка встречается, то, наверное, она входит в негласный top-10 (а может и top-5) самых распространенных, самых бесполезных и самых вредных оптимизаций - потому что swap-файл это одна из самых интересных, сложно понимаемых и недооцененных   сущностей в подсистеме управления виртуальной памятью.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" font-style:italic; color:#333333;">Эта статья является обзорной и предназначена для того, чтобы дать представление об общих процессах, происходящих в системе, и объяснить, откуда берутся некоторые мифы, следование которым может доставить неприятные моменты</span></p>
<h3 style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:32px; background-color:#ffffff;"><span style=" font-size:large; font-weight:496; color:#333333; background-color:#ffffff;">В начале был … вопрос</span></h3>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Когда возникает необходимость в swap-файле? Самый частый ответ — «когда не хватает памяти». И, естественно, это ответ неправильный почти полностью. Правильный ответ - необходимость в использовании swap-файла возникает тогда, когда система не может удержать в памяти</span><span style=" color:#333333;"> </span><span style=" font-weight:600; color:#333333;">необходимый кэш</span><span style=" color:#333333;"> и </span><span style=" font-weight:600; color:#333333;">грязные страницы</span><span style=" color:#333333;">. А чтобы понять, что это значит, нам надо сделать маленький экскурс внутрь ядра операционной системы.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Вся память, которой оперирует система, разбита на страницы. Каждый процесс в системе имеет свое «плоское» адресное пространство. Для каждого процесса система поддерживает карту страниц — какая страница адресного пространства процесса (страница виртуальной памяти) отображена в какую страницу физической памяти - если вообще отображена, разумеется.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">И когда процесс пытается получить доступ к какой-то странице своей памяти, MMU (memory management unit) процессора фактически производит обращение к той странице физической оперативной памяти, куда страница отображена.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">А если страница не отображена ни в какую физическую страницу, то возникает</span><span style=" color:#333333;"> </span><span style=" font-weight:600; color:#333333;">page fault</span><span style=" color:#333333;"> — исключительная ситуация «страница не найдена». При обработке этой ситуации система (ядро) проверяет, имеет ли процесс право получить доступ к своей логической странице: если не имеет (например эта страница заразервирована ядром или находится «за хвостом кучи» процесса) - то процессу придет сигнал </span><span style=" font-weight:600; color:#333333;">SEGFAULT</span><span style=" color:#333333;"> — и процесс умрет.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">А если имеет — то ядро выполнит все нужные действия, чтобы восстановить правильное содержимое страницы, и предъявит её процессу - после чего операция успешно выполнится.</span></p>
<h3 style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:32px; background-color:#ffffff;"><span style=" font-size:large; font-weight:496; color:#333333; background-color:#ffffff;">Какие группы страниц памяти живут в системе?</span></h3>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Страницы физической памяти</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#333333;" style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Свободная — страница физической памяти, которая не используется для хранения данных и может быть свободно использована в любой момент времени</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Используемая — страница, хранящая данные, не принадлежащие кэшу</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Страница анонимного кэша (</span><span style=" font-size:16px; font-weight:600;">anonymous page cache</span><span style=" font-size:16px;">) — страница числится как принадлежащая кэшу, но не закрепленная ни за каким файлом. Очень похожа на используемую страницу (и в определенных ситуациях может превращаться в неё)</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Чистая страница кэша (</span><span style=" font-size:16px; font-weight:600;">clean cache page</span><span style=" font-size:16px;">)- страница, в которой хранятся закэшированные данные файла, которые не менялись.</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Грязная страница кэща (</span><span style=" font-size:16px; font-weight:600;">dirty cache page</span><span style=" font-size:16px;">) — страница, в которой хранятся данные файла, которые были изменены (данные в кэше поменяли но на диск изменения не сохранили)</span></li></ul>
<p style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Страница процесса, в свою очередь, также может иметь несколько состояний</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#333333;" style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Недоступная — процесс не имеет права на доступ к этой странице. Если процесс к ней обращается &quot;неподобающим образом&quot; то получает </span><span style=" font-size:16px; font-weight:600;">SEGFAULT</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Доступная, сопоставленная физической странице, не принадлежащей кэшу. Процесс может работать с этой страницей</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Доступная, сопоставленная физической странице кэша, в которую загружены данные файла. Процесс может работать с этой страницей.</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Доступная, не сопоставленная физической странице, но сопоставленная региону какого-либо файла. Прежде чем процесс сможет работать с этой страницей, система должна выделить физическую страницу, отдать ее в кэш, загрузить в нее данные из файла — и после этого процесс сможет с ней работать (потому, что она превратится в предыдущую разновидность)</span></li></ul>
<p style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">И сейчас, когда мы более-менее определились с видами страниц, мы переходим к самой интересной части</span></p>
<h4 style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:26px; background-color:#ffffff;"><span style=" font-size:medium; font-weight:496; color:#333333; background-color:#ffffff;">Работа процесса</span></h4>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Чтобы понять как все эти механизмы связаны и работают, давайте рассмотрим запуск нового процесса. Мы запускаем новый процесс, и система загружает исполняемый файл. Как это происходит?</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Система открывает бинарный файл с программой и … Нет, она не читает его. Она отображает файл в адресное пространство процесса — то есть создает записи (например)</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#333333;" style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Страница 0 ... 15 -&gt; /usr/bin/filename сегмент 0 ... 65535</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">Страница 16 ... 31 -&gt; /usr/bin/filename сегмент 65536 ... 131071</span></li></ul>
<p style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Ну да, там всё сложнее — но нам сейчас главное понять идею.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">С точки зрения системы, эти логические страницы принадлежат процессу, отображены на какой-то файл файловой системы и не сопоставлены никакой физической странице. И теперь, управление отдается процессу — например вызывается инструкция с какой-то страницы или читаются или записываются данные в страницу.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">MMU обнаруживает ошибку — странице процесса не сопоставлена никакая физическая страница - ошибка,</span><span style=" color:#333333;"> </span><span style=" font-weight:600; color:#333333;">page fault</span><span style=" color:#333333;">! Ядро получает эту ошибку, смотрит на статус страницы:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#333333;" style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">процессу разрешен доступ</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">физической странице не сопоставлена (и это логично, иначе бы page fault не возник)</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">но сопоставлена сегменту файла</span></li>
<li style=" color:#333333;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px;"><span style=" font-size:16px;">указанный фрагмент файла в кэше не обнаружен</span></li></ul>
<p style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">В указанной ситуации, ядро берет свободную страницу, объявляет её страницей кэша и загружает в неё данные из файла с диска. Теперь это чистая страница кэша -</span><span style=" color:#333333;"> </span><span style=" font-weight:600; color:#333333;">clean page</span><span style=" color:#333333;">. Затем ядро добавляет ссылку «этой странице процесса сопоставлена эта физическая страница, принадлежащая кэшу и взятая из указанного места файла». Управление возвращается процессу, а проблемная операция завершается успешно. Ну а если это была операция модификации данных (и модификация допустима), то после записи данных страница помечается как измененная — и становится грязной страницей кэша - </span><span style=" font-weight:600; color:#333333;">dirty page</span><span style=" color:#333333;"> с точки зрения ядра.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Если же в кэше системы уже есть физическая страница, в которой лежат данные из файла в неизменном виде (найдена чистая страница кэша), то страница процесса просто начинает ссылаться на обнаруженную страницу кэша.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Точно такие же процессы происходят для разделяемых библиотек (бинарник программы, на самом деле, тоже фактически разделяемая библиотека, которая просто содержит специальную точку входа).</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" font-style:italic; color:#333333;"> Примечание &quot;на полях&quot;: на самом деле, когда файл разделяемой библиотеки загружается, он частично прочитывается (как минимум его заголовок и секция символов: описание расположения объектов (функций и переменных) содержащихся в файле разделяемой библиотеки) — но в большинстве случаев, целиком файл не читается, и подгружается в процессе работы программы по мере обращения к функциям и переменным, описанным в загруженных разделяемых библиотеках. Поэтому, после перезагрузки система может немного «подтупливать» - в том числе всё то время, пока кэш заполняется разделяемыми библиотеками.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" font-style:italic; color:#333333;">Второе &quot;примечание&quot;: механизмы работы с отображаемыми в память файлами намного сложнее и если за них браться, эта статья превратилась бы в многостраничный трактат. Но нам сейчас надо понять основные линии поведения системы в стрессовых условиях нехватки RAM</span></p>
<h3 style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:32px; background-color:#ffffff;"><span style=" font-size:large; font-weight:496; color:#333333; background-color:#ffffff;">Откуда (и когда) начинается использование swap-файла?</span></h3>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Представим, что мы загрузили большой бинарник с большим количеством библиотек (привет, браузер!) в котором открыли сколько-то вкладок с документами, и исчерпали доступную физическую память. При этом, у нас образуется две  больших группы страниц —</span><span style=" color:#333333;"> </span><span style=" font-weight:600; color:#333333;">чистые страницы кэша</span><span style=" color:#333333;">, сопоставленные разделяемым библиотекам — причем в этих страницах содержится использующийся код (мы ведь помним про то, что библиотеки загружаются «по мере необходимости») и </span><span style=" font-weight:600; color:#333333;">приватные страницы процесса</span><span style=" color:#333333;"> или страницы </span><span style=" font-weight:600; color:#333333;">anonymous page cache</span><span style=" color:#333333;"> (этот механизм часто используется для предварительной аллокации памяти). Но, в обоих случаях, мы можем рассматривать их как данные процесса.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Свободных страниц у нас нет — всё ушло на кэш и данные.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Теперь мы открываем еще одну вкладку, что при этом случается? Чтобы найти память, система вынуждена освободить часть чистых страниц кэша и отдать их под данные приложения — ведь данные которые там лежали, можно снова загрузить с диска (это ведь &quot;</span><span style=" font-weight:600; color:#333333;">чистые</span><span style=" color:#333333;">&quot; страницы!).</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Но в этих страницах был ИСПОЛЬЗУЕМЫЙ код — иначе бы они не подтянулись в кэш.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">А это значит, что как только (и скорей всего через не самый долгий промежуток времени) программа пойдет в код, который был выгружен из памяти, она получит</span><span style=" color:#333333;"> </span><span style=" font-weight:600; color:#333333;">page fault</span><span style=" color:#333333;"> — и система снова прочтет код из файла библиотеки с диска. В новую пустую страницу. Но чтобы её получить, надо сбросить другую чистую страницу кэша! И система входит в трэшинг - она постоянно вынуждена освобождать и снова погружать код, раз за разом, из одного файла за другим.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" font-weight:600; color:#333333;">То есть фактически, в системе уже есть swap-файл, из которого постоянно ведется чтение — и это разделяемые библиотеки. Но система не может использовать его эффективно, поскольку он ограничен и фактически неуправляем - и скатывается в трэшинг</span></p>
<h3 style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:32px; background-color:#ffffff;"><span style=" font-size:large; font-weight:496; color:#333333; background-color:#ffffff;">А если бы у нас был настоящий swap-файл?</span></h3>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">На основе учета частоты обращения к различным страницам, система скорей всего не освободила бы страницу с кодом, а поместила в swap данные наиболее давно не использовавшихся вкладок. И вместо постоянного чтения с диска, у нас случились бы одна запись и одно чтение — причем именно в момент обращения к выгруженной в swap вкладке.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Для страницы, которая была поднята из swap-файла, применяются дополнительные изящные механизмы — она фактически считается «чистой страницей кэша» пока не изменена, но место в swap-файле за ней по-прежнему резервируется - и пока страница остается «чистой», она может быть при необходимости просто «забыта» без сохранения в swap аналогично обычным чистым страницам кэша.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Для этого, пока поднятая из swap-файла страница не поменялась, место, которое страница занимала в swap-файле, будет по возможности за ней удерживаться и не считается «освобожденным» пока страница не изменится. Это означает, что в случае, если у вас большой swap-файл, редко читаемые и не изменившиеся данные могут «уехать в swap» и</span><span style=" color:#333333;"> </span><span style=" font-weight:600; color:#333333;">многократно</span><span style=" color:#333333;"> доставаться оттуда по мере надобности — то есть в нормальной ситуации, swap работает по принципу «</span><span style=" font-weight:600; color:#333333;">одна запись, много чтений</span><span style=" color:#333333;">«.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">А если swap-файл маленький, то начинается «веселье» с постоянным записью-чтением в swap-файл.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Таким образом, отключение / отсутствие swap-файла, равно как и его малый размер, отрицательно влияет на производительность в условиях начала нехватки памяти, не позволяя системе выгружать наименее используемые страницы и заставляя делать лишние записи там, где запись, на самом деле, не нужна — ведь вместо того, чтобы удержать код, к которому мы обращаемся часто, система вынуждена сохранять в памяти данные, к которым мы не обращаемся - потому что их негде больше сохранить.</span></p>
<h3 style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:32px; background-color:#ffffff;"><span style=" font-size:large; font-weight:496; color:#333333; background-color:#ffffff;">Какие выводы можно сделать из всего вышеописанного?</span></h3>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Кэш (page cache) — это не только кэш данных! Кэш - это очень существенный компонент в схеме организации виртуальной памяти - и теперь мы понимаем неправильность вопроса «почему система ушла в свал а не освободила кэш». Ведь ответ очень прост - этот кэш на самом деле не просто кэш, а код. И если код используется чаще, чем данные - то в данном случае более важно сохранить в памяти код (сохранить кэш) чем удерживать в памяти данные!</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Поэтому не надо бояться наличия swap-файла — если статистика не покажет необходимости - система не полезет в свап.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Swap-файл может считаться используемым даже если все данные из него уже подняты обратно в память.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Малый размер swap-файла вреден — он не позволяет системе работать эффективно, поскольку увеличивает объем непродуктивного I/O</span></p>
<h3 style=" margin-top:32px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:32px; background-color:#ffffff;"><span style=" font-size:large; font-weight:496; color:#333333; background-color:#ffffff;">Резюме?</span></h3>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Это прекрасно, когда объем оперативной памяти достаточно велик, чтобы вместить и весь необходимый кэш, и данные. Но если у вас бюджетная система с 8 … 16ГБ оперативной памяти (не говоря уж об ультрабюджетных ноутбуках с распаянными и нерасширяемыми 4GB), то swap достаточного объема (не менее 1 x ) это &quot;то, что доктор прописал&quot;.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">И достаточный размер swap-файла на быстром накопителе (кто сказал NVMe?) на бюджетном ноутбуке может очень хорошо увеличить производительность системы, особенно если вы любитель держать много открытых вкладок, документов, рисунков в графическом редакторе и т.д.</span></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; background-color:#ffffff;"><span style=" color:#333333; background-color:#ffffff;">Не мешайте системе работать. Нет нужды бояться swap-файла. Если он не нужен — он не будет использован. И то, что вы видите, что он якобы использован - на самом деле совсем не значит, что он использован. Просто нам показали картинку «без подробностей».</span></p>
<p style="-qt-paragraph-type:empty; margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:24px; color:#333333; background-color:#ffffff;"><br /></p></body></html>