<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">В этой статье рассказывается про базовые инструменты для работы с ARM-микроконтроллерами, а так же объясняются многие тонкости работы микропроцессоров ARM, о которых обычно нигде в свободной форме не написано. Обязательно к прочтению для устаканивания информации в голове для всех, кто работает с ARM на низком (аппаратном) уровне.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Я тут в очередной раз пытаюсь освоить программирование микроконтролеров. Захотелось написать такой полу-ЖЖ, полу-туториал (как говорится - хочешь разобраться в чём-то, объясни это другим). Может кто почерпнёт или подскажет чего полезного.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Если интерес будет, буду продолжать.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Итак осваиваем STM32 не как нормальные люди.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Примерный план:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Подключить его к компьютеру и убедиться, что там что-то происходит. Использовать будем st-util и gdb.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Написать простейшую программу на ассемблере, которая в цикле прибавляет регистр, скомпилировать из неё прошивку, залить на плату и пронаблюдать её работу. Использовать будем <span style=" font-family:'FreeMono'; font-size:11pt; color:#6a1009;">binutils</span> и <span style=" font-family:'FreeMono'; font-size:11pt; color:#6a1009;">st-flash</span>.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поморгать диодом (на ассемблере же).</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Переписать осмысленный код на С (дальше всё на С).</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Переписать моргание с использованием таймера, чтобы внести свой вклад в борьбу с глобальным потеплением.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сказать внешнему миру «Hello world» через UART.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Переписать «Hello world» с помощью CMSIS, уже с пониманием того, что там происходит.</li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">На этом этапе начальное освоение микроконтроллеров можно считать завершённым. Дальше, видимо, сотни страниц датащитов по записи нужных битов в нужные места, или использование готовых библиотек. В любом случае навыки из списка выше полезны при использовании любых библиотек, т.к. всё растёт из этой базы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Сразу скажу, что в процессе будет использовано достаточно много инструментов вроде make, ld, gdb, as, gcc и тд, по каждому из них можно книги писать (и пишут). Поэтому, конечно, углубляться в них я не буду, а напротив буду использовать в максимально примитивном виде.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Ниже ссылки на мануалы, где можно подробней раскрыть тему. Ожидается, что читатель будет активно ими пользоваться.</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf"><span style=" text-decoration: underline; color:#0000ff;">STM32F101xx Reference Manual</span></a>. Тут вся справочная информация по всем битам и байтам конкретного микроконтроллера.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf"><span style=" text-decoration: underline; color:#0000ff;">STM32F10xxx Programming manual</span></a>. Тут справочная информация по ARM: все инструкции, описание работы процессора.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/"><span style=" text-decoration: underline; color:#0000ff;">GNU debugger GDB</span></a>. Это отладчик.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://www.gnu.org/software/make/manual/html_node/index.html"><span style=" text-decoration: underline; color:#0000ff;">GNU make</span></a></li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://sourceware.org/binutils/docs/ld/"><span style=" text-decoration: underline; color:#0000ff;">GNU linker ld</span></a></li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://sourceware.org/binutils/docs/as/"><span style=" text-decoration: underline; color:#0000ff;">GNU assembler as</span></a></li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Часть 1: подключаем и исследуем плату</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Для неё нужен компьютер, собственно плата и программатор ST-Link.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">На компьютер нужно установить Arm GNU Toolchain. Его можно скачать </span><a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">тут</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, возможно в вашем дистрибутиве уже есть готовые пакеты. У вас должна работать команда </span><span style=" font-family:'FreeMono'; color:#6a1009;">arm-none-eabi-gdb</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Также нужно установить </span><span style=" font-family:'FreeMono'; color:#6a1009;">st-link</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (</span><a href="https://github.com/stlink-org/stlink"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">исходники</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), он тоже есть во многих репозиториях. Я всё делал на линуксе, но в теории макось и винда тоже должны подойти.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Программатор у меня - фирменный st-link, выломанный из фирменной платы Nucleo. Но больше распространены китайские st-link в виде флешки, они тоже довольно дёшевы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Программатор нужно подключить к компьютеру и выполнить команду </span><span style=" font-family:'FreeMono'; color:#6a1009;">st-info --probe</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Он должен отобразить некоторую информацию о программаторе. Если у вас ошибка, попробуйте </span><span style=" font-family:'FreeMono'; color:#6a1009;">sudo st-info --probe</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Если сработает, значит проблема с правами, копайте </span><span style=" font-family:'FreeMono'; color:#6a1009;">udev</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, ну или работайте от рута.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Плата у меня т.н. blue pill с микроконтроллером STM32F103C8T6. Это дешёвая и распространённая китайская плата. Я не специалист по STM32, но мне показалось, что на базовом уровне они все работают примерно одинаково, поэтому, наверное, информация будет применима и для других плат.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">У меня плата после покупки и подключению к компьютеру моргала синим диодом. То бишь в ней уже была какая-то простейшая прошивка для демонстрации работоспособности.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Плату к программатору надо подключить тремя проводами: GND, SWCLK, SWDIO. Я плату и программатор вставлял в два USB-разъёма USB-хаба и у меня всё было хорошо и ничего не сгорело. Также плату можно запитать от программатора, тогда в USB её включать не придётся. Можно ли плату подключить к USB-зарядке, а программатор к компьютеру - я не знаю.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">После того, как плата подключена к программатору, </span><span style=" font-family:'FreeMono'; color:#6a1009;">st-info --probe</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> должен показать информацию о плате. Если на этом этапе проблемы, нужно их решить.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Вот что выводит у меня:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">&gt; st-info --probe</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Found 1 stlink programmers</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  version:    V2J29S18</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  serial:     066CFF494849887767255731</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  flash:      65536 (pagesize: 1024)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  sram:       20480</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  chipid:     0x0410</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  descr:      F1xx Medium-density</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Теперь попробуем подключиться к плате отладчиком. Это самое интересное. Для этого в одной вкладке терминала запускаем </span><span style=" font-family:'FreeMono'; color:#6a1009;">st-util --connect-under-reset</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Он выведет что-то вроде</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">2023-09-08T17:26:46 WARN common.c: NRST is not connected</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">2023-09-08T17:26:46 INFO common.c: F1xx Medium-density: 20 KiB SRAM, 64 KiB flash in at least 1 KiB pages.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">2023-09-08T17:26:46 INFO gdb-server.c: Listening at *:4242...</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Что это предупреждение означает, я не знаю, если подключить ногу NRST от микроконтроллера к программатору, оно не исчезает. Но вроде всё работает, поэтому будем его игнорировать.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Собственно видно: что </span><span style=" font-family:'FreeMono'; color:#6a1009;">st-util</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> запустил TCP-сервер на порту 4242. К этому серверу будет подключаться </span><span style=" font-family:'FreeMono'; color:#6a1009;">gdb</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Во второй вкладке запускаем </span><span style=" font-family:'FreeMono'; color:#6a1009;">arm-none-eabi-gdb</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (возможно обычный gdb тоже подойдёт, я не знаю, честно говоря, в чём отличие):</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">&gt; arm-none-eabi-gdb </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">GNU gdb (Arm GNU Toolchain 12.3.Rel1 (Build arm-12.35)) 13.2.90.20230627-git</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Copyright (C) 2023 Free Software Foundation, Inc.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">This is free software: you are free to change and redistribute it.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">There is NO WARRANTY, to the extent permitted by law.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Type &quot;show copying&quot; and &quot;show warranty&quot; for details.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">This GDB was configured as &quot;--host=x86_64-pc-linux-gnu --target=arm-none-eabi&quot;.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Type &quot;show configuration&quot; for configuration details.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">For bug reporting instructions, please see:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">&lt;https://bugs.linaro.org/&gt;.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Find the GDB manual and other documentation resources online at:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">For help, type &quot;help&quot;.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">И дальше подключаемся к вышеупомянутому серверу:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) target remote 127.0.0.1:4242</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">Remote debugging using 127.0.0.1:4242</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">warning: No executable has been specified and target does not support</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">determining executable automatically.  Try using the &quot;file&quot; command.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">0x08000130 in ?? ()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Итак мы подключились отладчиком к плате. В последней строчке у вас скорей всего будет другой адрес, не суть.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Теперь пару слов про то, как вообще работает этот микроконтролер. Я, конечно, буду упускать много деталей, попытаюсь передать суть.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Вообще у него всё взаимодействие со всеми устройствами ведётся через оперативную память (и прерывания). Это 32-битный процессор, т.е. он может адресовать 4 ГБ памяти. Конечно самой памяти у него гораздо меньше, на моём устройстве 20 кибибайтов оперативной памяти и 64 кибибайта флеш-памяти. Поэтому адресного пространства хватает и на оперативную память, и на флеш-память и на все остальные периферийные устройства. Если быть более конкретным, то оперативная память начинается с адреса 0x2000 0000, а флеш-память начинается с адреса 0x0800 0000. А также имеется несколько десятков периферийных устройств, каждое из которых имеет свои участки памяти, через которые идёт взаимодействие с этим самым устройством. Всё взаимодействие по сути сводится к чтению и записи данных по адресам памяти.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Итак мы подали питание. У него есть два пина BOOT0 и BOOT1. На плате они настраиваются двумя перемычками. Есть три варианта загрузки, нас интересует загрузка из главной флеш-памяти. Для этого нужно выставить BOOT0 в «0» (т.е. соединить с «землёй»), на моей плате этому соответствует положение перемычки ближе к USB-порту. Посмотреть больше информации про это можно в reference manual 3.4. В зависимости от выбранной конфигурации процессор делает доступным выбранное устройство загрузки по адресу 0x0000 0000. Иными словами когда мы грузимся с флеш-памяти, то адрес 0x0800 0000 становится также доступным по адресу 0x0000 0000 (а также все остальные адреса). Далее процессор читает по адресу 0x0000 0000 4 байта и присваивает это значение регистру </span><span style=" font-family:'FreeMono'; color:#6a1009;">sp</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (stack pointer, вершина стека). Далее процессор читает по адресу 0x0000 0004 4 байта и присваивает это значение регистру </span><span style=" font-family:'FreeMono'; color:#6a1009;">pc</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (program counter), иными словами делает переход по указанному адресу. Ну и, собственно, начинает работу. Читает инструкцию, выполняет и тд.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Помимо этого у процессора есть возможность его отладки. Собственно что мы и сделали, подключив к нему программатор. В этом режиме он после инициализации ничего не начинает выполнять, а ждёт команды от отладчика, а также даёт возможность отладчику читать значения всех регистров, любого адреса оперативной памяти и тд.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Собственно для начала прочитаем по 8 байтов по адресам 0x0000 0000 и 0x0800 0000, убедимся, что они действительно совпадают, а также попробуем понять их смысл.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) x/2z 0x00000000</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">0x0:	0x20004ffc	0x08000131</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) x/2z 0x08000000</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">0x8000000:	0x20004ffc	0x08000131</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Команда </span><span style=" font-family:'FreeMono'; color:#6a1009;">x</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> читает значения из памяти по указанному адресу. Строка </span><span style=" font-family:'FreeMono'; color:#6a1009;">/2z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> говорит о том, что мы хотим прочитать 2 слова (т.е. 4-байтовых значения) и напечатать их в 16-ричном формате.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Как видно, по обоим адресам действительно лежат одинаковые данные. Иными словами, если верить описанию выше, то после инициализации регистру </span><span style=" font-family:'FreeMono'; color:#6a1009;">sp</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> должно было присвоиться значение 0x20004ffc, а регистру pc значение 0x08000131. Сейчас мы этом проверим, а пока попробуем чуть-чуть похулиганить. На моей плате 64 кибибайта флеша, поэтому попробуем прочитать пару слов в самом конце.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) x/2z 0x08000000 + 64 * 1024 - 4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">0x800fffc:	0xffffffff	Cannot access memory at address 0x8010000</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Собственно как и ожидалось - последнее слово ещё что-то содержит, а после него уже адреса недоступны для чтения. Поэтому командой x можно исследовать что угодно без всяких опасений.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Теперь проверим значения регистров:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) print/z $sp</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$1 = 0x20004ffc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) print/z $pc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$2 = 0x08000130</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Для чтения значений используется команда </span><span style=" font-family:'FreeMono'; color:#6a1009;">print</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Регистры доступны через синтаксис </span><span style=" font-family:'FreeMono'; color:#6a1009;">$sp</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><span style=" font-family:'FreeMono'; color:#6a1009;">$pc</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><span style=" font-family:'FreeMono'; color:#6a1009;">$r0</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и тд. Также все регистры можно посмотреть командой </span><span style=" font-family:'FreeMono'; color:#6a1009;">info registers</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Важно понимать разницу между </span><span style=" font-family:'FreeMono'; color:#6a1009;">print $sp</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><span style=" font-family:'FreeMono'; color:#6a1009;">x $sp</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Первая команда печатает </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">значение регистра</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, вторая команда значение регистра </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">интерпретирует как адрес</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, и печатает значение из памяти.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Собственно видно, что со значением регистра </span><span style=" font-family:'FreeMono'; color:#6a1009;">$sp</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> всё ожидаемо - он действительно загрузился из адреса 0x0000 0000, а вот </span><span style=" font-family:'FreeMono'; color:#6a1009;">$pc</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> оказался на единицу меньше. Тут можно много рассказывать, но это всё не очень интересно - просто запомните, что в архитектуре arm cortex адреса инструкций всегда чётные, при этом значения указателей иногда нечётные. Собственно адрес 0x0000 0004, с которого начнётся выполнение, должен быть нечётным, при этом младший бит обнулится перед переходом. Также инструкции перехода </span><span style=" font-family:'FreeMono'; color:#6a1009;">BX</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><span style=" font-family:'FreeMono'; color:#6a1009;">BLX</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> требуют то же самое: младший бит адреса, на который выполняется переход, должен быть равен единице, но при этом переход делается на адрес с нулевым младшим битом. А команды </span><span style=" font-family:'FreeMono'; color:#6a1009;">B</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><span style=" font-family:'FreeMono'; color:#6a1009;">BL</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> не требуют, вот такая особенность.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В итоге процессор перешёл на адрес 0x08000130 и остановился. На вашей плате скорей всего все эти значения будут немного другими, я «заводскую» прошивку стёр, но принцип ровно тот же. На всякий случай напомню, что по адресу 0x08000130 у нас доступна флеш-память, т.е. это код из флеш-памяти.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Теперь можно попробовать дизассемблировать инструкцию, которая сейчас будет выполняться:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) x/i $pc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">=&gt; 0x8000130:	add.w	r0, r0, #1</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Как видно, для дизассемблирования используется ровно та же команда </span><span style=" font-family:'FreeMono'; color:#6a1009;">x</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (examine). Только вместо </span><span style=" font-family:'FreeMono'; color:#6a1009;">/z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> используется формат </span><span style=" font-family:'FreeMono'; color:#6a1009;">/i</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Формат </span><span style=" font-family:'FreeMono'; color:#6a1009;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> - это шестнадцатеричный формат, а формат </span><span style=" font-family:'FreeMono'; color:#6a1009;">i</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> - это интерпретация числа, как инструкции. Для интереса покажу ещё несколько форматов, думаю, всё и так очевидно.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) x/z $pc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">0x8000130:	0x0001f100</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) x/d $pc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">0x8000130:	127232</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) x/x $pc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">0x8000130:	0x0001f100</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) x/t $pc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">0x8000130:	00000000000000011111000100000000</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Форматы </span><span style=" font-family:'FreeMono'; color:#6a1009;">/z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><span style=" font-family:'FreeMono'; color:#6a1009;">/x</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> означают одно и то же, но в некоторых случаях </span><span style=" font-family:'FreeMono'; color:#6a1009;">/x</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> не добавляет нули слева, а </span><span style=" font-family:'FreeMono'; color:#6a1009;">/z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> всегда добавляет нули.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Иными словами 4 байта </span><span style=" font-family:'FreeMono'; color:#6a1009;">01 00 f1 00</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> процессором интерпретируются, как команда </span><span style=" font-family:'FreeMono'; color:#6a1009;">add.w r0, r0, #1</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Эта команда аналогична псевдокоду </span><span style=" font-family:'FreeMono'; color:#6a1009;">r0 := r0 + 1</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Важно понимать, что эта команда ещё не выполнена, процессор только готовится её выполнить.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Теперь распечатаем значение регистра </span><span style=" font-family:'FreeMono'; color:#6a1009;">r0</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, далее выполним команду и распечатаем значение регистра ещё раз.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) p/z $r0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$6 = 0x48b503b6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) stepi</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">0x08000134 in ?? ()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">(gdb) p/z $r0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$7 = 0x48b503b7</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Как видно, в регистре </span><span style=" font-family:'FreeMono'; color:#6a1009;">r0</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> было какое-то непонятное значение и процессор действительно увеличил это значение в регистре </span><span style=" font-family:'FreeMono'; color:#6a1009;">r0</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> на единицу. После команды </span><span style=" font-family:'FreeMono'; color:#6a1009;">stepi</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> процессор перешёл на 4 байта вперёд и готовится выполнить следующую команду. Посмотрим, что там за команда.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">x/i $pc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">=&gt; 0x8000134:	b.w	0x8000130</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Это команда </span><span style=" font-family:'FreeMono'; color:#6a1009;">branch</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, команда безусловного перехода по указанному адресу. Если её выполнить, то процессор вернётся на предыдущую инструкцию. Ну собственно так и будет туда-сюда прыгать, считая от 0 до 4 миллиардов по кругу, пока не выключим питание.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В псевдокоде эта программа выглядит примерно так:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">loop: r0 := r0 + 1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">goto loop;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В дальнейшем я буду иллюстрировать программы на ассемблере псевдокодом, похожим на C, по крайней мере мне так проще.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">На вашей плате из магазина программа будет другая. Но принципы работы те же.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">На этом первая часть закончена. Мы запустили плату, подключились к ней и убедились, что там внутри действительно процессор, а не просто лампочка.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p></body></html>