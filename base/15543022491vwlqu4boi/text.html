<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Настройка SMTP-сервера – задача не для слабонервных. При этом очень важно обеспечить надёжную защиту данных, и, пожалуй, ещё важнее настроить доставляемость рассылок, которые не будут помечаться как спам.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ретрансляция почты может решить обе эти проблемы. Настроить ретрансляцию гораздо проще, чем полномасштабный сервер SMTP: вы просто направляете всю почту, сгенерированную вашим сервером, на управляемый профессионалами сервер SMTP. Таким образом, вам не придётся сталкиваться с трудностями SMTP.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Существует два типа ретрансляции: открытая и закрытая. Открытая ретрансляция направляет почту с внутреннего сервера и внешних ресурсов. Такой тип ретрансляции могут использовать в своих целях спам-боты. Закрытая ретрансляция подразумевает передачу только почты, сгенерированной на внутреннем сервере и в закрытой сети.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для ретрансляции почты можно использовать любой внешний SMTP-сервер. Сервер Mailgun имеет множество преимуществ над другими SMTP-серверами. Этот сервис можно использовать бесплатно до 10000 писем в месяц, он очень надёжен. Кроме того, он позволяет отправлять почту с отдельного домена, а это обеспечивает дополнительный уровень безопасности и спасает ваши письма от чёрных списков.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Данное руководство поможет вам создать бесплатный аккаунт Mailgun и поддомен, добавить все необходимые записи и настроить закрытую ретрансляцию почты с помощью Postfix.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Требования</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сервер Ubuntu 16.04 (инструкции по настройке сервера – <a href="https://www.8host.com/blog/nachalnaya-nastrojka-servera-ubuntu-16-04/"><span style=" text-decoration: underline; color:#0000ff;">здесь</span></a>).</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пользователь с доступом к sudo.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Зарегистрированный домен (в руководстве используется <a href="http://example.com"><span style=" text-decoration: underline; color:#0000ff;">example.com</span></a>).</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обычная учетная запись электронной почты (для тестирования).</li></ul>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">1: Учётная запись Mailgun</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создайте новую учётную запись, перейдя по <a href="https://mailgun.com/signup"><span style=" text-decoration: underline; color:#0000ff;">этой ссылке</span></a>. Войдите в новый аккаунт, откройте <a href="https://mailgun.com/app/dashboard"><span style=" text-decoration: underline; color:#0000ff;">панель </span></a>управления и выберите Domains.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы увидите, что сервис Mailgun создал для вас домен.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Не используйте этот домен. Лучше сразу создайте поддомен для Mailgun. Для этого нажмите на Add New Domain. Выберите поддомен для сервиса, например <a href="http://mailgun.example.com"><span style=" text-decoration: underline; color:#0000ff;">mailgun.example.com</span></a> или bulkemail.example.com.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Примечание</span>: В руководстве будет использоваться поддомен <a href="http://mg.example1.com"><span style=" text-decoration: underline; color:#0000ff;">mg.example1.com</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После этого новый поддомен появится в списке доменов на странице Domains. Откройте страницу поддомена, для этого кликните по нему на странице Domains. Вы увидите три набора DNS-записей.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Добавьте эти записи в настройки домена на сервере. Для этого используется панель управления хостинг-провайдера.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вам понадобятся записи для отправки и отслеживания почты (разделы Sending и Tracking). Записи для получения почты (Receiving) создавать не обязательно. Не закрывайте эту страницу: данные, указанные на ней нужно будет копировать в настройки DNS на сервере.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">2: Настройка DNS-записей</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итак, вам нужно создать две записи TXT и запись CNAME. Опционально можно добавить запись MX.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создайте все необходимые записи, используя предоставленную сервисом Mailgun информацию.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы создать CNAME:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Name: email</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Hostname: mailgun.org. (обязательно поставьте точку в конце).</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы создать первую записьTXT:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Name: @</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Text: введите текст для первой записи TXT, предоставленный Mailgun, и возьмите его в двойные кавычки. Например: «v=spf1 include:mailgun.org ~all».</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы создать вторую записьTXT:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Name: укажите выделенную жирным часть имени хоста со страницы Mailgun. Например: mallo._domainkey.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Text: скопируйте значение со страницы Mailgun и возьмите его в двойные кавычки. Например: «k=rsa; p=MIGfMA0G…AQAB».</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь Mailgun должен подтвердить ваш домен, прежде чем вы сможете продолжить. Вы можете подождать, пока обновятся записи DNS, или же вернуться на страницу Mailgun, найти раздел Domain Verification &amp; DNS и нажать Check DNS Records Now. После проверки записей рядом с ними появятся зелёные галочки.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обновление записей может занять некоторое время (от нескольких минут до нескольких часов).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Примечание</span>: Если сервис Mailgun не подтвердил ваши записи, проверьте введённые вами значения и убедитесь, что вы правильно указали все данные, предоставленные Mailgun. Записи TXT нужно брать в двойные кавычки. Имя первой записи TXT — @, но не hostname со страницы Mailgun.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ожидая проверки записей, вы можете просмотреть и скопировать учётные данные SMTP со страницы MailGun (они нужны для дальнейшей работы). Откройте раздел Domain Information. В строке Default SMTP Login вы найдёте имя, а в Default Password – пароль. Чтобы изменить эти значения, нажмите Manage SMTP credentials.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">3: Настройка Postfix</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для установки Postfix можно использовать встроенный менеджер пакетов.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Подключитесь к серверу как пользователь с доступом к sudo:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">ssh 8host@your_server_ip</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как правило, установка Postfix происходит в интерактивном режиме. Так программа может запросить у вас необходимые данные. Чтобы предотвратить ошибки во время установки, лучше настроить эти данные предварительно, а затем запустить установку.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Настройте Postfix как ретранслятор почты:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo debconf-set-selections &lt;&lt;&lt; &quot;postfix postfix/main_mailer_type select Satellite system&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Укажите имя хоста сервера (оно будет использоваться в качестве имени хоста почтового сервера):</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo debconf-set-selections &lt;&lt;&lt; &quot;postfix postfix/mailname string $HOSTNAME&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Настройте Postfix для использования SMTP-сервера Mailgun.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo debconf-set-selections &lt;&lt;&lt; &quot;postfix postfix/relayhost string smtp.mailgun.org&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь можно начать установку Postfix.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo apt -y install postfix</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы сервис Postfix мог подключиться к Mailgun, нужно создать файл с учётными данными и добавить в него скопированное имя и пароль Mailgun (раздел 2).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Примечание</span>: Каждый поддомен Mailgun использует уникальные учётные данные. Больше информации можно найти в <a href="https://help.mailgun.com/hc/en-us/articles/203380100-Where-can-I-find-my-API-key-and-SMTP-credentials"><span style=" text-decoration: underline; color:#0000ff;">документации Mailgun</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создайте и отредактируйте файл для учётных данных:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo nano /etc/postfix/sasl_passwd</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Добавьте в него строку:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">smtp.mailgun.org your_mailgun_smtp_user@your_subdomain_for_mailgun:your_mailgun_smtp_password</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ограничьте доступ к файлу. Право на чтение и запись могут быть только у пользователя root. Используйте команду postmap, чтобы обновить параметры Postfix.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo chmod 600 /etc/postfix/sasl_passwd<br />sudo postmap /etc/postfix/sasl_passwd</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Заблокируйте анонимный доступ к серверу и укажите файл с учётными данными для Mailgun. Откройте конфигурации Postfix:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo nano /etc/postfix/main.cf</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">И добавьте в файл такие строки:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">smtp_sasl_auth_enable = yes<br />smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd<br />smtp_sasl_security_options = noanonymous<br />smtp_sasl_tls_security_options = noanonymous<br />smtp_sasl_mechanism_filter = AUTH LOGIN</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Примечание</span>: Postfix предлагает множество настроек безопасности, которые блокирую доступ спам-ботам (больше информации – по <a href="http://www.postfix.org/SMTPD_ACCESS_README.html"><span style=" text-decoration: underline; color:#0000ff;">этой ссылке</span></a>). В частности, эти две строки ограничивают использование ретрансляции почты до локальной сети и указанных вам SASL-пользователей:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">smtpd_relay_restrictions = permit_mynetworks<br />permit_sasl_authenticated defer_unauth_destination</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перезапустите Postfix:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo systmctl restart postfix</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Также нужно убедиться, что все входящие порты SMTP заблокированы. Проверьте состояние брандмауэра:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo ufw status<br />To                         Action      From<br />--                         ------      ----<br />22                         ALLOW IN    Anywhere<br />22 (v6)                    ALLOW IN    Anywhere (v6)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В столбце To не должно быть портов 25, 465 и 587. Эти порты используются SMTP. На них не должен поступать входящий трафик. Если же эти порты открыты в брандмауэре, их нужно заблокировать.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Читайте также</span>: <a href="https://www.8host.com/blog/nastrojka-brandmauera-ufw-na-servere-ubuntu-14-04/"><span style=" text-decoration: underline; color:#0000ff;">Настройка брандмауэра UFW на сервере Ubuntu 14.04</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обычно при настройке SMTP на Postfix имя хоста сервера должно совпадать с <a href="https://ru.wikipedia.org/wiki/FQDN"><span style=" text-decoration: underline; color:#0000ff;">FQDN</span></a>. Если это так, пропустите раздел 4.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">4: Настройка отображения доменов</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поскольку для настройки SMTP используется Mailgun, а не Postfix, FQDN не должен совпадать с именем хоста. К примеру, серверы баз данных или мониторинговые серверы обычно вообще не имеют доменов.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создайте таблицу для отображения доменов, которая будет заменять один электронный адрес другим.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В данном случае почтовая учётная запись сервера Linux должна использовать имена MailGun.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создайте новый файл /etc/postfix/generic и отредактируйте его.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo nano /etc/postfix/generic</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Добавьте эту строку, которая свяжет следующие имена пользователей:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">8host@your_hostname sender@your_subdomain_for_mailgun</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Примечание</span>: Имена sender и 8host замените своими данными. Особенное внимание нужно уделить элементу your_subdomain_for_mailgun: его нужно заменить поддоменом Mailgun (раздел 1).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы указать несколько пользователей, добавьте в файл новый строки с таким же синтаксисом. Теперь добавьте эти правила отображения в Postfix с помощью команды postmap:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo postmap /etc/postfix/generic</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Отредактируйте конфигурационный файл Postfix:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo nano /etc/postfix/main.cf</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В конец файла добавьте строку:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">smtp_generic_maps = hash:/etc/postfix/generic</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перезапустите Postfix:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo systemctl restart postfix</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь можно протестировать ретрансляцию почты.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">5: Тестирование ретрансляции почты</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы протестировать настройку, отправьте с сервера сообщение на ваш личный адрес электронной почты. Установите mailutils, чтобы отправить тестовое письмо.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">sudo apt -y install mailutils</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">С помощью mailutils составьте и отправьте сообщение на ваш адрес электронной почты. Например:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">mail -s &quot;Test mail&quot; your_email_address &lt;&lt;&lt; &quot;A test message using Mailgun&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проверьте почтовый клиент и убедитесь, что вы получили сообщение. Если сообщение не пришло, читайте следующий раздел.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">6: Устранение неполадок</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Во время настройки ретрансляции можно допустить множество ошибок. Рассмотрим самые общие из них.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Во-первых, нужно убедиться, что Mailgun подтвердил DNS-записи. Ничего не будет работать до тех пор, пока сервис не примет новые записи. Откройте интерфейс пользователя Mailgun и убедитесь, что записи приняты.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Затем нужно проверить учётные данные в файле /etc/postfix/sasl_passwd. Указанные здесь имя и пароль должны совпадать с учётными данными соответствующего поддомена Mailgun. Не спутайте их с учётными данными аккаунта Mailgun.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Узнать больше об ошибках можно в логах почтового сервиса. Сначала проверьте /var/log/mail.log.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">tail -f /var/log/mail.log</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это выведет несколько последних строк лога. По мере появления в логе новых записей вывод будет обновляться. Просмотрите вывод на наличие сообщений об ошибках, которые могут помочь вам обнаружить проблему. Например, так выглядит сообщение о неправильном пароле Mailgun.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">&gt; Nov 1 16:07:45 cart-1268 postfix/smtp[30082]: 0E8062038A: to=&lt;yourmail@example.com&gt;, relay=smtp.mailgun.org[173.203.37.114]:25, delay=2.3, delays=0.02/0/2.3/0, dsn=4.7.0, status=deferred (SASL authentication failed; server smtp.mailgun.org[173.203.37.114] said: </span><span style=" font-family:'monospace'; color:#ff0000;">535 5.7.0 Mailgun is not loving your login or password</span><span style=" font-family:'monospace';">)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Также Mailgun регистрирует транзакции. Откройте панель управления Mailgun, выберите Logs и просмотрите содержимое на наличие ошибок. Возможно, здесь вы найдёте информацию о том, почему сообщение не было доставлено.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если имя хоста сервера не совпадает с FQDN, убедитесь, что вы правильно выполнили раздел 4.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Заключение</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если у вас есть дополнительные серверы, и вы хотели бы настроить их для отправки почты, нужно просто повторить разделы 3 и 4 на каждом таком сервере. Вы можете повторно использовать домен MailGun на всех этих серверах.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обычно на почтовых серверах используются два домена: один для внутренней почты, второй – для массовой рассылки сообщений. Внутренняя почта – это сообщения, отправленные с помощью одной из программ сервера (cron или WordPress). Массовая рассылка – это отправка сообщений на все почтовые адреса, состоящие в списке рассылки. Этот тип почты особенно часто попадает в черный список из-за спама, так что, вероятно, лучше использовать домен, который не страшно потерять, если он будет заблокирован.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Больше информации о рассылке можно найти <a href="http://blog.mailgun.com/art-of-inboxing/"><span style=" text-decoration: underline; color:#0000ff;">здесь</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы добавить ещё один домен, выполните разделы 1 и 2 (для каждого домена) и отредактируйте файлы /etc/postfix/sasl_passwd и /etc/postfix/generic. Базовая настройка Postfix остаётся без изменений. </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Tags: <a href="https://www.8host.com/blog/tag/dns/"><span style=" text-decoration: underline; color:#0000ff;">DNS</span></a>, <a href="https://www.8host.com/blog/tag/mailgun/"><span style=" text-decoration: underline; color:#0000ff;">Mailgun</span></a>, <a href="https://www.8host.com/blog/tag/postfix/"><span style=" text-decoration: underline; color:#0000ff;">Postfix</span></a>, <a href="https://www.8host.com/blog/tag/smtp/"><span style=" text-decoration: underline; color:#0000ff;">SMTP</span></a>, <a href="https://www.8host.com/blog/tag/ubuntu-16-04/"><span style=" text-decoration: underline; color:#0000ff;">Ubuntu 16.04</span></a></p></body></html>