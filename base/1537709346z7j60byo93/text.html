<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Arial'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Всемирно известная компания Microsoft отличается большой оригинальностью в области стандартов. Иначе как объяснить появление операционной системы, в которой кодировка имен файлов и кодировка консоли не совпадают?</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В русской редакции Windows есть следующая застарелая проблема: в качестве кодировки локали, а, следовательно, и кодировки имен файлов и директорий, принята кодировка CP 1251. Однако кодировкой консоли является CP 866. Как с этим жить в Qt?</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проблема в том, что в Qt5 не предусмотрено разделение на кодировку локали и кодировку консоли. Если в русскоязычной Windows выполнить следующий код:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">QTextCodec::setCodecForLocale(QTextCodec::codecForName(&quot;CP 866&quot;));</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">то после его выполнения вывод в консоль русских строк будет работать правильно. Вывод через <span style=" font-family:'Courier New'; color:#6a1009;">qDebug()</span>, <span style=" font-family:'Courier New'; color:#6a1009;">qInfo()</span>, <span style=" font-family:'Courier New'; color:#6a1009;">qWarning()</span><span style=" font-family:'DejaVu Sans';">, </span><span style=" font-family:'Courier New'; color:#6a1009;">qCritical()</span><span style=" font-family:'DejaVu Sans';">, </span><span style=" font-family:'Courier New'; color:#6a1009;">qFatal()</span> начнет работать сразу, без всяких ухищрений:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">qDebug() &lt;&lt; &quot;Привет&quot;;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">А вывод через <span style=" font-family:'Courier New'; color:#6a1009;">cout</span> нужно оформлять немного сложнее, учитывая что кодировка исходников UTF-8:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">cout &lt;&lt; QString::fromUtf8(&quot;Привет!&quot;).toLocal8Bit().data();</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В любом случае, в консоли станут появляться правильные русские символы.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Однако, все действия с файлами и директориями, в именах которых присутсвую русские символы, не будут работать в таких классах как <span style=" font-family:'Courier New'; color:#6a1009;">QFile</span> и <span style=" font-family:'Courier New'; color:#6a1009;">QDir</span>, если установлена кодировка CP 866. Да и низкоуровневые функции fopen() / fclose() тоже не смогут работать с русскоязычными именами файлов.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если же установить в программе кодек на кодировку 1251: </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">QTextCodec::setCodecForLocale(QTextCodec::codecForName(&quot;CP 1251&quot;));</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">то сразу заработают файловые операции через <span style=" font-family:'Courier New'; color:#6a1009;">QFile</span> и <span style=" font-family:'Courier New'; color:#6a1009;">QDir</span> над файлами и директориями, в именах которых присутствуют национальные русскоязычные символы. Функции fopen() / fclose() тоже заработают, если имена файлов указывать через <span style=" font-family:'Courier New'; color:#6a1009;">QString</span> методы <span style=" font-family:'Courier New'; color:#6a1009;">.toLocal8Bit().data()</span>.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проблема в том, что кодек локали в Qt всего один. И он глобальный, и устанавливается вызовом <span style=" font-family:'Courier New'; color:#6a1009;">QTextCodec::setCodecForLocale(имяКодека)</span>. В таких условиях невозможно одновременно работать с разными кодировками для локали и консоли. Что же делать?</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вариантов немного, и все они неудобные.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вариант 1. Забить на кодировку консоли. Выставить кодировку локали как CP 1251 и спокойно работать. Да, в консоль будут сыпаться кракозябры, но хотя бы весь функционал программы по работе с файлами будет нормально работать.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вариант 2. </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>