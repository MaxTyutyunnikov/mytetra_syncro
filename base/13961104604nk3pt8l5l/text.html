<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Использование </span><span style=" font-family:'FreeMono'; color:#6a1009;">mutable</span><span style=" font-size:10pt;"> – замечательное решение проблемы, когда побитовая константность вас не вполне устраивает, но оно не устраняет всех трудностей, связанных с </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;">. Например, представьте, что </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> в классе </span><span style=" font-family:'FreeMono'; color:#6a1009;">TextBlock</span><span style=" font-size:10pt;"> (и </span><span style=" font-family:'FreeMono'; color:#6a1009;">CTextBlock</span><span style=" font-size:10pt;">) не только возвращает ссылку на соответствующий символ, но также проверяет выход за пределы массива, протоколирует информацию о доступе и, возможно, даже проверяет целостность данных. Помещение всей этой логики в обе версии функции </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> – константную и неконстантную (даже если забыть, что теперь мы имеем необычно длинные встроенные функции – см. правило 30) – приводит к такому вот неуклюжему коду:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">class TextBlock {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">const char&amp; operator[](std::size_t position) const</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  ... // выполнить проверку границ массива</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  ... // протоколировать доступ к данным</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  ... // проверить целостность данных</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  return text[position];</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">char&amp; operator[](std::size_t position) const</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  ... // выполнить проверку границ массива</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  ... // протоколировать доступ к данным</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  ... // проверить целостность данных</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  return text[position];</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">private:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  std:string text;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Ох! Налицо все неприятности, связанные с </span><span style=" font-size:10pt; font-weight:600;">дублированием кода</span><span style=" font-size:10pt;">: увеличение времени компиляции, размера программы и неудобство сопровождения. Конечно, можно переместить весь код для проверки выхода за границы массива и прочего в отдельную функцию-член (естественно, закрытую), которую будут вызывать обе версии </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;">, но обращения к этой функции все же будут дублироваться.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">В действительности было бы желательно реализовать функциональность </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> один раз, а использовать в двух местах. То есть одна версия </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> должна вызывать другую. И это подводит нас к вопросу об отбрасывании константности.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">С самого начала отметим, отбрасывать константность нехорошо. Я посвятил целое правило 27 тому, чтобы убедить вас не делать этого, но дублирование кода – тоже не сахар. В данном случае константная версия </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> делает в точности то же самое, что неконстантная, и отличие между ними – лишь в присутствии модификатора const. В этой ситуации отбрасывать </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;"> безопасно, поскольку пользователь, вызывающий неконстантный </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;">, так или иначе должен получить неконстантный объект. Ведь в противном случае он не стал бы вызывать неконстантную функцию. Поэтому реализация неконстантного </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> путем вызова константной версии – это безопасный способ избежать дублирования кода, пусть даже для этого требуется воспользоваться оператором </span><span style=" font-family:'FreeMono'; color:#6a1009;">const_cast</span><span style=" font-size:10pt;">. Ниже приведен получающийся в результате код, но он станет яснее после того, как вы прочитаете следующие далее объяснения:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">class TextBlock {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  ...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  const char&amp; operator[](std::size_t position) const // то же, что и раньше</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">    ...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">    return text[position];</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  char&amp; operator[](std::size_t position) const // теперь просто вызываем const op[]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">    return const_cast&lt;char&amp;&gt;( // из возвращаемого типа op[] исключить const</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">      static_cast&lt;const TextBlock&amp;&gt;(*this) // добавить const типу *this</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">      [position] // вызвать константную версию op[]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">    );</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">  ...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; font-size:10pt; color:#6a0e07;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Как видите, код включает два приведения, а не одно. Мы хотим, чтобы неконстантный </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> вызывал константный, но если внутри неконстантного оператора </span><span style=" font-family:'FreeMono'; color:#6a1009;">[]</span><span style=" font-size:10pt;"> просто вызовем </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;">, то получится рекурсивный вызов. Во избежание бесконечной рекурсии нужно указать, что мы хотим вызвать </span><span style=" font-family:'FreeMono'; color:#6a1009;">const operator[]</span><span style=" font-size:10pt;">, но прямого способа сделать это не существует. Поэтому мы приводим </span><span style=" font-family:'FreeMono'; color:#6a1009;">*this</span><span style=" font-size:10pt;"> от типа </span><span style=" font-family:'FreeMono'; color:#6a1009;">TextBlock&amp;</span><span style=" font-size:10pt;"> к </span><span style=" font-family:'FreeMono'; color:#6a1009;">const TextBlock&amp;</span><span style=" font-size:10pt;">. Да, мы выполняем приведение, чтобы </span><span style=" font-size:10pt; font-style:italic;">добавить</span><span style=" font-size:10pt;"> константность! Таким образом, мы имеем два приведения: одно добавляет константность </span><span style=" font-family:'FreeMono'; color:#6a1009;">*this</span><span style=" font-size:10pt;"> (чтобы был вызван </span><span style=" font-family:'FreeMono'; color:#6a1009;">const operator[]</span><span style=" font-size:10pt;">), а второе – исключает </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;"> из типа возвращаемого значения.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Приведение, которое добавляет </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;">, выполняет безопасное преобразование (от неконстантного объекта к константному), поэтому мы используем для этой цели </span><span style=" font-family:'FreeMono'; color:#6a1009;">static_cast</span><span style=" font-size:10pt;">. Приведение же, которое отбрасывает </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;">, может быть выполнено только с помощью </span><span style=" font-family:'FreeMono'; color:#6a1009;">const_cast</span><span style=" font-size:10pt;">, поэтому у нас здесь нет выбора. (Строго говоря, выбор есть. Приведение в стиле C также работает, но, как я объясняю в правиле 27, такие приведения редко являются правильным рещением. Если вы не знакомы с операторами </span><span style=" font-family:'FreeMono'; color:#6a1009;">static_cast</span><span style=" font-size:10pt;"> или </span><span style=" font-family:'FreeMono'; color:#6a1009;">const_cast</span><span style=" font-size:10pt;">, прочитайте о них в правиле 27.)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Помимо всего прочего, в этом примере мы вызываем оператор, поэтому синтаксис выглядит немного странно. Возможно, этот код не займет приз на конкурсе красоты, зато позволяет достичь нужного эффекта – избежать дублирования посредством реализации неконстантной версии </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> в терминах константной. И хотя для достижения цели пришлось воспользоваться неуклюжим синтаксисом, который сможете понять только вы сами, однако техника реализации неконстантных функций-членов через неконстантные определенно заслуживает того, чтобы ее знать.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">А еще нужно иметь в виду, что решать эту задачу наоборот – путем вызова неконстантной версии из константной – неправильно. Помните, что константная функция-член обещает никогда не изменять логическое состояние объекта, а неконстантная не дает таких гарантий. Если вы вызовете неконстантную функцию из константной, то рискуете получить ситуацию, когда объект, который не должен модифицироваться, будет изменен. Вот почему этого не следует делать: чтобы объект не изменился. Фактически, чтобы получить компилируемый код, вам пришлось бы использовать const_cast для отбрасывания константности </span><span style=" font-family:'FreeMono'; color:#6a1009;">*this</span><span style=" font-size:10pt;">, а это явный признак неудачного решения. Обратная последовательность вызовов – такая, как описана выше, – безопасна. Неконстантная функция-член может делать все, что захочет с объектом, поэтому вызов из нее константной функции-члена ничем не грозит. Потому-то мы и применяем к </span><span style=" font-family:'FreeMono'; color:#6a1009;">*this</span><span style=" font-size:10pt;"> оператор </span><span style=" font-family:'FreeMono'; color:#6a1009;">static_cast</span><span style=" font-size:10pt;">, отбрасывания константности при этом не происходит.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Как я уже упоминал в начале этого правила, модификатор </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;"> – чудесная вещь. Для указателей и итераторов; для объектов, на которые ссылаются указатели, итераторы и ссылки; для параметров функций и возвращаемых ими значений; для локальных переменных, для функций-членов – всюду </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;"> ваш мощный союзник. Используйте его, где только возможно. Вам понравится!</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600; font-style:italic;">Что следует помнить</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">• Объявление чего-либо с модификатором </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;"> помогает компиляторам обнаруживать ошибки. </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;"> можно использовать с объектами в любой области действия, с параметрами функций и возвращаемых значений, а также с функциями-членами в целом.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">• Компиляторы проверяют побитовую константность, но вы должны программировать, применяя логическую константность.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">• Когда константные и неконстантные функции-члены имеют, по сути, одинаковую реализацию, то дублирования кода можно избежать, заставив неконстантную версию вызывать константную.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p></body></html>