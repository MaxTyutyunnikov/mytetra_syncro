<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Давайте возьмём пару от двух типов </span><span style=" font-family:'FreeMono'; color:#6a1009;">&lt;YourType, bool&gt;</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> — что вы можете сделать с композицией подобного рода?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В этой статье я расскажу вам про </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> — новый вспомогательный тип, добавленный в C++17. Это обёртка для вашего типа и флаг показывает, инициализировано ваше значение или нет. Давайте посмотрим, где это может быть полезно.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="vstuplenie"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">В</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ступление</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Добавлением логических флагов к другим типам вы можете достичь то, что называется &quot;Nullable типы&quot;. Как было сказано ранее, флаг используется для обозначения того, доступно значение или нет. Такая обёртка выразительно представляет объект, который может быть пустым (не через комментарии :).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Вы можете достигнуть пустого значения объекта с помощью использования уникальных идентификаторов (-1, бесконечность, </span><span style=" font-family:'FreeMono'; color:#6a1009;">nullptr</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), но это не так точно выражает мысль, как отдельный тип-обёртка. Вы даже можете использовать </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::unique_ptr&lt;Type&gt;</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и трактовать пустой указатель как неинициализированный объект — это сработает, но вместе с этим вы должны будете смириться с затратами на выделения памяти для объекта там, где в этом нет необходимости.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Опциональные типы — это то, что пришло из мира функционального программирования, принеся с собой безопасность типов и выразительность. Большинство других языков имеют что-то похожее: например </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::option</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в Rust, </span><span style=" font-family:'FreeMono'; color:#6a1009;">Optional&lt;T&gt;</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в Java, </span><span style=" font-family:'FreeMono'; color:#6a1009;">Data.Maybe</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в Haskell.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> был добавлен в C++17 из </span><span style=" font-family:'FreeMono'; color:#6a1009;">boost::optional</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, где был доступен многие годы. Начиная с C++17, вы можете просто написать </span><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;optional&gt;</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> для использования этого типа.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Этот тип является типом-значением (value-type) (таким образом, вы можете копировать его). Более того, для </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> не нужно отдельно выделять память.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> является частью </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">словарных типов C++</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> на ряду с </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::any</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::variant</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::string_view</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<h2 style="-qt-paragraph-type:empty; margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:x-large; font-weight:600;"><br /></h2>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="ispolzovanie"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">И</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">спользование</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Обычно, опциональный тип может быть использован в следующих сценариях:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вы хотите красиво представить nullable-тип.</li>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это лучше, чем использовать уникальные значения (например, <span style=" font-family:'FreeMono'; font-size:11pt; color:#6a1009;">-1</span>, <span style=" font-family:'FreeMono'; font-size:11pt; color:#6a1009;">nullptr</span>, <span style=" font-family:'FreeMono'; font-size:11pt; color:#6a1009;">NO_VALUE</span> или что-то подобное).</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Например, среднее имя пользователя является опциональным. Вы можете предположить, что пустой строки будет для этого достаточно, но может быть важно само понимание того, что пользователь что-то ввёл. С помощью <span style=" font-family:'FreeMono'; font-size:11pt; color:#6a1009;">std::optional&lt;std::string&gt;</span> вы сможете получить больше информации.</li></ul>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вернуть результат каких-либо вычислений, которые не смогли дать конечный результат, но это не является ошибкой.</li>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Например, поиск элемента в словаре: если нет элемента, соответствующего заданному ключу, то это не ошибка, но нам стоит обработать эту ситуацию.</li></ul>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для получения ресурсов с отложенной загрузкой.</li>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Например, если у какого-либо ресурса нет конструктора по умолчанию и конструирование объекта занимает довольно длительное время. Тогда вы можете объявить <span style=" font-family:'FreeMono'; font-size:11pt; color:#6a1009;">std::optional&lt;Resource&gt;</span>, и передать этот объект дальше системе, а выполнять загрузку уже позднее по необходимости.</li></ul>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы передать опциональные параметры в функции.</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Мне нравится определение опционального типа из </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">boost</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, которое подводит итог по тем ситуациям, когда нам следует его использовать. </span><a href="https://www.boost.org/doc/libs/1_67_0/libs/optional/doc/html/boost_optional/tutorial/when_to_use_optional.html"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">Из документации boost</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Шаблонный класс </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> управляет опциональным значением, т. е. значением, которое может быть представлено, а может и не быть.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обычным примером использования опционального типа данных является возвращаемое значение функции, которая может вернуть ошибочный результат в процессе выполнения. В отличии от других подходов, таких как <span style=" font-family:'FreeMono'; color:#6a1009;">std::pair&lt;T, bool&gt;</span>, опциональный тип данных хорошо управляется с тяжёлыми для конструирования объектами и является более читабельным, поскольку явно выражает намерения разработчика.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Хотя иногда тяжело решить, стоит ли использовать опциональный тип, вы точно не должны его использовать для обработки ошибок. Он лучше всего подходит для тех случаев, когда отсутствие значения является нормальным поведением программы.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="prostoy-primer"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">П</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ростой пример</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Ниже вы можете увидеть простой пример того, что можно сделать с использованием опционального типа:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional&lt;std::string&gt; UI::FindUserNick()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    if (nick_available)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        return { mStrNickName };</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    return std::nullopt; // То же самое, как если вернуть просто { };</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">// Использование:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional&lt;std::string&gt; UserNick = UI-&gt;FindUserNick();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">if (UserNick)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    Show(*UserNick);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В коде выше мы объявили функцию, которая возвращает опциональную строку. Если имя пользователя доступно, она вернёт строку. Если нет, то вернёт </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::nullopt</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Позже мы сможем присвоить это значение опциональному типу и проверить его (у </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> есть оператор приведения к типу </span><span style=" font-family:'FreeMono'; color:#6a1009;">bool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), содержит оно реальное значение или нет. Тип </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> также перегружает </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator*()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> для более простого доступа к содержащемуся значению.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В следующих параграфах вы сможете увидеть как создавать </span><span style=" font-family:'FreeMono'; color:#6a1009;">std::optional</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, работать с ним, передавать и даже его производительность, которую вам наверняка интересно увидеть.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p></body></html>