<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HUsingtheraspberrypiforvideomonitoring"></a><span style=" font-size:xx-large; font-weight:600;">U</span><span style=" font-size:xx-large; font-weight:600;">sing the raspberry pi for video monitoring</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The Raspberry PI is a good hardware for making a simple video monitoring device, such as watching at any time what's happening at home, if cats have enough to eat, chicken safe from fox attacks, or simply see at distance what's the weather like. The linphone console tools (<span style=" font-weight:600;">linphonec</span> and <span style=" font-weight:600;">linphone-daemon</span>) can be used to automatically accept a SIP call with video, so that it becomes possible from Linphone android or iOS app to call home at any time.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">From a hardware standpoint, <span style=" font-weight:600;">a raspberry pi2 is a minimum for a decent image quality</span>. Indeed, video software encoding is a cpu consuming task that a pi 1 can hardly achieve as it doesn't have the NEON (multimedia) instruction set.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The PI's camera has excellent quality, however plugging a USB camera can be more interesting as it will provide sound recording thanks to its integrated microphone, which the raspberry doesn't have.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">An ethernet connection is preferred, though wifi would work decently for video transmission as long as the raspberry is not too far from the wifi router.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Displaying the video received by the raspberry is out of this article's scope : we will just focus on the capture, sound and video, as well as the transmission via SIP to another SIP phone.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The following section explains how to setup the video monitoring on the raspberry pi. Several options are possible: </p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">use of the python wrapper</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">compilation on the raspberry to use linphone console tools directly</li></ul>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HPrequisites"></a><span style=" font-size:x-large; font-weight:600;">P</span><span style=" font-size:x-large; font-weight:600;">requisites</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">We recommend to use Raspbian, as a base installation to run linphone.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Since linphone heavily makes uses of dual-stack (ipv6 and ipv4) sockets, it is required to enable ipv6 on the raspberry by doing (as root):</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eeeeee;">echo ipv6 &gt;&gt; /etc/modules</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">And reboot.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">To be clear, there is absolutely no need to have an IPv6 connection, the concern is only to enable the IPv6 APIs of the kernel (which are compatible with IPv4 operation of course).</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HUsingthepythonwrappertodevelopasimplescript"></a><span style=" font-size:x-large; font-weight:600;">U</span><span style=" font-size:x-large; font-weight:600;">sing the python wrapper to develop a simple script</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">First of all, you need to install the python wrapper for liblinphone API on your raspberry. You can follow the Linux instructions (there are raspberry pi specifics) from this <a href="https://wiki.linphone.org/xwiki/wiki/public/view/Lib/Linphone%20Python%20Wrapper/"><span style=" text-decoration: underline; color:#0000ff;">page</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Here's a simple script (a bit more advanced than the sample from the Linphone Python Wrapper page).</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HDependencies"></a><span style=" font-size:large; font-weight:600;">D</span><span style=" font-size:large; font-weight:600;">ependencies</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">In addition to the linphone python wrapper, this script uses daemon, so you'll have to install it first:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">pip install python-daemon</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HCode"></a><span style=" font-size:large; font-weight:600;">C</span><span style=" font-size:large; font-weight:600;">ode</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Here are the features:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Obviously it will answer if it receives an incoming call from a whitelisted account ;</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">If you send it a SIP message, it will take a capture from the camera and send it back to you as a message with an attachement ;</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Everything will be logged into linphonecam.log.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#408080;">#!/usr/bin/env python</span><br /><span style=" color:#408080;"># -*- coding: utf-8 -*-</span><br /><br /><span style=" font-weight:600; color:#008000;">import</span> <span style=" font-weight:600; color:#0000ff;">linphone</span><br /><span style=" font-weight:600; color:#008000;">import</span> <span style=" font-weight:600; color:#0000ff;">logging</span><br /><span style=" font-weight:600; color:#008000;">import</span> <span style=" font-weight:600; color:#0000ff;">signal</span><br /><span style=" font-weight:600; color:#008000;">import</span> <span style=" font-weight:600; color:#0000ff;">time</span><br /><span style=" font-weight:600; color:#008000;">import</span> <span style=" font-weight:600; color:#0000ff;">daemon</span><br /><span style=" font-weight:600; color:#008000;">import</span> <span style=" font-weight:600; color:#0000ff;">os</span><br /><span style=" font-weight:600; color:#008000;">import</span> <span style=" font-weight:600; color:#0000ff;">sys</span><br /><br /><span style=" font-weight:600; color:#008000;">class</span> <span style=" font-weight:600; color:#0000ff;">SecurityCamera</span>:<br /> <span style=" font-weight:600; color:#008000;">def</span> <span style=" color:#0000ff;">__init__</span>(<span style=" color:#008000;">self</span>, whitelist<span style=" color:#666666;">=</span>[]):<br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>quit <span style=" color:#666666;">=</span> <span style=" color:#008000;">False</span><br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>whitelist <span style=" color:#666666;">=</span> whitelist<br /><br />    callbacks <span style=" color:#666666;">=</span> linphone<span style=" color:#666666;">.</span>Factory<span style=" color:#666666;">.</span>get()<span style=" color:#666666;">.</span>create_core_cbs()<br />    callbacks<span style=" color:#666666;">.</span>call_state_changed <span style=" color:#666666;">=</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>call_state_changed<br />    callbacks<span style=" color:#666666;">.</span>registration_state_changed <span style=" color:#666666;">=</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>call_state_changed<br />    callbacks<span style=" color:#666666;">.</span>message_received <span style=" color:#666666;">=</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>message_received<br /><br />    path <span style=" color:#666666;">=</span> os<span style=" color:#666666;">.</span>path<span style=" color:#666666;">.</span>dirname(os<span style=" color:#666666;">.</span>path<span style=" color:#666666;">.</span>abspath(__file__))<br />    logger <span style=" color:#666666;">=</span> logging<span style=" color:#666666;">.</span>getLogger()<br />    logger<span style=" color:#666666;">.</span>setLevel(logging<span style=" color:#666666;">.</span>INFO)<br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>logfile <span style=" color:#666666;">=</span> logging<span style=" color:#666666;">.</span>FileHandler(path <span style=" color:#666666;">+</span> <span style=" color:#ba2121;">'/linphonecam.log'</span>)<br />    logger<span style=" color:#666666;">.</span>addHandler(<span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>logfile)<br /><br />    signal<span style=" color:#666666;">.</span>signal(signal<span style=" color:#666666;">.</span>SIGINT, <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>signal_handler)<br />    linphone<span style=" color:#666666;">.</span>set_log_handler(<span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>log_handler)<br /><br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>quit_when_registered <span style=" color:#666666;">=</span> <span style=" color:#008000;">False</span><br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core <span style=" color:#666666;">=</span> linphone<span style=" color:#666666;">.</span>Factory<span style=" color:#666666;">.</span>get()<span style=" color:#666666;">.</span>create_core(callbacks, path <span style=" color:#666666;">+</span> <span style=" color:#ba2121;">'/config.rc'</span>, <span style=" color:#008000;">None</span>)<br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>path <span style=" color:#666666;">=</span> path<br /><br /> <span style=" font-weight:600; color:#008000;">def</span> <span style=" color:#0000ff;">signal_handler</span>(<span style=" color:#008000;">self</span>, signal, frame):<br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>terminate_all_calls()<br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>quit <span style=" color:#666666;">=</span> <span style=" color:#008000;">True</span><br /><br /> <span style=" font-weight:600; color:#008000;">def</span> <span style=" color:#0000ff;">log_handler</span>(<span style=" color:#008000;">self</span>, level, msg):<br />    method <span style=" color:#666666;">=</span> <span style=" color:#008000;">getattr</span>(logging, level)<br />    method(msg)<br /><br /> <span style=" font-weight:600; color:#008000;">def</span> <span style=" color:#0000ff;">registration_state_changed</span>(<span style=" color:#008000;">self</span>, core, proxy, state, message):<br />   <span style=" font-weight:600; color:#008000;">if</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>quit_when_registered:<br />     <span style=" font-weight:600; color:#008000;">if</span> state <span style=" color:#666666;">==</span> linphone<span style=" color:#666666;">.</span>RegistrationState<span style=" color:#666666;">.</span>Ok:<br />       <span style=" font-weight:600; color:#008000;">print</span> <span style=" color:#ba2121;">'Account configuration OK'</span><br />       <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>config<span style=" color:#666666;">.</span>sync()<br />       <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>quit <span style=" color:#666666;">=</span> <span style=" color:#008000;">True</span><br />     <span style=" font-weight:600; color:#008000;">elif</span> state <span style=" color:#666666;">==</span> linphone<span style=" color:#666666;">.</span>RegistrationState<span style=" color:#666666;">.</span>Failed:<br />       <span style=" font-weight:600; color:#008000;">print</span> <span style=" color:#ba2121;">'Account configuration failure: {0}'</span><span style=" color:#666666;">.</span>format(message)<br />       <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>quit <span style=" color:#666666;">=</span> <span style=" color:#008000;">True</span><br /><br /> <span style=" font-weight:600; color:#008000;">def</span> <span style=" color:#0000ff;">call_state_changed</span>(<span style=" color:#008000;">self</span>, core, call, state, message):<br />   <span style=" font-weight:600; color:#008000;">if</span> state <span style=" color:#666666;">==</span> linphone<span style=" color:#666666;">.</span>CallState<span style=" color:#666666;">.</span>IncomingReceived:<br />     <span style=" font-weight:600; color:#008000;">if</span> call<span style=" color:#666666;">.</span>remote_address<span style=" color:#666666;">.</span>as_string_uri_only() <span style=" font-weight:600; color:#aa22ff;">in</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>whitelist:<br />        params <span style=" color:#666666;">=</span> core<span style=" color:#666666;">.</span>create_call_params(call)<br />        core<span style=" color:#666666;">.</span>accept_call_with_params(call, params)<br />     <span style=" font-weight:600; color:#008000;">else</span>:<br />        core<span style=" color:#666666;">.</span>decline_call(call, linphone<span style=" color:#666666;">.</span>Reason<span style=" color:#666666;">.</span>Declined)<br /><br /> <span style=" font-weight:600; color:#008000;">def</span> <span style=" color:#0000ff;">message_received</span>(<span style=" color:#008000;">self</span>, core, room, message):<br />    sender <span style=" color:#666666;">=</span> message<span style=" color:#666666;">.</span>from_address<br />     <span style=" font-weight:600; color:#008000;">if</span> sender<span style=" color:#666666;">.</span>as_string_uri_only() <span style=" font-weight:600; color:#aa22ff;">in</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>whitelist:<br />        capture_file <span style=" color:#666666;">=</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>path <span style=" color:#666666;">+</span> <span style=" color:#ba2121;">'/capture.jpg'</span><br />       <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>take_preview_snapshot(capture_file)<br />        time<span style=" color:#666666;">.</span>sleep(<span style=" color:#666666;">2</span>)<br />        content <span style=" color:#666666;">=</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>create_content()<br />        content<span style=" color:#666666;">.</span>name <span style=" color:#666666;">=</span> <span style=" color:#ba2121;">'capture.jpg'</span><br />        capture <span style=" color:#666666;">=</span> <span style=" color:#008000;">open</span>(capture_file, <span style=" color:#ba2121;">'rb'</span>)<br />        content<span style=" color:#666666;">.</span>buffer <span style=" color:#666666;">=</span> <span style=" color:#008000;">bytearray</span>(capture<span style=" color:#666666;">.</span>read())<br />        msg <span style=" color:#666666;">=</span> room<span style=" color:#666666;">.</span>create_file_transfer_message(content)<br />        room<span style=" color:#666666;">.</span>send_chat_message(msg)<br />   <br /> <span style=" font-weight:600; color:#008000;">def</span> <span style=" color:#0000ff;">configure_sip_account</span>(<span style=" color:#008000;">self</span>, username, password):<br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>quit_when_registered <span style=" color:#666666;">=</span> <span style=" color:#008000;">True</span><br /> <br />    proxy_cfg <span style=" color:#666666;">=</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>create_proxy_config()<br />    proxy_cfg<span style=" color:#666666;">.</span>identity_address <span style=" color:#666666;">=</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>create_address(<span style=" color:#ba2121;">'sip:{username}@sip.linphone.org'</span><span style=" color:#666666;">.</span>format(username<span style=" color:#666666;">=</span>username))<br />    proxy_cfg<span style=" color:#666666;">.</span>server_addr <span style=" color:#666666;">=</span> <span style=" color:#ba2121;">'sip:sip.linphone.org;transport=tls'</span><br />    proxy_cfg<span style=" color:#666666;">.</span>register_enabled <span style=" color:#666666;">=</span> <span style=" color:#008000;">True</span><br />    proxy_cfg<span style=" color:#666666;">.</span>avpf_mode <span style=" color:#666666;">=</span> <span style=" color:#666666;">1</span><br />    proxy_cfg<span style=" color:#666666;">.</span>publish_enabled <span style=" color:#666666;">=</span> <span style=" color:#008000;">True</span><br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>add_proxy_config(proxy_cfg)<br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>default_proxy_config <span style=" color:#666666;">=</span> proxy_cfg<br /> <br />    auth_info <span style=" color:#666666;">=</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>create_auth_info(username, <span style=" color:#008000;">None</span>, password, <span style=" color:#008000;">None</span>, <span style=" color:#008000;">None</span>, <span style=" color:#ba2121;">'sip.linphone.org'</span>)<br />   <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>add_auth_info(auth_info)<br />   <br /> <span style=" font-weight:600; color:#008000;">def</span> <span style=" color:#0000ff;">run</span>(<span style=" color:#008000;">self</span>):<br />   <span style=" font-weight:600; color:#008000;">while</span> <span style=" font-weight:600; color:#aa22ff;">not</span> <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>quit:<br />     <span style=" color:#008000;">self</span><span style=" color:#666666;">.</span>core<span style=" color:#666666;">.</span>iterate()<br />      time<span style=" color:#666666;">.</span>sleep(<span style=" color:#666666;">0.03</span>)<br /><br /><span style=" font-weight:600; color:#008000;">if</span> __name__ <span style=" color:#666666;">==</span> <span style=" color:#ba2121;">'__main__'</span>:<br />  cam <span style=" color:#666666;">=</span> SecurityCamera(whitelist<span style=" color:#666666;">=</span>[<span style=" color:#ba2121;">''</span>])<br /> <span style=" font-weight:600; color:#008000;">if</span> <span style=" color:#008000;">len</span>(sys<span style=" color:#666666;">.</span>argv) <span style=" color:#666666;">==</span> <span style=" color:#666666;">4</span> <span style=" font-weight:600; color:#aa22ff;">and</span> sys<span style=" color:#666666;">.</span>argv[<span style=" color:#666666;">1</span>] <span style=" color:#666666;">==</span> <span style=" color:#ba2121;">'configure_account'</span>:<br />    cam<span style=" color:#666666;">.</span>configure_sip_account(sys<span style=" color:#666666;">.</span>argv[<span style=" color:#666666;">2</span>], sys<span style=" color:#666666;">.</span>argv[<span style=" color:#666666;">3</span>])<br />    cam<span style=" color:#666666;">.</span>run()<br /> <span style=" font-weight:600; color:#008000;">else</span>:<br />    context <span style=" color:#666666;">=</span> daemon<span style=" color:#666666;">.</span>DaemonContext(files_preserve <span style=" color:#666666;">=</span> [ cam<span style=" color:#666666;">.</span>logfile<span style=" color:#666666;">.</span>stream, ],)<br />    context<span style=" color:#666666;">.</span>open()<br />    cam<span style=" color:#666666;">.</span>run()</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HHowtouseit"></a><span style=" font-size:large; font-weight:600;">H</span><span style=" font-size:large; font-weight:600;">ow to use it</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">First of all, edit the script itself to set which account will be allowed to call your raspberry. For example, I'll allow myself:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">cam <span style=" color:#666666;">=</span> SecurityCamera(whitelist<span style=" color:#666666;">=</span>[<span style=" color:#ba2121;">'sip:sylvain.berfini@sip.linphone.org'</span>])</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The script simplifies the configuration of the Linphone SIP account you'll use to contact your raspberry-pi. To configure the account, use the following command:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">./linphonecam.py configure_account &lt;username&gt; &lt;password&gt;</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">If you don't have yet a Linphone SIP account, you can create one for free at <a href="https://www.linphone.org/free-sip-service.html"><span style=" text-decoration: underline; color:#0000ff;">https://www.linphone.org/free-sip-service.html</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">You're good to go, just call the account used to on the previous configuration step using a Linphone application (or another SIP client) on which you have your whitelisted account configured on:</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HAutomaticstartatboot"></a><span style=" font-size:large; font-weight:600;">A</span><span style=" font-size:large; font-weight:600;">utomatic start at boot</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">If you want your daemon to be started automatically when your raspberry pi boots, you can use the following script:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo cp linphonecam /etc/init.d/</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Adjust the DIR accordingly (and possibly some other values depending on the name you gave the script):</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#408080;"># Provides:          linphonecam<br /># Required-Start:    $remote_fs $syslog<br /># Required-Stop:     $remote_fs $syslog<br /># Default-Start:     2 3 4 5<br /># Default-Stop:      0 1 6<br /># Short-Description: Surveillance camera using Linphone<br /># Description:       Linphonecam allows you to use your device as a surveillance camera using Linphone<br />### END INIT INFO<br /></span><br /><span style=" color:#408080;"># Change the next 3 lines to suit where you install your script and what you want to call it<br /></span><span style=" color:#19177c;">DIR</span><span style=" color:#666666;">=</span>/home/pi/linphonecam<br /><span style=" color:#19177c;">DAEMON</span><span style=" color:#666666;">=</span><span style=" color:#19177c;">$DIR</span>/linphonecam.py<br /><span style=" color:#19177c;">DAEMON_NAME</span><span style=" color:#666666;">=</span>linphonecam<br /><br /><span style=" color:#408080;"># Add any command line options for your daemon here<br /></span><span style=" color:#19177c;">DAEMON_OPTS</span><span style=" color:#666666;">=</span><span style=" color:#ba2121;">&quot;&quot;</span><br /><br /><span style=" color:#408080;"># This next line determines what user the script runs as.<br /># Root generally not recommended but necessary if you are using the Raspberry Pi GPIO from Python.<br /></span><span style=" color:#19177c;">DAEMON_USER</span><span style=" color:#666666;">=</span>pi<br /><br /><span style=" color:#408080;"># The process ID of the script when it runs is stored here:<br /></span><span style=" color:#19177c;">PIDFILE</span><span style=" color:#666666;">=</span>/var/run/<span style=" color:#19177c;">$DAEMON_NAME</span>.pid<br /><br />. /lib/lsb/init-functions<br /><br />do_start <span style=" color:#666666;">()</span> <span style=" color:#666666;">{</span><br />    log_daemon_msg <span style=" color:#ba2121;">&quot;Starting system </span><span style=" color:#19177c;">$DAEMON_NAME</span><span style=" color:#ba2121;"> daemon&quot;</span><br />    start-stop-daemon --start --background --pidfile <span style=" color:#19177c;">$PIDFILE</span> --make-pidfile --user <span style=" color:#19177c;">$DAEMON_USER</span> --chuid <span style=" color:#19177c;">$DAEMON_USER</span> --startas <span style=" color:#19177c;">$DAEMON</span> -- <span style=" color:#19177c;">$DAEMON_OPTS</span><br />    log_end_msg <span style=" color:#19177c;">$?</span><br /><span style=" color:#666666;">}</span><br />do_stop <span style=" color:#666666;">()</span> <span style=" color:#666666;">{</span><br />    log_daemon_msg <span style=" color:#ba2121;">&quot;Stopping system </span><span style=" color:#19177c;">$DAEMON_NAME</span><span style=" color:#ba2121;"> daemon&quot;</span><br />    start-stop-daemon --stop --pidfile <span style=" color:#19177c;">$PIDFILE</span> --retry 10<br />    log_end_msg <span style=" color:#19177c;">$?</span><br /><span style=" color:#666666;">}</span><br /><br /><span style=" font-weight:600; color:#008000;">case</span> <span style=" color:#ba2121;">&quot;</span><span style=" color:#19177c;">$1</span><span style=" color:#ba2121;">&quot;</span> in<br /><br />    start|stop<span style=" color:#666666;">)</span><br />        do_<span style=" font-weight:600; color:#bb6688;">${</span><span style=" color:#19177c;">1</span><span style=" font-weight:600; color:#bb6688;">}</span><br />        ;;<br /><br />    restart|reload|force-reload<span style=" color:#666666;">)</span><br />        do_stop<br />        do_start<br />        ;;<br /><br />    status<span style=" color:#666666;">)</span><br />        status_of_proc <span style=" color:#ba2121;">&quot;</span><span style=" color:#19177c;">$DAEMON_NAME</span><span style=" color:#ba2121;">&quot;</span> <span style=" color:#ba2121;">&quot;</span><span style=" color:#19177c;">$DAEMON</span><span style=" color:#ba2121;">&quot;</span> <span style=" color:#666666;">&amp;&amp;</span> <span style=" color:#008000;">exit</span> <span style=" color:#666666;">0</span> <span style=" color:#666666;">||</span> <span style=" color:#008000;">exit</span> <span style=" color:#19177c;">$?</span><br />        ;;<br /><br />    *<span style=" color:#666666;">)</span><br />       <span style=" color:#008000;">echo</span> <span style=" color:#ba2121;">&quot;Usage: /etc/init.d/</span><span style=" color:#19177c;">$DAEMON_NAME</span><span style=" color:#ba2121;"> {start|stop|restart|status}&quot;</span><br />       <span style=" color:#008000;">exit</span> 1<br />        ;;<br /><br /><span style=" font-weight:600; color:#008000;">esac</span><br /><span style=" color:#008000;">exit</span> 0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Finally, apply the changes:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo update-rc.d linphonecam defaults</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="H"></a><span style=" font-size:x-large; font-weight:600;">C</span><span style=" font-size:x-large; font-weight:600;">ompiling linphone on the rasberry pi</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">This procedure is for using the linphone console tools (linphonec, linphonecsh or linphone-daemon) on the raspberry pi.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">It assumes that the raspberry pi is installed with a Raspbian image</span>. </p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Install build dependencies from raspbian repositories</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo apt-get install cmake automake autoconf libtool intltool yasm libasound2-dev libpulse-dev libv4l-dev nasm git libglew-dev</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Clone the linphone-desktop git repository. This repository comprises the linphone source code plus all required dependencies, with an overall build script that builds everything in order.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">git clone git://git.linphone.org/linphone-desktop.git --recursive</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Setup compilation options for the whole linphone-desktop project. The line below sets options for a minimal linphone build, without graphical user interface.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#008000;">cd</span> linphone-desktop<br />./prepare.py no-ui -DENABLE_OPENH264<span style=" color:#666666;">=</span>ON -DENABLE_WEBRTC_AEC<span style=" color:#666666;">=</span>OFF -DENABLE_UNIT_TESTS<span style=" color:#666666;">=</span>OFF -DENABLE_MKV<span style=" color:#666666;">=</span>OFF -DENABLE_FFMPEG<span style=" color:#666666;">=</span>ON -DENABLE_CXX_WRAPPER<span style=" color:#666666;">=</span>OFF -DENABLE_NON_FREE_CODECS<span style=" color:#666666;">=</span>ON -DENABLE_VCARD<span style=" color:#666666;">=</span>OFF -DENABLE_BV16<span style=" color:#666666;">=</span>OFF -DENABLE_V4L<span style=" color:#666666;">=</span>OFF</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Now proceed with the compilation. This step may take around half an hour and will warm the raspberry !</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">make -j4</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Once completed, the output executables are in OUTPUT/no-ui/bin. The intermediate compilation products are all located in the WORK directory, that you can safely remove. Should any compilation problem happen, in order to restart the compilation from the beginning, removing the WORK directory is sufficient.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Now the software is ready to be used !</span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HConfiguration"></a><span style=" font-size:large; font-weight:600;">C</span><span style=" font-size:large; font-weight:600;">onfiguration</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">First run <span style=" font-style:italic;">linphonec</span> once in order to configure your SIP account, so that you can place calls to your raspberry from another place (typically the linphone app on android or iOS!). We recommend to use our free sip.linphone.org service, on which accounts can be created <a href="https://www.linphone.org/free-sip-service.html"><span style=" text-decoration: underline; color:#0000ff;">using this online form</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eeeeee;">cd OUTPUT/no-ui/bin</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">./linphonec</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[.....]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">linphonec&gt; proxy add</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[…enter sip account configuration.<br />We recommend to set proxy address to &lt;sip:sip.linphone.org;transport=tls&gt;<br />Once done, you should be prompted for your sip account password, and then it should indicate that it is successfully registered. ]<br />quit</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">You may also, within the linphonec command prompt, set the sound card to use for capturing sound. The raspberry-pi has no microphone, but if your plan is to plug a USB camera onto the raspberry pi, it probably has a built-in microphone. To tell linphonec to use the microphone from the usb camera, use the &quot;soundcard list&quot; and &quot;soundcard use&quot; commands to select the sound card index to use.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Now open <span style=" font-style:italic;">~/.linphonerc</span> file with an editor (vim, nano...) in order to tweak a few things:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">In section [sound], set</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eeeeee;">echocancellation=0</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Indeed, echo cancellation is not needed, our raspberry pi has no speaker. No need to spend cpu cycles on this.</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">In section [video], set vga video size to achieve decent quality, compatible with the pi's processing capabilities:</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eeeeee;">size=vga</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">720p is also possible but the pi2 cpu is a bit too slow for this image format with VP8 codec. svga tends to work not so bad as well.</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Turn on ICE, in section [net] section:</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eeeeee;">stun_server=stun.linphone.org<br />firewall_policy=3</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HStartinglinphonec"></a><span style=" font-size:large; font-weight:600;">S</span><span style=" font-size:large; font-weight:600;">tarting linphonec</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">You can then launch linphonec in background mode in with auto-answer mode. We assume the current directory is already in the OUTPUT/no-ui/bin directory.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#008000;">export</span> <span style=" color:#19177c;">PATH</span><span style=" color:#666666;">=</span><span style=" color:#19177c;">$PATH</span>:<span style=" color:#ba2121;">`</span><span style=" color:#008000;">pwd</span><span style=" color:#ba2121;">`</span><br />linphonecsh init -a -C -c ~/.linphonerc -d <span style=" color:#666666;">6</span> -l /tmp/log.txt</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Notice the &quot;-d 6 -l /tmp/log.txt&quot; which are there to tell linphonec to output all debug messages into /tmp/log.txt. Looking into this file might be useful should any trouble arrive.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">To stop it, do:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">linphonecsh exit</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HAutomaticstartatboot-1"></a><span style=" font-size:large; font-weight:600;">A</span><span style=" font-size:large; font-weight:600;">utomatic start at boot</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">In order to have linphonec automatically started when the raspberry boots: you can add this line to /etc/rc.local :</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#008000;">export</span> <span style=" color:#19177c;">PATH</span><span style=" color:#666666;">=</span>/home/pi/linphone-desktop/OUTPUT/no-ui/bin:<span style=" color:#19177c;">$PATH</span><br />sudo -u pi linphonecsh init -a -C -c /home/pi/.linphonerc -d <span style=" color:#666666;">6</span> -l /tmp/log.txt</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The lines above assume that your linphone-desktop source tree is in /home/pi/linphone-desktop. Please adapt if it is not the case.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Just a final reboot and now you can place calls from your favourite linphone app (mobile or desktop) to your raspberry, by calling its sip address !</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HCommonhardwareproblems"></a><span style=" font-size:large; font-weight:600;">C</span><span style=" font-size:large; font-weight:600;">ommon hardware problems</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">If you are using the RaspberryPi Camera, you'll notice it won't show up as a /dev/video entry, thus it won't be available in linphone for use. To fix that, use the following:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">first enable the camera thanks to the raspi-config utility included in your raspberry.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">tell the raspberry to load the driver specific to the raspberry camera and do it automatically and next reboot:</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo bash<br />modprobe bcm2835-v4l2<br />echo &quot;bcm2835-v4l2&quot; &gt;&gt; /etc/modules<br />exit</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="HSadly2Ctheraspberryloosingthenetworkconnectivityisafrequentoccurrence.Unfortunately2CallthatNetworkManagerstuffincludedwithRaspbianwasdesignedforLinuxworkstationorservers2Candisnotrobusttotemporarynetworkconnectivitylosses.Theyhappenquitefrequentlybecauseofvariousreasons:"></a>Sadly, the raspberry loosing the network connectivity is a frequent occurrence. Unfortunately, all that NetworkManager stuff included with Raspbian was designed for Linux workstation or servers, and  is not robust to temporary network connectivity losses. They happen quite frequently because of various reasons:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The internet box looses DSL connection and reboots</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The wifi signal is lost temporarily due to interferences</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The wifi driver has bugs and looses connection after some hours</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The house general power shuts down and comes back due to a thunderstorm, but the raspberry starts faster than the DSL box and will have no internet at boot time.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">I recommend to plug the DSL box onto a programable power timer so that it is restarted every day : indeed it is not so rare that a DSL box hangs forever and needs a manual reboot.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">In order to force the raspberry to check the network periodically and force a re-connection, I suggest these two scripts, that can be invoked periodically from cron daemon:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The first one called &quot;restart_wlan0_if_necessary.sh&quot;. It just tries a ping to linphone.org, and in absence of response, trigers a shutdown/restart of the wlan0 network interface.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#408080;">#!/bin/sh<br /></span>date<br /><span style=" font-weight:600; color:#008000;">if</span> <span style=" color:#008000;">test</span> -z <span style=" color:#ba2121;">&quot;`ping -w 5 linphone.org |grep time`&quot;</span> ; <span style=" font-weight:600; color:#008000;">then</span> <br />       <span style=" color:#008000;">echo</span> <span style=" color:#ba2121;">&quot;broken connection, restarting wlan0 now&quot;</span><br />        /sbin/ifdown wlan0<br />        sleep 1<br />        /sbin/ifup wlan0<br />       <span style=" color:#008000;">echo</span> <span style=" color:#ba2121;">&quot;wlan0 restarted.&quot;</span><br /><span style=" font-weight:600; color:#008000;">else</span><br />       <span style=" color:#008000;">echo</span> <span style=" color:#ba2121;">&quot;Everything ok with network.&quot;</span><br /><span style=" font-weight:600; color:#008000;">fi</span><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The second one, called &quot;reboot_if_necessary.sh&quot;. Its goal is to reboot the raspberry if network is still not working, which is the case when the wifi driver or hardware has entered an irrecoverabilly corrupted state.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Sadly, the wifi devices and drivers are generally so bad in terms of robustness, that this kind of trick is necessary.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#408080;">#!/bin/sh<br /></span>date<br /><span style=" font-weight:600; color:#008000;">if</span> <span style=" color:#008000;">test</span> -z <span style=" color:#ba2121;">&quot;`ping -w 5 linphone.org |grep time`&quot;</span> ; <span style=" font-weight:600; color:#008000;">then</span><br />       <span style=" color:#008000;">echo</span> <span style=" color:#ba2121;">&quot;broken connection, rebooting now&quot;</span><br />        /sbin/reboot<br /><span style=" font-weight:600; color:#008000;">else</span><br />       <span style=" color:#008000;">echo</span> <span style=" color:#ba2121;">&quot;Everything ok with network.&quot;</span><br /><span style=" font-weight:600; color:#008000;">fi</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">And here's the crontab file:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">5 12 * * *       /home/pi/reboot_if_necessary &gt;&gt; /home/pi/reboots.log 2&gt;&amp;1<br />0 *  * * *       /home/pi/restart_wlan0_if_necessary.sh &gt;&gt; /home/pi/restarts.log 2&gt;&amp;1<br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Use <span style=" font-style:italic;">sudo crontab -e</span> to write these lines aboves.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">This will schedule restart_wlan0_if_necessary.sh every hour, and reboot_if_necessary every day at 12:05.</p></body></html>