<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Данное руководство поможет подготовить автоматизированную оркестровку сервера с помощью инструмента конфигурационного управления Ansible. Вы ознакомитесь с основными терминами, синтаксисом и функциями Ansible. В результате вы получите полностью автоматизированное простое развёртывание, которое состоит из таких этапов:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обновление индекса пакетов.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Установка Apache.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создание пользовательского каталога document root.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создание в нём файла index.html.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Применение шаблона для установки пользовательского виртуального хоста.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перезапуск Apache.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Примечание</span><span style=" font-family:'Sans'; font-size:10pt;">: Данное руководство сосредоточено на создании плейбуков – сценариев Ansible для автоматизации настройки. Больше о терминологии Ansible можно прочитать </span><a href="https://www.8host.com/blog/ustanovka-i-nastrojka-ansible-v-ubuntu-14-04/"><span style=" font-family:'Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">здесь</span></a><span style=" font-family:'Sans'; font-size:10pt;">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans';">Внимение! Все примеры конфигураций в этой статье имеют нарушенную структуру отступов. При воспроизведении примеров нужно учитывать синтаксис YAML.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans';"><br /></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Начало работы</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Прежде чем приступить к разработке плейбука, нужно ознакомиться с основными терминами Ansible.</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="aswift_0_expand"></a><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Т</span><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">ерминология Ansible</span></h3>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Контроллер: машина, на которую установлен сервер Ansible.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Инвентарь: INI-файл, в котором хранится информация о ведомых серверах.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Плейбук: точка входа для оркестровки Ansible, сценарий, в котором определены параметры машины, которую нужно настроить.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задача: блок, который определяет одну процедуру, которую нужно выполнить (например, установка пакета).</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Модуль: инструмент, который берёт на себя какую-либо задачу системы (например, управление пакетами или создание и изменение файлов). Ansible предлагает множество встроенных модулей, но вы также можете создавать новые пользовательские модули.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Роль: предопределённый способ организации плейбуков и других файлов, позволяющий совместно и повторно использовать фрагменты настроек.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Плей: процесс оркестровки от начала до конца.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Факты: глобальные переменные системы.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обработчики: изменяют статус сервиса (запуск, остановка и т.д.).</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Оркестровка Ansible пишется на простом языке сериализации данных YAML.</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Задачи</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Каждая задача определяет один шаг оркестровки. Как правило, в задачах используются модули или простые команды. Задача выглядит так:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: This is a task<br />apt: pkg=vim state=latest</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Элемент name опционален, но его рекомендуется использовать, так как он отображает в выводе имя задачи, которая была выполнена. Элемент apt – это встроенный модуль Ansible, который управляет пакетами в Debian-подобных дистрибутивах. Эта задача задаёт пакету vim состояние latest, что заставит менеджер пакетов установить этот пакет в случае, если он еще не установлен.</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Формат плейбуков</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Плейбуки – точка входа для оркестровки Ansible. Они содержат данные о системах, в которых будет происходить оркестровка, а также все директивы и команды, которые нужно выполнить. Ниже можно найти пример простого плейбука, который обновляет индекс пакетов и устанавливает vim:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">---<br />- hosts: all<br />become: true<br />tasks:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: Update apt-cache<br />apt: update_cache=yes<br />- name: Install Vim<br />apt: name=vim state=latest</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">YAML сериализует структуры данных, потому очень важно проследить, чтобы все пробелы и абзацы были на месте.</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Написание плейбука</span></h2>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Переменные</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Ansible задаёт переменные несколькими способами. Самый простой из них – использование раздела vars самого плейбука. Ниже показано, как определить переменную package внутри задачи:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">---<br />- hosts: all<br />become: true<br />vars:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">package: vim</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">tasks:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: Install Package<br />apt: name={{ package }} state=latest</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Переменная package доступна из любой точки оркестровки (даже в добавленных файлах и шаблонах).</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Использование циклов</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Циклы, как правило, используются для повторения задачи с помощью различных входных значений. То есть, вместо того чтобы создавать 10 задач для установки 10 различных пакетов, вы можете создать одну задачу и использовать цикл, чтобы  повторить задачу для установки любых пакетов, которые нужно установить.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Чтобы создать цикл в задаче, добавьте опцию with_items и массив значений. Доступ к контенту можно получить с помощью переменной item. Например:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: Install Packages<br />apt: name={{ item }} state=latest<br />with_items:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- vim<br />- git<br />- curl</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Также можно использовать массив переменных, чтобы определить компоненты:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">---<br />- hosts: all<br />sudo: true<br />vars:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">packages: [ 'vim', 'git', 'curl' ]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">tasks:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: Install Package<br />apt: name={{ item }} state=latest<br />with_items: packages</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Использование условных выражений</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Условные выражения можно использовать для динамической настройки (например, когда на основе переменной или вывода команды нужно решить, следует ли выполнять задачу).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Ниже показан пример задачи, которая будет выполнена только в системах на основе Debian.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: Shutdown Debian Based Systems<br />command: /sbin/shutdown -t now<br />when: ansible_os_family == &quot;Debian&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Условное выражение when принимает в качестве аргумента выражение, которое нужно оценить. Задача будет выполнена только в том случае, если выражение истинно (true).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Условные выражения часто используются в IT-автоматизации, если выполнение задачи зависит от вывода команды. В Ansible условные выражения внедряются путем добавления переменной для хранения результатов выполненной команды и проверки этой переменной в следующей задаче. Вы можете проверить состояние выхода команды (успешно она выполнена или нет) и наличие в нем конкретного фрагмента (хотя для этого может потребоваться использование регулярных выражений).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">В приведённом ниже примере показаны две условные задачи, чьё выполнение зависит от вывода команды php –v. Данный код проверяет состояние вывода команды, поскольку она не будет выполнена в случае, если PHP не установлен на этот сервер. Раздел задачи ignore_errors позволяет продолжить оркестровку, даже если команду выполнить не удалось.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: Check if PHP is installed<br />register: php_installed<br />command: php -v<br />ignore_errors: true<br />- name: This task is only executed if PHP is installed<br />debug: var=php_install<br />when: php_installed|success<br />- name: This task is only executed if PHP is NOT installed<br />debug: msg='PHP is NOT installed'<br />when: php_installed|failed</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Модуль debug позволяет просмотреть содержимое переменных или отладочные сообщения. Он может вывести строку (при использовании аргумента msg) или содержимое переменной (с помощью аргумента var).</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Использование шаблонов</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Шаблоны обычно используются в конфигурационных файлах и позволяют добавлять переменные и другие функции, которые делают эти файлы более универсальными и обеспечивают их повторное выполнение. Ansible использует механизм шаблонов </span><a href="http://jinja.pocoo.org/docs/dev/"><span style=" font-family:'Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Jinja2</span></a><span style=" font-family:'Sans'; font-size:10pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Ниже приведен пример шаблона для создания виртуального хоста Apache, в котором используется переменная для создания корневого каталога этого хоста:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">&lt;VirtualHost *:80&gt;<br />ServerAdmin webmaster@localhost<br />DocumentRoot {{ doc_root }}<br />&lt;Directory {{ doc_root }}&gt;<br />AllowOverride All<br />Require all granted<br />&lt;/Directory&gt;<br />&lt;/VirtualHost&gt;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Встроенный модуль template позволяет применить шаблон задачи. Если назвать файл шаблона в примере vhost.tpl и поместить его в один каталог с плейбуком, такой шаблон заменит виртуальный хост Apache по умолчанию:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: Change default Apache virtual host<br />template: src=vhost.tpl dest=/etc/apache2/sites-available/000-default.conf</span></p>
<h3 style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Определение обработчиков</span></h3>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Обработчики изменяют состояние сервиса (например, останавливают или перезапускают его). Обработчики очень похожи на задачи, которые выполняются один раз и в том же порядке, в каком они определены; однако они выполняются только в том случае, если ранее в задаче срабатывает директива notify. Обработчики обычно определяются как массив в разделе плейбука handlers.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Рассмотрим предыдущий пример шаблона, который предназначен для создания виртуального хоста Apache. Чтобы обеспечить перезагрузку Apache после изменения виртуального хоста, нужно создать обработчик для этого сервиса. Это делается так:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">handlers:<br />- name: restart apache<br />service: name=apache2 state=restarted<br />- name: other handler<br />service: name=other state=restarted</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Директива name является уникальным идентификатором обработчика. Чтобы извлечь обработчик из задачи, используйте опцию notify.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: Change default Apache virtual host<br />template: src=vhost.tpl dest=/etc/apache2/sites-available/000-default.conf<br />notify: restart apache</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Пример плейбука</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Теперь можно собрать весь код данного руководства в один плейбук, который будет автоматизировать установку Apache в Ubuntu 14.04.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Примечание</span><span style=" font-family:'Sans'; font-size:10pt;">: Дополненный вариант плейбука можно найти на </span><a href="https://github.com/erikaheidi/cfmgmt/tree/master/ansible"><span style=" font-family:'Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Github</span></a><span style=" font-family:'Sans'; font-size:10pt;">. Также эта папка содержит файл Vagrant, который позволяет протестировать плейбук на упрощённой установке с помощью виртуальной машины </span><a href="https://vagrantup.com/"><span style=" font-family:'Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Vagrant</span></a><span style=" font-family:'Sans'; font-size:10pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">---<br />- hosts: all<br />become: true<br />vars:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">doc_root: /var/www/example</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">tasks:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: Update apt<br />apt: update_cache=yes<br />- name: Install Apache<br />apt: name=apache2 state=latest<br />- name: Create custom document root<br />file: path={{ doc_root }} state=directory owner=www-data group=www-data<br />- name: Set up HTML file<br />copy: src=index.html dest={{ doc_root }}/index.html owner=www-data group=www-data mode=0644<br />- name: Set up Apache virtual host file<br />template: src=vhost.tpl dest=/etc/apache2/sites-available/000-default.conf<br />notify: restart apache</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">handlers:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-size:10pt;">- name: restart apache<br />service: name=apache2 state=restarted</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">hosts: all: В начале плейбука указываются хосты, к которым его нужно применить, и в данном случае это все хосты. Вы можете также создавать индивидуальные плейбуки).</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">become: true: Этот фрагмент позволяет Ansible повысить привилегии для выполнения всех задач в плейбуке; можно устанавливать эту опцию для отдельных задач).</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">vars: В данном примере в задаче определяется переменная doc_root.</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">tasks: В этом разделе определяются все задачи данного плейбука; первая задача обновляет индекс пакетов, а вторая устанавливает пакет apache2. Третья задача использует встроенный модуль file (управляет файлами и каталогами), чтобы создать каталог document root. Четвёртая задача копирует локальный файл на удалённый сервер с помощью модуля copy (это простой HTML-файл, который Apache будет обслуживать как сртаницу сайта).</li>
<li style=" font-family:'Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">handlers: В этом разделе определяются сервисы. В четвёртой задаче используется обработчик restart apache.</li></ul>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt; font-weight:600;">Заключение</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans'; font-size:10pt;">Ansible – это инструмент IT-автоматизации, который использует для оркестровки сценарии YAML. Он предоставляет огромное количество встроенных модулей, которые могут самостоятельно выполнять некоторые задачи (устанавливать пакеты, обрабатывать шаблоны и т.д.). Он упрощает работу с инфраструктурой, поскольку сам использует очень простой язык.</span></p></body></html>