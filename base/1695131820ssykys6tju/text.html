<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Множество систем на кристалле используют в своей конструкции ARM процессор. Чтобы лучше понять, как он работает нужно разобраться в его системе команд. Скажу честно, понимать ассемблерный код вообще не очень просто. Еще труднее понимать код для ARM процессора – очень много странных суффиксов у команд, существуют разные непонятные значки возле операндов в командах. Понять не очень просто, но стоит однажды разобраться, чтобы потом с легкостью ориентироваться в чужом коде.<br /><br />Надеюсь эта статья поможет в освоении  процессоров семейства ARM.<br />Несмотря на то, что в системе Amber реализован процессор самой младшей серии ARM v2a очень многое остается в силе и для более старших моделей процессоров. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Кому это вообще нужно – разбираться в ассемблере? Ведь сейчас все пишут программы на высокоуровневых языках вроде C++, C#, Java или Python? Ну все, да не все. Если вы разрабатываете систему реального времени и пишите обработчик прерываний, или даже просто пишите драйвер устройства, работающий в режиме ядра операционной системы – вам могут понадобиться знания ассемблера.<br /><br />Итак, ассемблерный код – это текстовый файл в котором одна строка текста, как правило, описывает одну команду процессора. Компилятор ассемблера преобразует этот текст в бинарный файл в котором команды закодированны специальным образом. Процессор будет читать эти команды из памяти системы и исполнять по очереди. Иногда он может переходить к выполнению команд по другому адресу, выполняя условный или безусловный переход. Внутри процессора есть набор регистров, условно говоря - это временные переменные программы. Процессор может манипулировать значениями в этих регистрах с помощью арифметических, логических команд или команд сдвига. Так же он может загружать в регистры значения из памяти или выгружать в память. Это все довольно общие сведения, которые относятся к ассемблеру для любого процессора. Давайте перейдем конкретно к ARM.<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Пример программы и компилятор.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Поскольку мы изучаем систему на кристалле Amber, то вероятно у нас уже есть ее исходные тексты (можно взять на нашей странице в GitHub </span><a href="https://github.com/marsohod4you/Amber-Marsohod2"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">https://github.com/marsohod4you/Amber-Marsohod2</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), а значит и исходные тексты некоторых ее программ в папке </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#008000;">sw/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Так же, мы уже </span><a href="https://marsohod.org/m2/amber-arm-soc/24-ourblog/armsoc/219-c-compiler"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">установили пакет CodeSourcery</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, который на самом деле является и компилятором C и компилятором ассемблера.<br />Для экспериментов с ассемблером можно взять любой простой проект вроде </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#008000;">sw/hello-world</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Внутри этой папки есть файл </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#008000;">hello-world.c </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">содержащий функцию main(..) на языке C и файл </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#008000;">start.S</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> который и является файлом на языке ассемблера. Собственно программа стартует с выполнения процедуры _start из файла</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#008000;"> start.S</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br />Откомпилировать программу просто. Наберите в консоли «make» и он сделает все, что нужно. В результате мы получаем несколько файлов, среди которых собственно исполняемый файл </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#008000;">hello-world.elf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в специальном формате для Linux и файл листинга </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#008000;">hello-world.dis</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. В файле листинга видно по каким адресам теперь расположен какой скомпилированный код:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080; background-color:#ffffff;">hello-world.elf:     file format elf32-littlearm<br /><br />Disassembly of section .text:<br /><br />00000000 &lt;_start&gt;:<br />0:    e3a00000     mov    r0, #0<br />4:    e13ff000     teq    pc, r0<br />8:    e3e00000     mvn    r0, #0<br />c:    ee030f10     mcr    15, 0, r0, cr3, cr0, {0}<br />10:   e3a00001     mov    r0, #1<br />14:   ee020f10     mcr    15, 0, r0, cr2, cr0, {0}<br />18:   e59fd004     ldr    sp, [pc, #4]    ; 24 &lt;AdrStack&gt;<br />1c:   eb00036e     bl     ddc &lt;main&gt;<br />20:   ea000110     b      468 &lt;_testpass&gt;<br /><br />00000024 &lt;AdrStack&gt;:<br />24:    00001ff0     .word    0x00001ff0<br />......</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Видно, что по адресу 0 расположен код 0xE3A00000, который обозначает команду процессора ARM </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">mov r0,#0</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> а по адресу 0x20 код 0xEA000110 – это команда перехода на адрес 0x468<br /><br />По сути дела наш компилятор – это хороший инструмент для изучения ассемблера. Можно писать код, компилировать и смотреть его двоичное представление.<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Система команд процессора ARM</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />ARM является RISC процессором – это </span><a href="http://ru.wikipedia.org/wiki/RISC"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">Reduced Instruction Set Computer</span></a><a href="http://ru.wikipedia.org/wiki/RISC"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff; vertical-align:sub;">(wiki)</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Существуют процессоры других типов, как, например, семейство x86 – CISC (</span><a href="http://ru.wikipedia.org/wiki/CISC"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">Complex Instruction Set Computer</span></a><a href="http://ru.wikipedia.org/wiki/CISC"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff; vertical-align:sub;">(wiki)</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">).<br /><br />Процессоры CISC выполняют за одну команду довольно сложные операции, включая арифметические и логические операции над содержимым ячеек памяти. Команды CISC процессора могут иметь разную длину.<br /><br />Напротив, RISC имеет относительно простую систему команд с четким делением по типу операции:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">работа с памятью (считывание из памяти в регистры или запись из регистров в память),</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">обработка данных в регистрах (арифметические, логические, сдвиги данных влево/вправо или ротация бит в регистре),</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">команды условных или безусловных переходов на другие адреса.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Как правило (но не всегда, и только при условии попадания кода программы в память кэш контроллера) одна команда исполняется один такт процессора. Длина команды процессора ARM фиксированная – 4 байта (одно компьютерное слово). Вообще-то современный процессор ARM может переходить в другие режимы работы, например, в режим THUMB, когда длина команды становится 2 байта. Это позволяет сделать код более компактным. Однако в этой статье мы не рассматриваем этот режим, так как в процессоре Amber ARM v2a он не поддерживается. По этой же причине не будем рассматривать такие режимы как Jazelle (оптимизирован для исполнения Java кода) и не будем рассматривать команды NEON – команды операций над множественными данными. Все-таки мы изучаем чистую систему команд ARM.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Регистры процессора ARM.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Процессор ARM имеет несколько наборов регистров из которых в данный момент времени доступны программисту только 16. Существует несколько режимов работы процессора, в зависимости от режима работы выбирается соответствующий банк регистров. Эти режимы работы:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">режим приложения (USR, user mode),</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">режим супервизора или режим операционной системы (SVC, supervisor mode),</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">режим обработки прерывания (IRQ, interrupt mode) и</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">режим обработки «срочного прерывания» (FIRQ, fast interrupt mode).</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">То есть, например, при возникновении прерывания процессор сам переходит к адресу программы обработчика прерываний и сам автоматически «переключает» банки регистров.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Процессоры ARM более старших версий кроме вышеперечисленных режимов работы имеют еще дополнительные режимы:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Abort (используется для обработки исключений доступа к памяти),</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Undefined (используется для реализации сопроцессора программным способом) и</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">режим привелигированных задач операционной системы System.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В процессоре Amber ARM v2a этих дополнительных трех режимов нет.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Для Amber ARM v2a набор регистров можно представить следующим образом:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1695131803hvmuckmbrk.png" /><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Регистры </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r0-r7</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> одни и те же для всех режимов.<br />Регистры </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r8-r12</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> общие только для режимов USR, SVC, IRQ.<br />Регистр </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r13 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– является указателем стека. Он во всех режимах свой.<br />Регистр </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r14 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– регистр возврата из подпрограммы так же во всех режимах свой.<br />Регистр </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r15 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">является указателем на исполняемые команды. Он общий для всех режимов.<br /><br />Видно, что режим FIRQ самый обособленный, у него больше всего своих собственных регистров. Это сделано для того, чтобы какое-то очень критичное прерывание можно было бы обрабатывать не сохраняя регистры в стек, не теряя на это время.<br /><br />Особенное внимание нужно уделить регистру </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r15</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, он же </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">pc </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Program Counter</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">) – указатель на исполняемые команды. Над его содержимым можно выполнять разные арифметические и логические операции, тем самым исполнение программы будет переходить на другие адреса. Однако, именно для процессора ARM v2a, реализованного в системе Amber есть некоторые тонкости в интерпретации битов этого регистра.<br /><br />Дело в том, что в этом процессоре в регистре </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r15 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">pc</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">) кроме собственно указателя на исполняемые команды содержится следующая информация:<br /></span><img src="image1695131803ujyn6cz9w2.png" /><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Биты 31:28 – флаги результата выполнения арифметической или логической операции </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">{ Negative, Zero, Carry, oVerflow }</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br />Биты 27 – маска IRQ прерывания, прерывания запрещены, когда бит установлен.<br />Биты 26 – маска FIRQ прерывания, быстрые прерывания запрещены, когда бит установлен.<br />Биты 25:2 – собственно указатель на команды программы занимает только 26 бит.<br />Биты 1:0 – текущий режим работы процессора.<br />  3 - Supervisor<br />  2 - Interrupt<br />  1 - Fast Interrupt<br />  0 – User<br /><br />В более старших процессорах ARM все флаги и служебные биты расположены в отдельных регистрах </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-style:italic;">Current Program Status Register </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">cpsr</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">) и Saved Program Status Register (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">spsr</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), для доступа к которым есть отдельные специальные команды. Это сделано для того, что бы расширить доступное адресное пространство для программ.<br /><br />Одна из трудностей освоения ассемблера ARM – это альтернативные имена некоторых регистров. Так, как выше было сказано, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r15 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– это тот же </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">pc</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Еще есть </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r13 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– это тот же </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">sp </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Stack Pointer</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r14 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– это </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">lr </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Link Register</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">) – регистр адреса возврата из процедуры. Кроме этого, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r12 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– это тот же самый </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ip </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Intra-Procedure</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">-call scratch register), используется компиляторами C особым образом для доступа к параметрам в стеке. Такое альтернативное именование иногда сбивает с толку, когда смотришь в чужой код программы – там встречаются и те и эти обозначения регистров.<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Особенности исполнения кода.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Во многих типах процессороров (например x86) по условию может выполняться только переход на другой адрес программы. В ARM это не так. Каждая команда процессора ARM может быть выполнена или не выполнена по условию. Это позволяет минимизировать количество переходов по программе и следовательно эффективнее использовать конвейер (pipeline) процессора.<br /><br />Ведь что такое pipeline? Одна команда процессора сейчас выбирается из кода программы, предыдущяя уже декодируется, а пред-предыдущая уже исполняется. Это в случае 3х стадийного конвейера процессора Amber A23, который мы используем в нашем проекте для </span><a href="https://marsohod.org/howtostart/marsohod2"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">платы Марсоход2Марсоход2</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Модификация процессора Amber A25 имеет 5-ти стадийный конвейер, он еще более эффективный. Но, есть одно большое НО. Команды перехода вынуждают процессор очищать pipeline и наполнять его заново. Таким образом, новая команда выбирается, но еще нечего декодировать и тем более сразу нечего исполнять. Эффективность выполнения кода при частых переходах падает. В современных процессорах есть всякие механизмы предсказания переходов, которые как-то оптимизируют наполнение конвейера, но в нашем процессоре этого нет. В любом случае, ARM поступила мудро, сделав возможным исполнение каждой команды условным.<br /><br />В процессоре ARM, в команде любого типа четыре бита условия исполнения команды закодированы в старших четырех битах кода команды:<br /></span><img src="image1695131803lgup1tnp72.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Всего в процессоре 4 флага условия:<br />•    Negative – результат операции получился отрицательным, <br />•    Zero – результат равен нулю, <br />•    Carry – при выполнении операции с беззнаковыми чисоами произошел перенос, <br />•    oVerflow – при выполнении операции со знаковыми числами произошло переполнение, результат не помещается в регистр} <br /><br />Эти 4 флага формируют множество  возможных комбинаций условия:</span></p>
<table border="2" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> Код</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> Суффикс</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Значение</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> Флаги</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h0</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eq </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Equal</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Z set</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h1</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ne </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Not equal</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Z clear</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h2</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">cs / hs  </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Carry set / unsigned higher or same</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">C set</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h3</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">cc / lo  </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Carry clear / unsigned lower</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">C clear</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h4</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">mi </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Minus / negative </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">N set</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h5</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">pl </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Plus / positive or zero</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">N clear</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h6</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">vs </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Overflow </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">V set</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h7</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">vc </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">No overflow </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">V clear</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h8</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">hi</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Unsigned higher </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">C set and Z clear</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'h9</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ls </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Unsigned lower or same </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">C clear or Z set</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'ha</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ge </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Signed greater than or equal </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">N == V</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'hb</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">lt </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Signed less than </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">N != V</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'hc</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">gt </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Signed greater than </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Z == 0,N == V</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'hd</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">le </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Signed less than or equal </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Z == 1 or N != V</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'he</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">al </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Always (unconditional)</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">4'hf</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> - </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Invalid condition</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Теперь из этого следует еще одна сложность изучения команд процессора ARM – множество суффиксов, которые могут быть добавлены к коду команды. Например, сложение при условии, что флаг Z установлен – это команда </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">addeq </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">как </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">add </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">+ суффикс </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">eq</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Переход на подпрограмму в случае, если флаг N=0 – это </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">blpl </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">как </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">bl </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">+ суффикс </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">pl</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.<br /><br />Флаги </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">{ Negative, Zero, Carry, oVerflow }</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">  устанавливаются то же не всегда при арифметических или логических операциях, как это бывает скажем в x86 процессоре, а только, когда захочет программист. Для этого есть еще один суффикс к мнемонике команд: «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">» (в коде команды кодируется битом 20). Таким образом, команда сложения </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">add </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">не меняет флагов, а команда </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">adds </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">меняет флаги. А может еще быть условная команда сложения, но которая меняет флаги. Например: </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">addgts</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Понятно, что число возможных сочетаний названий команд с разными суффиксами условного выполнения и установки флагов делает ассемблерный код ARM процессора весьма своеобразным и трудно читаемым. Однако со временем к этому привыкаешь и начинаешь понимать этот текст.<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Арифметические и логические операции (Data Processing).</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Процессор ARM может выполнять различные арифметические и логические операции.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1695131803a4dxzpxlho.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Собственно четырехбитный код операции </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">{Opcode}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> содержится в битах [24:21] команды процессора.<br /><br />Любая операция выполняется над содержимым регистра [</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Rn</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">] и так называемым </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">shifter_operand</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Результат операции помещается в регистр [</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Rd</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">]. Четырехбитные </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Rn </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Rd </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– это индексы регистров в активном банке процессора.<br /><br />В зависимости от бита I</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">25</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">shifter_operand</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> трактуется либо как числовая константа, либо как индекс второго регистра операнда и даже операция сдвига над значением второго операнда.<br /><br />Простые примеры команд ассемблера будут выглядеть, например, вот так:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">add r0,r1,r2    @ поместить в регистр r0 сумму значений регистров r1 и r2<br />sub r5,r4,#7    @ поместить в регистр r5 разность (r4-7)</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Здесь и далее везде, после символа «@» в ассемблерном тексте идет комментарий.<br /><br />Выполняемые операции кодируются следующим образом:<br /><br />4'h0 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">and </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Логическое И Rd := Rn AND shifter_operand<br />4'h1 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">eor </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Логическаое исключающее ИЛИ Rd := Rn XOR shifter_operand<br />4'h2 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">sub </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Арифметическое вычитание Rd := Rn - shifter_operand<br />4'h3 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">rsb </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Арифметическое обратное вычитание  Rd := shifter_operand - Rn<br />4'h4 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">add </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Арифметическое сложение  Rd := Rn + shifter_operand<br />4'h5 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">adc </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Арифметическое сложение плюс флаг переноса Rd := Rn + shifter_operand + Carry Flag<br />4'h6 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">sbc </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Арифметическое вычитание с переносом Rd := Rn - shifter_operand - NOT(Carry Flag)<br />4'h7 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">rsc </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Арифметическое обратное вычитание с переносом Rd := shifter_operand - Rn - NOT(Carry Flag)<br />4'h8 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">tst </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Логическое И, но без запоминания результата, изменяются только флаги Rn AND shifter_operand S bit always set<br />4'h9 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">teq </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Логическое исключающее ИЛИ, но без запоминания результата, изменяются только флаги Rn EOR shifter_operand<br />S bit always set<br />4'ha </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">cmp </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Сравнение, вернее арифметическое вычитание без запоминания результата, изменяются только флаги Rn – shifter_operand S bit always set<br />4'hb </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">cmn </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Сравнение инверсного, вернее арифметическое сложение без запоминания результата, изменяются только флаги Rn + shifter_operand S bit always set<br />4'hc </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">orr </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Логическое ИЛИ Rd := Rn OR shifter_operand<br />4'hd </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">mov </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Копирование значения Rd := shifter_operand (no first operand)<br />4'he </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">bic </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Сброс битов Rd := Rn AND NOT(shifter_operand)<br />4'hf </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">mvn </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Копирование инверсногозначения  Rd := NOT shifter_operand (no first operand)<br /><br />Далее давайте посмотрим, что же такое </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">shifter_operand</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">?<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Barrel shifter.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />В процессоре ARM есть специальная схема “barrel shifter” которая позволяет один из операндов сдвинуть или развернуть на заданное число бит перед любой арифметической или логической операцией. Это довольно интересная особенность процессора, которая позволяет создавать очень эффективный код.<br /><br />Например:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">@ умножение на 9 – это умножение числа на 8 <br />@ путем сдвига влево на 3 бита плюс еще число<br />add r0, r1, r1, lsl #3      @ r0= r1+(r1&lt;&lt;3) = r1*9<br /><br />@ умножение на 15 – это умножение на 16 минус число<br />rsb r0, r1, r1, lsl #4      @ r0= (r1&lt;&lt;4)-r1 = r1*15<br /><br />@ доступ к таблице 4-х байтовых слов, где <br />@ r1 – это базовый адрес таблицы<br />@ r2 – это индекс элемента в таблице<br />ldr r0, [r1, r2, lsl #2]</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Кроме логического сдвига влево </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">lsl </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">есть еще логический сдвиг вправо </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">lsr </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">и арифметический сдвиг вправо </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">asr </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(сдвиг с сохранением знака числа, старший бит размножается слева одновременно со сдвигом).<br /><br />Еще есть ротация бит </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ror </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– биты выдвигаются вправо и те, что выдвиннуты - задвигаются слева.<br />Есть сдвиг на один бит через флаг C – это команда </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">rrx</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Значение регистра сдвигается вправо на один бит. Слева в старший разряд регистра загружается флаг C<br /><br />Сдвиг может осуществляться не на фиксированное число-константу, а по значению третьего регистра-операнда. Например:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">add r0, r1, r1, lsr r3 @ это r0 = r1 + (r1&gt;&gt;r3);<br />add r0, r0, r1, lsr r3 @ это r0 = r0 + (r1&gt;&gt;r3);</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Таким образом, shifter_operand это то, что мы описываем в командах ассемблера, например, как «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r1, lsr r3</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">» или «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r2, lsl #5</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">».<br /><br />Самое интересное, что использование сдвигов в операциях ничего не стоит. На эти сдвиги (обычно) не тратится дополнительных тактов и это очень хорошо для производительности системы.<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Использование числовых операндов.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Арифметические или логические операции могут использовать в качестве второго операнда не только содержимое регистра, но и числовую константу.<br /><br />К сожалению, здесь существует одно важное ограничение. Поскольку все команды имеют фиксированную длину 4 байта (32 бита), то закодировать в ней «любое» число не получится. В коде операции и так 4 бита заняты кодом условия выполнения </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">{Cond}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> , 4 бита на сам код операции</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;"> {Opcode}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, потом, 4 бита – регистр приемника </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Rd</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, и еще 4 бита – регистр первого операнда </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Rn</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, плюс еще разные флаги I</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">25 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(как раз обозначает числовую константу в коде операции) и S</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">20</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (установка флагов после операции). Итого, на возможную константу остается всего 12 бит, так называемый shifter_operand – мы это видели выше. Поскольку 12-ю битами можно закодировать числа только в узком диапазоне разработчики процессора ARM решили сделать кодирование константы следующим образом. Двенадцать бит</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;"> shifter_operand </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">разбиты на две части: четырехбитный показатель вращения </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">encode_imm</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и собственно восьмибитное числовое значение </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">imm_8</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.<br /><br />В процессоре ARM константа определяется восьмибитным числом внутри 32-х битного числа, развернутым вправо на четное число бит. То есть:<br /><br /></span><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">imm_32 = imm_8 ROR (encode_imm *2)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Получилось довольно мудрено. Получается, что не каждое число константу можно использовать в командах ассемблера.<br /><br />Можно написать</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">add r0, r2, #255    @ константа в десятичном виде<br />add r0, r3, #0xFF    @ константа в шестнадцатеричном виде</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">так как 255 находится в диапазоне 8 бит. Эти команды будут скомпилированны вот так:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">0:    e28200ff     add    r0, r2, #255    ; 0xff<br />4:    e28300ff     add    r0, r3, #255    ; 0xff</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">И даже можно написать </span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">add r0, r4, #512<br />add r0, r5, 0x650000</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Скомпилированный код получится вот такой:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">0:    e2840c02     add    r0, r4, #512    ; 0x200<br />4:    e2850865     add    r0, r5, #6619136    ; 0x650000</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В этом случае, само число 512, конечно, не помещается в байт. Но зато мы представляем себе его в шестнадцатеричном виде 32’h00000200 и видим, что это 2 развернутая вправо на 24 бита (1 ror 24). Коэффициент вращения в два раза меньше, чем 24, то есть 12. Вот и получается shifter_operand = { 4’hc , 8’h02 } – это двенадцать младших бит команды. Так же и с числом 0x650000. Для него shifter_operand = { 4’h8, 8’h65 }.<br /><br />Понятно, что нельзя написать </span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">add r0, r1,#1234567</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">или нельзя написать </span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">mov r0, #511</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">так как здесь число не получается представить в виде</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;"> imm_8 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">encode_imm</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> – фактора вращения. Компилятор ассемблера будет выдавать ошибку.<br /><br />Что же делать, когда константа не может быть прямо закодирована в </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">shifter_operand</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">? Придется делать всякие ухищрения.<br />Например, можно сперва загрузить в свободный регистр число 512, а потом вычесть единицу:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">mov r0, #511<br />sub  r0,r0,#1</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Второй способ загрузить в регистр специфическое число – считать его из специально зарезервированной переменной находящейся в памяти:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">ldr r7,my_var<br />.....<br />my_var: .word 0x123456</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Самый же простой способ написать вот так:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">ldr r2,=511</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В этом случае (обратите внимание на знак «=») если константа может быть представлена как </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">imm_8</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">encode_imm</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, если может быть вписана в 12 бит </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">shifter_operand</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, то компилятор ассемблера автоматически скомпилирует </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldr </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">в команду </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">mov</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. А вот если число не может быть так представлено, то компилятор сам зарезервирует в программе ячейку памяти для этой константы, и сам задаст этой ячейке памяти имя и скомпилирует команду в </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldr</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.<br /><br />Вот я написал вот так:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">ldr    r7,my_var<br />ldr    r8,=511<br />ldr    r8,=1024<br />ldr    r9,=0x3456<br />........<br />My_var: .word 0x123456</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">После компиляции получил вот что:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">18:    e59f7030     ldr    r7, [pc, #48]    ; 50 &lt;my_var&gt;<br />1c:    e59f8030     ldr    r8, [pc, #48]    ; 54 &lt;my_var+0x4&gt;<br />20:    e3a08b01     mov    r8, #1024    ; 0x400<br />24:    e59f902c     ldr    r9, [pc, #44]    ; 58 &lt;my_var+0x8&gt;<br />.............<br />00000050 &lt;my_var&gt;:<br />50:    00123456     .word    0x00123456<br />54:    000001ff     .word    0x000001ff<br />58:    00003456     .word    0x00003456</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Обратите внимание, что компилятор использует адресацию ячеек памяти относительно регистра </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">pc </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(он же </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r15</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">).<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Чтение ячейки памяти и запись регистра в память.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Как я уже написал выше, процессор ARM может выполнять арифметические или логические операции только над содержимым регистров. Данные для операций нужно читать из памяти и результат операций записывать опять в память. Для этого существуют специальные команды: </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldr </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(вероятно от сочетания «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">LoaD Register</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">») для чтения и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">str </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(наверное «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">STore Register</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">») для записи.<br /><br /></span><img src="image1695131803lr70utsu2o.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Казалось бы - всего две команды, но на самом деле у них есть много вариаций. Достаточно посмотреть на способы кодирования команд </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldr</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">str </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">процессора Amber ARM, чтобы увидеть, как много вспомогательных битов-флажков L</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">20</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, W</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">21</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, B</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">22</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, U</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">23</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, P</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">24</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, I</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">25</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> – и они определяют конкретное поведение команды: <br /><br />Здесь:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Бит L<span style=" vertical-align:sub;">20 </span>определяет запись или чтение. 1 – <span style=" color:#000080;">ldr</span>, чтение, 0 – <span style=" color:#000080;">str</span>, запись.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Бит B<span style=" vertical-align:sub;">22 </span>определяет чтение/запись 32-х битного слова или 8-ми битного байта. 1 – значит операция с байтом. При чтении байта в регистр старшие биты регистра обнуляются.</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Бит I<span style=" vertical-align:sub;">25 </span>определяет использование поля <span style=" color:#000080;">Offset</span>. Если I<span style=" vertical-align:sub;">25</span>==0, то Offset интерпретируется как числовое смещение, которое нужно либо прибавить к базовому адресу из регистра [<span style=" color:#000080;">Rn</span>] или отнять. А вот прибавлять или отнимать зависит от бита U<span style=" vertical-align:sub;">23</span>.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">{Cond}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> – условие выполнения операции. Интерпретируется так же, как и для логических/арифметических команд – чтение или запись могут быть условными.<br /><br />Таким образом, в ассемблерном тексте можно написать вот такое:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">ldr    r1,[r0]        @ в регистр r1 читать слово по адресу из регистра r0 <br />ldrb    r1,[r0]        @ в регистр r1 читать байт по адресу из регистра r0 <br />ldreq    r2,[r1]        @ условное чтение слова<br />ldrgtb    r2,[r1]        @ условное чтение байта<br />ldr    r3,[r4,#8]    @ чтение слова по адресу 8 относительно адреса из регистра r4<br />ldr    r4,[r5,#-16]     @ чтение слова по адресу -16 относительно адреса из регистра r5</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Откомпилировав этот текст можно увидеть, собственно коды этих команд:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">0:    e5901000     ldr    r1, [r0]<br />4:    e5d01000     ldrb    r1, [r0]<br />8:    05912000     ldreq    r2, [r1]<br />c:    c5d12000     ldrbgt    r2, [r1]<br />10:    e5943008     ldr    r3, [r4, #8]<br />14:    e5154010     ldr    r4, [r5, #-16]</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В приведенном выше примере я использую только </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldr</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, но и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">str </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">используется примерно так же. <br /><br />Самое интересно начинается дальше, ведь специальные биты P</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">24</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и W</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">21</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в коде команд чтения/записи описывают еще много разных режимов работы.<br /><br />Существуют режимы пре-индексного и пост-индексного доступа к памяти с обратной записью. В этих режимах указатель доступа к памяти обновляется до или после выполнения команды. Если вы знакомы с языком программирования C, то вам известны конструкции доступа по указателям вроде ( </span><span style=" font-family:'courier new','courier'; font-size:12pt; font-style:italic;">*psource++;</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ) или (</span><span style=" font-family:'courier new','courier'; font-size:12pt;"> </span><span style=" font-family:'courier new','courier'; font-size:12pt; font-style:italic;">a=*++psource;</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> ). В процессоре ARM этот режим доступа в памяти как раз и реализован. При выполнении команды чтения обновляется сразу два регистра – регистр приемник получает считанное из памяти значение и значение в регистре-указателе на ячейку памяти перемещается вперед или назад.<br /><br />Запись этих команд, на мой взгляд, несколько нелогична. Нужно долго привыкать.</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">ldr     r3, [r0, #4]!           @ psrc++; r3 = *psrc;<br />ldr     r3, [r0], #4            @ r3 = *psrc; psrc++;</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Первая команда </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldr </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">сперва увеличивает указатель, потом выполняет чтение. Вторая команда сперва выполняет чтение, потом увеличивает указатель. Значение указателя psrc находится в регистре </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r0</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.<br /><br />Все рассмотренные выше примеры были для случая, когда бит I</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; vertical-align:sub;">25</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в коде команды был сброшен. Но ведь он еще может быть установленным! Тогда в значении поля Offset будет не числовая константа, а уже третий регистр, учавствующий в операции. Причем значение третьего регистра еще может быть предварительно сдвинуто! <br /><br />Вот примеры возможных вариаций кода:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">0:    e7921003     ldr    r1, [r2, r3]    @ адрес для чтения – сумма значений из регистров r2 и r3<br />4:    e7b21003     ldr    r1, [r2, r3]!    @ то же самое, но после чтения r2 будет увеличен на значение из r3<br />8:    e6932004     ldr    r2, [r3], r4    @ сперва будет чтение по адресу r3, а потом r3 увеличится на r4<br />c:    e7943185     ldr    r3, [r4, r5, lsl #3] @ адрес для чтения r4+r5*8<br />10:    e7b43285     ldr    r3, [r4, r5, lsl #5]! @ адрес для чтения r4+r5*32, после чтения r4 будет установлен в значение этого адреса<br />14:    e69431a5     ldr    r3, [r4], r5, lsr #3 @ адрес для чтения r4, по после исполнения команды r4 будет установлен в r4+r5/8</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br />Вот такие вариации команд чтения/записи в процессоре ARM v2a.<br /><br />В более старших моделях процессоров ARM это разнообразие команд еще больше.<br />Это из-за того, что процессор позволяет, например, читать не только слова (32-х битные числа) и байты, но и полуслова (16 бит, 2 байта). Тогда к командам </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldr</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">str </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">добавляется суффикс «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">h</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">», от слова half-word. Команды будут выглядеть как </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldrh </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">или </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">strh</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Так же есть команды загрузки полуслов </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldrsh </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">или байтов </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldrsb </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">интерпретируемых как знаковые числа. В этих случаях старший бит загружаемого полослова или байта размножается в старшие биты целого слова в регистре приемнике. Например, загружая командой </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldrsh</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> полуслово </span><span style=" font-family:'courier new','courier'; font-size:12pt;">0xff25 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">в регистре-приемнике получается </span><span style=" font-family:'courier new','courier'; font-size:12pt;">0xffffff25</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Множественные чтения и запись.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Команды </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldr</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">str </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">не единственные для доступа к памяти. В процессоре ARM есть еще команды позволяющие выполнять блочную передачу – можно загрузить содержимое нескольких последовательных слов из памяти сразу несколько регистров. Так же можно записать последовательно в память значения нескольких регистров.<br /><br /></span><img src="image1695131803c3k68lzvqn.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Мнемоники команд блочной передачи начинаются с корня </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldm </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">LoaD Multiple</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">) или </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">stm </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Store Multiple</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">). А вот дальше, как обычно в ARM, начинается история с суффиксами.<br /><br />В общем случае команда выглядит вот так:<br /><br /></span><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">op{cond}{mode} Rd{!}, {Register list}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Суффикс </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">{Cond}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> – это понятно, это условие выполнения команды. Суффикс </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">{mode}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> – это режим передачи, о нем четь позже. </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Rd </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– регистр определяющий базовый адрес в памяти для чтения или записи. Восклицательный знак после регистра </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Rd </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">обозначает, что после операции чтения/записи он будет изменен. Список регистров, которые загружаются из памяти или выгружаются в память – это </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">{Register list}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. <br /><br />Список регистров задается в в фигурных скобках через запятую или в виде диапазона. Например:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">stm    r0,{r3,r1, r5-r8}</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br />Запись в память будет прозведена не в порядке перечисления. Список просто обозначает какие регистры будут записаны в память и все. В коде команды есть зарезервированные для </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Register List</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> 16 бит, как раз по числу регистров в банке процессора. Каждый бит в этом поле обозначает какой регистр будет участвовать в операции.<br /><br />Теперь о режиме чтения/записи mode. Тут есть где запутаться. Дело в том, что для одного и того же действия могут использоваться разные названия режима.<br /><br />Если сделать небольшое лирическое отступление, то нужно рассказать о... стеке. Стек – это способ доступа к данным типа </span><a href="http://en.wikipedia.org/wiki/LIFO_%28computing%29"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">LIFO – Last In First Out</span></a><a href="http://en.wikipedia.org/wiki/LIFO_%28computing%29"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff; vertical-align:sub;">(wiki)</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> – последним вошел, первым вышел. Стек широко используется в программировании при вызове процедур и сохранении состояния регистров на входе функций и восстановлении их при выходе, а так же при передаче параметров вызываемым процедурам. <br /><br />Стек в памяти бывает, кто бы мог подумать, четырех типов.<br /><br />Первый тип – </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Full Descending</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Это когда указатель стека указывает на занятый элемент стека и стек растет в сторону уменьшения адресов. Когда нужно положить слово на стек, то сперва указатель стека уменьшается (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Decrement Before</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">), потом по адресу указателя стека записывается слово. Когда нужно снять компьютерное слово со стека, то по текущему значению указателя стека читается слово, потом указатель перемещается вверх (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Increment After</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">).<br /><br />Второй тип –</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;"> Full Ascending</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Стек растет не вниз а в верх, в сторону больших адресов. Указатель так же указывает на занятый элемент. Когда нужно положить слово на стек, то сперва указатель стека увеличивается, потом производится запись слова по указателю (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Increment Before</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">). Когда надо снять со стека, то сперва читаем по указателю стека, ведь он указывает на занятый элемент, потом уменьшается указатель стека (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Decrement Afte</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r).<br /><br />Третий тип – </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Empty Descending</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Стек растет вниз, как и в случае с </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Full Descending</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, но отличие состоит в том, что указатель стека указывавет на не занятую ячейку. Таким образом, когда нужно положить слово на стек, то сразу делается запись, потом указатель стека уменьшается (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Decrement After</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">). При снятии со стека сперва увеличивают указатель, потом читают (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Increment Before</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">).<br /><br />Четвертый тип -</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;"> Empty Ascending</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Надеюсь все понятно – стек растет вверх. Указатель стека указывает на пустой элемент. Положить на стек – это записать слово по адресу указателя стека и увеличить указатель стека (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Increment After</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">). Снять со стека – уменьшить указатель стека и прочитать слово (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Decrement Before</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">).<br /><br />Таким образом, при операциях со стеком нужно указатель увеличивать или уменьшать  - (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Increment/Decrement</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">) до или после (</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Before/After</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">) чтения/записи в память в зависимости от типа стека. В процессорах Intel, например, есть специальные команды для работы со стеком типа </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">PUSH </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(положить слово на стек) или </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">POP </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(снять слово со стека). В процессоре ARM специальных команд нет, но используются  </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldm </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">stm </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">команды.<br /><br />Если реализовывать стек с помощью команд процессора ARM, то получается вот такая картина:<br /><br /></span></p>
<table border="2" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Тип стека</span></p></td>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Положить на стек, <br />PUSH</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Снять со стека, <br />POP</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Full descending</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">STMFD (STMDB)</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">LDMFD (LDMIA)</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Full ascending</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">STMFA (STMIB)</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">LDMFA (LDMDA)</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Empty descending</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">STMED (STMDA)</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">LDMED (LDMIB)</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Empty ascending</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">STMEA (STMIA)</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">LDMEA (LDMDB)</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br />Зачем одной и той же команде нужно было давать разные имена? Вообще не понимаю... Здесь, конечно, нужно заметить, что стандарт стека для ARM – все же Full Descending.<br /><br />Указатель стека в процессоре ARM – это регистр </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">sp </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">или </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r13</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Это в общем такая договоренность. Конечно, запись </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">stm </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">или чтение </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ldm</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> могут быть выполнены и с другими базовыми регистрами. Однако нужно помнить, чем регистр </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">sp </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">отличается от других регистров – он в разных режимах работы процессора (USR, SVC, IRQ, FIRQ) может быть свой, ведь там свои банки регистров.<br /><br />И еще замечание. Написать в ассемблерном коде ARM строку вроде </span><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">push {r0-r3}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, конечно можно. Только вот на самом деле это будет та же самая команда </span><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">stmfd sp!,{r0-r3}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.<br /><br />На последок приведу пример ассемблерного кода и его откомпилированный дизассемблированный текст. Имеем:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">@ эти три инструкции одинаковы и делают одно и то же<br />stmfd    sp!,{r0-r3}<br />stmdb    sp!,{r0-r3}<br />push    {r0-r3}<br /><br />@ эти три инструкции одинаковы и делают одно и то же<br />pop    {r0-r3}<br />ldmia    sp!,{r0-r3}<br />ldmfd    r13!,{r0-r3}<br /><br />stmfd    r4,{r0-r3,r5,r8}<br />stmea    r4!,{r0-r3,r7,r9,lr,pc}<br />ldm    r5,{r0,pc}</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Получаем после компиляции:</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">0:    e92d000f     push    {r0, r1, r2, r3}<br />4:    e92d000f     push    {r0, r1, r2, r3}<br />8:    e92d000f     push    {r0, r1, r2, r3}<br />c:    e8bd000f     pop    {r0, r1, r2, r3}<br />10:    e8bd000f     pop    {r0, r1, r2, r3}<br />14:    e8bd000f     pop    {r0, r1, r2, r3}<br />18:    e904012f     stmdb    r4, {r0, r1, r2, r3, r5, r8}<br />1c:    e8a4c28f     stmia    r4!, {r0, r1, r2, r3, r7, r9, lr, pc}<br />20:    e8958001     ldm    r5, {r0, pc}</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Переходы в программах.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Программирование не возможно без переходов. В любых программах встречается и циклическое выполнение кода, и вызов процедур, функций, есть и условное выполнение участков кода.<br /><br />В процессоре Amber ARM v2a есть всего две команды: </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">b</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> (от слова </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Branch </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– ветка, переход) и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">bl </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Branch with Link</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> – переход с сохранением адреса возврата).<br /><br /></span><img src="image1695131803dhrqe6vr8c.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Синтаксис команд очень прост:<br /><br /></span><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">b{cond} label<br />bl{cond} label</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Понятно, что любые переходы могут быть условными, то есть в программе могут встретиться вот такие, образованные от корней «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">b</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">» и «</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">bl</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">» и суффиксов условия </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">{Cond}</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, странные слова: <br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">beq, bne, bcs, bhs, bcc, blo, bmi, bpl, bvs, bvc, bhi, bls, bge, bgt, ble, bal, b</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />и<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">bleq, blne, blcs, blhs, blcc, bllo, blmi, blpl, blvs, blvc, blhi, blls, blge, blgt, blle, blal, bl</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Разнообразие поражает, не правда ли?<br /><br />В команде перехода содержится 24-х битное смещение </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Offset</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Адрес перехода вычисляется как сумма текущего значения указателя </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">pc</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и сдвинутого на 2 бита влево числа </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Offset</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, интерпретируемого как знаковое число:<br /><br /></span><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">New pc = pc + Offset*4</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />Таким образом, диапазон переходов составляет 32Мб вперед или назад. <br /><br />Рассмотрим, что такое переход с сохранением адреса возврата </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">bl</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Эта команда используется для вызова подпрограмм. Интересной особенностью этой команды является то, что адрес возврата из процедуры при вызове процедуры сохраняется не в стеке, как у процессоров Интел, а в обычном регистре </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r14</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Тогда для возврата из процедуры не нужна специальная команда  </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">ret</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, как у тех же процессоров Интел, а можно просто скопировать значение </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r14 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">назад в </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">pc</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Теперь понятно, почему регистр </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">r14 </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">имеет альтернативное название </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">lr </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Link Register</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">).<br /><br />Рассмотрим процедуру </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">outbyte </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">из проекта hello-world для системы на кристалле Amber.</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new','courier'; font-size:12pt; color:#000080;">000004a0 &lt;_outbyte&gt;:<br />4a0:    e59f1454     ldr    r1, [pc, #1108]    ; 8fc &lt; адрес регистра данных UART &gt;<br />4a4:    e59f3454     ldr    r3, [pc, #1108]    ; 900 &lt; адрес регистра статуса UART &gt;<br />4a8:    e5932000     ldr    r2, [r3]           ; прочитаем текущий статус<br />4ac:    e2022020     and    r2, r2, #32<br />4b0:    e3520000     cmp    r2, #0             ; проверяем, что UART не занят<br />4b4:    05c10000     strbeq r0, [r1]           ; записываем символ в UART только если он не занят<br />4b8:    01b0f00e     movseq pc, lr             ; условный возврат из процедуры, если UART не был занят<br />4bc:    1afffff9     bne    4a8 &lt;_outbyte+0x8&gt; ; цикл на проверку статуса UART</span></p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Я думаю из комментариев этого фрагмента понятно, как работает эта процедура.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Еще важное замечание по переходам. Регистр r15 (pc) может быть использован в обычных арифметических или логических операциях в качестве регистра приемника. Так что команда вроде </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">add pc,pc,#8</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> вполне себе является инструкцией для перехода на другой адрес.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">По поводу переходов нужно сделать еще одно замечание. В более старших процессорах ARM есть еще дополнительные команды переходов </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">bx</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">blx </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">и </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">blj</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Это команды для переходов на фрагменты кода с другой системой команд. </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Bx</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">/</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">blx </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">позволяет делать переход на 16-ти битный код THUMB процессоров ARM. </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; color:#000080;">Blj </span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">– это вызов процедур системы команд Jazelle (поддержка языка Java в ARM процессорах). В нашем Amber ARM v2a этих команд нет.<br /><br /></span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600; text-decoration: underline;">Другие инструкции процессора ARM.</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /><br />В этой статье я описал многое, но далеко не все.<br />Я не рассказал о командах передачи данных между памятью и сопроцессором, о командах передачи данных между регистрами процессора и регистрами сопроцессора, о командах обработки данных в сопроцессоре и о программных прерываниях. Еще я упустил из виду команды умножения:<br /><br /></span><img src="image1695131803f9329ev18d.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Возможно когда нибудь я восполню этот пробел.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Надеюсь приведенная информация была полезной.</span></p></body></html>