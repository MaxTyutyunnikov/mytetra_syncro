<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">В данной статье описан пример минимального компилятора, бекенд которого основан на LLVM. Транслятор умеет превращать исходный код с функциями и выражениями в промежуточный код на языке LLVM-IR, который затем можно скомпилировать вручную.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" font-style:italic; color:#323232;">Пример к статье </span><a href="https://github.com/ps-group/compiler-theory-samples/tree/master/llvm-codegen"><span style=" font-style:italic; text-decoration: underline; color:#2a7ae2;">доступен на github</span></a></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow0"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">Н</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">ововведения</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Данный транслятор был получен путём доработки интерпретатора из примера</span><span style=" color:#000000;"> </span><span style=" color:#000000; background-color:#fefefe;">lemon-8</span><span style=" color:#000000;"> с использованием LLVM для генерации кода. Была реализована только часть языка:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">функции и определение функции main</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">выражения</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">На данный момент не работают:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">кодогенерация для типов Boolean, String</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">кодогенерация для циклов и ветвлений</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Пример компилируемого кода:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">function main()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  x = 2 + 34 / 2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  print x - 4 * 0.5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">end</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Транслятор пока ещё не умеет компилировать файлы в объектные и выдаёт LLVM-IR код, который мы прокомментировали для вашего удобства. Вы легко заметите, что никаких вычислений в коде нет, потому что LLVM обнаружил константы и произвёл вычисления заранее:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; комментарии начинаются с ';'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; ModuleID = 'main module'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; source_filename - атрибут для отладочных целей</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">source_filename = &quot;main module&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; @str - глобальная строковая константа, содержит строку &quot;%lf\n&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">@str = internal constant [5 x i8] c&quot;%lf\0A\00&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; @printf - внешняя функция, реализация находится в стандартной библиотеке</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">;  языка C и есть в каждой операционной системе</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">declare i32 @printf(i8*, ...)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; @main - точка входа программы по соглашениям LLVM-IR</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">define i32 @main() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; entry - метка, открывающая первый блок инструкций функции</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">entry:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; инструкция call вызывает функцию printf</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  %0 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([5 x i8], [5 x i8]* @str, i32 0, i32 0), double 0x4030FFFFFF800000)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  ret i32 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Также изменилась грамматика:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">теперь инструкции должны находится строго внутри функций</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">точкой входа служит функция </span><span style=" font-size:16px; background-color:#fefefe;">main</span><span style=" font-size:18px;"> без аргументов и без </span><span style=" font-size:16px; background-color:#fefefe;">return</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Транслятор читает входной поток целиком, и затем пишет в выходной поток LLVM-IR код в человекочитаемом виде. Этот код можно скомпилировать в исполняемый файл командой</span><span style=" color:#000000;"> </span><span style=" color:#000000; background-color:#fefefe;">&quot;clang main.ll&quot;</span><span style=" color:#000000;">.</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow1"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">К</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">ласс CCompilerDriver</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Класс имеет очень простой интерфейс и реализует паттерн “Фасад” (“Facade”), т.е. его основная цель - объединить подсистемы компилятора в простой и удобный интерфейс.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-weight:600; color:#000000; background-color:#ffffff;">class</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">CCompilerDriver</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-weight:600; color:#000000; background-color:#ffffff;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    CCompilerDriver(std</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">ostream </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;">errors);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">~</span><span style=" color:#000000; background-color:#ffffff;">CCompilerDriver();</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> StartDebugTrace();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">bool</span><span style=" color:#000000; background-color:#ffffff;"> Compile(std</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">istream </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;">input, std</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">ostream </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;">output);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-weight:600; color:#000000; background-color:#ffffff;">private:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-style:italic; color:#999988; background-color:#ffffff;">// Используется идиома pointer-to-implementation.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">class</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">Impl</span><span style=" color:#000000; background-color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    std</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">unique_ptr</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&lt;</span><span style=" color:#000000; background-color:#ffffff;">Impl</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&gt;</span><span style=" color:#000000; background-color:#ffffff;"> m_pImpl;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Метод CCompilerDriver::Compile работает в два шага: сначала разбирает исходный текст и конструирует AST, а затем обходит AST в глубину и генерирует код. Именно генерация кода представляет наибольший интерес, поэтому рассмотрим её подробнее.</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow2"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">П</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">аттерн “Посетитель” (“Visitor”) для узлов AST</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">В интерпретаторе был использован паттерн “Интерпретатор”, т.е. каждый узел AST имел метод, который принимал контекст выполнения и выполнял рекурсивное вычисление узла с учётом текущего контекста выполнения:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">// Вычисление выражения возвращает результат в виде CValue</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">class IExpressionAst</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    virtual ~IExpressionAst() = default;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    virtual CValue Evaluate(CInterpreterContext&amp; context) const = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">// Выполнение инструкции результата не возвращает</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">class IStatementAst</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    virtual ~IStatementAst() = default;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    virtual void Execute(CInterpreterContext&amp; context) const = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">// Вычисление функции требует список аргументов и возвращает результат в виде CValue</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">class IFunctionAst</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    virtual ~IFunctionAst() = default;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    virtual CValue Call(CInterpreterContext&amp; context, std::vector&lt;CValue&gt; const&amp; arguments) const = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    virtual unsigned GetNameId() const = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Такой паттерн подходит для интерпретатора, где входные данные поступают вместе с исходным кодом программы и могут быть сразу использованы для вычисления. Процессы внутри компилятора выглядят сложнее:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">сначала должна произойти проверка типов и других семантических правил путём обхода AST</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">затем путём ещё одного обхода AST нужно сгенерировать промежуточный код на языке LLVM-IR</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">уже после генерации промежуточного кода он может быть превращён в машинный (это тема следующих статей) и использован для обработки входных данных</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Для множественной обработки AST лучше подходит паттерн “Посетитель”, который позволяет абстрагироваться от узлов AST. Для реализации паттерна достаточно создать у каждого узла дерева метод, например</span><span style=" color:#000000;"> </span><span style=" color:#000000; background-color:#fefefe;">void Accept(IVisitor&amp;)</span><span style=" color:#000000;">, который будет вызывать правильную перегрузку метода </span><span style=" color:#000000; background-color:#fefefe;">IVisitor::Visit</span><span style=" color:#000000;">, соответствующую типу текущего узла, и рекурсивно вызывать Accept для дочерних узлов:</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><img src="image1621371723wfb95418qc.png" /></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow3"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">Г</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">енерация кода выражений</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Для генерации кода выражений мы реализуем интерфейс IExpressionVisitor</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">class CExpressionCodeGenerator : protected IExpressionVisitor</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    CExpressionCodeGenerator(llvm::IRBuilder&lt;&gt;&amp; builder, CFrontendContext&amp; context);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    // Can throw std::exception.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    llvm::Value* Codegen(IExpressionAST&amp; ast);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">protected:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    void Visit(CBinaryExpressionAST&amp; expr) override;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    void Visit(CUnaryExpressionAST&amp; expr) override;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    void Visit(CLiteralAST&amp; expr) override;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    void Visit(CCallAST&amp; expr) override;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    void Visit(CVariableRefAST&amp; expr) override;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">private:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    // Стек используется для временного хранения</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    // по мере рекурсивного обхода дерева выражения.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    std::vector&lt;llvm::Value*&gt; m_values;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    CFrontendContext&amp; m_context;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    llvm::IRBuilder&lt;&gt;&amp; m_builder;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Для генерации списка инструкций нам потребуется принцип стековых вычислений</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" font-style:italic; color:#323232;">Принцип стековых вычислений описан в статье </span><a href="https://ps-group.github.io/compilers/stack_and_register"><span style=" font-style:italic; text-decoration: underline; color:#2a7ae2;">Стековые и регистровые машины</span></a></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Для стековых вычислений есть нюанс: в нашем распоряжении есть только регистры, в них находятся операнды инструкций и попадают результаты выполнения. В языке LLVM-IR бесконечно много регистров, и для создания нового регистра достаточно просто присвоить его. Так может выглядеть вычисление “28 / 9 + 7 + 5.5” на LLVM-IR:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; Программа вычисляет выражение 28.0 / 9.0 + 7.0 * 5.5 и печатает в консоль результат</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; @str - глобальная строковая константа, содержит строку &quot;%lf\n&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">@str = internal constant [5 x i8] c&quot;%lf\0A\00&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">; @printf - внешняя функция, реализация находится в стандартной библиотеке</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">;  языка C и есть в каждой операционной системе</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">declare i32 @printf(i8*, ...)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">define i32 @main() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">entry:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  %0 = fdiv double 28.0, 9.0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  %1 = fmul double 7.0, 5.5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  %2 = fadd double %0, %1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  %3 = getelementptr inbounds [5 x i8], [5 x i8]* @str, i32 0, i32 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  %4 = call i32 (i8*, ...) @printf(i8* %3, double %2)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">  ret i32 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Нетрудно заметить, что здесь можно применить разложение выражения в линейный список инструкций с помощью стека. При этом в ячейках стека следует хранить не значения, а регистры, потому что на момент компиляции входных данных и соответственно значений ещё нет.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">В библиотеках LLVM объекты регистров представляются указателями типа</span><span style=" color:#000000;"> </span><span style=" color:#000000; background-color:#fefefe;">llvm::Value*</span><span style=" color:#000000;">, а в качестве стека подойдёт обычный </span><span style=" color:#000000; background-color:#fefefe;">std::vector</span><span style=" color:#000000;">. Класс CExpressionCodeGenerator по мере рекурсивного обхода одного выражения сохраняет регистры с результатами подвыражений в поле </span><span style=" color:#000000; background-color:#fefefe;">std::vector&lt;llvm::Value*&gt; m_values;</span><span style=" color:#000000;">. В конце обхода (в случае, если кодогенератор написан правильно) на стеке останется ровно один регистр, который и будет хранить в себе значение после выполнения всех инструкций.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">Value</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">*</span><span style=" color:#000000; background-color:#ffffff;"> CExpressionCodeGenerator</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">Codegen(IExpressionAST</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> ast)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    llvm</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">Value</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">*</span><span style=" color:#000000; background-color:#ffffff;"> pValue </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">=</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" color:#0086b3; background-color:#ffffff;">nullptr</span><span style=" color:#000000; background-color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">try</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">        ast.Accept(</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">*this</span><span style=" color:#000000; background-color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">        pValue </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">=</span><span style=" color:#000000; background-color:#ffffff;"> m_values.at(</span><span style=" color:#009999; background-color:#ffffff;">0</span><span style=" color:#000000; background-color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">        m_values.clear();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">catch</span><span style=" color:#000000; background-color:#ffffff;"> (std</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">exception </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">const&amp;</span><span style=" color:#000000; background-color:#ffffff;"> ex)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">        m_context.PrintError(ex.what());</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">return</span><span style=" color:#000000; background-color:#ffffff;"> pValue;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Генерация инструкций выполняется с помощью объекта</span><span style=" color:#000000;"> </span><span style=" color:#000000; background-color:#fefefe;">llvm::IRBuilder&lt;&gt;&amp; m_builder;</span><span style=" color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">Value</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">*</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" font-weight:600; color:#990000; background-color:#ffffff;">GenerateUnaryExpr</span><span style=" color:#000000; background-color:#ffffff;">(IRBuilder</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&lt;&gt;&amp;</span><span style=" color:#000000; background-color:#ffffff;"> builder, LLVMContext</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> context, UnaryOperation op, Value</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">*</span><span style=" color:#000000; background-color:#ffffff;"> x)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    (</span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;">)context;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">switch</span><span style=" color:#000000; background-color:#ffffff;"> (op)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">case</span><span style=" color:#000000; background-color:#ffffff;"> UnaryOperation:</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">:</span><span style=" color:#000000; background-color:#ffffff;">Plus</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">        </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">return</span><span style=" color:#000000; background-color:#ffffff;"> x;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">case</span><span style=" color:#000000; background-color:#ffffff;"> UnaryOperation:</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">:</span><span style=" color:#000000; background-color:#ffffff;">Minus</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">        </span><span style=" font-style:italic; color:#999988; background-color:#ffffff;">// Генерация инструкции negtmp</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">        </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">return</span><span style=" color:#000000; background-color:#ffffff;"> builder.CreateFNeg(x, </span><span style=" color:#dd1144; background-color:#ffffff;">&quot;negtmp&quot;</span><span style=" color:#000000; background-color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">throw</span><span style=" color:#000000; background-color:#ffffff;"> std</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">runtime_error(</span><span style=" color:#dd1144; background-color:#ffffff;">&quot;Unknown unary operation&quot;</span><span style=" color:#000000; background-color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> CExpressionCodeGenerator</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">Visit(CUnaryExpressionAST</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> expr)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    expr.GetOperand().Accept(</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">*this</span><span style=" color:#000000; background-color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    Value</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">*</span><span style=" color:#000000; background-color:#ffffff;"> x </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">=</span><span style=" color:#000000; background-color:#ffffff;"> m_values.at(m_values.size() </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">-</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" color:#009999; background-color:#ffffff;">1</span><span style=" color:#000000; background-color:#ffffff;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    m_values.pop_back();</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">auto</span><span style=" color:#000000; background-color:#ffffff;"> pValue </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">=</span><span style=" color:#000000; background-color:#ffffff;"> GenerateUnaryExpr(m_builder, m_context.GetLLVMContext(), expr.GetOperation(), x);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    m_values.push_back(pValue);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow4"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">Г</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">енерация кода инструкций</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">В процедурных языках программирования есть цепочки инструкций, и в языках ассемблера они тоже есть. Поэтому генерация кода инструкций заключается в простом последовательном отображении высокоуровневых инструкций вашего языка на низкоуровневые инструкции ассемблера. Однако, с некоторыми высокоуровневыми конструкциями могут возникнуть сложности: мы рассмотрим основные случаи. Для генерации кода цепочек инструкций служит класс CBlockCodeGenerator:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-weight:600; color:#000000; background-color:#ffffff;">class</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">CBlockCodeGenerator</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">:</span><span style=" color:#000000; background-color:#ffffff;"> </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">protected</span><span style=" color:#000000; background-color:#ffffff;"> IStatementVisitor</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-weight:600; color:#000000; background-color:#ffffff;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    CBlockCodeGenerator(CFrontendContext</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> context);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> Codegen(llvm</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">BasicBlock</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> bb, </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">const</span><span style=" color:#000000; background-color:#ffffff;"> StatementsList</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> block);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> AddExitMain();</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-style:italic; color:#999988; background-color:#ffffff;">// IStatementVisitor interface</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">protected:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> Visit(CPrintAST</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> ast) </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">override</span><span style=" color:#000000; background-color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> Visit(CAssignAST</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> expr) </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">override</span><span style=" color:#000000; background-color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> Visit(CReturnAST</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> expr) </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">override</span><span style=" color:#000000; background-color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> Visit(CWhileAst</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> expr) </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">override</span><span style=" color:#000000; background-color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> Visit(CRepeatAst</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> expr) </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">override</span><span style=" color:#000000; background-color:#ffffff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> Visit(CIfAst</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> expr) </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">override</span><span style=" color:#000000; background-color:#ffffff;">;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-weight:600; color:#000000; background-color:#ffffff;">private:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    CFrontendContext</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> m_context;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    llvm</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">IRBuilder</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&lt;&gt;</span><span style=" color:#000000; background-color:#ffffff;"> m_builder;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    CExpressionCodeGenerator m_exprGen;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Начнём с самой простой инструкции возврата, которая должна просто привести в вызову инструкции ret языка LLVM-IR:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-style:italic; color:#999988; background-color:#ffffff;">// Выбрасывает ret double %имя_регистра</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> CBlockCodeGenerator</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">Visit(CReturnAST</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> expr)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">if</span><span style=" color:#000000; background-color:#ffffff;"> (</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">auto*</span><span style=" color:#000000; background-color:#ffffff;"> pValue </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">=</span><span style=" color:#000000; background-color:#ffffff;"> m_exprGen.Codegen(expr.GetValue()))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">        m_builder.CreateRet(pValue);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><span style=" color:#000000; background-color:#fefefe;">Немного сложнее будет реализация присваивания: по сути переменные - это отображение имени (идентификатора) на некоторую ячейку памяти, а для построения такого отображения в памяти компилятора подойдёт структура данных “хеш-массив” (известная как ассоциативный массив или словарь). В примере ниже вызывается метод AssignVariable, который получает регистр, имя переменной (в виде целочисленного ID) и сохраняет отображение имени на регистр в хеш-таблице. Пока что у нас нет обработки областей видимости, поэтому хеш-таблица единая на всю программу.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-weight:600; color:#445588; background-color:#ffffff;">void</span><span style=" color:#000000; background-color:#ffffff;"> CBlockCodeGenerator</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">Visit(CAssignAST</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">&amp;</span><span style=" color:#000000; background-color:#ffffff;"> ast)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    llvm</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">::</span><span style=" color:#000000; background-color:#ffffff;">Value</span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">*</span><span style=" color:#000000; background-color:#ffffff;"> pValue </span><span style=" font-weight:600; color:#000000; background-color:#ffffff;">=</span><span style=" color:#000000; background-color:#ffffff;"> m_exprGen.Codegen(ast.GetValue());</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">    m_context.AssignVariable(ast.GetNameId(), pValue);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" color:#000000; background-color:#ffffff;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000; background-color:#ffffff;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow5"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">О</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">стальные изменения в сравнении с lemon-8-types</span></h2>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">новые классы </span><span style=" font-size:16px; background-color:#fefefe;">CCodeGenerator</span><span style=" font-size:18px;">, </span><span style=" font-size:16px; background-color:#fefefe;">CBlockCodeGenerator</span><span style=" font-size:18px;">, </span><span style=" font-size:16px; background-color:#fefefe;">CExpressionCodeGenerator</span><span style=" font-size:18px;"> генерируют код для программы целиком, для тела функции и для выражения соответственно</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">класс </span><span style=" font-size:16px; background-color:#fefefe;">CInterpreterContext</span><span style=" font-size:18px;"> переименован в </span><span style=" font-size:16px; background-color:#fefefe;">CFrontendContext</span><span style=" font-size:18px;"> и претерпел изменения в типах данных, с которыми он работает.</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">класс </span><span style=" font-size:16px; background-color:#fefefe;">CValue</span><span style=" font-size:18px;"> был удалён за ненадобностью</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">методы </span><span style=" font-size:16px; background-color:#fefefe;">Evaluate</span><span style=" font-size:18px;"> и </span><span style=" font-size:16px; background-color:#fefefe;">Execute</span><span style=" font-size:18px;"> у выражений и инструкций были удалены, теперь узлы AST лишь дают возможность обхода посетителем, но сами не содержат логики генерации кода.</span></li></ul>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fefefe;"><a name="wow6"></a><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">И</span><span style=" font-size:x-large; font-weight:600; color:#000000; background-color:#fefefe;">спользованная литература</span></h2>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://llvm.org/docs/tutorial/LangImpl3.html"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">язык Kaleidoscope, глава 3 (llvm.org)</span></a></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://stackoverflow.com/questions/16656855/llvm-ir-string-initialization"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">передача строковой константы как аргумента фукнции (stackoverflow.com)</span></a></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://stackoverflow.com/questions/9148890/how-to-make-clang-compile-to-llvm-ir"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">как заставить Clang скомпилировать C++ в LLVM-IR (stackoverflow.com)</span></a></li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p></body></html>