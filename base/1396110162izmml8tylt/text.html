<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Назначение модификатора </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;"> в объявлении функций-членов – это определить, какие из них можно вызывать для константных объектов. Такие функции-члены важны по двум причинам. Во-первых, они облегчают понимание интерфейса класса, ведь полезно сразу видеть, какие функции могут модифицировать объект, а какие нет. Во-вторых, они обеспечивают возможность работать с константными объектами. Это очень важно для написания эффективного кода, потому что, как объясняется в правиле 20, один из основных способов повысить производительность программ на C++ – передавать объекты по ссылке на константу. Но эта техника будет работать только в случае, когда функции-члены для манипулирования константными объектами объявлены с модификатором </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Многие упускают из виду, что функции, отличающиеся только наличием </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;"> в объявлении, могут быть перегружены. Это, однако, важное свойство C++. Рассмотрим класс, представляющий блок текста:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">class TextBlock {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">    const char&amp; operator[](std::size_t position) const // operator[] для</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">        {return text[position];}                       // константных объектов</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">    char&amp; operator[](std::size_t position) // operator[] для</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">        {return text[position];}           // неконстантных объектов</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">private:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">    std::string text;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Функцию </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> в классе </span><span style=" font-family:'FreeMono'; color:#6a1009;">TextBlock</span><span style=" font-size:10pt;"> можно использовать следующим образом:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">TextBlock tb(“Hello”);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">Std::cout &lt;&lt; tb[0]; // вызов неконстантного</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">                    // оператора TextBlock::operator[]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">const TextBlock ctb(“World”);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">Std::cout &lt;&lt; ctb[0]; // вызов константного</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">                     // оператора TextBlock::operator[]</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Кстати, константные объекты чаще всего встречаются в реальных программах в результате передачи по указателю или ссылке на константу. Приведенный выше пример </span><span style=" font-family:'FreeMono'; color:#6a1009;">ctb</span><span style=" font-size:10pt;"> является довольно искусственным. Но вот вам более реалистичный:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">void print(const TextBlock&amp; ctb) // в этой функции ctb – ссылка</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">                                 // на константный объект</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">std::cout &lt;&lt; ctb[0]; // вызов const TextBlock::operator[]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Перегружая </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> и создавая различные версии с разными возвращаемыми типами, вы можете по-разному обрабатывать константные и неконстантные объекты </span><span style=" font-family:'FreeMono'; color:#6a1009;">TextBlock</span><span style=" font-size:10pt;">:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">std::cout &lt;&lt; tb[0]; // нормально – читается</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">                    // неконстантный TextBlock</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">tb[0] = ‘x’; // нормально – пишется</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">             // неконстантный TextBlock</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">std::cout &lt;&lt; ctb[0]; // нормально – читается</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">                     // константный TextBlock</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">ctb[0] = ‘x’; // ошибка! – запись</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">              // константного TextBlock</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Отметим, что ошибка здесь связана только с типом значения, возвращаемого </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[];</span><span style=" font-size:10pt;"> сам вызов </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> проходит нормально. Причина ошибки – в попытке присвоить значение объекту типа </span><span style=" font-family:'FreeMono'; color:#6a1009;">const char&amp;</span><span style=" font-size:10pt;">, потому что это именно такой тип возвращается константной версией </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Отметим также, что тип, возвращаемый неконстантной версией </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;">, – это ссылка на </span><span style=" font-family:'FreeMono'; color:#6a1009;">char</span><span style=" font-size:10pt;">, а не сам </span><span style=" font-family:'FreeMono'; color:#6a1009;">char</span><span style=" font-size:10pt;">. Если бы </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> возвращал просто </span><span style=" font-family:'FreeMono'; color:#6a1009;">char</span><span style=" font-size:10pt;">, то следующее предложение не скомпилировалось бы:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">tb[0] = ‘x’;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Это объясняется тем, что возвращаемое функцией значение встроенного типа модифицировать некорректно. Даже если бы это было допустимо, тот факт, что C++ возвращает объекты по значению (см. правило 20), означал бы следующее: модифицировалась </span><span style=" font-size:10pt; font-style:italic;">копия</span><span style=" font-size:10pt;"> </span><span style=" font-family:'FreeMono'; color:#6a1009;">tb.text[0]</span><span style=" font-size:10pt;">, а не само значение </span><span style=" font-family:'FreeMono'; color:#6a1009;">tb.text[0]</span><span style=" font-size:10pt;">. Вряд ли это то, чего вы ожидаете.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Давайте немного передохнем и пофилософствуем. Что означает для функции-члена быть константной? Существует два широко распространенных понятия: </span><span style=" font-size:10pt; font-style:italic;">побитовая константность</span><span style=" font-size:10pt;"> (также известная как </span><span style=" font-size:10pt; font-style:italic;">физическая константность)</span><span style=" font-size:10pt;"> и </span><span style=" font-size:10pt; font-style:italic;">логическая константность.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Сторонники побитовой константности полагают, что функция-член константна тогда и только тогда, когда она не модифицирует никакие данные-члены объекта (за исключением статических), то есть не модифицирует ни одного бита внутри объекта. Определение побитовой константности хорошо тем, что ее нарушение легко обнаружить: компилятор просто ищет присваивания членам класса. Фактически, побитовая константность – это константность, определенная в C++: функция-член с модификатором const не может модифицировать нестатические данные-члены объекта, для которого она вызвана.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">К сожалению, многие функции-члены, которые ведут себя далеко не константно, проходят побитовый тест. В частности, функция-член, которая модифицирует то, на что указывает указатель, часто не ведет себя как константная. Но если объекту принадлежит только указатель, то функция формально является побитово константной, и компилятор не станет возражать. Это может привести к неожиданному поведению. Например, предположим, что есть класс подобный Text-Block, где данные хранятся в строках типа </span><span style=" font-family:'FreeMono'; color:#6a1009;">char *</span><span style=" font-size:10pt;"> вместо </span><span style=" font-family:'FreeMono'; color:#6a1009;">string</span><span style=" font-size:10pt;">, поскольку это необходимо для передачи в функции, написанные на языке C, который не понимает, что такое объекты типа </span><span style=" font-family:'FreeMono'; color:#6a1009;">string</span><span style=" font-size:10pt;">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">class CtextBlock {</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:10pt; color:#6a0e07;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> char&amp; operator[](std::size_t position) const // неудачное (но побитово</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> { return pText[position]}                    // константное)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">                                              // объявление operator[]</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:10pt; color:#6a0e07;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">private:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> char *pText;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">В этом классе функция </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> (неправильно!) объявлена как константная функция-член, хотя она возвращает ссылку на внутренние данные объекта (эта тема обсуждается в правиле 28). Оставим это пока в стороне и отметим, что реализация </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;"> никак не модифицирует pText. В результате компилятор спокойно сгенерирует код для функции </span><span style=" font-family:'FreeMono'; color:#6a1009;">operator[]</span><span style=" font-size:10pt;">. Ведь она действительно является побитово константной, а это все, что компилятор может проверить. Но посмотрите, что происходит:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">const CtextBlock cctb(“Hello”); // объявление константного объекта</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">char &amp;pc = &amp;cctb[0]; // вызов const operator[] для получения</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">                     // указателя на данные cctb</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">*pc = ‘j’; // cctb теперь имеет значение “Jello”</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Несомненно, есть что-то некорректное в том, что вы создаете константный объект с определенным значением, вызываете для него только константную функцию-член и тем не менее изменяете его значение!</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Это приводит нас к понятию </span><span style=" font-size:10pt; font-weight:600;">логической константности</span><span style=" font-size:10pt;">. Сторонники этой философии утверждают, что функции-члены с </span><span style=" font-family:'FreeMono'; color:#6a1009;">const</span><span style=" font-size:10pt;"> могут модифицировать некоторые биты вызвавшего их объекта, </span><span style=" font-size:10pt; font-weight:600;">но только так, чтобы пользователь не мог этого обнаружить</span><span style=" font-size:10pt;">. Например, ваш класс </span><span style=" font-family:'FreeMono'; color:#6a1009;">CTextBlock</span><span style=" font-size:10pt;"> мог бы кэшировать длину текстового блока при каждом запросе:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">Class CtextBlock {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> std::size_t length() const;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">private:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> char *pText;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> std::size_t textLength; // последнее вычисленное значение длины</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">                         // текстового блока</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> bool lengthIsValid;     // корректна ли длина в данный момент</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:10pt; color:#6a0e07;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">std::size_t CtextBlock::length() const</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> if(!lengthIsValid) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">  textLength = std::strlen(pText); // ошибка! Нельзя присваивать</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">  lengthIsValid = true;            // значение textLength и</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> }                                 // lengthIsValid в константной функции-члене</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> return textLength;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Эта реализация </span><span style=" font-family:'FreeMono'; color:#6a1009;">length()</span><span style=" font-size:10pt;">, конечно же, не является </span><span style=" font-size:10pt; font-weight:600;">побитово константной</span><span style=" font-size:10pt;">, поскольку может модифицировать значения членов </span><span style=" font-family:'FreeMono'; color:#6a1009;">textLength</span><span style=" font-size:10pt;"> и </span><span style=" font-family:'FreeMono'; color:#6a1009;">lengthlsValid</span><span style=" font-size:10pt;">. Но в то же время со стороны кажется, что константности объектов </span><span style=" font-family:'FreeMono'; color:#6a1009;">CTextBlock</span><span style=" font-size:10pt;"> это не угрожает. Однако компилятор не согласен. Он настаивает на побитовой константности. Что делать?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600;">Решение простое:</span><span style=" font-size:10pt;"> используйте модификатор </span><span style=" font-family:'FreeMono'; color:#6a1009;">mutable</span><span style=" font-size:10pt;">. Он освобождает нестатические данные-члены от ограничений побитовой константности:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">Class CtextBlock {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> std::size_t length() const;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">private:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> char *pText;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> mutable std::size_t textLength; // Эти данные-члены всегда могут быть</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> mutable bool lengthIsValid;     // модифицированы, </span><span style=" font-family:'Courier New'; font-size:10pt; font-weight:600; color:#6a0e07;">даже в константных функциях-членах</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:10pt; color:#6a0e07;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">std::size_t CtextBlock::length() const</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> if(!lengthIsValid) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">  textLength = std::strlen(pText); // теперь порядок</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">  lengthIsValid = true;            // здесь то же</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;"> return textLength;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a0e07;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p></body></html>