<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="content"></a><span style=" font-size:x-large; color:#000000;">Р</span><span style=" font-size:x-large; color:#000000;">уководство для начинающих</span></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="100%" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В этом руководстве рассматироваются темы:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Запуск, остановка, перезагрузка конфигурации</li>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Структура конфигурационного файла</li>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Раздача статического содержимого</li>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Настройка простого прокси-сервера</li>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Настройка проксирования FastCGI</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В этом руководстве даётся начальное введение в nginx и описываются некоторые простые задачи, которые могут быть решены с его помощью. Предполагается, что nginx уже установлен на компьютере читателя. Если нет, см. <a href="http://nginx.org/ru/docs/install.html"><span style=" text-decoration: underline; color:#0000ff;">Установка nginx</span></a>. В этом руководстве описывается, как запустить и остановить nginx и перезагрузить его конфигурацию, объясняется, как устроен конфигурационный файл, и описывается, как настроить nginx для раздачи статического содержимого, как настроить прокси-сервер на nginx, и как связать nginx с приложением FastCGI. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">У nginx есть один главный и несколько рабочих процессов. Основная задача главного процесса — чтение и проверка конфигурации и управление рабочими процессами. Рабочие процессы выполняют фактическую обработку запросов. nginx использует модель, основанную на событиях, и зависящие от операционной системы механизмы для эффективного распределения запросов между рабочими процессами. Количество рабочих процессов задаётся в конфигурационном файле и может быть фиксированным для данной конфигурации или автоматически устанавливаться равным числу доступных процессорных ядер (см. <a href="http://nginx.org/ru/docs/ngx_core_module.html#worker_processes"><span style=" text-decoration: underline; color:#0000ff;">worker_processes</span></a>). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как работают nginx и его модули, определяется в конфигурационном файле. По умолчанию, конфигурационный файл называется <span style=" font-family:'Courier New,courier';">nginx.conf</span> и расположен в каталоге <span style=" font-family:'Courier New,courier';">/usr/local/nginx/conf</span>, <span style=" font-family:'Courier New,courier';">/etc/nginx</span> или <span style=" font-family:'Courier New,courier';">/usr/local/etc/nginx</span>. </p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Запуск, остановка, перезагрузка конфигурации</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы запустить nginx, нужно выполнить исполняемый файл. Когда nginx запущен, им можно управлять, вызывая исполняемый файл с параметром <span style=" font-family:'Courier New,courier';">-s</span>. Используйте следующий синтаксис: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">nginx -s </span><span style=" font-family:'Courier New,courier'; font-style:italic;">сигнал</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Где <span style=" font-style:italic;">сигнал</span> может быть одним из нижеследующих: </p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">stop</span> — быстрое завершение </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">quit</span> — плавное завершение </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">reload</span> — перезагрузка конфигурационного файла </li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">reopen</span> — переоткрытие лог-файлов </li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Например, чтобы остановить процессы nginx с ожиданием окончания обслуживания текущих запросов рабочими процессами, можно выполнить следующую команду: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">nginx -s quit</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;">Команда должна быть выполнена под тем же пользователем, под которым был запущен nginx.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Изменения, сделанные в конфигурационном файле, не будут применены, пока команда перезагрузить конфигурацию не будет вручную отправлена nginx’у или он не будет перезапущен. Для перезагрузки конфигурации выполните: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">nginx -s reload</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Получив сигнал, главный процесс проверяет правильность синтаксиса нового конфигурационного файла и пытается применить конфигурацию, содержащуюся в нём. Если это ему удаётся, главный процесс запускает новые рабочие процессы и отправляет сообщения старым рабочим процессам с требованием завершиться. В противном случае, главный процесс откатывает изменения и продолжает работать со старой конфигурацией. Старые рабочие процессы, получив команду завершиться, прекращают принимать новые запросы и продолжают обслуживать текущие запросы до тех пор, пока все такие запросы не будут обслужены. После этого старые рабочие процессы завершаются. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Посылать сигналы процессам nginx можно также средствами Unix, такими как утилита <span style=" font-family:'Courier New,courier';">kill</span>. В этом случае сигнал отправляется напрямую процессу с данным ID. ID главного процесса nginx записывается по умолчанию в файл <span style=" font-family:'Courier New,courier';">nginx.pid</span> в каталоге <span style=" font-family:'Courier New,courier';">/usr/local/nginx/logs</span> или <span style=" font-family:'Courier New,courier';">/var/run</span>. Например, если ID главного процесса равен 1628, для отправки сигнала QUIT, который приведёт к плавному завершению nginx, нужно выполнить: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">kill -s QUIT 1628</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для просмотра списка всех запущенных процессов nginx может быть использована утилита <span style=" font-family:'Courier New,courier';">ps</span>, например, следующим образом: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">ps -ax | grep nginx</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Дополнительную информацию об отправке сигналов процессам nginx можно найти в <a href="http://nginx.org/ru/docs/control.html"><span style=" text-decoration: underline; color:#0000ff;">Управление nginx</span></a>. </p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Структура конфигурационного файла</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">nginx состоит из модулей, которые настраиваются директивами, указанными в конфигурационном файле. Директивы делятся на простые и блочные. Простая директива состоит из имени и параметров, разделённых пробелами, и оканчивается точкой с запятой (<span style=" font-family:'Courier New,courier';">;</span>). Блочная директива устроена так же, как и простая директива, но вместо точки с запятой после имени и параметров следует набор дополнительных инструкций, помещённых внутри фигурных скобок (<span style=" font-family:'Courier New,courier';">{</span> и <span style=" font-family:'Courier New,courier';">}</span>). Если у блочной директивы внутри фигурных скобок можно задавать другие директивы, то она называется контекстом (примеры: <a href="http://nginx.org/ru/docs/ngx_core_module.html#events"><span style=" text-decoration: underline; color:#0000ff;">events</span></a>, <a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#http"><span style=" text-decoration: underline; color:#0000ff;">http</span></a>, <a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#server"><span style=" text-decoration: underline; color:#0000ff;">server</span></a> и <a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#location"><span style=" text-decoration: underline; color:#0000ff;">location</span></a>). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Директивы, помещённые в конфигурационном файле вне любого контекста, считаются находящимися в контексте <a href="http://nginx.org/ru/docs/ngx_core_module.html"><span style=" text-decoration: underline; color:#0000ff;">main</span></a>. Директивы <span style=" font-family:'Courier New,courier';">events</span> и <span style=" font-family:'Courier New,courier';">http</span> располагаются в контексте <span style=" font-family:'Courier New,courier';">main</span>, <span style=" font-family:'Courier New,courier';">server</span> — в <span style=" font-family:'Courier New,courier';">http</span>, а <span style=" font-family:'Courier New,courier';">location</span> — в <span style=" font-family:'Courier New,courier';">server</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Часть строки после символа <span style=" font-family:'Courier New,courier';">#</span> считается комментарием. </p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Раздача статического содержимого</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Одна из важных задач конфигурации nginx — раздача файлов, таких как изображения или статические HTML-страницы. Рассмотрим пример, в котором в зависимости от запроса файлы будут раздаваться из разных локальных каталогов: <span style=" font-family:'Courier New,courier';">/data/www</span>, который содержит HTML-файлы, и <span style=" font-family:'Courier New,courier';">/data/images</span>, содержащий файлы с изображениями. Для этого потребуется отредактировать конфигурационный файл и настроить блок <a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#server"><span style=" text-decoration: underline; color:#0000ff;">server</span></a> внутри блока <a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#http"><span style=" text-decoration: underline; color:#0000ff;">http</span></a> с двумя блоками <a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#location"><span style=" text-decoration: underline; color:#0000ff;">location</span></a>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Во-первых, создайте каталог <span style=" font-family:'Courier New,courier';">/data/www</span> и положите в него файл <span style=" font-family:'Courier New,courier';">index.html</span> с любым текстовым содержанием, а также создайте каталог <span style=" font-family:'Courier New,courier';">/data/images</span> и положите в него несколько файлов с изображениями. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее, откройте конфигурационный файл. Конфигурационный файл по умолчанию уже включает в себя несколько примеров блока <span style=" font-family:'Courier New,courier';">server</span>, большей частью закомментированных. Для нашей текущей задачи лучше закомментировать все такие блоки и добавить новый блок <span style=" font-family:'Courier New,courier';">server</span>: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">http {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В общем случае конфигурационный файл может содержать несколько блоков <span style=" font-family:'Courier New,courier';">server</span>, <a href="http://nginx.org/ru/docs/http/request_processing.html"><span style=" text-decoration: underline; color:#0000ff;">различаемых</span></a> по портам, на которых они <a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#listen"><span style=" text-decoration: underline; color:#0000ff;">слушают</span></a>, и по <a href="http://nginx.org/ru/docs/http/server_names.html"><span style=" text-decoration: underline; color:#0000ff;">имени сервера</span></a>. Определив, какой <span style=" font-family:'Courier New,courier';">server</span> будет обрабатывать запрос, nginx сравнивает URI, указанный в заголовке запроса, с параметрами директив <span style=" font-family:'Courier New,courier';">location</span>, определённых внутри блока <span style=" font-family:'Courier New,courier';">server</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В блок <span style=" font-family:'Courier New,courier';">server</span> добавьте блок <span style=" font-family:'Courier New,courier';">location</span> следующего вида: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    root /data/www;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Этот блок <span style=" font-family:'Courier New,courier';">location</span> задаёт “<span style=" font-family:'Courier New,courier';">/</span>” в качестве префикса, который сравнивается с URI из запроса. Для подходящих запросов добавлением URI к пути, указанному в директиве <a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#root"><span style=" text-decoration: underline; color:#0000ff;">root</span></a>, то есть, в данном случае, к <span style=" font-family:'Courier New,courier';">/data/www</span>, получается путь к запрашиваемому файлу в локальной файловой системе. Если есть совпадение с несколькими блоками <span style=" font-family:'Courier New,courier';">location</span>, nginx выбирает блок с самым длинным префиксом. В блоке <span style=" font-family:'Courier New,courier';">location</span> выше указан самый короткий префикс, длины один, и поэтому этот блок будет использован, только если не будет совпадения ни с одним из остальных блоков <span style=" font-family:'Courier New,courier';">location</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее, добавьте второй блок <span style=" font-family:'Courier New,courier';">location</span>: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">location /images/ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    root /data;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Он будет давать совпадение с запросами, начинающимися с <span style=" font-family:'Courier New,courier';">/images/</span> (<span style=" font-family:'Courier New,courier';">location /</span> для них тоже подходит, но указанный там префикс короче). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итоговая конфигурация блока <span style=" font-family:'Courier New,courier';">server</span> должна выглядеть следующим образом: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        root /data/www;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location /images/ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        root /data;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это уже работающая конфигурация сервера, слушающего на стандартном порту 80 и доступного на локальном компьютере по адресу <span style=" font-family:'Courier New,courier';">http://localhost/</span>. В ответ на запросы, URI которых начинаются с <span style=" font-family:'Courier New,courier';">/images/</span>, сервер будет отправлять файлы из каталога <span style=" font-family:'Courier New,courier';">/data/images</span>. Например, на запрос <span style=" font-family:'Courier New,courier';">http://localhost/images/example.png</span> nginx отправит в ответ файл <span style=" font-family:'Courier New,courier';">/data/images/example.png</span>. Если же этот файл не существует, nginx отправит ответ, указывающий на ошибку 404. Запросы, URI которых не начинаются на <span style=" font-family:'Courier New,courier';">/images/</span>, будут отображены на каталог <span style=" font-family:'Courier New,courier';">/data/www</span>. Например, в результате запроса <span style=" font-family:'Courier New,courier';">http://localhost/some/example.html</span> в ответ будет отправлен файл <span style=" font-family:'Courier New,courier';">/data/www/some/example.html</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы применить новую конфигурацию, запустите nginx, если он ещё не запущен, или отправьте сигнал <span style=" font-family:'Courier New,courier';">reload</span> главному процессу nginx, выполнив: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">nginx -s reload</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;">В случае если что-то работает не как ожидалось, можно попытаться выяснить причину с помощью файлов <span style=" font-family:'Courier New,courier';">access.log</span> и <span style=" font-family:'Courier New,courier';">error.log</span> из каталога <span style=" font-family:'Courier New,courier';">/usr/local/nginx/logs</span> или <span style=" font-family:'Courier New,courier';">/var/log/nginx</span>. </p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Настройка простого прокси-сервера</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Одним из частых применений nginx является использование его в качестве прокси-сервера, то есть сервера, который принимает запросы, перенаправляет их на проксируемые сервера, получает ответы от них и отправляет их клиенту. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Мы настроим базовый прокси-сервер, который будет обслуживать запросы изображений из локального каталога и отправлять все остальные запросы на проксируемый сервер. В этом примере оба сервера будут работать в рамках одного экземпляра nginx. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Во-первых, создайте проксируемый сервер, добавив ещё один блок <span style=" font-family:'Courier New,courier';">server</span> в конфигурационный файл nginx со следующим содержимым: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    listen 8080;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    root /data/up1;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это будет простой сервер, слушающий на порту 8080 (ранее директива <span style=" font-family:'Courier New,courier';">listen</span> не указывалась, потому что использовался стандартный порт 80) и отображающий все запросы на каталог <span style=" font-family:'Courier New,courier';">/data/up1</span> в локальной файловой системе. Создайте этот каталог и положите в него файл <span style=" font-family:'Courier New,courier';">index.html</span>. Обратите внимание, что директива <span style=" font-family:'Courier New,courier';">root</span> помещена в контекст <span style=" font-family:'Courier New,courier';">server</span>. Такая директива <span style=" font-family:'Courier New,courier';">root</span> будет использована, когда директива <span style=" font-family:'Courier New,courier';">location</span>, выбранная для выполнения запроса, не содержит собственной директивы <span style=" font-family:'Courier New,courier';">root</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее, используйте конфигурацию сервера из предыдущего раздела и видоизмените её, превратив в конфигурацию прокси-сервера. В первый блок <span style=" font-family:'Courier New,courier';">location</span> добавьте директиву <a href="http://nginx.org/ru/docs/http/ngx_http_proxy_module.html#proxy_pass"><span style=" text-decoration: underline; color:#0000ff;">proxy_pass</span></a>, указав протокол, имя и порт проксируемого сервера в качестве параметра (в нашем случае это <span style=" font-family:'Courier New,courier';">http://localhost:8080</span>): </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        proxy_pass http://localhost:8080;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location /images/ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        root /data;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Мы изменим второй блок <span style=" font-family:'Courier New,courier';">location</span>, который на данный момент отображает запросы с префиксом <span style=" font-family:'Courier New,courier';">/images/</span> на файлы из каталога <span style=" font-family:'Courier New,courier';">/data/images</span> так, чтобы он подходил для запросов изображений с типичными расширениями файлов. Изменённый блок <span style=" font-family:'Courier New,courier';">location</span> выглядит следующим образом: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">location ~ \.(gif|jpg|png)$ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    root /data/images;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Параметром является регулярное выражение, дающее совпадение со всеми URI, оканчивающимися на <span style=" font-family:'Courier New,courier';">.gif</span>, <span style=" font-family:'Courier New,courier';">.jpg</span> или <span style=" font-family:'Courier New,courier';">.png</span>. Регулярному выражению должен предшествовать символ <span style=" font-family:'Courier New,courier';">~</span>. Соответствующие запросы будут отображены на каталог <span style=" font-family:'Courier New,courier';">/data/images</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда nginx выбирает блок <span style=" font-family:'Courier New,courier';">location</span>, который будет обслуживать запрос, то вначале он проверяет директивы <a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#location"><span style=" text-decoration: underline; color:#0000ff;">location</span></a>, задающие префиксы, запоминая <span style=" font-family:'Courier New,courier';">location</span> с самым длинным подходящим префиксом, а затем проверяет регулярные выражения. Если есть совпадение с регулярным выражением, nginx выбирает соответствующий <span style=" font-family:'Courier New,courier';">location</span>, в противном случае берётся запомненный ранее <span style=" font-family:'Courier New,courier';">location</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итоговая конфигурация прокси-сервера выглядит следующим образом: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        proxy_pass http://localhost:8080/;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location ~ \.(gif|jpg|png)$ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        root /data/images;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Этот сервер будет фильтровать запросы, оканчивающиеся на <span style=" font-family:'Courier New,courier';">.gif</span>, <span style=" font-family:'Courier New,courier';">.jpg</span> или <span style=" font-family:'Courier New,courier';">.png</span>, и отображать их на каталог <span style=" font-family:'Courier New,courier';">/data/images</span> (добавлением URI к параметру директивы <span style=" font-family:'Courier New,courier';">root</span>) и перенаправлять все остальные запросы на проксируемый сервер, сконфигурированный выше. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы применить новую конфигурацию, отправьте сигнал <span style=" font-family:'Courier New,courier';">reload</span> nginx’у, как описывалось в предыдущих разделах. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Существует <a href="http://nginx.org/ru/docs/http/ngx_http_proxy_module.html"><span style=" text-decoration: underline; color:#0000ff;">множество</span></a> других директив для дальнейшей настройки прокси-соединения. </p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Настройка проксирования FastCGI</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">nginx можно использовать для перенаправления запросов на FastCGI-серверы. На них могут исполняться приложения, созданные с использованием разнообразных фреймворков и языков программирования, например, PHP. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Базовая конфигурация nginx для работы с проксируемым FastCGI-сервером включает в себя использование директивы <a href="http://nginx.org/ru/docs/http/ngx_http_fastcgi_module.html#fastcgi_pass"><span style=" text-decoration: underline; color:#0000ff;">fastcgi_pass</span></a> вместо директивы <span style=" font-family:'Courier New,courier';">proxy_pass</span>, и директив <a href="http://nginx.org/ru/docs/http/ngx_http_fastcgi_module.html#fastcgi_param"><span style=" text-decoration: underline; color:#0000ff;">fastcgi_param</span></a> для настройки параметров, передаваемых FastCGI-серверу. Представьте, что FastCGI-сервер доступен по адресу <span style=" font-family:'Courier New,courier';">localhost:9000</span>. Взяв за основу конфигурацию прокси-сервера из предыдущего раздела, замените директиву <span style=" font-family:'Courier New,courier';">proxy_pass</span> на директиву <span style=" font-family:'Courier New,courier';">fastcgi_pass</span> и измените параметр на <span style=" font-family:'Courier New,courier';">localhost:9000</span>. В PHP параметр <span style=" font-family:'Courier New,courier';">SCRIPT_FILENAME</span> используется для определения имени скрипта, а в параметре <span style=" font-family:'Courier New,courier';">QUERY_STRING</span> передаются параметры запроса. Получится следующая конфигурация: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        fastcgi_pass  localhost:9000;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        fastcgi_param QUERY_STRING    $query_string;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location ~ \.(gif|jpg|png)$ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        root /data/images;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Таким образом будет настроен сервер, который будет перенаправлять все запросы, кроме запросов статических изображений, на проксируемый сервер, работающий по адресу <span style=" font-family:'Courier New,courier';">localhost:9000</span>, по протоколу FastCGI. </p></body></html>