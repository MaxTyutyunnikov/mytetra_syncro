<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600;">Как в PowerShell фильтровать вывод командлета</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600; color:#000000;">Where-Object – фильтр. Сводим результаты PowerShell к самому необходимому </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">В предыдущих статьях рубрики я рассказывал о том, как с помощью конвейера (|), объединяющего несколько команд PowerShell в цепочку, можно создавать простые отчеты, например:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">get-aduser –f * -pr lastlogondate | select samaccountname,lastlogondate | sort lastlogondate</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Эта комбинация команд позволяет вывести список имен пользователей, выбрать только имена и даты последней регистрации и отсортировать результаты по дате последней регистрации. Результат выполнения такого запроса может содержать много ненужной информации. Предположим, нам требуется вывести имена и даты последней регистрации не всех пользователей, а только тех, кто не заходил в систему в течение определенного времени.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Эту задачу позволяет решить команда </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">where-object</span><span style=" font-size:10pt;">, которую практически никогда не вызывают по полному имени. В большинстве случаев для ее вызова используется </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">where</span><span style=" font-size:10pt;"> или знак вопроса (</span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">?</span><span style=" font-size:10pt;">). В предыдущих публикациях речь шла о парах команд PowerShell, состоящих из команды вывода учетных записей, соответствующих определенному критерию и команды-действия (применение определенного действия к извлеченному подмножеству AD). Рассматривались и некоторые команды, содержащие фильтры: </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">get-aduser</span><span style=" font-size:10pt;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">search-adaccount</span><span style=" font-size:10pt;"> и другие.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Where-object – это фильтр. Чтобы понять синтаксис команды, начнем с примера. Для вывода пользователей, не запускавших систему после 1 января 2013 года, построим следующий запрос:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">get-aduser -f * | where {$_.lastlogondate -le «1 January 2013»}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Команда </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">get-aduser</span><span style=" font-size:10pt;"> извлекает все учетные записи пользователей домена. Результаты передаются по конвейеру команде </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">where-object</span><span style=" font-size:10pt;">, которая проверяет каждый входящий объект на соответствие определенному критерию. Критерий, заключенный в фигурные скобки, заслуживает отдельного рассмотрения.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Запись </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">–le</span><span style=" font-size:10pt;"> означает «меньше или равно»; указанная справа дата также не вызывает вопросов. Остается разобраться, что такое </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">$_.lastlogondate</span><span style=" font-size:10pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Как уже было сказано, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">where-object</span><span style=" font-size:10pt;"> анализирует приходящие по конвейеру данные. Понятно, что утверждение </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">(нечто) -le «1 January 2013»</span><span style=" font-size:10pt;"> предполагает сопоставление этого (нечто) с указанной датой. Таким образом, данное (нечто) должно быть именно тем, что в данный момент приходит по конвейеру.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Для обозначения того, что передано по конвейеру, используется символ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">$_</span><span style=" font-size:10pt;">. Мы уже знаем, что PowerShell имеет переменные, позволяющие хранить временную информацию в памяти компьютера. Переменную можно узнать по первому символу – знаку доллара (</span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">$</span><span style=" font-size:10pt;">). Переменные можно создавать в ходе работы, но у PowerShell, как и у большинства сред построения сценариев, есть и встроенные переменные, например </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">$true</span><span style=" font-size:10pt;"> и </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">$false</span><span style=" font-size:10pt;">, хранящие значения </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">true</span><span style=" font-size:10pt;"> и </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">false</span><span style=" font-size:10pt;">. По аналогии логично было бы хранить текущее содержимое конвейера в переменной </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">$pipeline</span><span style=" font-size:10pt;">, но вместо этого используется переменная </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">$_</span><span style=" font-size:10pt;">, которая в данном случае хранит весь передаваемый по конвейеру объект – учетную запись пользователя.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Однако приведенный в нашем примере критерий предусматривает сопоставление с датой (1 января 2013 г.) не всего объекта пользователя, а лишь его свойства </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">lastlogondate</span><span style=" font-size:10pt;">. Задачу извлечения лишь нужной информации решает добавление точки и имени свойства, в результате чего получается запись </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">$_.lastlogondate</span><span style=" font-size:10pt;">. Итак, усовершенствованный с помощью </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">where-object</span><span style=" font-size:10pt;"> запрос будет выглядеть следующим образом:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">get-aduser –f * -pr lastlogondate |? {$_.lastlogondate -le «1 January 2012»} | select samaccountname,lastlogondate | sort lastlogondate</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">С помощью </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">where-object</span><span style=" font-size:10pt;"> и </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">$_</span><span style=" font-size:10pt;"> можно строить любые виды фильтров. Например, вывести имена всех пользователей, чье имя (</span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">SamAccountName</span><span style=" font-size:10pt;">) начинается с </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">F</span><span style=" font-size:10pt;">, позволяет такой запрос:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">get-aduser -f * | where {$_.samaccountname -like «f*&quot;}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Может возникнуть вопрос: зачем было тратить столько времени на обсуждение параметра -filter команды get-aduser? Почему бы не применять для всех запросов единую форму:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">get-aduser -f * | where {$_. -like»&quot;}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">С технической точки зрения, для этого нет противопоказаний, кроме одного: такой подход может привести к излишней трате полосы пропускания и времени сервера. Команда get-aduser с фильтром посылает команду контроллеру домена (DC), и DC возвращает лишь небольшое подмножество AD. Когда же результат get-aduser -f * подается на вход where-object, у DC запрашиваются все учетные записи пользователей, после чего локальный процессор отфильтровывает их, оставляя только нужные данные. Таким образом, where-object – отличный универсальный инструмент, однако следует избегать его применения, когда у исходной команды get-whatever уже есть встроенный фильтр.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p></body></html>