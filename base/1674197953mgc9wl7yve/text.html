<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В современном мире рост производительности компьютеров в первую очередь достигается не за счет увеличения скорости работы каждого отдельного ядра, а обусловлен наращиванием их количества. С текущим уровнем технологий такая тенденция будет наблюдаться еще как минимум некоторое время. Поэтому для решения все более сложных и объемных задач разработчики программного обеспечения вынуждены использовать те или иные приемы параллельных вычислений. Одним из таких приемов является использование нескольких программных потоков в рамках единого процесса. Здесь будут рассмотрены основные средства Qt, которые позволят задействовать многопоточность в Qt-программах.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Содержание</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Тестовая площадка: рисование фрактала Мандельброта</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Однопоточный алгоритм построения фрактала</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Многопоточный алгоритм построения фрактала на основе QThread</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Многопоточный алгоритм построения фрактала на основе QThreadPool</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Многопоточный алгоритм построения фрактала на основе QtConcurrent</li>
<li style=" font-family:'DejaVu LGC Sans'; font-size:12pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Заключение</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="testovaya-ploschadka-fraktal-mandelbrota"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">Т</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">естовая площадка: рисование фрактала Мандельброта</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Чтобы можно было проводить какие-либо сравнения, различные варианты использования потоков мы будем рассматривать на примере решения одной и той же задачи. В качестве такой задачи возьмем построение фрактала Мандельброта.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Сначала определим виджет, а также несколько вспомогательных классов и структур, которые позволят нам легко добавлять новые версии решений:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#ifndef FRACTALVIEW_H</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">#define FRACTALVIEW_H</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">#include &lt;QWidget&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">#include &lt;QTime&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">class QLabel;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">class QComboBox;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; font-size:15px; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; font-size:15px; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">// Настройки фрактала </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">struct FractalConf {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    double zxMin = -2.0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    double zxMax = 1.0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    double zyMin = -1.2;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    double zyMax = 1.2;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    double step = 0.0026;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    int maxIterCount = 0xFF;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    int getImageWidth() const {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">        if( step &lt;= 0.0 ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">            return -1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">        return ceil( ( zxMax - zxMin ) / step );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    int getImageHeight() const {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">        if( step &lt;= 0.0 ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">            return -1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">        return ceil( ( zyMax - zyMin ) / step );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; font-size:15px; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">class FractalDrawAlgorithm;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; font-size:15px; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">// Область отображания фрактала</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">class FractalView : public QWidget {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    Q_OBJECT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    FractalView( const FractalConf&amp; fractalConf, QWidget* parent = 0 );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    ~FractalView();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    void addAlgorithm( const QString&amp; name, FractalDrawAlgorithm* algorithm );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">public slots:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    void onStarted();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    void onPartAvailable( int x, int y, const QImage&amp; img );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    void onFinished();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">private:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    QLabel* m_lblView;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    QLabel* m_lblTime;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    QComboBox* m_cmbAlgorithm;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    QTime m_time;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    FractalConf m_fractalConf;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    QImage m_img;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    QVector&lt; FractalDrawAlgorithm* &gt; m_algorithms;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">};</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; font-size:15px; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">// Алгоритм отрисовки фрактала</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">class FractalDrawAlgorithm : public QObject {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    Q_OBJECT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    FractalDrawAlgorithm( QObject* parent = 0 ) : QObject( parent ) { }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    void setFractalConf( const FractalConf&amp; fractal ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">        m_fractalConf = fractal;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">public slots:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    virtual void start() = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">signals:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    void partAvailable( int x, int y, const QImage&amp; img );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    void ready();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">protected:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">    FractalConf m_fractalConf;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">};</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:15px; color:#6a1009;">#endif // FRACTALVIEW_H</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:15px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:15px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Структура </span><a name="crayon-63ca3772d8a2b930632187"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> определяет конфигурацию фрактала, который мы хотим нарисовать. Она содержит поля </span><a name="crayon-63ca3772d8a39619365492"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">xMin</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><a name="crayon-63ca3772d8a3c941644678"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">xMax</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><a name="crayon-63ca3772d8a3d710661405"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">yMin</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><a name="crayon-63ca3772d8a3f150029712"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">yMax</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><a name="crayon-63ca3772d8a40130128666"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tep</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a41320236651"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">axIterCount</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1674198082wzf4gr6ode.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">На графике мы видим две координатные сетки: внешнюю с координатами </span><a name="crayon-63ca3772d8a43851954207"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x; y)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и внутреннюю с координатами </span><a name="crayon-63ca3772d8a44363131159"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">zx, zy)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Обе они определяют одно и то же изображение фрактала. Однако внешняя соответствует его графическому представлению в пикселях, которое предназначено для вывода на экран с началом координат в левом верхнем углу. Внутренняя же определяет математическое представление фрактала Мандельброта с более традиционным расположением начала координат. Обратим внимание, что на осях </span><a name="crayon-63ca3772d8a45702375891"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a46087314859"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> отложено по две точки: </span><a name="crayon-63ca3772d8a48738568035"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">xMin=-2.0</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><a name="crayon-63ca3772d8a49156366703"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">xMax=1.0</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a4a787141626"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">yMin=-1.2</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><a name="crayon-63ca3772d8a4b192210243"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">yMax=1.2</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, которые задают границы прямоугольной области. Эти значения и определены в одноименных полях структуры </span><a name="crayon-63ca3772d8a4c141678660"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Кроме того, нам необходимо выбрать шаг, с которым мы будем двигаться по внутренней координатной сетке фрактала. Это связано с тем, что рисовать фрактал мы будем по точкам (пикселям). И расстояние от предыдущей до следующей точки должно быть постоянным. Такое расстояние определено в поле структуры </span><a name="crayon-63ca3772d8a4e194897177"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и называется </span><a name="crayon-63ca3772d8a4f901790763"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tep</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Для каждой точки фрактала Мандельброта с координатами </span><a name="crayon-63ca3772d8a50847306315"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">zx; zy)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> определяется некая «глубина», для расчета которой используется рекуррентный алгоритм. Чтобы этот алгоритм не оказался бесконечным, необходимо определить максимальную глубину, то есть максимальное количество итераций, после выполнения которых мы считаем, что глубина найдена. Это значение также определено в структуре </span><a name="crayon-63ca3772d8a51893924862"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в поле с </span><a name="crayon-63ca3772d8a53903156686"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">axIterCount</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Чтобы изобразить фрактал нам нужно «раскрасить» каждую его точку на основе найденной глубины, а также перейти от математических координат фрактала к координатам в пикселях. О решении этих задач мы поговорим немного позже. Однако заметил, что найти размеры изображения в пикселях, которое мы будем рисовать, совсем не трудно, что и демонстрируют следующие функции-члены структуры </span><a name="crayon-63ca3772d8a54254957461"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">: </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">int getImageWidth() const {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    if( step &lt;= 0.0 ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        return -1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    return ceil( ( zxMax - zxMin ) / step );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">int getImageHeight() const {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    if( step &lt;= 0.0 ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        return -1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    return ceil( ( zyMax - zyMin ) / step );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Дальше поговорим о классе виджета </span><a name="crayon-63ca3772d8a56740879463"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalView</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. В конструкторе мы заранее передаем ему конфигурацию фрактала </span><a name="crayon-63ca3772d8a58104226583"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. То есть мы будем рисовать один и тот же фрактал Мандельброта разными методами, которые представим с помощью абстрактного класса </span><a name="crayon-63ca3772d8a59789939743"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalDrawAlgorithm</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Конкретные алгоритмы, реализующие этот класс, можно будет добавлять к экземплярам класса </span><a name="crayon-63ca3772d8a5a929470116"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalView</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> с помощью функции-члена </span><a name="crayon-63ca3772d8a5b897472536"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">a</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ddAlogrithm()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Получаем некую вариацию паттерна Стратегия.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Связь между виджетом и алгоритмами определяется с помощью сигналов и слотов. Для запуска алгоритма используется виртуальный слот </span><a name="crayon-63ca3772d8a5c969322754"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalDrawAlgorithm::start()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, который будет вызываться в приложении по нажатию кнопки на виджете. О результатах своей работы алгоритмы будут сообщать с помощью сигналов </span><a name="crayon-63ca3772d8a5e837878692"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">p</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">artAvailable()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a5f036543618"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Первый будет привязан к слоту виджета </span><a name="crayon-63ca3772d8a60241692165"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">nPartAvailable()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и вернет промежуточный результат построения фрактала в виде координат </span><a name="crayon-63ca3772d8a61406465302"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x; y)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и изображения </span><a name="crayon-63ca3772d8a63186807869"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Image</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Такое решение связано с тем, что мы будем рисовать фрактал в нескольких потоках по частям. Поэтому для наглядности имеет смысл отображать не весь фрактал сразу, а компоновать его из полученных кусочков, как мозаику. Это повышает отзывчивость интерфейса приложения и пользователям кажется, что оно работает быстрее. Когда же алгоритм завершит свою работу, то он должен вызвать сигнал </span><a name="crayon-63ca3772d8a64524144688"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, чтобы сообщить виджету, что все готово. Нам понадобится это для того, чтобы делать замеры времени и сравнить скорость работы различных версий алгоритмов.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Рассмотрим реализацию класса </span><a name="crayon-63ca3772d8a65027879389"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalView</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &quot;fractalview.h&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;QLabel&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;QComboBox&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;QVBoxLayout&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;QPushButton&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">#include &lt;QPainter&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">FractalView::FractalView( const FractalConf&amp; fractalConf, QWidget* parent ) :</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    QWidget( parent ),</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_fractalConf( fractalConf ),</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_img( m_fractalConf.getImageWidth(), m_fractalConf.getImageHeight(), QImage::Format_RGB888 ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    QVBoxLayout* mainLayout = new QVBoxLayout;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_lblView = new QLabel;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_lblView-&gt;setAlignment( Qt::AlignCenter );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    mainLayout-&gt;addWidget( m_lblView, 1 );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    QHBoxLayout* panelLayout = new QHBoxLayout;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_cmbAlgorithm = new QComboBox;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    panelLayout-&gt;addWidget( m_cmbAlgorithm );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    QPushButton* btnStart = new QPushButton( trUtf8( &quot;Поехали!&quot; ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    connect( btnStart, SIGNAL( clicked() ), SLOT( onStarted() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    panelLayout-&gt;addWidget( btnStart );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_lblTime = new QLabel;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    panelLayout-&gt;addWidget( m_lblTime );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    panelLayout-&gt;addStretch();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    mainLayout-&gt;addLayout( panelLayout );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    setLayout( mainLayout );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    resize( 800, 800 );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">FractalView::~FractalView() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void FractalView::addAlgorithm( const QString&amp; name, FractalDrawAlgorithm* algorithm ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_cmbAlgorithm-&gt;addItem( name );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_algorithms &lt;&lt; algorithm;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    connect(</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        algorithm,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        SIGNAL( partAvailable( int, int, QImage ) ),</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        SLOT( onPartAvailable( int, int, QImage ) )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    connect( algorithm, SIGNAL( ready() ), SLOT( onFinished() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void FractalView::onStarted() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_img.fill( Qt::white );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_lblView-&gt;clear();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_time.start();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    if( !m_algorithms.isEmpty() ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        FractalDrawAlgorithm* algorithm = m_algorithms[ m_cmbAlgorithm-&gt;currentIndex() ];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        algorithm-&gt;setFractalConf( m_fractalConf );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        algorithm-&gt;start();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void FractalView::onPartAvailable( int x, int y, const QImage&amp; img ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    QPainter painter;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    painter.begin( &amp;m_img );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    painter.drawImage( x, y, img );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    painter.end();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_lblView-&gt;setPixmap( QPixmap::fromImage( m_img ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void FractalView::onFinished() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_lblTime-&gt;setText( trUtf8( &quot;&lt;strong&gt;%1&lt;/strong&gt; sec&quot; ).arg( m_time.elapsed() / 1000.0 ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Как видим, здесь нет ничего необычного. В конструкторе мы просто компонуем элементы UI на нашем виджете. Кроме того, заметьте, что еще в конструкторе мы проинициализировали изображение </span><a name="crayon-63ca3772d8a68524983742"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">_img</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> с шириной и высотой, которую будет иметь фрактал с переданной конфигурацией. На виджете у нас будет всего одна кнопка, комбо-бокс и несколько лейблов. Кнопка будет запускать алгоритм рисования фрактала в слоте виджета </span><a name="crayon-63ca3772d8a6a485284514"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">nStarted()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Причем в этом слоте мы запускаем таймер, с помощью которого определим время, затраченное на работу алгоритма. Выбор алгоритма осуществляется с помощью выпадающего списка.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В функции-члене </span><a name="crayon-63ca3772d8a6c635763294"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">a</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ddAlgorithm()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> сигналы добавленных алгоритмов привязываются к слотам </span><a name="crayon-63ca3772d8a6d570989574"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">nPartAvalilabe()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a6e918060506"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">nFinished()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Об их назначении мы уже говорили. Однако заметим, что склеивание частей фрактала осуществляется с помощью </span><a name="crayon-63ca3772d8a6f133523694"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Painter</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и его функции-члена </span><a name="crayon-63ca3772d8a71697467424"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">rawImage()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Затем получившееся изображение выводится вызовом </span><a name="crayon-63ca3772d8a72069238989"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etPixmap()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. А после поступления сигнала готовности в слот </span><a name="crayon-63ca3772d8a73834993822"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">nFinished()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> мы просто выводим прошедшее с начала запуска алгоритма время.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В результате у нас получился такой, пока что почти пустой, виджет:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1674198082acdnpsl2el.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Пришло время добавить алгоритмы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> </span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="odnopotochnyy-algoritm-postroeniya-fraktala"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">О</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">днопоточный алгоритм построения фрактала</span></h2>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Начнем с однопоточного алгоритма построения фрактала. Без него нам все равно не обойтись. Возьмем простейшую реализацию функции, которая нарисует нам фрактал Мандельброта с заданной конфигурацией:</span><span style=" color:#000000;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">int makeIter( double zx, double zy, int maxIterCount ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    int count = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    double zxIter = zx;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    double zyIter = zy;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    while( ( zxIter * zxIter + zyIter * zyIter &lt;= 4.0 ) &amp;&amp; ( count &lt; maxIterCount ) ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        double zxIterOld = zxIter;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        zxIter = zxIter * zxIter - zyIter * zyIter + zx;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        zyIter = 2 * zxIterOld * zyIter + zy;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        ++count;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    return count;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">QImage drawFractal( const FractalConf&amp; fractalConf ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    const int IMG_WIDTH = fractalConf.getImageWidth();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    const int IMG_HEIGHT = fractalConf.getImageHeight();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    if( IMG_WIDTH &lt;= 0 || IMG_HEIGHT &lt;= 0 ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        return QImage();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    QImage img( IMG_WIDTH, IMG_HEIGHT, QImage::Format_RGB888 );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    img.fill( Qt::white );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    QPainter painter;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    painter.begin( &amp;img );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    double zx = fractalConf.zxMin;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    for( int x = 0; x &lt; IMG_WIDTH; ++x, zx += fractalConf.step ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        double zy = fractalConf.zyMin;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        for( int y = 0; y &lt; IMG_HEIGHT; ++y, zy += fractalConf.step ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            int count = makeIter( zx, zy, fractalConf.maxIterCount );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            QPen pen( count == fractalConf.maxIterCount ?  Qt::black : count &lt;&lt; 11 );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            painter.setPen( pen );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            painter.drawPoint( x, y );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    painter.end();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    return img;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Функция </span><a name="crayon-63ca3772d8a76571123622"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">akeIter()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> находит глубину точки фрактала, о которой мы говорили в предыдущем разделе. Ее реализация стандартна, поэтому останавливаться на ней не будем. Нашей рабочей функцией является </span><a name="crayon-63ca3772d8a77368483788"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">rawFractal()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Она превращает конфигурацию фрактала </span><a name="crayon-63ca3772d8a78790695467"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в соответствующее изображение </span><a name="crayon-63ca3772d8a7a921095247"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Image</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, которое мы можем отобразить на экране. Сначала мы просто создаем пустое изображение </span><a name="crayon-63ca3772d8a7b585012788"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Image</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, на котором будем рисовать. Его ширина и высота в пикселях определяются с помощью подготовленных ранее функций </span><a name="crayon-63ca3772d8a7c107075576"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">g</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etImageWidth()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a7d011950041"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">g</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">etImageHeight()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Построение фрактала мы проводим в двойном цикле по пиксельной координатной сетке изображения </span><a name="crayon-63ca3772d8a7e620813218"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x; y)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> с началом координат в левом верхнем углу. Параллельно с </span><a name="crayon-63ca3772d8a80514660182"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a81711389127"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> мы двигаемся по математическим координатам </span><a name="crayon-63ca3772d8a82094978788"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a83522392687"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в заданной конфигурацией фрактала области. Для координат изображения в пикселях все совсем просто. У нас есть известное количество пикселей с двумя координатами и каждый из них должен быть заполнен. Ровно это мы и делаем, проходя в цикле по всему изображению. Но по точкам в математической координатной сетке фрактала </span><a name="crayon-63ca3772d8a84669225490"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">zx, zy)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> так легко ходить мы не можем. И здесь на помощь приходит шаг </span><a name="crayon-63ca3772d8a86154909160"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tep</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Таким образом, мы начинаем с точек </span><a name="crayon-63ca3772d8a87523937717"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x; y) = (0; 0)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a88267878706"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">zx; zy) = (zxMin; zyMin)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Внутренний цикл проходит по оси </span><a name="crayon-63ca3772d8a89593328571"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, поэтому далее последуют точки </span><a name="crayon-63ca3772d8a8a158685041"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x; y) = (0; 1)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a8c514177379"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">zx; zy) = (zxMin; zyMin + step)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Затем мы попадем в точки </span><a name="crayon-63ca3772d8a8d647851182"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x; y) = (0; 2)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a8e256007273"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">zx; zy) = (zxMin; zyMin + 2 * step)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. И так до тех пор, пока не пройдем каждый пиксель изображения, а заодно и соответствующие точки фрактала в нужной нам области. Здесь стоит обратить внимание, что направление роста осей </span><a name="crayon-63ca3772d8a8f538787395"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8a90446263072"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> будут отличаться, поскольку они направлены в разные стороны, но нас это не сильно волнует, так как фрактал вдоль этих осей симметричен.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Как и для склейки частей фрактала, в </span><a name="crayon-63ca3772d8a92529898482"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">rawFractal()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> используется </span><a name="crayon-63ca3772d8a93950958786"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Painter</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, однако мы рисуем по точкам, поэтому используется функция-член </span><a name="crayon-63ca3772d8a94730342271"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">rawPoint()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Для каждой точки мы сначала вычисляем глубину с помощью </span><a name="crayon-63ca3772d8a95368106185"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">akeIter()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, а затем полученное значение превращаем в цвет. Если глубина достигла установленного максимума, то делаем точку черной, иначе определяем цвет на основе получившейся глубины с помощью выражения </span><a name="crayon-63ca3772d8a96318179512"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">c</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ount &lt;&lt; 11</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Вообще, существует множество способов раскраски фрактала Мандельброта, но я для примера выбрал один из простейших.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Теперь реализуем первый алгоритм рисования, который назовем </span><a name="crayon-63ca3772d8a98895117766"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">E</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">asyFractalDrawAlgorithm</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Он и правда простой:</span><span style=" color:#000000;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">class EasyFractalDrawAlgorithm : public FractalDrawAlgorithm {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    Q_OBJECT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    explicit EasyFractalDrawAlgorithm( QObject* parent = 0 ) :</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        FractalDrawAlgorithm( parent ) { }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public slots:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    void start() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        emit partAvailable( 0, 0, drawFractal( m_fractalConf ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        emit ready();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Этот алгоритм основан на приведенной ранее функции </span><a name="crayon-63ca3772d8a9a588048311"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">rawFractal()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Отдельных частей мы здесь не формируем, а возвращаем сразу весь фрактал. А затем сразу же сообщаем о том, что все готово.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Напишем функцию </span><a name="crayon-63ca3772d8a9b233544706"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ain()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, и проведем первое испытание:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">int main( int argc, char* argv[] ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    QApplication a( argc, argv );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    FractalConf fractalConf;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    FractalView w( fractalConf );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    w.addAlgorithm( &quot;Easy&quot;, new EasyFractalDrawAlgorithm( &amp;w ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    w.show();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    return a.exec();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Вот результат запуска на моем компьютере:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image16741980824wnlqfzmxq.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Построение заняло 621 миллисекунду. Не так уж и плохо, но это все же заметная глазу пауза. К тому же, приложение на это время стало неотзывчивым, поскольку главный поток был занят вычислениями и не мог реагировать на действия пользователя.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Пришло время потоков приступить к выполнению своих обязанностей.</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="mnogopotochnyy-algoritm-postroeniya-fraktala"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">М</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ногопоточный алгоритм построения фрактала на основе QThread</span></h2>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Прежде чем перейти к реализации многопоточной версии алгоритма, определим вспомогательный класс </span><a name="crayon-63ca3772d8a9f705793232"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalDrawTask</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">class FractalDrawTask : public QObject, public QRunnable {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    Q_OBJECT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    FractalDrawTask( int x, int y, const FractalConf&amp; fractalConf, QObject* parent = 0 ) :</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        QObject( parent ), m_x( x ), m_y( y ), m_fractalConf( fractalConf ) { }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public slots:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    void run() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        emit ready( m_x, m_y, drawFractal( m_fractalConf ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">signals:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    void ready( int x, int y, const QImage&amp; img );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">private:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    int m_x;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    int m_y;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    FractalConf m_fractalConf;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Он наследует классы </span><a name="crayon-63ca3772d8aa2856264103"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Object</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8aa3231652377"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Runnable</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Первый нужен для того, чтобы мы могли пользоваться сигналами и слотами, а причины использования второго станут понятны немного позже. Конструктор класса </span><a name="crayon-63ca3772d8aa4559772869"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalDrawTask</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> принимает координаты </span><a name="crayon-63ca3772d8aa5671515220"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8aa6973593349"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, а также конфигурацию фрактала </span><a name="crayon-63ca3772d8aa8501437881"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Координаты в самом классе напрямую не используются, однако он возвращает их с помощью сигнала </span><a name="crayon-63ca3772d8aa9929671991"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в слоте </span><a name="crayon-63ca3772d8aaa116391519"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">un()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> вместе с изображением фрактала, построенным по заданной конфигурации.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Теперь посмотрим на первую многопоточную версию алгоритма:</span><span style=" color:#000000;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">class MultiThreadedFractalDrawAlgorithm : public FractalDrawAlgorithm {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    Q_OBJECT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    MultiThreadedFractalDrawAlgorithm( int threadCount = QThread::idealThreadCount(), QObject* parent = 0 ) :</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        FractalDrawAlgorithm( parent ), m_threadCount( threadCount ) { }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public slots:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    void start();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    virtual void start( int x, int y, const FractalConf&amp; fractalConf ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        FractalDrawTask* task = new FractalDrawTask( x, y, fractalConf );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        QThread* thread = new QThread;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        connect( thread, SIGNAL( finished() ), task, SLOT( deleteLater() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        connect( thread, SIGNAL( finished() ), thread, SLOT( deleteLater() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        connect( task, SIGNAL( ready( int, int, QImage ) ), SLOT( onPartReady( int, int, QImage ) ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        connect( task, SIGNAL( ready( int, int, QImage ) ), thread, SLOT( quit() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        connect( thread, SIGNAL( started() ), task, SLOT( run() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        task-&gt;moveToThread( thread );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        thread-&gt;start();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">protected slots:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    void onPartReady( int x, int y, const QImage&amp; img );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">private:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    int m_threadCount;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    int m_taskCount;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">};</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void MultiThreadedFractalDrawAlgorithm::start() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    const int IMG_HEIGHT = m_fractalConf.getImageHeight();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    if( IMG_HEIGHT &lt;= 0 ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        emit ready();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        return;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    m_taskCount = m_threadCount;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    const int BLOCK_HEIGHT = IMG_HEIGHT / m_taskCount;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    const double BLOCK_STEP = BLOCK_HEIGHT * m_fractalConf.step;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    FractalConf fractalConf = m_fractalConf;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    fractalConf.zyMax = m_fractalConf.zyMin + BLOCK_STEP;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    for( int y = 0; y &lt; IMG_HEIGHT; y += BLOCK_HEIGHT ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        start( 0, y, fractalConf );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        fractalConf.zyMin = fractalConf.zyMax;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        fractalConf.zyMax += BLOCK_STEP;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void MultiThreadedFractalDrawAlgorithm::onPartReady( int x, int y, const QImage&amp; img ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    emit partAvailable( x, y, img );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    --m_taskCount;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    if( m_taskCount == 0 ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        emit ready();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Количество потоков, которое будет задействовано алгоритмом, мы можем указать через конструктор класса в параметре </span><a name="crayon-63ca3772d8aad704993519"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">t</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">hreadCount</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Использоваться этот параметр будет в реализации слота </span><a name="crayon-63ca3772d8aae691119047"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tart()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Рассмотрим ее поподробнее. Ключевым моментом здесь является то, что мы делим ожидаемую высоту готового изображения фрактала в пикселях на количество потоков. Например, для четырех потоков имеем:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1674198082wzf4gr6ode.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Расстояние между началом и концом каждой получившейся горизонтальной полосы постоянно и равно высоте изображения в пикселях, разделенной на количество потоков. Зная высоту одной полосы в пикселях, которую обозначили </span><a name="crayon-63ca3772d8aaf610857000"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">B</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">LOCK_HEIGHT</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, легко найти соответствующую высоту полосы во внутренней системе координат </span><a name="crayon-63ca3772d8ab1432330807"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">(</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">zx; zy)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Для этого просто умножим </span><a name="crayon-63ca3772d8ab2342595801"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">B</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">LOCK_HEIGHT</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> на величину шага </span><a name="crayon-63ca3772d8ab3841640618"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tep</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, определенную во </span><a name="crayon-63ca3772d8ab4677544665"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Далее следует простой цикл, в котором мы двигаемся по оси </span><a name="crayon-63ca3772d8ab5680340927"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> с шагом, равным </span><a name="crayon-63ca3772d8ab7501032366"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">B</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">LOCK_HEIGHT</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Параллельно мы двигаемся по оси </span><a name="crayon-63ca3772d8ab8278058368"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">z</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> с найденным ранее шагом </span><a name="crayon-63ca3772d8ab9952931205"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">B</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">LOCK_STEP</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Для каждой полосы мы определяем соответствующую конфигурацию </span><a name="crayon-63ca3772d8aba903969795"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalConf</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и передаем ее вместе с координатами </span><a name="crayon-63ca3772d8abb358194618"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">x</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8abc093810421"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">y</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в слот </span><a name="crayon-63ca3772d8abe938389628"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tart()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. В этом слоте происходит непосредственное создание и вызов потока для обработки переданной полосы фрактала. Сначала мы создаем новый объект задачи </span><a name="crayon-63ca3772d8abf274211478"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalDrawTask</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, передавая ей переданные параметры. Далее определяем новый поток, в котором будет решаться эта задача. Но перед запуском потока связываем сигналы и слоты: </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">connect( thread, SIGNAL( finished() ), task, SLOT( deleteLater() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">connect( thread, SIGNAL( finished() ), thread, SLOT( deleteLater() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">connect( task, SIGNAL( ready( int, int, QImage ) ), SLOT( onPartReady( int, int, QImage ) ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">connect( task, SIGNAL( ready( int, int, QImage ) ), thread, SLOT( quit() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">connect( thread, SIGNAL( started() ), task, SLOT( run() ) );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Первые два коннекта определяют связь между завершением потока и удалением объектов, чтобы предотвратить утечки памяти. Затем мы привязываем сигнал </span><a name="crayon-63ca3772d8ac1533062660"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> к слоту </span><a name="crayon-63ca3772d8ac3724278153"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">nPartReady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, в котором мы перенаправим результаты в виджет, чтобы он смог отобразить подготовленную часть фрактала. Кроме того, в слоте </span><a name="crayon-63ca3772d8ac4186982140"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">nPartReady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> мы также проверим, была ли эта часть последней или есть еще. Если окажется, что частей больше нет, то мы вызовем сигнал </span><a name="crayon-63ca3772d8ac5547643000"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Завершение работы потока также привязывается к сигналу </span><a name="crayon-63ca3772d8ac6061219251"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> объекта </span><a name="crayon-63ca3772d8ac7907742310"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">t</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ask</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. А запуск слота </span><a name="crayon-63ca3772d8ac9526476933"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">un()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> для решения задачи связывается с сигналом потока </span><a name="crayon-63ca3772d8aca755541182"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tarted()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Важно не забыть перевести объект </span><a name="crayon-63ca3772d8acb653090514"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">t</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ask</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> для работы в потоке и все запустить: </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">task-&gt;moveToThread( thread );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">thread-&gt;start();</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Для добавления этого алгоритма в наш виджет достаточно добавить в функции </span><a name="crayon-63ca3772d8acd115354994"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ain()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> строку следующего вида:</span><span style=" color:#000000;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">w.addAlgorithm( &quot;MultiThreaded&quot;, new MultiThreadedFractalDrawAlgorithm( 8, &amp;w ) );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Мой процессор имеет 8 ядер, поэтому такой вариант показал максимальную производительность и составил в среднем 180 миллисекунд. Для однопоточной реализации была 621 миллисекунда, то есть скорость возросла примерно в три с половиной раза. Я пробовал запускать обе версии со значениями параметра </span><a name="crayon-63ca3772d8ad0611997086"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">m</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">axIterCount</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> побольше и разница оказалась примерно такой же. Однако увеличение скорости в 3,5 раза уже серьезный показатель. Более того, многопоточная версия не блокирует графический интерфейс пользователя и практически сразу начинает выдавать фрагменты изображения с фракталом, а это лишний раз показывает, что приложение не зависло, а делает свою работу.</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="mnogopotochnyy-algoritm-postroeniya-fraktala-2"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">М</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ногопоточный алгоритм построения фрактала на основе QThreadPool</span></h2>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Оказывается, рассмотренный выше пример можно реализовать еще проще. Для этого в Qt существует </span><a name="crayon-63ca3772d8ad2601129953"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ThreadPool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Рассмотрим соответствующую версию алгоритма:</span><span style=" color:#000000;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">class ThreadPoolFractalDrawAlgorithm : public MultiThreadedFractalDrawAlgorithm {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    Q_OBJECT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    ThreadPoolFractalDrawAlgorithm( int threadCount = QThread::idealThreadCount() , QObject* parent = 0 ) :</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        MultiThreadedFractalDrawAlgorithm( threadCount, parent ) { }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public slots:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    void start( int x, int y, const FractalConf&amp; fractalConf ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        FractalDrawTask* task = new FractalDrawTask( x, y, fractalConf );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        connect( task, SIGNAL( ready( int, int, QImage ) ), SLOT( onPartReady( int, int, QImage ) ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        m_threadPool.start( task );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">private:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    QThreadPool m_threadPool;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Новый алгоритм </span><a name="crayon-63ca3772d8ad5601911113"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">T</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">hreadPoolFractalDrawAlgorithm</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> наследует класс </span><a name="crayon-63ca3772d8ad6791765380"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">M</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ultiThreadedFractalDrawAlgorithm</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, чтобы повторно использовать цикл прохода по полосам фрактала и всего лишь реализует свою версию слота </span><a name="crayon-63ca3772d8ad7274972220"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tart()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. А в ней все значительно лаконичнее, чем было у его предка. Мы также создаем объект задачи </span><a name="crayon-63ca3772d8ad9559094409"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">t</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ask</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, но теперь достаточно лишь привязать сигнал </span><a name="crayon-63ca3772d8ada098774621"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> с нашим слотом-обработчиком </span><a name="crayon-63ca3772d8adb419052994"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">o</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">nPartReady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, а обо всем остальном уже позаботится </span><a name="crayon-63ca3772d8adc677731310"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ThreadPool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Он и поток создаст, и задачу запустит и память освободит. А что еще нужно? — Чтобы быстро работало. Но и здесь все прекрасно. В среднем производительность ничем не отличается от версии, где мы сами создавали потоки, поэтому для реализации простой логики взаимодействия потоков, как у нас, этот подход является наилучшим.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Но не так быстро. А откуда </span><a name="crayon-63ca3772d8add066614272"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ThreadPool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> знает, каким образом нужно запускать наш </span><a name="crayon-63ca3772d8adf047469937"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">t</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ask</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">? — Все очень просто. Помните, при объявлении класса </span><a name="crayon-63ca3772d8ae0629160867"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">F</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ractalDrawTask</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> мы наследовали его от </span><a name="crayon-63ca3772d8ae1164583060"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Object</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8ae2588288544"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Runnable</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">? Так вот второй унаследованный класс здесь нам и пригодился. Он имеет виртуальную функцию-член </span><a name="crayon-63ca3772d8ae3849006823"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">un()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, которую мы определили в виде слота и реализовали. А </span><a name="crayon-63ca3772d8ae5924504492"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ThreadPool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> при вызове </span><a name="crayon-63ca3772d8ae6454474689"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">s</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tart()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> как раз и ожидает указатель на </span><a name="crayon-63ca3772d8ae7957593563"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Runnable</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, для которого потом запускает </span><a name="crayon-63ca3772d8ae8205559439"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">un()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> в потоке.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Еще одно преимущество </span><a name="crayon-63ca3772d8b00662831745"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ThreadPool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> заключается в том, что он может компоновать очередь задач, если все выделенные потоки уже задействованы. Когда поток освобождается, то он автоматически переключается на решение одной из задач в очереди. Это очень удобно, если количество потоков существенно меньше числа задач, которые мы ему передаем.</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="mnogopotochnyy-algoritm-postroeniya-fraktala-3"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">М</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">ногопоточный алгоритм построения фрактала на основе QtConcurrent</span></h2>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Я сначала сомневался, стоит ли включать сюда этот вариант, но решил, что для полноты картины не помешает упомянуть и его. Однако заранее отмечу, что такой вариант использования, который мы сейчас рассмотрим, является допустимым, но не целевым. Думаю, что по многопоточности будут еще заметки и в них мы уже рассмотрим более подходящий пример. А для решения нашей текущей задачи по построению фрактала лучше использовать </span><a name="crayon-63ca3772d8b04024136389"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ThreadPool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Но перейдем к делу. Вот реализация на основе </span><a name="crayon-63ca3772d8b08871918841"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tConcurrent::run()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">: </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">class ConcurrentFractalDrawAlgorithm : public MultiThreadedFractalDrawAlgorithm {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    Q_OBJECT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    ConcurrentFractalDrawAlgorithm( int threadCount = QThread::idealThreadCount() , QObject* parent = 0 ) :</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        MultiThreadedFractalDrawAlgorithm( threadCount, parent ) { }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public slots:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    void start( int x, int y, const FractalConf&amp; fractalConf ) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        FractalDrawTask* task = new FractalDrawTask( x, y, fractalConf );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        connect( task, SIGNAL( ready( int, int, QImage ) ), SLOT( onPartReady( int, int, QImage ) ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        connect( task, SIGNAL( ready( int, int, QImage ) ), task, SLOT( deleteLater() ) );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        QtConcurrent::run( task, &amp;FractalDrawTask::run );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Получившаяся реализация чем-то похожа на то, что было в версии на основе </span><a name="crayon-63ca3772d8b0b942637359"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ThreadPool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Однако здесь мы вынуждены явно установить соединение сигнала </span><a name="crayon-63ca3772d8b0c943130479"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eady()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и слота </span><a name="crayon-63ca3772d8b0e845677095"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">d</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">eleteLater()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> для удаления объекта. Кроме того, нам приходится передавать указатель на функцию </span><a name="crayon-63ca3772d8b0f587506625"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">r</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">un()</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, которую мы хотим вызвать. Скорость работы этой версии, как и ожидалось, ничем не хуже и не лучше других рассмотренных многопоточных решений. Если выбирать между этой реализацией и вариантом на основе </span><a name="crayon-63ca3772d8b10117491341"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Thread</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, то, конечно, более предпочтительным выглядит </span><a name="crayon-63ca3772d8b11020665761"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tConcurrent</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Однако повторю еще раз, что сила </span><a name="crayon-63ca3772d8b13393256423"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tConcurrent</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> заключается в решении другого типа задач, но об этом мы поговорим уже в другой заметке (см. </span><a href="https://tech-geek.ru/example-of-using-qtconcurrent/"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; text-decoration: underline; color:#0000ff;">Пример использования QtConcurrent</span></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">).</span></p>
<h2 style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="zaklyuchenie"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">З</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt; font-weight:600;">аключение</span></h2>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">В этой заметке мы коротко прошлись по базовым принципам работы с потоками в Qt-приложениях. Рассмотрели несколько вариантов алгоритма построения фрактала Мандельброта с применением </span><a name="crayon-63ca3772d8b14739832165"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Thread</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, </span><a name="crayon-63ca3772d8b15428414943"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ThreadPool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;"> и </span><a name="crayon-63ca3772d8b16922794916"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">tConcurrent</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">. Убедились, что прирост производительности этих решений по сравнению с однопоточной версией и правда есть, причем не маленький. И остановились на том, что для рассмотренной задачи наиболее оптимальным выбором является использование </span><a name="crayon-63ca3772d8b18278392250"></a><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">Q</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">ThreadPool</span><span style=" font-family:'DejaVu LGC Sans'; font-size:12pt;">, который сочетает в себе простоту использования и гибкость работы.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu LGC Sans'; font-size:12pt;"><br /></p></body></html>