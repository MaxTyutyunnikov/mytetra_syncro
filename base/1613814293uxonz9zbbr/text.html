<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Почему для синхронизации не подходит rsync?</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Rsync - это утилита резервного копирования. Она умеет делать полный дубликат директории-источника в директорию приемника. И такое простое поведение не подходит для организации процесса синхронизации в случае, если файлы в директории изменяются (между запусками <span style=" font-family:'FreeMono'; color:#6a1009;">rsync</span>) как на стороне источника, так и на стороне приемника. По-сути, все изменения в файлах приемника просто перезатрутся содержимым файла источника, если файлы будут различаться.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поэтому для организации настоящего процесса синхронизации нужно пользоваться другим классом программ, которые специально предназначены для синхронизации.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Что такое утилита Unison</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://www.cis.upenn.edu/~bcpierce/unison/"><span style=" text-decoration: underline; color:#0000ff;">Unison</span></a> - это замечательная кроссплатформенная утилита, предназначенная для двусторонней синхронизации директорий. Она написана на языке <span style=" font-family:'FreeMono'; color:#6a1009;">ocalm</span>. Так как язык в некоторой степени экзотичен, авторы выкладывают статические сборки на странице проекта на GitHub:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://github.com/bcpierce00/unison/releases"><span style=" text-decoration: underline; color:#0000ff;">https://github.com/bcpierce00/unison/releases</span></a></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Там можно подобрать версию, подходящую для различных дистрибутивов Linux, имеющих различные версии ядер и библиотеки LIBC. Этой утилитой можно пользоваться как в консоли, так и через GTK-интерфейс, поставляемый в виде дополнительного бинарника. Помимо Linux-платформ, утилита unison имеет статические сборки для Windows и MacOs.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В процессе работы утилита <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span> создает в пользовательской директории каталог с названием &quot;.unison&quot;, в котором скапливается информация о состоянии файлов в директориях, которые участвуют в синхронизации. По-сути, <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span> запоминает информацию о том, в каком состоянии файл был, и в случае его изменения на любой стороне синхронизации, копирует в нужную сторону состояние именно измененного файла. Для процесса передачи содержимого файлов unison использует механизм утилиты <span style=" font-family:'FreeMono'; color:#6a1009;">rsync</span>, как наиболее быстродействующий из открытых реализаций процесса копирования файлов.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее будет рассматриваться настройка консольного варианта. Настройка в консоли наиболее кроссплатформенна и поддерживает весь набор возможностей этой программы.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Синхронизация двух компьютеров через третий</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы говорить предметно, далее будет описана схема синхронизации директорий, расположенных на двух разных компьютерах, через третий, промежуточный. На самом деле, ничего не мешает настроить синхронизацию просто между двумя компьютерами: на первом запускается синхронизация со вторым, на втором - с первым. Однако здесь рассматривается более сложный случай. Как он может возникнуть?</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Имеется сеть предприятия, в которой выделены два напрямую несвязанных между собой сегмента сети: &quot;защищенный&quot; и &quot;для всех&quot;. В &quot;защищенной&quot; сети имеется хост с Linux. В &quot;сети для всех&quot; имеется хост с Windows. Между сетями находится Linux-сервер, на который имеется доступ в качестве непривелегированного пользователя по протоколу SSH. К этому серверу можно коннектиться как в защищенной сети, так и из &quot;сети для всех&quot;. Размещение компьютеров выглядит примерно так:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1613819705pfzi4ey3se.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задача: получить синхронизацию файлового каталога между <span style=" font-family:'FreeMono'; color:#6a1009;">linuxhost</span> и <span style=" font-family:'FreeMono'; color:#6a1009;">winhost</span>. Сложность в том, что server находится не под нашим контролем, мы просто пользователи, имеющие SSH-доступ на <span style=" font-family:'FreeMono'; color:#6a1009;">server</span>, и не более того. А это значит, что установить нужное дополнительное системное ПО на сервер (тот же unison) не представляется возможным.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Тем не менее, даже в таких условиях сделать синхронизацию через <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span> возможно.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Настройка server</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Мы не является администраторами <span style=" font-family:'FreeMono'; color:#6a1009;">server</span>, но можем произвести нужные настройки у себя в каталоге пользователя. Для правильной работы <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span> необходимо, чтобы он был установлен на обоих компьютерах, участвующих в синхронизации. В нашем случае синхронизируются пары <span style=" font-family:'FreeMono'; color:#6a1009;">server-winhost</span> и <span style=" font-family:'FreeMono'; color:#6a1009;">server-linuxhost</span>. А это значит, что на всех трех компьютерах должен быть установлен <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span>.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Хорошая новость в том, что, как было сказано выше, сборки <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span> распространяются статически, и могут быть запущены из любого каталога операционной системы.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для настройки сервера, надо залить в каталог пользователя статический дистрибутив <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span> и проверить как он работает. Заливку можно сделать из Linux с помощью Midnight Commander через пункт меню &quot;Shell-соединение&quot;. Заливку из Windows можно сделать через утилиту WinSCP. В любом случае, после заливки надо войти своим пользователем на сервер через SSH и проверить как выполняется <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span>. Например, если дистрибутив <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span> был залит в каталог:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">/home/user/portableSoft/unisonSyncronizer</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">... то для проверки можно запустить команду:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">/home/user/portableSoft/unisonSyncronizer/bin/unison -help</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если команда выполнилась без ошибок, небыло сообщений о неподходящей версии ядра или неподдерживаемой версии LIBC, то настройку можно продолжать дальше. Если же <span style=" font-family:'FreeMono'; color:#6a1009;">unison</span> не запустился, надо подобрать версию дистрибутива этой утилиты. Возможно, что надо попробовать более старую. Как было сказано выше, авторы делают официальные сборки и в более старых окружениях.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На этом настройка <span style=" font-family:'FreeMono'; color:#6a1009;">server</span> закончена.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14pt; font-weight:600;">Настройка winhost</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вначале лучше заняться настройкой Windows-машины, потому что соединение linux-linux сделать достаточно просто, а вот с windows-linux придется поковыряться.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для начала в Windows нужно установить пакет OpenSSH. Он необходим, чтобы соединение winhost-server устанавливалось с помощью ключей шифрования, и не требовало ввода логина-пароля. Автор статьи устанавливает OpenSSH вместе с Git for Windows, так как OpenSSH сразу идет в комплекте с этой системой контроля версий. Но можно поставить OpenSSH и отдельно по следующей ссылке:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">https://remoteshaman.com/project/openssh-for-windows</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В любом случае после установки OpenSSH необходимо убедиться, что исполнимые файлы типа <span style=" font-family:'FreeMono'; color:#6a1009;">ssh.exe</span> и <span style=" font-family:'FreeMono'; color:#6a1009;">ssh-keygen.exe</span> были доступны на исполнение. Для этого в переменную PATH пользователя (или в системный PATH) должен быть прописан путь до директории, в которой расположены эти исполняемые файлы.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее необходимо сгенерировать пару открытого и закрытого ключа. Для этого необходимо запустить утилиту ssh-keygen:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1614602352gk21axyigt.png" /></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На все запросы, в том числе на запрос ввести passphrase, надо нажимать Enter. В результате в каталоге пользователя будет создан каталог <span style=" font-family:'FreeMono'; color:#6a1009;">/.ssh</span>, в котором будет лежать два файла: <span style=" font-family:'FreeMono'; color:#6a1009;">id_rsa</span> и <span style=" font-family:'FreeMono'; color:#6a1009;">id_rsa.pub</span>. Это закрытый и открытый ключи шифрования SSH-сессии.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Публичный ключ надо прописать на <span style=" font-family:'FreeMono'; color:#6a1009;">server</span> в файл <span style=" font-family:'FreeMono'; color:#6a1009;">/home/user/.ssh/authorized_keys</span>. Если этого файла нет, его можно создать. Публичный ключ пользователя прописывается в виде одной строки в данном файле. Либо же можно воспользоваться утилитой </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>