<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Итак, мы остановились на том, что у нас есть более-менее настроенная EMU0404-USB под Линкусом. Однако на текущий момент мы можем послать на карту только один звуковой поток, при попытке воспроизведения второго потока, мы получаем ошибку о том , что &quot;устройство занято&quot;. Как говорилось ранее это связано с тем, что карта не имеет аппаратного микширования.<br />Но и эта проблема решаема, мы можем объявить программный микшер(в терминах ALSA - dmix). Ниже приведен &quot;.asoundrc&quot; c регулятором громкости, и микшером:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">pcm.usb_dmix  {<br />   ipc_key 1025<br />   type dmix<br />   slave {<br />    pcm &quot;hw:1,0&quot;<br />    rate 44100<br />    format S24_3LE<br />    period_time 0<br />    period_size 1024<br />    buffer_size 8192<br />   }<br />   bindings {<br />        0 0<br />        1 1<br />   }<br />}<br /><br />pcm.pre_dmix{<br /> type plug<br /> slave{<br />  pcm &quot;usb_dmix&quot;<br />  format S24_3LE<br />  channels 2<br /> }<br />}<br /><br />pcm.usb_sv{<br />  type softvol<br />  slave.pcm &quot;pre_dmix&quot;<br />  control.name &quot;SoftMaster&quot;<br />  control.card 1<br />  max_dB 0.0<br />  min_dB -51.0<br />  resolution 100<br />  hint{<br />    show on<br />    description &quot;EMU-0404USB Volume&quot;<br />  }<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a0e07;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Так, что мы здесь имеем: пропало объявление &quot;usb_44&quot; - правильно, нам не нужен ресемплер, поскольку микшер требует привидения всех потоков к одной частоте перед микшированием, это мы и указали в одyом из параметров dmix. Второе изменение - появлось описание устройства &quot;pre_dmix&quot;. Казалось бы, зачем нам нужен какой-то промежуточный уровень между регулятором громкости и микшером? Все просто: микшер в качестве &quot;конечного&quot; устройства понимает только алиасы типа hw:n,m, при попытке подставить plughw, мы не получим ничего кроме ошибки. Поэтому нам нужно перед отдачей потока в микшер преорбразовать его в стерео 24 бит. По сути дела, виртуальное устройство &quot;pre_dmix&quot; выполняет ту же самую работу, что и &quot;plughw&quot;.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';"> Итак, открываем две консоли, и готовимся воспроизводить 2 потока одновременно, набираем в обеих консолях:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">aplay -D usb_sv foo.wav</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">и запускаем на выполнение команду в одной консоли, и сразу же в другой. Оба потока должны воспроизводиться одновременно.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Но WTF2!!!! мы слышим существенное ухудшение звука: шум и призвуки слышны даже на наушниках-&quot;вкладышах&quot;, не говоря о более серьезной аппаратуре.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Подобная деградация связана с ошибкой в alsa-lib в коде dmix для случая 24 битных звуковых потоков. Поэтому нам необходимо поставить заплатку.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Забегая вперед, скажу - ошибка есть и в регуляторе громкости для 24 битного потока, но вы её не заметите, пока не начнете слушать 24 бинтные файлы, такие, например, как vinyl-ripы 24/96, поэтому мы будем ставить два патча сразу.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">   Подготовимся к установке патчей: необходимо установить пакеты </span><span style=" font-family:'Sans Serif'; font-weight:600;">build-essentials</span><span style=" font-family:'Sans Serif';"> и </span><span style=" font-family:'Sans Serif'; font-weight:600;">patch</span><span style=" font-family:'Sans Serif';">.<br />   1.Идем на сайт ALSA (</span><a href="http://www.alsa-project.org"><span style=" font-family:'Sans Serif'; text-decoration: underline; color:#0000ff;">www.alsa-project.org</span></a><span style=" font-family:'Sans Serif';">) и скачиваем исходники alsa-lib той версии, которая установлена в системе (установленную версию можно подсмотреть в синаптике)<br />   2.Разархивируем исходники<br />   3.Открываем консоль и вводим команды (первая команда - вход в папку с исходниками)<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">$cd alsa-lib-1.0.xx<br />$wget http://www.pastie.org/512796.txt<br />$patch -p0 &lt; 512796.txt<br />$wget http://www.pastie.org/514225.txt<br />$patch -p0 &lt; 514225.txt<br />$./configure<br />$make<br />$sudo make install</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans Serif';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Готово! Перегружать ничего не надо. Повторяем одновременный вывод двух потоков через aplay, как указано выше. Все должно теперь звучать &quot;чисто&quot;. (Кстати, поскольку Вы уже &quot;продвинутые&quot;, я не напоминаю о необходимости перебивать индексы карты и менять объявление &quot;usb_sv&quot; на &quot;!default&quot; </span><img src="image836336645.png" /><span style=" font-family:'Sans Serif';">).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Теперь подходим к самому интересному. Наверное, я буду прав, если предположу, что карты E-MU USB покупают люди, которые неравнодушны к качеству звука, и передискретизация &quot;всего чего только можно&quot; к 44100 является для них, мягко говоря, не совсем уместным  </span><img src="image971447700.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';"> Чтож, дело поправимое, готовимся патчить драйвер: с того же сайта ALSA качаем исходники, теперь alsa-driver (обязательно той версии, которая у вас установлена, предполагаю, что на момент написания сего опуса это будет версия 1.0.18)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';"> Открываем консоль и вводим команды (первая команда - вход в папку с исходниками)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans Serif';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">$ cd alsa-driver-1.0.xx<br />$ wget http://pastie.org/504385.txt<br />$ patch -p0 &lt; 504385.txt<br />$ ./configure <br />$ make <br />$ sudo make install</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Можете пока пойти сделать себе кофе/чай/виски-с-содовоай - компилироваться будет долго, можно, конечно ограничиться компилированием драйверов только для нескольких типов карт (ключ --with-cards для команды configure), но я вам этого делать не советую, можете промахнуться, и встроенная звуковая работать перестанет.<br />Теперь нужно выгрузить и загрузить заново модуль ядра snd-usb-audio, но проще будет просто перегрузить компьютер, всё таки не сервер настраиваем.<br /> Открываем консоль и запускаем alsamixer для карты №1<br /></span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">alsmixer -c 1</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Среди ползунков наблюдаем &quot;Clock rate selector&quot;. Он имеет 6 положений, обозначенные 0-20-40-60-80-100. Чтож не совсем user-friendly, но думаю освоитесь, и запомните, что это соответствует 44100-48000-88200-96000-176400-192000.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Попробуем возвратить в &quot;.asoundrc&quot; самую-самую первую версию содержимого - в которой есть только программный регулятор громкости без передисекретизаторов и микшеров.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">Теперь повторим эксперимент с запуском какого-нибудь фильма. Звук опять играет ужасно. Переходим в окно alsamixer'а и ставим ползунок &quot;Clock rate selector&quot; в положение 20 (48000кГц). Другое дело!<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">К сожалению пока не удается сделать патч для alsa-driver, чтобы частота выставлялась автоматически, в зависимости от выводимого потока (как это сделано в WIndows). Также существенным ограничением является фиксирование частоты в dmix - не будешь же постоянно вручную корректировать .asoundrc Поэтому пусть каждый решает для себя, что ему важнее - воспроизведение нескольких потоков одновременно на фиксированной частоте, или возможность менять частоту, и не терять и толики качества материала, но только для одyого потока.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';"> Владельцы Kubuntu могут для изменеия частоты пользовать стандартный Kmix, вместо alsamixer. А вот, пользователям Gnome повезло меньше. Нет, регулятор в гномовском микшере есть, но он &quot;плавный&quot;, и попасть в одно из 6 значений довольно тяжело.<br /></span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans Serif';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">P.S. За кадром полностью остался вопрос записи звука. Скажу сразу - запись выше, чем на 96кГц работает некорректно, почему - ещё нужно разобраться, в остальных случаях никаких &quot;косяков&quot; вроде не замечено. Также для тех, кто остановится на варианте с dmix, и желает использовать запись и воспроизведение в дуплексном режиме, например для  общения в Скайпе, советую обратиться к документации по ALSA (алиас asym).<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">P.P.S. Для &quot;повернутых на качестве звука&quot;, типа меня, советую перед usb_sv объявить преобразователь в 32бита(по аналогии с pre_dmix), тогда погрешности регулятора громкости будут на порядок меньше.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Sans Serif';">P.P.P.S. Обратите внимание на блок </span><span style=" font-family:'Sans Serif'; font-weight:600;">hint</span><span style=" font-family:'Sans Serif';"> внутри объявления виртуального устройства, он позволяет &quot;увидеть&quot; системе это виртуальное устройство. Очень странно, но эта возможность практически нигде не описана, хотя существует достаточно давно (c версии альсы 1.0.14). Например она широко используется в KDE 4, начиная с v4.1. </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans Serif';"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Sans Serif';"><br /></p></body></html>